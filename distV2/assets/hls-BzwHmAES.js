import{g as qe,b5 as et}from"./vendor-B2CzOxuJ.js";function tt(Oe,be){for(var Ae=0;Ae<be.length;Ae++){const Le=be[Ae];if(typeof Le!="string"&&!Array.isArray(Le)){for(const ue in Le)if(ue!=="default"&&!(ue in Oe)){const Pe=Object.getOwnPropertyDescriptor(Le,ue);Pe&&Object.defineProperty(Oe,ue,Pe.get?Pe:{enumerable:!0,get:()=>Le[ue]})}}}return Object.freeze(Object.defineProperty(Oe,Symbol.toStringTag,{value:"Module"}))}var Ge={exports:{}};(function(Oe,be){typeof window<"u"&&function(Le,ue){Oe.exports=ue()}(et,()=>(()=>{var Ae={"./src/config.ts":(Y,B,x)=>{x.r(B),x.d(B,{enableStreamingMode:()=>f,hlsDefaultConfig:()=>i,mergeConfig:()=>t});var F=x("./src/controller/abr-controller.ts"),A=x("./src/controller/audio-stream-controller.ts"),b=x("./src/controller/audio-track-controller.ts"),R=x("./src/controller/subtitle-stream-controller.ts"),k=x("./src/controller/subtitle-track-controller.ts"),P=x("./src/controller/buffer-controller.ts"),L=x("./src/controller/timeline-controller.ts"),S=x("./src/controller/cap-level-controller.ts"),_=x("./src/controller/fps-controller.ts"),T=x("./src/controller/eme-controller.ts"),c=x("./src/controller/cmcd-controller.ts"),y=x("./src/utils/xhr-loader.ts"),m=x("./src/utils/fetch-loader.ts"),o=x("./src/utils/cues.ts"),u=x("./src/utils/mediakeys-helper.ts"),s=x("./src/utils/logger.ts");function n(){return n=Object.assign?Object.assign.bind():function(e){for(var d=1;d<arguments.length;d++){var E=arguments[d];for(var v in E)Object.prototype.hasOwnProperty.call(E,v)&&(e[v]=E[v])}return e},n.apply(this,arguments)}function g(e,d){var E=Object.keys(e);if(Object.getOwnPropertySymbols){var v=Object.getOwnPropertySymbols(e);d&&(v=v.filter(function(D){return Object.getOwnPropertyDescriptor(e,D).enumerable})),E.push.apply(E,v)}return E}function h(e){for(var d=1;d<arguments.length;d++){var E=arguments[d]!=null?arguments[d]:{};d%2?g(Object(E),!0).forEach(function(v){r(e,v,E[v])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(E)):g(Object(E)).forEach(function(v){Object.defineProperty(e,v,Object.getOwnPropertyDescriptor(E,v))})}return e}function r(e,d,E){return d=l(d),d in e?Object.defineProperty(e,d,{value:E,enumerable:!0,configurable:!0,writable:!0}):e[d]=E,e}function l(e){var d=p(e,"string");return typeof d=="symbol"?d:String(d)}function p(e,d){if(typeof e!="object"||e===null)return e;var E=e[Symbol.toPrimitive];if(E!==void 0){var v=E.call(e,d||"default");if(typeof v!="object")return v;throw new TypeError("@@toPrimitive must return a primitive value.")}return(d==="string"?String:Number)(e)}var i=h(h({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,maxBufferSize:60*1e3*1e3,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,enableSoftwareAES:!0,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,startLevel:void 0,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:y.default,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:F.default,bufferController:P.default,capLevelController:S.default,fpsController:_.default,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:u.requestMediaKeySystemAccess,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0},a()),{},{subtitleStreamController:R.SubtitleStreamController,subtitleTrackController:k.default,timelineController:L.TimelineController,audioStreamController:A.default,audioTrackController:b.default,emeController:T.default,cmcdController:c.default});function a(){return{cueHandler:o.default,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function t(e,d){if((d.liveSyncDurationCount||d.liveMaxLatencyDurationCount)&&(d.liveSyncDuration||d.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(d.liveMaxLatencyDurationCount!==void 0&&(d.liveSyncDurationCount===void 0||d.liveMaxLatencyDurationCount<=d.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(d.liveMaxLatencyDuration!==void 0&&(d.liveSyncDuration===void 0||d.liveMaxLatencyDuration<=d.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');return n({},e,d)}function f(e){var d=e.loader;if(d!==m.default&&d!==y.default)s.logger.log("[config]: Custom loader detected, cannot enable progressive streaming"),e.progressive=!1;else{var E=(0,m.fetchSupported)();E&&(e.loader=m.default,e.progressive=!0,e.enableSoftwareAES=!0,s.logger.log("[config]: Progressive streaming enabled, using FetchLoader"))}}},"./src/controller/abr-controller.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>y});var F=x("./src/polyfills/number.ts"),A=x("./src/utils/ewma-bandwidth-estimator.ts"),b=x("./src/events.ts"),R=x("./src/errors.ts"),k=x("./src/types/loader.ts"),P=x("./src/utils/logger.ts");function L(m,o){for(var u=0;u<o.length;u++){var s=o[u];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(m,_(s.key),s)}}function S(m,o,u){return o&&L(m.prototype,o),Object.defineProperty(m,"prototype",{writable:!1}),m}function _(m){var o=T(m,"string");return typeof o=="symbol"?o:String(o)}function T(m,o){if(typeof m!="object"||m===null)return m;var u=m[Symbol.toPrimitive];if(u!==void 0){var s=u.call(m,o);if(typeof s!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(m)}var c=function(){function m(u){this.hls=void 0,this.lastLoadedFragLevel=0,this._nextAutoLevel=-1,this.timer=void 0,this.onCheck=this._abandonRulesCheck.bind(this),this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this.hls=u;var s=u.config;this.bwEstimator=new A.default(s.abrEwmaSlowVoD,s.abrEwmaFastVoD,s.abrEwmaDefaultEstimate),this.registerListeners()}var o=m.prototype;return o.registerListeners=function(){var s=this.hls;s.on(b.Events.FRAG_LOADING,this.onFragLoading,this),s.on(b.Events.FRAG_LOADED,this.onFragLoaded,this),s.on(b.Events.FRAG_BUFFERED,this.onFragBuffered,this),s.on(b.Events.LEVEL_LOADED,this.onLevelLoaded,this),s.on(b.Events.ERROR,this.onError,this)},o.unregisterListeners=function(){var s=this.hls;s.off(b.Events.FRAG_LOADING,this.onFragLoading,this),s.off(b.Events.FRAG_LOADED,this.onFragLoaded,this),s.off(b.Events.FRAG_BUFFERED,this.onFragBuffered,this),s.off(b.Events.LEVEL_LOADED,this.onLevelLoaded,this),s.off(b.Events.ERROR,this.onError,this)},o.destroy=function(){this.unregisterListeners(),this.clearTimer(),this.hls=this.onCheck=null,this.fragCurrent=this.partCurrent=null},o.onFragLoading=function(s,n){var g=n.frag;if(g.type===k.PlaylistLevelType.MAIN&&!this.timer){var h;this.fragCurrent=g,this.partCurrent=(h=n.part)!=null?h:null,this.timer=self.setInterval(this.onCheck,100)}},o.onLevelLoaded=function(s,n){var g=this.hls.config;n.details.live?this.bwEstimator.update(g.abrEwmaSlowLive,g.abrEwmaFastLive):this.bwEstimator.update(g.abrEwmaSlowVoD,g.abrEwmaFastVoD)},o._abandonRulesCheck=function(){var s=this.fragCurrent,n=this.partCurrent,g=this.hls,h=g.autoLevelEnabled,r=g.media;if(!(!s||!r)){var l=n?n.stats:s.stats,p=n?n.duration:s.duration;if(l.aborted||l.loaded&&l.loaded===l.total||s.level===0){this.clearTimer(),this._nextAutoLevel=-1;return}if(!(!h||r.paused||!r.playbackRate||!r.readyState)){var i=g.mainForwardBufferInfo;if(i!==null){var a=performance.now()-l.loading.start,t=Math.abs(r.playbackRate);if(!(a<=500*p/t)){var f=l.loaded&&l.loading.first,e=this.bwEstimator.getEstimate(),d=g.levels,E=g.minAutoLevel,v=d[s.level],D=l.total||Math.max(l.loaded,Math.round(p*v.maxBitrate/8)),I=f?l.loaded*1e3/a:0,O=I?(D-l.loaded)/I:D*8/e,C=i.len/t;if(!(O<=C)){var M=Number.POSITIVE_INFINITY,U;for(U=s.level-1;U>E;U--){var w=d[U].maxBitrate;if(M=I?p*w/(8*.8*I):p*w/e,M<C)break}M>=O||(P.logger.warn("Fragment "+s.sn+(n?" part "+n.index:"")+" of level "+s.level+" is loading too slowly and will cause an underbuffer; aborting and switching to level "+U+`
      Current BW estimate: `+((0,F.isFiniteNumber)(e)?(e/1024).toFixed(3):"Unknown")+` Kb/s
      Estimated load time for current fragment: `+O.toFixed(3)+` s
      Estimated load time for the next fragment: `+M.toFixed(3)+` s
      Time to underbuffer: `+C.toFixed(3)+" s"),g.nextLoadLevel=U,f&&this.bwEstimator.sample(a,l.loaded),this.clearTimer(),(s.loader||s.keyLoader)&&(this.fragCurrent=this.partCurrent=null,s.abortRequests()),g.trigger(b.Events.FRAG_LOAD_EMERGENCY_ABORTED,{frag:s,part:n,stats:l}))}}}}}},o.onFragLoaded=function(s,n){var g=n.frag,h=n.part;if(g.type===k.PlaylistLevelType.MAIN&&(0,F.isFiniteNumber)(g.sn)){var r=h?h.stats:g.stats,l=h?h.duration:g.duration;if(this.clearTimer(),this.lastLoadedFragLevel=g.level,this._nextAutoLevel=-1,this.hls.config.abrMaxWithRealBitrate){var p=this.hls.levels[g.level],i=(p.loaded?p.loaded.bytes:0)+r.loaded,a=(p.loaded?p.loaded.duration:0)+l;p.loaded={bytes:i,duration:a},p.realBitrate=Math.round(8*i/a)}if(g.bitrateTest){var t={stats:r,frag:g,part:h,id:g.type};this.onFragBuffered(b.Events.FRAG_BUFFERED,t)}}},o.onFragBuffered=function(s,n){var g=n.frag,h=n.part,r=h?h.stats:g.stats;if(!r.aborted&&!(g.type!==k.PlaylistLevelType.MAIN||g.sn==="initSegment")){var l=r.parsing.end-r.loading.start;this.bwEstimator.sample(l,r.loaded),r.bwEstimate=this.bwEstimator.getEstimate(),g.bitrateTest?this.bitrateTestDelay=l/1e3:this.bitrateTestDelay=0}},o.onError=function(s,n){var g;if(((g=n.frag)===null||g===void 0?void 0:g.type)===k.PlaylistLevelType.MAIN){if(n.type===R.ErrorTypes.KEY_SYSTEM_ERROR){this.clearTimer();return}switch(n.details){case R.ErrorDetails.FRAG_LOAD_ERROR:case R.ErrorDetails.FRAG_LOAD_TIMEOUT:case R.ErrorDetails.KEY_LOAD_ERROR:case R.ErrorDetails.KEY_LOAD_TIMEOUT:this.clearTimer();break}}},o.clearTimer=function(){self.clearInterval(this.timer),this.timer=void 0},o.getNextABRAutoLevel=function(){var s=this.fragCurrent,n=this.partCurrent,g=this.hls,h=g.maxAutoLevel,r=g.config,l=g.minAutoLevel,p=g.media,i=n?n.duration:s?s.duration:0,a=p&&p.playbackRate!==0?Math.abs(p.playbackRate):1,t=this.bwEstimator?this.bwEstimator.getEstimate():r.abrEwmaDefaultEstimate,f=g.mainForwardBufferInfo,e=(f?f.len:0)/a,d=this.findBestLevel(t,l,h,e,r.abrBandWidthFactor,r.abrBandWidthUpFactor);if(d>=0)return d;P.logger.trace((e?"rebuffering expected":"buffer is empty")+", finding optimal quality level");var E=i?Math.min(i,r.maxStarvationDelay):r.maxStarvationDelay,v=r.abrBandWidthFactor,D=r.abrBandWidthUpFactor;if(!e){var I=this.bitrateTestDelay;if(I){var O=i?Math.min(i,r.maxLoadingDelay):r.maxLoadingDelay;E=O-I,P.logger.trace("bitrate test took "+Math.round(1e3*I)+"ms, set first fragment max fetchDuration to "+Math.round(1e3*E)+" ms"),v=D=1}}return d=this.findBestLevel(t,l,h,e+E,v,D),Math.max(d,0)},o.findBestLevel=function(s,n,g,h,r,l){for(var p,i=this.fragCurrent,a=this.partCurrent,t=this.lastLoadedFragLevel,f=this.hls.levels,e=f[t],d=!!(e!=null&&(p=e.details)!==null&&p!==void 0&&p.live),E=e==null?void 0:e.codecSet,v=a?a.duration:i?i.duration:0,D=g;D>=n;D--){var I=f[D];if(!(!I||E&&I.codecSet!==E)){var O=I.details,C=(a?O==null?void 0:O.partTarget:O==null?void 0:O.averagetargetduration)||v,M=void 0;D<=t?M=r*s:M=l*s;var U=f[D].maxBitrate,w=U*C/M;if(P.logger.trace("level/adjustedbw/bitrate/avgDuration/maxFetchDuration/fetchDuration: "+D+"/"+Math.round(M)+"/"+U+"/"+C+"/"+h+"/"+w),M>U&&(w===0||!(0,F.isFiniteNumber)(w)||d&&!this.bitrateTestDelay||w<h))return D}}return-1},S(m,[{key:"nextAutoLevel",get:function(){var s=this._nextAutoLevel,n=this.bwEstimator;if(s!==-1&&!n.canEstimate())return s;var g=this.getNextABRAutoLevel();return s!==-1&&this.hls.levels[g].loadError?s:(s!==-1&&(g=Math.min(s,g)),g)},set:function(s){this._nextAutoLevel=s}}]),m}();const y=c},"./src/controller/audio-stream-controller.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>r});var F=x("./src/polyfills/number.ts"),A=x("./src/controller/base-stream-controller.ts"),b=x("./src/events.ts"),R=x("./src/utils/buffer-helper.ts"),k=x("./src/controller/fragment-tracker.ts"),P=x("./src/types/level.ts"),L=x("./src/types/loader.ts"),S=x("./src/loader/fragment.ts"),_=x("./src/demux/chunk-cache.ts"),T=x("./src/demux/transmuxer-interface.ts"),c=x("./src/types/transmuxer.ts"),y=x("./src/controller/fragment-finders.ts"),m=x("./src/utils/discontinuities.ts"),o=x("./src/errors.ts");function u(){return u=Object.assign?Object.assign.bind():function(l){for(var p=1;p<arguments.length;p++){var i=arguments[p];for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(l[a]=i[a])}return l},u.apply(this,arguments)}function s(l,p){l.prototype=Object.create(p.prototype),l.prototype.constructor=l,n(l,p)}function n(l,p){return n=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(a,t){return a.__proto__=t,a},n(l,p)}var g=100,h=function(l){s(p,l);function p(a,t,f){var e;return e=l.call(this,a,t,f,"[audio-stream-controller]")||this,e.videoBuffer=null,e.videoTrackCC=-1,e.waitingVideoCC=-1,e.audioSwitch=!1,e.trackId=-1,e.waitingData=null,e.mainDetails=null,e.bufferFlushed=!1,e.cachedTrackLoadedData=null,e._registerListeners(),e}var i=p.prototype;return i.onHandlerDestroying=function(){this._unregisterListeners(),this.mainDetails=null},i._registerListeners=function(){var t=this.hls;t.on(b.Events.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(b.Events.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(b.Events.MANIFEST_LOADING,this.onManifestLoading,this),t.on(b.Events.LEVEL_LOADED,this.onLevelLoaded,this),t.on(b.Events.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),t.on(b.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.on(b.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.on(b.Events.ERROR,this.onError,this),t.on(b.Events.BUFFER_RESET,this.onBufferReset,this),t.on(b.Events.BUFFER_CREATED,this.onBufferCreated,this),t.on(b.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),t.on(b.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),t.on(b.Events.FRAG_BUFFERED,this.onFragBuffered,this)},i._unregisterListeners=function(){var t=this.hls;t.off(b.Events.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(b.Events.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(b.Events.MANIFEST_LOADING,this.onManifestLoading,this),t.off(b.Events.LEVEL_LOADED,this.onLevelLoaded,this),t.off(b.Events.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),t.off(b.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.off(b.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.off(b.Events.ERROR,this.onError,this),t.off(b.Events.BUFFER_RESET,this.onBufferReset,this),t.off(b.Events.BUFFER_CREATED,this.onBufferCreated,this),t.off(b.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),t.off(b.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),t.off(b.Events.FRAG_BUFFERED,this.onFragBuffered,this)},i.onInitPtsFound=function(t,f){var e=f.frag,d=f.id,E=f.initPTS;if(d==="main"){var v=e.cc;this.initPTS[e.cc]=E,this.log("InitPTS for cc: "+v+" found from main: "+E),this.videoTrackCC=v,this.state===A.State.WAITING_INIT_PTS&&this.tick()}},i.startLoad=function(t){if(!this.levels){this.startPosition=t,this.state=A.State.STOPPED;return}var f=this.lastCurrentTime;this.stopLoad(),this.setInterval(g),this.fragLoadError=0,f>0&&t===-1?(this.log("Override startPosition with lastCurrentTime @"+f.toFixed(3)),t=f,this.state=A.State.IDLE):(this.loadedmetadata=!1,this.state=A.State.WAITING_TRACK),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=t,this.tick()},i.doTick=function(){switch(this.state){case A.State.IDLE:this.doTickIdle();break;case A.State.WAITING_TRACK:{var t,f=this.levels,e=this.trackId,d=f==null||(t=f[e])===null||t===void 0?void 0:t.details;if(d){if(this.waitForCdnTuneIn(d))break;this.state=A.State.WAITING_INIT_PTS}break}case A.State.FRAG_LOADING_WAITING_RETRY:{var E,v=performance.now(),D=this.retryDate;(!D||v>=D||(E=this.media)!==null&&E!==void 0&&E.seeking)&&(this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded(this.trackId),this.state=A.State.IDLE);break}case A.State.WAITING_INIT_PTS:{var I=this.waitingData;if(I){var O=I.frag,C=I.part,M=I.cache,U=I.complete;if(this.initPTS[O.cc]!==void 0){this.waitingData=null,this.waitingVideoCC=-1,this.state=A.State.FRAG_LOADING;var w=M.flush(),N={frag:O,part:C,payload:w,networkDetails:null};this._handleFragmentLoadProgress(N),U&&l.prototype._handleFragmentLoadComplete.call(this,N)}else if(this.videoTrackCC!==this.waitingVideoCC)this.log("Waiting fragment cc ("+O.cc+") cancelled because video is at cc "+this.videoTrackCC),this.clearWaitingFragment();else{var K=this.getLoadPosition(),W=R.BufferHelper.bufferInfo(this.mediaBuffer,K,this.config.maxBufferHole),G=(0,y.fragmentWithinToleranceTest)(W.end,this.config.maxFragLookUpTolerance,O);G<0&&(this.log("Waiting fragment cc ("+O.cc+") @ "+O.start+" cancelled because another fragment at "+W.end+" is needed"),this.clearWaitingFragment())}}else this.state=A.State.IDLE}}this.onTickEnd()},i.clearWaitingFragment=function(){var t=this.waitingData;t&&(this.fragmentTracker.removeFragment(t.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state=A.State.IDLE)},i.resetLoadingState=function(){this.clearWaitingFragment(),l.prototype.resetLoadingState.call(this)},i.onTickEnd=function(){var t=this.media;!t||!t.readyState||(this.lastCurrentTime=t.currentTime)},i.doTickIdle=function(){var t=this.hls,f=this.levels,e=this.media,d=this.trackId,E=t.config;if(!(!f||!f[d])&&!(!e&&(this.startFragRequested||!E.startFragPrefetch))){var v=f[d],D=v.details;if(!D||D.live&&this.levelLastLoaded!==d||this.waitForCdnTuneIn(D)){this.state=A.State.WAITING_TRACK;return}var I=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&I&&(this.bufferFlushed=!1,this.afterBufferFlushed(I,S.ElementaryStreamTypes.AUDIO,L.PlaylistLevelType.AUDIO));var O=this.getFwdBufferInfo(I,L.PlaylistLevelType.AUDIO);if(O!==null){var C=this.audioSwitch;if(!C&&this._streamEnded(O,D)){t.trigger(b.Events.BUFFER_EOS,{type:"audio"}),this.state=A.State.ENDED;return}var M=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,L.PlaylistLevelType.MAIN),U=O.len,w=this.getMaxBufferLength(M==null?void 0:M.len);if(!(U>=w&&!C)){var N=D.fragments,K=N[0].start,W=O.end;if(C&&e){var G=this.getLoadPosition();W=G,D.PTSKnown&&G<K&&(O.end>K||O.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),e.currentTime=K+.05)}if(!(M&&W>M.end+D.targetduration)&&!((!M||!M.len)&&O.len)){var j=this.getNextFragment(W,D);if(!j){this.bufferFlushed=!0;return}this.loadFragment(j,D,W)}}}}},i.getMaxBufferLength=function(t){var f=l.prototype.getMaxBufferLength.call(this);return t?Math.max(f,t):f},i.onMediaDetaching=function(){this.videoBuffer=null,l.prototype.onMediaDetaching.call(this)},i.onAudioTracksUpdated=function(t,f){var e=f.audioTracks;this.resetTransmuxer(),this.levels=e.map(function(d){return new P.Level(d)})},i.onAudioTrackSwitching=function(t,f){var e=!!f.url;this.trackId=f.id;var d=this.fragCurrent;d&&d.abortRequests(),this.fragCurrent=null,this.clearWaitingFragment(),e?this.setInterval(g):this.resetTransmuxer(),e?(this.audioSwitch=!0,this.state=A.State.IDLE):this.state=A.State.STOPPED,this.tick()},i.onManifestLoading=function(){this.mainDetails=null,this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=!1},i.onLevelLoaded=function(t,f){this.mainDetails=f.details,this.cachedTrackLoadedData!==null&&(this.hls.trigger(b.Events.AUDIO_TRACK_LOADED,this.cachedTrackLoadedData),this.cachedTrackLoadedData=null)},i.onAudioTrackLoaded=function(t,f){var e;if(this.mainDetails==null){this.cachedTrackLoadedData=f;return}var d=this.levels,E=f.details,v=f.id;if(!d){this.warn("Audio tracks were reset while loading level "+v);return}this.log("Track "+v+" loaded ["+E.startSN+","+E.endSN+"],duration:"+E.totalduration);var D=d[v],I=0;if(E.live||(e=D.details)!==null&&e!==void 0&&e.live){var O=this.mainDetails;if(E.fragments[0]||(E.deltaUpdateFailed=!0),E.deltaUpdateFailed||!O)return;!D.details&&E.hasProgramDateTime&&O.hasProgramDateTime?((0,m.alignMediaPlaylistByPDT)(E,O),I=E.fragments[0].start):I=this.alignPlaylists(E,D.details)}D.details=E,this.levelLastLoaded=v,!this.startFragRequested&&(this.mainDetails||!E.live)&&this.setStartPosition(D.details,I),this.state===A.State.WAITING_TRACK&&!this.waitForCdnTuneIn(E)&&(this.state=A.State.IDLE),this.tick()},i._handleFragmentLoadProgress=function(t){var f,e=t.frag,d=t.part,E=t.payload,v=this.config,D=this.trackId,I=this.levels;if(!I){this.warn("Audio tracks were reset while fragment load was in progress. Fragment "+e.sn+" of level "+e.level+" will not be buffered");return}var O=I[D];console.assert(O,"Audio track is defined on fragment load progress");var C=O.details;console.assert(C,"Audio track details are defined on fragment load progress");var M=v.defaultAudioCodec||O.audioCodec||"mp4a.40.2",U=this.transmuxer;U||(U=this.transmuxer=new T.default(this.hls,L.PlaylistLevelType.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));var w=this.initPTS[e.cc],N=(f=e.initSegment)===null||f===void 0?void 0:f.data;if(w!==void 0){var K=!1,W=d?d.index:-1,G=W!==-1,j=new c.ChunkMetadata(e.level,e.sn,e.stats.chunkCount,E.byteLength,W,G);U.push(E,N,M,"",e,d,C.totalduration,K,j,w)}else{this.log("Unknown video PTS for cc "+e.cc+", waiting for video PTS before demuxing audio frag "+e.sn+" of ["+C.startSN+" ,"+C.endSN+"],track "+D);var H=this.waitingData=this.waitingData||{frag:e,part:d,cache:new _.default,complete:!1},V=H.cache;V.push(new Uint8Array(E)),this.waitingVideoCC=this.videoTrackCC,this.state=A.State.WAITING_INIT_PTS}},i._handleFragmentLoadComplete=function(t){if(this.waitingData){this.waitingData.complete=!0;return}l.prototype._handleFragmentLoadComplete.call(this,t)},i.onBufferReset=function(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1},i.onBufferCreated=function(t,f){var e=f.tracks.audio;e&&(this.mediaBuffer=e.buffer||null),f.tracks.video&&(this.videoBuffer=f.tracks.video.buffer||null)},i.onFragBuffered=function(t,f){var e=f.frag,d=f.part;if(e.type!==L.PlaylistLevelType.AUDIO){if(!this.loadedmetadata&&e.type===L.PlaylistLevelType.MAIN){var E;(E=this.videoBuffer||this.media)!==null&&E!==void 0&&E.buffered.length&&(this.loadedmetadata=!0)}return}if(this.fragContextChanged(e)){this.warn("Fragment "+e.sn+(d?" p: "+d.index:"")+" of level "+e.level+" finished buffering, but was aborted. state: "+this.state+", audioSwitch: "+this.audioSwitch);return}e.sn!=="initSegment"&&(this.fragPrevious=e,this.audioSwitch&&(this.audioSwitch=!1,this.hls.trigger(b.Events.AUDIO_TRACK_SWITCHED,{id:this.trackId}))),this.fragBufferedComplete(e,d)},i.onError=function(t,f){if(f.type===o.ErrorTypes.KEY_SYSTEM_ERROR){this.onFragmentOrKeyLoadError(L.PlaylistLevelType.AUDIO,f);return}switch(f.details){case o.ErrorDetails.FRAG_LOAD_ERROR:case o.ErrorDetails.FRAG_LOAD_TIMEOUT:case o.ErrorDetails.FRAG_PARSING_ERROR:case o.ErrorDetails.KEY_LOAD_ERROR:case o.ErrorDetails.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(L.PlaylistLevelType.AUDIO,f);break;case o.ErrorDetails.AUDIO_TRACK_LOAD_ERROR:case o.ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:this.state!==A.State.ERROR&&this.state!==A.State.STOPPED&&(this.state=f.fatal?A.State.ERROR:A.State.IDLE,this.warn(f.details+" while loading frag, switching to "+this.state+" state"));break;case o.ErrorDetails.BUFFER_FULL_ERROR:if(f.parent==="audio"&&(this.state===A.State.PARSING||this.state===A.State.PARSED)){var e=!0,d=this.getFwdBufferInfo(this.mediaBuffer,L.PlaylistLevelType.AUDIO);d&&d.len>.5&&(e=!this.reduceMaxBufferLength(d.len)),e&&(this.warn("Buffer full error also media.currentTime is not buffered, flush audio buffer"),this.fragCurrent=null,l.prototype.flushMainBuffer.call(this,0,Number.POSITIVE_INFINITY,"audio")),this.resetLoadingState()}break}},i.onBufferFlushed=function(t,f){var e=f.type;e===S.ElementaryStreamTypes.AUDIO&&(this.bufferFlushed=!0,this.state===A.State.ENDED&&(this.state=A.State.IDLE))},i._handleTransmuxComplete=function(t){var f,e="audio",d=this.hls,E=t.remuxResult,v=t.chunkMeta,D=this.getCurrentContext(v);if(!D){this.warn("The loading context changed while buffering fragment "+v.sn+" of level "+v.level+". This chunk will not be buffered."),this.resetStartWhenNotLoaded(v.level);return}var I=D.frag,O=D.part,C=D.level.details,M=E.audio,U=E.text,w=E.id3,N=E.initSegment;if(!(this.fragContextChanged(I)||!C)){if(this.state=A.State.PARSING,this.audioSwitch&&M&&this.completeAudioSwitch(),N!=null&&N.tracks&&(this._bufferInitSegment(N.tracks,I,v),d.trigger(b.Events.FRAG_PARSING_INIT_SEGMENT,{frag:I,id:e,tracks:N.tracks})),M){var K=M.startPTS,W=M.endPTS,G=M.startDTS,j=M.endDTS;O&&(O.elementaryStreams[S.ElementaryStreamTypes.AUDIO]={startPTS:K,endPTS:W,startDTS:G,endDTS:j}),I.setElementaryStreamInfo(S.ElementaryStreamTypes.AUDIO,K,W,G,j),this.bufferFragmentData(M,I,O,v)}if(w!=null&&(f=w.samples)!==null&&f!==void 0&&f.length){var H=u({id:e,frag:I,details:C},w);d.trigger(b.Events.FRAG_PARSING_METADATA,H)}if(U){var V=u({id:e,frag:I,details:C},U);d.trigger(b.Events.FRAG_PARSING_USERDATA,V)}}},i._bufferInitSegment=function(t,f,e){if(this.state===A.State.PARSING){t.video&&delete t.video;var d=t.audio;if(d){d.levelCodec=d.codec,d.id="audio",this.log("Init audio buffer, container:"+d.container+", codecs[parsed]=["+d.codec+"]"),this.hls.trigger(b.Events.BUFFER_CODECS,t);var E=d.initSegment;if(E!=null&&E.byteLength){var v={type:"audio",frag:f,part:null,chunkMeta:e,parent:f.type,data:E};this.hls.trigger(b.Events.BUFFER_APPENDING,v)}this.tick()}}},i.loadFragment=function(t,f,e){var d=this.fragmentTracker.getState(t);this.fragCurrent=t,(this.audioSwitch||d===k.FragmentState.NOT_LOADED||d===k.FragmentState.PARTIAL)&&(t.sn==="initSegment"?this._loadInitSegment(t,f):f.live&&!(0,F.isFiniteNumber)(this.initPTS[t.cc])?(this.log("Waiting for video PTS in continuity counter "+t.cc+" of live stream before loading audio fragment "+t.sn+" of level "+this.trackId),this.state=A.State.WAITING_INIT_PTS):(this.startFragRequested=!0,l.prototype.loadFragment.call(this,t,f,e)))},i.completeAudioSwitch=function(){var t=this.hls,f=this.media,e=this.trackId;f&&(this.log("Switching audio track : flushing all audio"),l.prototype.flushMainBuffer.call(this,0,Number.POSITIVE_INFINITY,"audio")),this.audioSwitch=!1,t.trigger(b.Events.AUDIO_TRACK_SWITCHED,{id:e})},p}(A.default);const r=h},"./src/controller/audio-track-controller.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>y});var F=x("./src/events.ts"),A=x("./src/errors.ts"),b=x("./src/controller/base-playlist-controller.ts"),R=x("./src/types/loader.ts");function k(m,o){for(var u=0;u<o.length;u++){var s=o[u];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(m,L(s.key),s)}}function P(m,o,u){return o&&k(m.prototype,o),Object.defineProperty(m,"prototype",{writable:!1}),m}function L(m){var o=S(m,"string");return typeof o=="symbol"?o:String(o)}function S(m,o){if(typeof m!="object"||m===null)return m;var u=m[Symbol.toPrimitive];if(u!==void 0){var s=u.call(m,o);if(typeof s!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(m)}function _(m,o){m.prototype=Object.create(o.prototype),m.prototype.constructor=m,T(m,o)}function T(m,o){return T=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(s,n){return s.__proto__=n,s},T(m,o)}var c=function(m){_(o,m);function o(s){var n;return n=m.call(this,s,"[audio-track-controller]")||this,n.tracks=[],n.groupId=null,n.tracksInGroup=[],n.trackId=-1,n.trackName="",n.selectDefaultTrack=!0,n.registerListeners(),n}var u=o.prototype;return u.registerListeners=function(){var n=this.hls;n.on(F.Events.MANIFEST_LOADING,this.onManifestLoading,this),n.on(F.Events.MANIFEST_PARSED,this.onManifestParsed,this),n.on(F.Events.LEVEL_LOADING,this.onLevelLoading,this),n.on(F.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),n.on(F.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),n.on(F.Events.ERROR,this.onError,this)},u.unregisterListeners=function(){var n=this.hls;n.off(F.Events.MANIFEST_LOADING,this.onManifestLoading,this),n.off(F.Events.MANIFEST_PARSED,this.onManifestParsed,this),n.off(F.Events.LEVEL_LOADING,this.onLevelLoading,this),n.off(F.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),n.off(F.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),n.off(F.Events.ERROR,this.onError,this)},u.destroy=function(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,m.prototype.destroy.call(this)},u.onManifestLoading=function(){this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.trackName="",this.selectDefaultTrack=!0},u.onManifestParsed=function(n,g){this.tracks=g.audioTracks||[]},u.onAudioTrackLoaded=function(n,g){var h=g.id,r=g.details,l=this.tracksInGroup[h];if(!l){this.warn("Invalid audio track id "+h);return}var p=l.details;l.details=g.details,this.log("audioTrack "+h+" loaded ["+r.startSN+"-"+r.endSN+"]"),h===this.trackId&&(this.retryCount=0,this.playlistLoaded(h,g,p))},u.onLevelLoading=function(n,g){this.switchLevel(g.level)},u.onLevelSwitching=function(n,g){this.switchLevel(g.level)},u.switchLevel=function(n){var g=this.hls.levels[n];if(g!=null&&g.audioGroupIds){var h=g.audioGroupIds[g.urlId];if(this.groupId!==h){this.groupId=h;var r=this.tracks.filter(function(p){return!h||p.groupId===h});this.selectDefaultTrack&&!r.some(function(p){return p.default})&&(this.selectDefaultTrack=!1),this.tracksInGroup=r;var l={audioTracks:r};this.log("Updating audio tracks, "+r.length+' track(s) found in "'+h+'" group-id'),this.hls.trigger(F.Events.AUDIO_TRACKS_UPDATED,l),this.selectInitialTrack()}}},u.onError=function(n,g){m.prototype.onError.call(this,n,g),!(g.fatal||!g.context)&&g.context.type===R.PlaylistContextType.AUDIO_TRACK&&g.context.id===this.trackId&&g.context.groupId===this.groupId&&this.retryLoadingOrFail(g)},u.setAudioTrack=function(n){var g=this.tracksInGroup;if(n<0||n>=g.length){this.warn("Invalid id passed to audio-track controller");return}this.clearTimer();var h=g[this.trackId];this.log("Now switching to audio-track index "+n);var r=g[n],l=r.id,p=r.groupId,i=p===void 0?"":p,a=r.name,t=r.type,f=r.url;if(this.trackId=n,this.trackName=a,this.selectDefaultTrack=!1,this.hls.trigger(F.Events.AUDIO_TRACK_SWITCHING,{id:l,groupId:i,name:a,type:t,url:f}),!(r.details&&!r.details.live)){var e=this.switchParams(r.url,h==null?void 0:h.details);this.loadPlaylist(e)}},u.selectInitialTrack=function(){var n=this.tracksInGroup;console.assert(n.length,"Initial audio track should be selected when tracks are known");var g=this.trackName,h=this.findTrackId(g)||this.findTrackId();h!==-1?this.setAudioTrack(h):(this.warn("No track found for running audio group-ID: "+this.groupId),this.hls.trigger(F.Events.ERROR,{type:A.ErrorTypes.MEDIA_ERROR,details:A.ErrorDetails.AUDIO_TRACK_LOAD_ERROR,fatal:!0}))},u.findTrackId=function(n){for(var g=this.tracksInGroup,h=0;h<g.length;h++){var r=g[h];if((!this.selectDefaultTrack||r.default)&&(!n||n===r.name))return r.id}return-1},u.loadPlaylist=function(n){m.prototype.loadPlaylist.call(this);var g=this.tracksInGroup[this.trackId];if(this.shouldLoadTrack(g)){var h=g.id,r=g.groupId,l=g.url;if(n)try{l=n.addDirectives(l)}catch(p){this.warn("Could not construct new URL with HLS Delivery Directives: "+p)}this.log("loading audio-track playlist for id: "+h),this.clearTimer(),this.hls.trigger(F.Events.AUDIO_TRACK_LOADING,{url:l,id:h,groupId:r,deliveryDirectives:n||null})}},P(o,[{key:"audioTracks",get:function(){return this.tracksInGroup}},{key:"audioTrack",get:function(){return this.trackId},set:function(n){this.selectDefaultTrack=!1,this.setAudioTrack(n)}}]),o}(b.default);const y=c},"./src/controller/base-playlist-controller.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>k});var F=x("./src/types/level.ts"),A=x("./src/controller/level-helper.ts"),b=x("./src/utils/logger.ts"),R=x("./src/errors.ts"),k=function(){function P(S,_){this.hls=void 0,this.timer=-1,this.requestScheduled=-1,this.canLoad=!1,this.retryCount=0,this.log=void 0,this.warn=void 0,this.log=b.logger.log.bind(b.logger,_+":"),this.warn=b.logger.warn.bind(b.logger,_+":"),this.hls=S}var L=P.prototype;return L.destroy=function(){this.clearTimer(),this.hls=this.log=this.warn=null},L.onError=function(_,T){T.fatal&&(T.type===R.ErrorTypes.NETWORK_ERROR||T.type===R.ErrorTypes.KEY_SYSTEM_ERROR)&&this.stopLoad()},L.clearTimer=function(){clearTimeout(this.timer),this.timer=-1},L.startLoad=function(){this.canLoad=!0,this.retryCount=0,this.requestScheduled=-1,this.loadPlaylist()},L.stopLoad=function(){this.canLoad=!1,this.clearTimer()},L.switchParams=function(_,T){var c=T==null?void 0:T.renditionReports;if(c)for(var y=0;y<c.length;y++){var m=c[y],o=void 0;try{o=new self.URL(m.URI,T.url).href}catch(g){b.logger.warn("Could not construct new URL for Rendition Report: "+g),o=m.URI||""}if(o===_.slice(-o.length)){var u=parseInt(m["LAST-MSN"])||(T==null?void 0:T.lastPartSn),s=parseInt(m["LAST-PART"])||(T==null?void 0:T.lastPartIndex);if(this.hls.config.lowLatencyMode){var n=Math.min(T.age-T.partTarget,T.targetduration);s>=0&&n>T.partTarget&&(s+=1)}return new F.HlsUrlParameters(u,s>=0?s:void 0,F.HlsSkip.No)}}},L.loadPlaylist=function(_){this.requestScheduled===-1&&(this.requestScheduled=self.performance.now())},L.shouldLoadTrack=function(_){return this.canLoad&&_&&!!_.url&&(!_.details||_.details.live)},L.playlistLoaded=function(_,T,c){var y=this,m=T.details,o=T.stats,u=self.performance.now(),s=o.loading.first?Math.max(0,u-o.loading.first):0;if(m.advancedDateTime=Date.now()-s,m.live||c!=null&&c.live){if(m.reloaded(c),c&&this.log("live playlist "+_+" "+(m.advanced?"REFRESHED "+m.lastPartSn+"-"+m.lastPartIndex:"MISSED")),c&&m.fragments.length>0&&(0,A.mergeDetails)(c,m),!this.canLoad||!m.live)return;var n,g=void 0,h=void 0;if(m.canBlockReload&&m.endSN&&m.advanced){var r=this.hls.config.lowLatencyMode,l=m.lastPartSn,p=m.endSN,i=m.lastPartIndex,a=i!==-1,t=l===p,f=r?0:i;a?(g=t?p+1:l,h=t?f:i+1):g=p+1;var e=m.age,d=e+m.ageHeader,E=Math.min(d-m.partTarget,m.targetduration*1.5);if(E>0){if(c&&E>c.tuneInGoal)this.warn("CDN Tune-in goal increased from: "+c.tuneInGoal+" to: "+E+" with playlist age: "+m.age),E=0;else{var v=Math.floor(E/m.targetduration);if(g+=v,h!==void 0){var D=Math.round(E%m.targetduration/m.partTarget);h+=D}this.log("CDN Tune-in age: "+m.ageHeader+"s last advanced "+e.toFixed(2)+"s goal: "+E+" skip sn "+v+" to part "+h)}m.tuneInGoal=E}if(n=this.getDeliveryDirectives(m,T.deliveryDirectives,g,h),r||!t){this.loadPlaylist(n);return}}else n=this.getDeliveryDirectives(m,T.deliveryDirectives,g,h);var I=this.hls.mainForwardBufferInfo,O=I?I.end-I.len:0,C=(m.edge-O)*1e3,M=(0,A.computeReloadInterval)(m,C);m.updated?u>this.requestScheduled+M&&(this.requestScheduled=o.loading.start):this.requestScheduled=-1,g!==void 0&&m.canBlockReload?this.requestScheduled=o.loading.first+M-(m.partTarget*1e3||1e3):this.requestScheduled=(this.requestScheduled===-1?u:this.requestScheduled)+M;var U=this.requestScheduled-u;U=Math.max(0,U),this.log("reload live playlist "+_+" in "+Math.round(U)+" ms"),this.timer=self.setTimeout(function(){return y.loadPlaylist(n)},U)}else this.clearTimer()},L.getDeliveryDirectives=function(_,T,c,y){var m=(0,F.getSkipValue)(_,c);return T!=null&&T.skip&&_.deltaUpdateFailed&&(c=T.msn,y=T.part,m=F.HlsSkip.No),new F.HlsUrlParameters(c,y,m)},L.retryLoadingOrFail=function(_){var T=this,c=this.hls.config,y=this.retryCount<c.levelLoadingMaxRetry;if(y){var m;if(this.requestScheduled=-1,this.retryCount++,_.details.indexOf("LoadTimeOut")>-1&&(m=_.context)!==null&&m!==void 0&&m.deliveryDirectives)this.warn("retry playlist loading #"+this.retryCount+' after "'+_.details+'"'),this.loadPlaylist();else{var o=Math.min(Math.pow(2,this.retryCount)*c.levelLoadingRetryDelay,c.levelLoadingMaxRetryTimeout);this.timer=self.setTimeout(function(){return T.loadPlaylist()},o),this.warn("retry playlist loading #"+this.retryCount+" in "+o+' ms after "'+_.details+'"')}}else this.warn('cannot recover from error "'+_.details+'"'),this.clearTimer(),_.fatal=!0;return y},P}()},"./src/controller/base-stream-controller.ts":(Y,B,x)=>{x.r(B),x.d(B,{State:()=>a,default:()=>t});var F=x("./src/polyfills/number.ts"),A=x("./src/task-loop.ts"),b=x("./src/controller/fragment-tracker.ts"),R=x("./src/utils/buffer-helper.ts"),k=x("./src/utils/logger.ts"),P=x("./src/events.ts"),L=x("./src/errors.ts"),S=x("./src/types/transmuxer.ts"),_=x("./src/utils/mp4-tools.ts"),T=x("./src/utils/discontinuities.ts"),c=x("./src/controller/fragment-finders.ts"),y=x("./src/controller/level-helper.ts"),m=x("./src/loader/fragment-loader.ts"),o=x("./src/crypt/decrypter.ts"),u=x("./src/utils/time-ranges.ts"),s=x("./src/types/loader.ts");function n(f,e){for(var d=0;d<e.length;d++){var E=e[d];E.enumerable=E.enumerable||!1,E.configurable=!0,"value"in E&&(E.writable=!0),Object.defineProperty(f,h(E.key),E)}}function g(f,e,d){return e&&n(f.prototype,e),Object.defineProperty(f,"prototype",{writable:!1}),f}function h(f){var e=r(f,"string");return typeof e=="symbol"?e:String(e)}function r(f,e){if(typeof f!="object"||f===null)return f;var d=f[Symbol.toPrimitive];if(d!==void 0){var E=d.call(f,e);if(typeof E!="object")return E;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(f)}function l(f){if(f===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return f}function p(f,e){f.prototype=Object.create(e.prototype),f.prototype.constructor=f,i(f,e)}function i(f,e){return i=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(E,v){return E.__proto__=v,E},i(f,e)}var a={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"},t=function(f){p(e,f);function e(E,v,D,I){var O;return O=f.call(this)||this,O.hls=void 0,O.fragPrevious=null,O.fragCurrent=null,O.fragmentTracker=void 0,O.transmuxer=null,O._state=a.STOPPED,O.media=null,O.mediaBuffer=null,O.config=void 0,O.bitrateTest=!1,O.lastCurrentTime=0,O.nextLoadPosition=0,O.startPosition=0,O.loadedmetadata=!1,O.fragLoadError=0,O.retryDate=0,O.levels=null,O.fragmentLoader=void 0,O.keyLoader=void 0,O.levelLastLoaded=null,O.startFragRequested=!1,O.decrypter=void 0,O.initPTS=[],O.onvseeking=null,O.onvended=null,O.logPrefix="",O.log=void 0,O.warn=void 0,O.logPrefix=I,O.log=k.logger.log.bind(k.logger,I+":"),O.warn=k.logger.warn.bind(k.logger,I+":"),O.hls=E,O.fragmentLoader=new m.default(E.config),O.keyLoader=D,O.fragmentTracker=v,O.config=E.config,O.decrypter=new o.default(E.config),E.on(P.Events.LEVEL_SWITCHING,O.onLevelSwitching,l(O)),O}var d=e.prototype;return d.doTick=function(){this.onTickEnd()},d.onTickEnd=function(){},d.startLoad=function(v){},d.stopLoad=function(){this.fragmentLoader.abort(),this.keyLoader.abort();var v=this.fragCurrent;v&&(v.abortRequests(),this.fragmentTracker.removeFragment(v)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=a.STOPPED},d._streamEnded=function(v,D){if(D.live||v.nextStart||!v.end||!this.media)return!1;var I=D.partList;if(I!=null&&I.length){var O=I[I.length-1],C=R.BufferHelper.isBuffered(this.media,O.start+O.duration/2);return C}var M=D.fragments[D.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(M)},d.getLevelDetails=function(){if(this.levels&&this.levelLastLoaded!==null){var v;return(v=this.levels[this.levelLastLoaded])===null||v===void 0?void 0:v.details}},d.onMediaAttached=function(v,D){var I=this.media=this.mediaBuffer=D.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),I.addEventListener("seeking",this.onvseeking),I.addEventListener("ended",this.onvended);var O=this.config;this.levels&&O.autoStartLoad&&this.state===a.STOPPED&&this.startLoad(O.startPosition)},d.onMediaDetaching=function(){var v=this.media;v!=null&&v.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),v&&this.onvseeking&&this.onvended&&(v.removeEventListener("seeking",this.onvseeking),v.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.keyLoader&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()},d.onMediaSeeking=function(){var v=this.config,D=this.fragCurrent,I=this.media,O=this.mediaBuffer,C=this.state,M=I?I.currentTime:0,U=R.BufferHelper.bufferInfo(O||I,M,v.maxBufferHole);if(this.log("media seeking to "+((0,F.isFiniteNumber)(M)?M.toFixed(3):M)+", state: "+C),this.state===a.ENDED)this.resetLoadingState();else if(D){var w=v.maxFragLookUpTolerance,N=D.start-w,K=D.start+D.duration+w;if(!U.len||K<U.start||N>U.end){var W=M>K;(M<N||W)&&(W&&D.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),D.abortRequests()),this.resetLoadingState())}}I&&(this.lastCurrentTime=M),!this.loadedmetadata&&!U.len&&(this.nextLoadPosition=this.startPosition=M),this.tickImmediate()},d.onMediaEnded=function(){this.startPosition=this.lastCurrentTime=0},d.onLevelSwitching=function(v,D){this.fragLoadError=0},d.onHandlerDestroying=function(){this.stopLoad(),f.prototype.onHandlerDestroying.call(this)},d.onHandlerDestroyed=function(){this.state=a.STOPPED,this.hls.off(P.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,f.prototype.onHandlerDestroyed.call(this)},d.loadFragment=function(v,D,I){this._loadFragForPlayback(v,D,I)},d._loadFragForPlayback=function(v,D,I){var O=this,C=function(U){if(O.fragContextChanged(v)){O.warn("Fragment "+v.sn+(U.part?" p: "+U.part.index:"")+" of level "+v.level+" was dropped during download."),O.fragmentTracker.removeFragment(v);return}v.stats.chunkCount++,O._handleFragmentLoadProgress(U)};this._doFragLoad(v,D,I,C).then(function(M){if(M){O.fragLoadError=0;var U=O.state;if(O.fragContextChanged(v)){(U===a.FRAG_LOADING||!O.fragCurrent&&U===a.PARSING)&&(O.fragmentTracker.removeFragment(v),O.state=a.IDLE);return}"payload"in M&&(O.log("Loaded fragment "+v.sn+" of level "+v.level),O.hls.trigger(P.Events.FRAG_LOADED,M)),O._handleFragmentLoadComplete(M)}}).catch(function(M){O.state===a.STOPPED||O.state===a.ERROR||(O.warn(M),O.resetFragmentLoading(v))})},d.flushMainBuffer=function(v,D,I){if(I===void 0&&(I=null),!!(v-D)){var O={startOffset:v,endOffset:D,type:I};this.fragLoadError=0,this.hls.trigger(P.Events.BUFFER_FLUSHING,O)}},d._loadInitSegment=function(v,D){var I=this;this._doFragLoad(v,D).then(function(O){if(!O||I.fragContextChanged(v)||!I.levels)throw new Error("init load aborted");return O}).then(function(O){var C=I.hls,M=O.payload,U=v.decryptdata;if(M&&M.byteLength>0&&U&&U.key&&U.iv&&U.method==="AES-128"){var w=self.performance.now();return I.decrypter.decrypt(new Uint8Array(M),U.key.buffer,U.iv.buffer).then(function(N){var K=self.performance.now();return C.trigger(P.Events.FRAG_DECRYPTED,{frag:v,payload:N,stats:{tstart:w,tdecrypt:K}}),O.payload=N,O})}return O}).then(function(O){var C=I.fragCurrent,M=I.hls,U=I.levels;if(!U)throw new Error("init load aborted, missing levels");var w=U[v.level].details;console.assert(w,"Level details are defined when init segment is loaded");var N=v.stats;I.state=a.IDLE,I.fragLoadError=0,v.data=new Uint8Array(O.payload),N.parsing.start=N.buffering.start=self.performance.now(),N.parsing.end=N.buffering.end=self.performance.now(),O.frag===C&&M.trigger(P.Events.FRAG_BUFFERED,{stats:N,frag:C,part:null,id:v.type}),I.tick()}).catch(function(O){I.state===a.STOPPED||I.state===a.ERROR||(I.warn(O),I.resetFragmentLoading(v))})},d.fragContextChanged=function(v){var D=this.fragCurrent;return!v||!D||v.level!==D.level||v.sn!==D.sn||v.urlId!==D.urlId},d.fragBufferedComplete=function(v,D){var I,O,C,M,U=this.mediaBuffer?this.mediaBuffer:this.media;this.log("Buffered "+v.type+" sn: "+v.sn+(D?" part: "+D.index:"")+" of "+(this.logPrefix==="[stream-controller]"?"level":"track")+" "+v.level+" (frag:["+((I=v.startPTS)!=null?I:NaN).toFixed(3)+"-"+((O=v.endPTS)!=null?O:NaN).toFixed(3)+"] > buffer:"+(U?u.default.toString(R.BufferHelper.getBuffered(U)):"(detached)")+")"),this.state=a.IDLE,U&&(!this.loadedmetadata&&v.type==s.PlaylistLevelType.MAIN&&U.buffered.length&&((C=this.fragCurrent)===null||C===void 0?void 0:C.sn)===((M=this.fragPrevious)===null||M===void 0?void 0:M.sn)&&(this.loadedmetadata=!0,this.seekToStartPos()),this.tick())},d.seekToStartPos=function(){},d._handleFragmentLoadComplete=function(v){var D=this.transmuxer;if(D){var I=v.frag,O=v.part,C=v.partsLoaded,M=!C||C.length===0||C.some(function(w){return!w}),U=new S.ChunkMetadata(I.level,I.sn,I.stats.chunkCount+1,0,O?O.index:-1,!M);D.flush(U)}},d._handleFragmentLoadProgress=function(v){},d._doFragLoad=function(v,D,I,O){var C,M=this;if(I===void 0&&(I=null),!this.levels)throw new Error("frag load aborted, missing levels");var U=null;if(v.encrypted&&!((C=v.decryptdata)!==null&&C!==void 0&&C.key)?(this.log("Loading key for "+v.sn+" of ["+D.startSN+"-"+D.endSN+"], "+(this.logPrefix==="[stream-controller]"?"level":"track")+" "+v.level),this.state=a.KEY_LOADING,this.fragCurrent=v,U=this.keyLoader.load(v).then(function(G){if(!M.fragContextChanged(G.frag))return M.hls.trigger(P.Events.KEY_LOADED,G),M.state===a.KEY_LOADING&&(M.state=a.IDLE),G}),this.hls.trigger(P.Events.KEY_LOADING,{frag:v}),this.throwIfFragContextChanged("KEY_LOADING")):!v.encrypted&&D.encryptedFragments.length&&this.keyLoader.loadClear(v,D.encryptedFragments),I=Math.max(v.start,I||0),this.config.lowLatencyMode&&D){var w=D.partList;if(w&&O){I>v.end&&D.fragmentHint&&(v=D.fragmentHint);var N=this.getNextPart(w,v,I);if(N>-1){var K=w[N];return this.log("Loading part sn: "+v.sn+" p: "+K.index+" cc: "+v.cc+" of playlist ["+D.startSN+"-"+D.endSN+"] parts [0-"+N+"-"+(w.length-1)+"] "+(this.logPrefix==="[stream-controller]"?"level":"track")+": "+v.level+", target: "+parseFloat(I.toFixed(3))),this.nextLoadPosition=K.start+K.duration,this.state=a.FRAG_LOADING,this.hls.trigger(P.Events.FRAG_LOADING,{frag:v,part:w[N],targetBufferTime:I}),this.throwIfFragContextChanged("FRAG_LOADING parts"),U?U.then(function(G){return!G||M.fragContextChanged(G.frag)?null:M.doFragPartsLoad(v,w,N,O)}).catch(function(G){return M.handleFragLoadError(G)}):this.doFragPartsLoad(v,w,N,O).catch(function(G){return M.handleFragLoadError(G)})}else if(!v.url||this.loadedEndOfParts(w,I))return Promise.resolve(null)}}this.log("Loading fragment "+v.sn+" cc: "+v.cc+" "+(D?"of ["+D.startSN+"-"+D.endSN+"] ":"")+(this.logPrefix==="[stream-controller]"?"level":"track")+": "+v.level+", target: "+parseFloat(I.toFixed(3))),(0,F.isFiniteNumber)(v.sn)&&!this.bitrateTest&&(this.nextLoadPosition=v.start+v.duration),this.state=a.FRAG_LOADING,this.hls.trigger(P.Events.FRAG_LOADING,{frag:v,targetBufferTime:I}),this.throwIfFragContextChanged("FRAG_LOADING");var W=this.config.progressive;return W&&U?U.then(function(G){return!G||M.fragContextChanged(G==null?void 0:G.frag)?null:M.fragmentLoader.load(v,O)}).catch(function(G){return M.handleFragLoadError(G)}):Promise.all([this.fragmentLoader.load(v,W?O:void 0),U]).then(function(G){var j=G[0];return!W&&j&&O&&O(j),j}).catch(function(G){return M.handleFragLoadError(G)})},d.throwIfFragContextChanged=function(v){if(this.fragCurrent===null)throw new Error("frag load aborted, context changed in "+v)},d.doFragPartsLoad=function(v,D,I,O){var C=this;return new Promise(function(M,U){var w=[],N=function K(W){var G=D[W];C.fragmentLoader.loadPart(v,G,O).then(function(j){w[G.index]=j;var H=j.part;C.hls.trigger(P.Events.FRAG_LOADED,j);var V=D[W+1];if(V&&V.fragment===v)K(W+1);else return M({frag:v,part:H,partsLoaded:w})}).catch(U)};N(I)})},d.handleFragLoadError=function(v){if("data"in v){var D=v.data;v.data&&D.details===L.ErrorDetails.INTERNAL_ABORTED?this.handleFragLoadAborted(D.frag,D.part):this.hls.trigger(P.Events.ERROR,D)}else this.hls.trigger(P.Events.ERROR,{type:L.ErrorTypes.OTHER_ERROR,details:L.ErrorDetails.INTERNAL_EXCEPTION,err:v,fatal:!0});return null},d._handleTransmuxerFlush=function(v){var D=this.getCurrentContext(v);if(!D||this.state!==a.PARSING){!this.fragCurrent&&this.state!==a.STOPPED&&this.state!==a.ERROR&&(this.state=a.IDLE);return}var I=D.frag,O=D.part,C=D.level,M=self.performance.now();I.stats.parsing.end=M,O&&(O.stats.parsing.end=M),this.updateLevelTiming(I,O,C,v.partial)},d.getCurrentContext=function(v){var D=this.levels,I=v.level,O=v.sn,C=v.part;if(!D||!D[I])return this.warn("Levels object was unset while buffering fragment "+O+" of level "+I+". The current chunk will not be buffered."),null;var M=D[I],U=C>-1?(0,y.getPartWith)(M,O,C):null,w=U?U.fragment:(0,y.getFragmentWithSN)(M,O,this.fragCurrent);return w?{frag:w,part:U,level:M}:null},d.bufferFragmentData=function(v,D,I,O){if(!(!v||this.state!==a.PARSING)){var C=v.data1,M=v.data2,U=C;if(C&&M&&(U=(0,_.appendUint8Array)(C,M)),!(!U||!U.length)){var w={type:v.type,frag:D,part:I,chunkMeta:O,parent:D.type,data:U};this.hls.trigger(P.Events.BUFFER_APPENDING,w),v.dropped&&v.independent&&!I&&this.flushBufferGap(D)}}},d.flushBufferGap=function(v){var D=this.media;if(D){if(!R.BufferHelper.isBuffered(D,D.currentTime)){this.flushMainBuffer(0,v.start);return}var I=D.currentTime,O=R.BufferHelper.bufferInfo(D,I,0),C=v.duration,M=Math.min(this.config.maxFragLookUpTolerance*2,C*.25),U=Math.max(Math.min(v.start-M,O.end-M),I+M);v.start-U>M&&this.flushMainBuffer(U,v.start)}},d.getFwdBufferInfo=function(v,D){var I=this.config,O=this.getLoadPosition();if(!(0,F.isFiniteNumber)(O))return null;var C=R.BufferHelper.bufferInfo(v,O,I.maxBufferHole);if(C.len===0&&C.nextStart!==void 0){var M=this.fragmentTracker.getBufferedFrag(O,D);if(M&&C.nextStart<M.end)return R.BufferHelper.bufferInfo(v,O,Math.max(C.nextStart,I.maxBufferHole))}return C},d.getMaxBufferLength=function(v){var D=this.config,I;return v?I=Math.max(8*D.maxBufferSize/v,D.maxBufferLength):I=D.maxBufferLength,Math.min(I,D.maxMaxBufferLength)},d.reduceMaxBufferLength=function(v){var D=this.config,I=v||D.maxBufferLength;return D.maxMaxBufferLength>=I?(D.maxMaxBufferLength/=2,this.warn("Reduce max buffer length to "+D.maxMaxBufferLength+"s"),!0):!1},d.getNextFragment=function(v,D){var I=D.fragments,O=I.length;if(!O)return null;var C=this.config,M=I[0].start,U;if(D.live){var w=C.initialLiveManifestSize;if(O<w)return this.warn("Not enough fragments to start playback (have: "+O+", need: "+w+")"),null;!D.PTSKnown&&!this.startFragRequested&&this.startPosition===-1&&(U=this.getInitialLiveFragment(D,I),this.startPosition=U?this.hls.liveSyncPosition||U.start:v)}else v<=M&&(U=I[0]);if(!U){var N=C.lowLatencyMode?D.partEnd:D.fragmentEnd;U=this.getFragmentAtPosition(v,N,D)}return this.mapToInitFragWhenRequired(U)},d.mapToInitFragWhenRequired=function(v){return v!=null&&v.initSegment&&!(v!=null&&v.initSegment.data)&&!this.bitrateTest?v.initSegment:v},d.getNextPart=function(v,D,I){for(var O=-1,C=!1,M=!0,U=0,w=v.length;U<w;U++){var N=v[U];if(M=M&&!N.independent,O>-1&&I<N.start)break;var K=N.loaded;K?O=-1:(C||N.independent||M)&&N.fragment===D&&(O=U),C=K}return O},d.loadedEndOfParts=function(v,D){var I=v[v.length-1];return I&&D>I.start&&I.loaded},d.getInitialLiveFragment=function(v,D){var I=this.fragPrevious,O=null;if(I){if(v.hasProgramDateTime&&(this.log("Live playlist, switching playlist, load frag with same PDT: "+I.programDateTime),O=(0,c.findFragmentByPDT)(D,I.endProgramDateTime,this.config.maxFragLookUpTolerance)),!O){var C=I.sn+1;if(C>=v.startSN&&C<=v.endSN){var M=D[C-v.startSN];I.cc===M.cc&&(O=M,this.log("Live playlist, switching playlist, load frag with next SN: "+O.sn))}O||(O=(0,c.findFragWithCC)(D,I.cc),O&&this.log("Live playlist, switching playlist, load frag with same CC: "+O.sn))}}else{var U=this.hls.liveSyncPosition;U!==null&&(O=this.getFragmentAtPosition(U,this.bitrateTest?v.fragmentEnd:v.edge,v))}return O},d.getFragmentAtPosition=function(v,D,I){var O=this.config,C=this.fragPrevious,M=I.fragments,U=I.endSN,w=I.fragmentHint,N=O.maxFragLookUpTolerance,K=!!(O.lowLatencyMode&&I.partList&&w);K&&w&&!this.bitrateTest&&(M=M.concat(w),U=w.sn);var W;if(v<D){var G=v>D-N?0:N;W=(0,c.findFragmentByPTS)(C,M,v,G)}else W=M[M.length-1];if(W){var j=W.sn-I.startSN;if(this.fragmentTracker.getState(W)===b.FragmentState.OK&&(C=W),C&&W.sn===C.sn&&!K){var H=C&&W.level===C.level;if(H){var V=M[j+1];W.sn<U&&this.fragmentTracker.getState(V)!==b.FragmentState.OK?(this.log("SN "+W.sn+" just loaded, load next one: "+V.sn),W=V):W=null}}}return W},d.synchronizeToLiveEdge=function(v){var D=this.config,I=this.media;if(I){var O=this.hls.liveSyncPosition,C=I.currentTime,M=v.fragments[0].start,U=v.edge,w=C>=M-D.maxFragLookUpTolerance&&C<=U;if(O!==null&&I.duration>O&&(C<O||!w)){var N=D.liveMaxLatencyDuration!==void 0?D.liveMaxLatencyDuration:D.liveMaxLatencyDurationCount*v.targetduration;(!w&&I.readyState<4||C<U-N)&&(this.loadedmetadata||(this.nextLoadPosition=O),I.readyState&&(this.warn("Playback: "+C.toFixed(3)+" is located too far from the end of live sliding playlist: "+U+", reset currentTime to : "+O.toFixed(3)),I.currentTime=O))}}},d.alignPlaylists=function(v,D){var I=this.levels,O=this.levelLastLoaded,C=this.fragPrevious,M=O!==null?I[O]:null,U=v.fragments.length;if(!U)return this.warn("No fragments in live playlist"),0;var w=v.fragments[0].start,N=!D,K=v.alignedSliding&&(0,F.isFiniteNumber)(w);if(N||!K&&!w){(0,T.alignStream)(C,M,v);var W=v.fragments[0].start;return this.log("Live playlist sliding: "+W.toFixed(2)+" start-sn: "+(D?D.startSN:"na")+"->"+v.startSN+" prev-sn: "+(C?C.sn:"na")+" fragments: "+U),W}return w},d.waitForCdnTuneIn=function(v){var D=3;return v.live&&v.canBlockReload&&v.partTarget&&v.tuneInGoal>Math.max(v.partHoldBack,v.partTarget*D)},d.setStartPosition=function(v,D){var I=this.startPosition;if(I<D&&(I=-1),I===-1||this.lastCurrentTime===-1){var O=v.startTimeOffset;(0,F.isFiniteNumber)(O)?(I=D+O,O<0&&(I+=v.totalduration),I=Math.min(Math.max(D,I),D+v.totalduration),this.log("Start time offset "+O+" found in playlist, adjust startPosition to "+I),this.startPosition=I):v.live?I=this.hls.liveSyncPosition||D:this.startPosition=I=0,this.lastCurrentTime=I}this.nextLoadPosition=I},d.getLoadPosition=function(){var v=this.media,D=0;return this.loadedmetadata&&v?D=v.currentTime:this.nextLoadPosition&&(D=this.nextLoadPosition),D},d.handleFragLoadAborted=function(v,D){this.transmuxer&&v.sn!=="initSegment"&&v.stats.aborted&&(this.warn("Fragment "+v.sn+(D?" part"+D.index:"")+" of level "+v.level+" was aborted"),this.resetFragmentLoading(v))},d.resetFragmentLoading=function(v){(!this.fragCurrent||!this.fragContextChanged(v)&&this.state!==a.FRAG_LOADING_WAITING_RETRY)&&(this.state=a.IDLE)},d.onFragmentOrKeyLoadError=function(v,D){if(D.fatal){this.stopLoad(),this.state=a.ERROR;return}var I=this.config;if(D.chunkMeta){var O=this.getCurrentContext(D.chunkMeta);O&&(D.frag=O.frag,D.levelRetry=!0,this.fragLoadError=I.fragLoadingMaxRetry)}var C=D.frag;if(!(!C||C.type!==v)){var M=this.fragCurrent;if(console.assert(M&&C.sn===M.sn&&C.level===M.level&&C.urlId===M.urlId,"Frag load error must match current frag to retry"),this.fragLoadError+1<=I.fragLoadingMaxRetry){this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition);var U=Math.min(Math.pow(2,this.fragLoadError)*I.fragLoadingRetryDelay,I.fragLoadingMaxRetryTimeout);this.warn("Fragment "+C.sn+" of "+v+" "+C.level+" failed to load, retrying in "+U+"ms"),this.retryDate=self.performance.now()+U,this.fragLoadError++,this.state=a.FRAG_LOADING_WAITING_RETRY}else D.levelRetry?(v===s.PlaylistLevelType.AUDIO&&(this.fragCurrent=null),this.fragLoadError=0,this.state=a.IDLE):(k.logger.error(D.details+" reaches max retry, redispatch as fatal ..."),D.fatal=!0,this.hls.stopLoad(),this.state=a.ERROR)}},d.afterBufferFlushed=function(v,D,I){if(v){var O=R.BufferHelper.getBuffered(v);this.fragmentTracker.detectEvictedFragments(D,O,I),this.state===a.ENDED&&this.resetLoadingState()}},d.resetLoadingState=function(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state=a.IDLE},d.resetStartWhenNotLoaded=function(v){if(!this.loadedmetadata){this.startFragRequested=!1;var D=this.levels?this.levels[v].details:null;D!=null&&D.live?(this.startPosition=-1,this.setStartPosition(D,0),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}},d.updateLevelTiming=function(v,D,I,O){var C=this,M=I.details;console.assert(!!M,"level.details must be defined");var U=Object.keys(v.elementaryStreams).reduce(function(w,N){var K=v.elementaryStreams[N];if(K){var W=K.endPTS-K.startPTS;if(W<=0)return C.warn("Could not parse fragment "+v.sn+" "+N+" duration reliably ("+W+")"),w||!1;var G=O?0:(0,y.updateFragPTSDTS)(M,v,K.startPTS,K.endPTS,K.startDTS,K.endDTS);return C.hls.trigger(P.Events.LEVEL_PTS_UPDATED,{details:M,level:I,drift:G,type:N,frag:v,start:K.startPTS,end:K.endPTS}),!0}return w},!1);U||(this.warn("Found no media in fragment "+v.sn+" of level "+I.id+" resetting transmuxer to fallback to playlist timing"),this.resetTransmuxer()),this.state=a.PARSED,this.hls.trigger(P.Events.FRAG_PARSED,{frag:v,part:D})},d.resetTransmuxer=function(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)},g(e,[{key:"state",get:function(){return this._state},set:function(v){var D=this._state;D!==v&&(this._state=v,this.log(D+"->"+v))}}]),e}(A.default)},"./src/controller/buffer-controller.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>c});var F=x("./src/polyfills/number.ts"),A=x("./src/events.ts"),b=x("./src/utils/logger.ts"),R=x("./src/errors.ts"),k=x("./src/utils/buffer-helper.ts"),P=x("./src/utils/mediasource-helper.ts"),L=x("./src/loader/fragment.ts"),S=x("./src/controller/buffer-operation-queue.ts"),_=(0,P.getMediaSource)(),T=/([ha]vc.)(?:\.[^.,]+)+/,c=function(){function y(o){var u=this;this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.appendError=0,this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this._onMediaSourceOpen=function(){var s=u.media,n=u.mediaSource;b.logger.log("[buffer-controller]: Media source opened"),s&&(s.removeEventListener("emptied",u._onMediaEmptied),u.updateMediaElementDuration(),u.hls.trigger(A.Events.MEDIA_ATTACHED,{media:s})),n&&n.removeEventListener("sourceopen",u._onMediaSourceOpen),u.checkPendingTracks()},this._onMediaSourceClose=function(){b.logger.log("[buffer-controller]: Media source closed")},this._onMediaSourceEnded=function(){b.logger.log("[buffer-controller]: Media source ended")},this._onMediaEmptied=function(){var s=u.media,n=u._objectUrl;s&&s.src!==n&&b.logger.error("Media element src was set while attaching MediaSource ("+n+" > "+s.src+")")},this.hls=o,this._initSourceBuffer(),this.registerListeners()}var m=y.prototype;return m.hasSourceTypes=function(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0},m.destroy=function(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=null},m.registerListeners=function(){var u=this.hls;u.on(A.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),u.on(A.Events.MEDIA_DETACHING,this.onMediaDetaching,this),u.on(A.Events.MANIFEST_PARSED,this.onManifestParsed,this),u.on(A.Events.BUFFER_RESET,this.onBufferReset,this),u.on(A.Events.BUFFER_APPENDING,this.onBufferAppending,this),u.on(A.Events.BUFFER_CODECS,this.onBufferCodecs,this),u.on(A.Events.BUFFER_EOS,this.onBufferEos,this),u.on(A.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),u.on(A.Events.LEVEL_UPDATED,this.onLevelUpdated,this),u.on(A.Events.FRAG_PARSED,this.onFragParsed,this),u.on(A.Events.FRAG_CHANGED,this.onFragChanged,this)},m.unregisterListeners=function(){var u=this.hls;u.off(A.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),u.off(A.Events.MEDIA_DETACHING,this.onMediaDetaching,this),u.off(A.Events.MANIFEST_PARSED,this.onManifestParsed,this),u.off(A.Events.BUFFER_RESET,this.onBufferReset,this),u.off(A.Events.BUFFER_APPENDING,this.onBufferAppending,this),u.off(A.Events.BUFFER_CODECS,this.onBufferCodecs,this),u.off(A.Events.BUFFER_EOS,this.onBufferEos,this),u.off(A.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),u.off(A.Events.LEVEL_UPDATED,this.onLevelUpdated,this),u.off(A.Events.FRAG_PARSED,this.onFragParsed,this),u.off(A.Events.FRAG_CHANGED,this.onFragChanged,this)},m._initSourceBuffer=function(){this.sourceBuffer={},this.operationQueue=new S.default(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]},this.lastMpegAudioChunk=null},m.onManifestParsed=function(u,s){var n=2;(s.audio&&!s.video||!s.altAudio)&&(n=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=n,this.details=null,b.logger.log(this.bufferCodecEventsExpected+" bufferCodec event(s) expected")},m.onMediaAttaching=function(u,s){var n=this.media=s.media;if(n&&_){var g=this.mediaSource=new _;g.addEventListener("sourceopen",this._onMediaSourceOpen),g.addEventListener("sourceended",this._onMediaSourceEnded),g.addEventListener("sourceclose",this._onMediaSourceClose),n.src=self.URL.createObjectURL(g),this._objectUrl=n.src,n.addEventListener("emptied",this._onMediaEmptied)}},m.onMediaDetaching=function(){var u=this.media,s=this.mediaSource,n=this._objectUrl;if(s){if(b.logger.log("[buffer-controller]: media source detaching"),s.readyState==="open")try{s.endOfStream()}catch(g){b.logger.warn("[buffer-controller]: onMediaDetaching: "+g.message+" while calling endOfStream")}this.onBufferReset(),s.removeEventListener("sourceopen",this._onMediaSourceOpen),s.removeEventListener("sourceended",this._onMediaSourceEnded),s.removeEventListener("sourceclose",this._onMediaSourceClose),u&&(u.removeEventListener("emptied",this._onMediaEmptied),n&&self.URL.revokeObjectURL(n),u.src===n?(u.removeAttribute("src"),u.load()):b.logger.warn("[buffer-controller]: media.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(A.Events.MEDIA_DETACHED,void 0)},m.onBufferReset=function(){var u=this;this.getSourceBufferTypes().forEach(function(s){var n=u.sourceBuffer[s];try{n&&(u.removeBufferListeners(s),u.mediaSource&&u.mediaSource.removeSourceBuffer(n),u.sourceBuffer[s]=void 0)}catch(g){b.logger.warn("[buffer-controller]: Failed to reset the "+s+" buffer",g)}}),this._initSourceBuffer()},m.onBufferCodecs=function(u,s){var n=this,g=this.getSourceBufferTypes().length;Object.keys(s).forEach(function(h){if(g){var r=n.tracks[h];if(r&&typeof r.buffer.changeType=="function"){var l=s[h],p=l.id,i=l.codec,a=l.levelCodec,t=l.container,f=l.metadata,e=(r.levelCodec||r.codec).replace(T,"$1"),d=(a||i).replace(T,"$1");if(e!==d){var E=t+";codecs="+(a||i);n.appendChangeType(h,E),b.logger.log("[buffer-controller]: switching codec "+e+" to "+d),n.tracks[h]={buffer:r.buffer,codec:i,container:t,levelCodec:a,metadata:f,id:p}}}}else n.pendingTracks[h]=s[h]}),!g&&(this.bufferCodecEventsExpected=Math.max(this.bufferCodecEventsExpected-1,0),this.mediaSource&&this.mediaSource.readyState==="open"&&this.checkPendingTracks())},m.appendChangeType=function(u,s){var n=this,g=this.operationQueue,h={execute:function(){var l=n.sourceBuffer[u];l&&(b.logger.log("[buffer-controller]: changing "+u+" sourceBuffer type to "+s),l.changeType(s)),g.shiftAndExecuteNext(u)},onStart:function(){},onComplete:function(){},onError:function(l){b.logger.warn("[buffer-controller]: Failed to change "+u+" SourceBuffer type",l)}};g.append(h,u)},m.onBufferAppending=function(u,s){var n=this,g=this.hls,h=this.operationQueue,r=this.tracks,l=s.data,p=s.type,i=s.frag,a=s.part,t=s.chunkMeta,f=t.buffering[p],e=self.performance.now();f.start=e;var d=i.stats.buffering,E=a?a.stats.buffering:null;d.start===0&&(d.start=e),E&&E.start===0&&(E.start=e);var v=r.audio,D=!1;p==="audio"&&(v==null?void 0:v.container)==="audio/mpeg"&&(D=!this.lastMpegAudioChunk||t.id===1||this.lastMpegAudioChunk.sn!==t.sn,this.lastMpegAudioChunk=t);var I=i.start,O={execute:function(){if(f.executeStart=self.performance.now(),D){var M=n.sourceBuffer[p];if(M){var U=I-M.timestampOffset;Math.abs(U)>=.1&&(b.logger.log("[buffer-controller]: Updating audio SourceBuffer timestampOffset to "+I+" (delta: "+U+") sn: "+i.sn+")"),M.timestampOffset=I)}}n.appendExecutor(l,p)},onStart:function(){},onComplete:function(){var M=self.performance.now();f.executeEnd=f.end=M,d.first===0&&(d.first=M),E&&E.first===0&&(E.first=M);var U=n.sourceBuffer,w={};for(var N in U)w[N]=k.BufferHelper.getBuffered(U[N]);n.appendError=0,n.hls.trigger(A.Events.BUFFER_APPENDED,{type:p,frag:i,part:a,chunkMeta:t,parent:i.type,timeRanges:w})},onError:function(M){b.logger.error("[buffer-controller]: Error encountered while trying to append to the "+p+" SourceBuffer",M);var U={type:R.ErrorTypes.MEDIA_ERROR,parent:i.type,details:R.ErrorDetails.BUFFER_APPEND_ERROR,err:M,fatal:!1};M.code===DOMException.QUOTA_EXCEEDED_ERR?U.details=R.ErrorDetails.BUFFER_FULL_ERROR:(n.appendError++,U.details=R.ErrorDetails.BUFFER_APPEND_ERROR,n.appendError>g.config.appendErrorMaxRetry&&(b.logger.error("[buffer-controller]: Failed "+g.config.appendErrorMaxRetry+" times to append segment in sourceBuffer"),U.fatal=!0,g.stopLoad())),g.trigger(A.Events.ERROR,U)}};h.append(O,p)},m.onBufferFlushing=function(u,s){var n=this,g=this.operationQueue,h=function(l){return{execute:n.removeExecutor.bind(n,l,s.startOffset,s.endOffset),onStart:function(){},onComplete:function(){n.hls.trigger(A.Events.BUFFER_FLUSHED,{type:l})},onError:function(i){b.logger.warn("[buffer-controller]: Failed to remove from "+l+" SourceBuffer",i)}}};s.type?g.append(h(s.type),s.type):this.getSourceBufferTypes().forEach(function(r){g.append(h(r),r)})},m.onFragParsed=function(u,s){var n=this,g=s.frag,h=s.part,r=[],l=h?h.elementaryStreams:g.elementaryStreams;l[L.ElementaryStreamTypes.AUDIOVIDEO]?r.push("audiovideo"):(l[L.ElementaryStreamTypes.AUDIO]&&r.push("audio"),l[L.ElementaryStreamTypes.VIDEO]&&r.push("video"));var p=function(){var a=self.performance.now();g.stats.buffering.end=a,h&&(h.stats.buffering.end=a);var t=h?h.stats:g.stats;n.hls.trigger(A.Events.FRAG_BUFFERED,{frag:g,part:h,stats:t,id:g.type})};r.length===0&&b.logger.warn("Fragments must have at least one ElementaryStreamType set. type: "+g.type+" level: "+g.level+" sn: "+g.sn),this.blockBuffers(p,r)},m.onFragChanged=function(u,s){this.flushBackBuffer()},m.onBufferEos=function(u,s){var n=this,g=this.getSourceBufferTypes().reduce(function(h,r){var l=n.sourceBuffer[r];return l&&(!s.type||s.type===r)&&(l.ending=!0,l.ended||(l.ended=!0,b.logger.log("[buffer-controller]: "+r+" sourceBuffer now EOS"))),h&&!!(!l||l.ended)},!0);g&&(b.logger.log("[buffer-controller]: Queueing mediaSource.endOfStream()"),this.blockBuffers(function(){n.getSourceBufferTypes().forEach(function(r){var l=n.sourceBuffer[r];l&&(l.ending=!1)});var h=n.mediaSource;if(!h||h.readyState!=="open"){h&&b.logger.info("[buffer-controller]: Could not call mediaSource.endOfStream(). mediaSource.readyState: "+h.readyState);return}b.logger.log("[buffer-controller]: Calling mediaSource.endOfStream()"),h.endOfStream()}))},m.onLevelUpdated=function(u,s){var n=s.details;n.fragments.length&&(this.details=n,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())},m.flushBackBuffer=function(){var u=this.hls,s=this.details,n=this.media,g=this.sourceBuffer;if(!(!n||s===null)){var h=this.getSourceBufferTypes();if(h.length){var r=s.live&&u.config.liveBackBufferLength!==null?u.config.liveBackBufferLength:u.config.backBufferLength;if(!(!(0,F.isFiniteNumber)(r)||r<0)){var l=n.currentTime,p=s.levelTargetDuration,i=Math.max(r,p),a=Math.floor(l/p)*p-i;h.forEach(function(t){var f=g[t];if(f){var e=k.BufferHelper.getBuffered(f);if(e.length>0&&a>e.start(0)){if(u.trigger(A.Events.BACK_BUFFER_REACHED,{bufferEnd:a}),s.live)u.trigger(A.Events.LIVE_BACK_BUFFER_REACHED,{bufferEnd:a});else if(f.ended&&e.end(e.length-1)-l<p*2){b.logger.info("[buffer-controller]: Cannot flush "+t+" back buffer while SourceBuffer is in ended state");return}u.trigger(A.Events.BUFFER_FLUSHING,{startOffset:0,endOffset:a,type:t})}}})}}}},m.updateMediaElementDuration=function(){if(!(!this.details||!this.media||!this.mediaSource||this.mediaSource.readyState!=="open")){var u=this.details,s=this.hls,n=this.media,g=this.mediaSource,h=u.fragments[0].start+u.totalduration,r=n.duration,l=(0,F.isFiniteNumber)(g.duration)?g.duration:0;u.live&&s.config.liveDurationInfinity?(b.logger.log("[buffer-controller]: Media Source duration is set to Infinity"),g.duration=1/0,this.updateSeekableRange(u)):(h>l&&h>r||!(0,F.isFiniteNumber)(r))&&(b.logger.log("[buffer-controller]: Updating Media Source duration to "+h.toFixed(3)),g.duration=h)}},m.updateSeekableRange=function(u){var s=this.mediaSource,n=u.fragments,g=n.length;if(g&&u.live&&s!==null&&s!==void 0&&s.setLiveSeekableRange){var h=Math.max(0,n[0].start),r=Math.max(h,h+u.totalduration);s.setLiveSeekableRange(h,r)}},m.checkPendingTracks=function(){var u=this.bufferCodecEventsExpected,s=this.operationQueue,n=this.pendingTracks,g=Object.keys(n).length;if(g&&!u||g===2){this.createSourceBuffers(n),this.pendingTracks={};var h=this.getSourceBufferTypes();if(h.length===0){this.hls.trigger(A.Events.ERROR,{type:R.ErrorTypes.MEDIA_ERROR,details:R.ErrorDetails.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,reason:"could not create source buffer for media codec(s)"});return}h.forEach(function(r){s.executeNext(r)})}},m.createSourceBuffers=function(u){var s=this.sourceBuffer,n=this.mediaSource;if(!n)throw Error("createSourceBuffers called when mediaSource was null");var g=0;for(var h in u)if(!s[h]){var r=u[h];if(!r)throw Error("source buffer exists for track "+h+", however track does not");var l=r.levelCodec||r.codec,p=r.container+";codecs="+l;b.logger.log("[buffer-controller]: creating sourceBuffer("+p+")");try{var i=s[h]=n.addSourceBuffer(p),a=h;this.addBufferListener(a,"updatestart",this._onSBUpdateStart),this.addBufferListener(a,"updateend",this._onSBUpdateEnd),this.addBufferListener(a,"error",this._onSBUpdateError),this.tracks[h]={buffer:i,codec:l,container:r.container,levelCodec:r.levelCodec,metadata:r.metadata,id:r.id},g++}catch(t){b.logger.error("[buffer-controller]: error while trying to add sourceBuffer: "+t.message),this.hls.trigger(A.Events.ERROR,{type:R.ErrorTypes.MEDIA_ERROR,details:R.ErrorDetails.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:t,mimeType:p})}}g&&this.hls.trigger(A.Events.BUFFER_CREATED,{tracks:this.tracks})},m._onSBUpdateStart=function(u){var s=this.operationQueue,n=s.current(u);n.onStart()},m._onSBUpdateEnd=function(u){var s=this.operationQueue,n=s.current(u);n.onComplete(),s.shiftAndExecuteNext(u)},m._onSBUpdateError=function(u,s){b.logger.error("[buffer-controller]: "+u+" SourceBuffer error",s),this.hls.trigger(A.Events.ERROR,{type:R.ErrorTypes.MEDIA_ERROR,details:R.ErrorDetails.BUFFER_APPENDING_ERROR,fatal:!1});var n=this.operationQueue.current(u);n&&n.onError(s)},m.removeExecutor=function(u,s,n){var g=this.media,h=this.mediaSource,r=this.operationQueue,l=this.sourceBuffer,p=l[u];if(!g||!h||!p){b.logger.warn("[buffer-controller]: Attempting to remove from the "+u+" SourceBuffer, but it does not exist"),r.shiftAndExecuteNext(u);return}var i=(0,F.isFiniteNumber)(g.duration)?g.duration:1/0,a=(0,F.isFiniteNumber)(h.duration)?h.duration:1/0,t=Math.max(0,s),f=Math.min(n,i,a);f>t&&!p.ending?(p.ended=!1,b.logger.log("[buffer-controller]: Removing ["+t+","+f+"] from the "+u+" SourceBuffer"),console.assert(!p.updating,u+" sourceBuffer must not be updating"),p.remove(t,f)):r.shiftAndExecuteNext(u)},m.appendExecutor=function(u,s){var n=this.operationQueue,g=this.sourceBuffer,h=g[s];if(!h){b.logger.warn("[buffer-controller]: Attempting to append to the "+s+" SourceBuffer, but it does not exist"),n.shiftAndExecuteNext(s);return}h.ended=!1,console.assert(!h.updating,s+" sourceBuffer must not be updating"),h.appendBuffer(u)},m.blockBuffers=function(u,s){var n=this;if(s===void 0&&(s=this.getSourceBufferTypes()),!s.length){b.logger.log("[buffer-controller]: Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(u);return}var g=this.operationQueue,h=s.map(function(r){return g.appendBlocker(r)});Promise.all(h).then(function(){u(),s.forEach(function(r){var l=n.sourceBuffer[r];(!l||!l.updating)&&g.shiftAndExecuteNext(r)})})},m.getSourceBufferTypes=function(){return Object.keys(this.sourceBuffer)},m.addBufferListener=function(u,s,n){var g=this.sourceBuffer[u];if(g){var h=n.bind(this,u);this.listeners[u].push({event:s,listener:h}),g.addEventListener(s,h)}},m.removeBufferListeners=function(u){var s=this.sourceBuffer[u];s&&this.listeners[u].forEach(function(n){s.removeEventListener(n.event,n.listener)})},y}()},"./src/controller/buffer-operation-queue.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>A});var F=x("./src/utils/logger.ts"),A=function(){function b(k){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=k}var R=b.prototype;return R.append=function(P,L){var S=this.queues[L];S.push(P),S.length===1&&this.buffers[L]&&this.executeNext(L)},R.insertAbort=function(P,L){var S=this.queues[L];S.unshift(P),this.executeNext(L)},R.appendBlocker=function(P){var L,S=new Promise(function(T){L=T}),_={execute:L,onStart:function(){},onComplete:function(){},onError:function(){}};return this.append(_,P),S},R.executeNext=function(P){var L=this.buffers,S=this.queues,_=L[P],T=S[P];if(T.length){var c=T[0];try{c.execute()}catch(y){F.logger.warn("[buffer-operation-queue]: Unhandled exception executing the current operation"),c.onError(y),(!_||!_.updating)&&(T.shift(),this.executeNext(P))}}},R.shiftAndExecuteNext=function(P){this.queues[P].shift(),this.executeNext(P)},R.current=function(P){return this.queues[P][0]},b}()},"./src/controller/cap-level-controller.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>L});var F=x("./src/events.ts");function A(S,_){for(var T=0;T<_.length;T++){var c=_[T];c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(S,R(c.key),c)}}function b(S,_,T){return _&&A(S.prototype,_),Object.defineProperty(S,"prototype",{writable:!1}),S}function R(S){var _=k(S,"string");return typeof _=="symbol"?_:String(_)}function k(S,_){if(typeof S!="object"||S===null)return S;var T=S[Symbol.toPrimitive];if(T!==void 0){var c=T.call(S,_);if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(S)}var P=function(){function S(T){this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.hls=void 0,this.streamController=void 0,this.clientRect=void 0,this.hls=T,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}var _=S.prototype;return _.setStreamController=function(c){this.streamController=c},_.destroy=function(){this.unregisterListener(),this.hls.config.capLevelToPlayerSize&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null},_.registerListeners=function(){var c=this.hls;c.on(F.Events.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),c.on(F.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),c.on(F.Events.MANIFEST_PARSED,this.onManifestParsed,this),c.on(F.Events.BUFFER_CODECS,this.onBufferCodecs,this),c.on(F.Events.MEDIA_DETACHING,this.onMediaDetaching,this)},_.unregisterListener=function(){var c=this.hls;c.off(F.Events.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),c.off(F.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),c.off(F.Events.MANIFEST_PARSED,this.onManifestParsed,this),c.off(F.Events.BUFFER_CODECS,this.onBufferCodecs,this),c.off(F.Events.MEDIA_DETACHING,this.onMediaDetaching,this)},_.onFpsDropLevelCapping=function(c,y){S.isLevelAllowed(y.droppedLevel,this.restrictedLevels)&&this.restrictedLevels.push(y.droppedLevel)},_.onMediaAttaching=function(c,y){this.media=y.media instanceof HTMLVideoElement?y.media:null,this.clientRect=null},_.onManifestParsed=function(c,y){var m=this.hls;this.restrictedLevels=[],this.firstLevel=y.firstLevel,m.config.capLevelToPlayerSize&&y.video&&this.startCapping()},_.onBufferCodecs=function(c,y){var m=this.hls;m.config.capLevelToPlayerSize&&y.video&&this.startCapping()},_.onMediaDetaching=function(){this.stopCapping()},_.detectPlayerSize=function(){if(this.media&&this.mediaHeight>0&&this.mediaWidth>0){var c=this.hls.levels;if(c.length){var y=this.hls;y.autoLevelCapping=this.getMaxLevel(c.length-1),y.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=y.autoLevelCapping}}},_.getMaxLevel=function(c){var y=this,m=this.hls.levels;if(!m.length)return-1;var o=m.filter(function(u,s){return S.isLevelAllowed(s,y.restrictedLevels)&&s<=c});return this.clientRect=null,S.getMaxLevelByMediaSize(o,this.mediaWidth,this.mediaHeight)},_.startCapping=function(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,this.hls.firstLevel=this.getMaxLevel(this.firstLevel),self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())},_.stopCapping=function(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)},_.getDimensions=function(){if(this.clientRect)return this.clientRect;var c=this.media,y={width:0,height:0};if(c){var m=c.getBoundingClientRect();y.width=m.width,y.height=m.height,!y.width&&!y.height&&(y.width=m.right-m.left||c.width||0,y.height=m.bottom-m.top||c.height||0)}return this.clientRect=y,y},S.isLevelAllowed=function(c,y){return y===void 0&&(y=[]),y.indexOf(c)===-1},S.getMaxLevelByMediaSize=function(c,y,m){if(!c||!c.length)return-1;for(var o=function(h,r){return r?h.width!==r.width||h.height!==r.height:!0},u=c.length-1,s=0;s<c.length;s+=1){var n=c[s];if((n.width>=y||n.height>=m)&&o(n,c[s+1])){u=s;break}}return u},b(S,[{key:"mediaWidth",get:function(){return this.getDimensions().width*this.contentScaleFactor}},{key:"mediaHeight",get:function(){return this.getDimensions().height*this.contentScaleFactor}},{key:"contentScaleFactor",get:function(){var c=1;if(!this.hls.config.ignoreDevicePixelRatio)try{c=self.devicePixelRatio}catch{}return c}}]),S}();const L=P},"./src/controller/cmcd-controller.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>m});var F=x("./src/events.ts"),A=x("./src/types/cmcd.ts"),b=x("./src/utils/buffer-helper.ts"),R=x("./src/utils/logger.ts");function k(o,u){for(var s=0;s<u.length;s++){var n=u[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(o,L(n.key),n)}}function P(o,u,s){return u&&k(o.prototype,u),Object.defineProperty(o,"prototype",{writable:!1}),o}function L(o){var u=S(o,"string");return typeof u=="symbol"?u:String(u)}function S(o,u){if(typeof o!="object"||o===null)return o;var s=o[Symbol.toPrimitive];if(s!==void 0){var n=s.call(o,u);if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}function _(o,u){var s=typeof Symbol<"u"&&o[Symbol.iterator]||o["@@iterator"];if(s)return(s=s.call(o)).next.bind(s);if(Array.isArray(o)||(s=T(o))||u){s&&(o=s);var n=0;return function(){return n>=o.length?{done:!0}:{done:!1,value:o[n++]}}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function T(o,u){if(o){if(typeof o=="string")return c(o,u);var s=Object.prototype.toString.call(o).slice(8,-1);if(s==="Object"&&o.constructor&&(s=o.constructor.name),s==="Map"||s==="Set")return Array.from(o);if(s==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(s))return c(o,u)}}function c(o,u){(u==null||u>o.length)&&(u=o.length);for(var s=0,n=new Array(u);s<u;s++)n[s]=o[s];return n}function y(){return y=Object.assign?Object.assign.bind():function(o){for(var u=1;u<arguments.length;u++){var s=arguments[u];for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&(o[n]=s[n])}return o},y.apply(this,arguments)}var m=function(){function o(s){var n=this;this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=function(){n.initialized&&(n.starved=!0),n.buffering=!0},this.onPlaying=function(){n.initialized||(n.initialized=!0),n.buffering=!1},this.applyPlaylistData=function(r){try{n.apply(r,{ot:A.CMCDObjectType.MANIFEST,su:!n.initialized})}catch(l){R.logger.warn("Could not generate manifest CMCD data.",l)}},this.applyFragmentData=function(r){try{var l=r.frag,p=n.hls.levels[l.level],i=n.getObjectType(l),a={d:l.duration*1e3,ot:i};(i===A.CMCDObjectType.VIDEO||i===A.CMCDObjectType.AUDIO||i==A.CMCDObjectType.MUXED)&&(a.br=p.bitrate/1e3,a.tb=n.getTopBandwidth(i)/1e3,a.bl=n.getBufferLength(i)),n.apply(r,a)}catch(t){R.logger.warn("Could not generate segment CMCD data.",t)}},this.hls=s;var g=this.config=s.config,h=g.cmcd;h!=null&&(g.pLoader=this.createPlaylistLoader(),g.fLoader=this.createFragmentLoader(),this.sid=h.sessionId||o.uuid(),this.cid=h.contentId,this.useHeaders=h.useHeaders===!0,this.registerListeners())}var u=o.prototype;return u.registerListeners=function(){var n=this.hls;n.on(F.Events.MEDIA_ATTACHED,this.onMediaAttached,this),n.on(F.Events.MEDIA_DETACHED,this.onMediaDetached,this),n.on(F.Events.BUFFER_CREATED,this.onBufferCreated,this)},u.unregisterListeners=function(){var n=this.hls;n.off(F.Events.MEDIA_ATTACHED,this.onMediaAttached,this),n.off(F.Events.MEDIA_DETACHED,this.onMediaDetached,this),n.off(F.Events.BUFFER_CREATED,this.onBufferCreated,this),this.onMediaDetached()},u.destroy=function(){this.unregisterListeners(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null},u.onMediaAttached=function(n,g){this.media=g.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)},u.onMediaDetached=function(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)},u.onBufferCreated=function(n,g){var h,r;this.audioBuffer=(h=g.tracks.audio)===null||h===void 0?void 0:h.buffer,this.videoBuffer=(r=g.tracks.video)===null||r===void 0?void 0:r.buffer},u.createData=function(){var n;return{v:A.CMCDVersion,sf:A.CMCDStreamingFormat.HLS,sid:this.sid,cid:this.cid,pr:(n=this.media)===null||n===void 0?void 0:n.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}},u.apply=function(n,g){g===void 0&&(g={}),y(g,this.createData());var h=g.ot===A.CMCDObjectType.INIT||g.ot===A.CMCDObjectType.VIDEO||g.ot===A.CMCDObjectType.MUXED;if(this.starved&&h&&(g.bs=!0,g.su=!0,this.starved=!1),g.su==null&&(g.su=this.buffering),this.useHeaders){var r=o.toHeaders(g);if(!Object.keys(r).length)return;n.headers||(n.headers={}),y(n.headers,r)}else{var l=o.toQuery(g);if(!l)return;n.url=o.appendQueryToUri(n.url,l)}},u.getObjectType=function(n){var g=n.type;if(g==="subtitle")return A.CMCDObjectType.TIMED_TEXT;if(n.sn==="initSegment")return A.CMCDObjectType.INIT;if(g==="audio")return A.CMCDObjectType.AUDIO;if(g==="main")return this.hls.audioTracks.length?A.CMCDObjectType.VIDEO:A.CMCDObjectType.MUXED},u.getTopBandwidth=function(n){var g=0,h,r=this.hls;if(n===A.CMCDObjectType.AUDIO)h=r.audioTracks;else{var l=r.maxAutoLevel,p=l>-1?l+1:r.levels.length;h=r.levels.slice(0,p)}for(var i=_(h),a;!(a=i()).done;){var t=a.value;t.bitrate>g&&(g=t.bitrate)}return g>0?g:NaN},u.getBufferLength=function(n){var g=this.hls.media,h=n===A.CMCDObjectType.AUDIO?this.audioBuffer:this.videoBuffer;if(!h||!g)return NaN;var r=b.BufferHelper.bufferInfo(h,g.currentTime,this.config.maxBufferHole);return r.len*1e3},u.createPlaylistLoader=function(){var n=this.config.pLoader,g=this.applyPlaylistData,h=n||this.config.loader;return function(){function r(p){this.loader=void 0,this.loader=new h(p)}var l=r.prototype;return l.destroy=function(){this.loader.destroy()},l.abort=function(){this.loader.abort()},l.load=function(i,a,t){g(i),this.loader.load(i,a,t)},P(r,[{key:"stats",get:function(){return this.loader.stats}},{key:"context",get:function(){return this.loader.context}}]),r}()},u.createFragmentLoader=function(){var n=this.config.fLoader,g=this.applyFragmentData,h=n||this.config.loader;return function(){function r(p){this.loader=void 0,this.loader=new h(p)}var l=r.prototype;return l.destroy=function(){this.loader.destroy()},l.abort=function(){this.loader.abort()},l.load=function(i,a,t){g(i),this.loader.load(i,a,t)},P(r,[{key:"stats",get:function(){return this.loader.stats}},{key:"context",get:function(){return this.loader.context}}]),r}()},o.uuid=function(){var n=URL.createObjectURL(new Blob),g=n.toString();return URL.revokeObjectURL(n),g.slice(g.lastIndexOf("/")+1)},o.serialize=function(n){for(var g=[],h=function(O){return!Number.isNaN(O)&&O!=null&&O!==""&&O!==!1},r=function(O){return Math.round(O)},l=function(O){return r(O/100)*100},p=function(O){return encodeURIComponent(O)},i={br:r,d:r,bl:l,dl:l,mtp:l,nor:p,rtp:l,tb:r},a=Object.keys(n||{}).sort(),t=_(a),f;!(f=t()).done;){var e=f.value,d=n[e];if(h(d)&&!(e==="v"&&d===1)&&!(e=="pr"&&d===1)){var E=i[e];E&&(d=E(d));var v=typeof d,D=void 0;e==="ot"||e==="sf"||e==="st"?D=e+"="+d:v==="boolean"?D=e:v==="number"?D=e+"="+d:D=e+"="+JSON.stringify(d),g.push(D)}}return g.join(",")},o.toHeaders=function(n){for(var g=Object.keys(n),h={},r=["Object","Request","Session","Status"],l=[{},{},{},{}],p={br:0,d:0,ot:0,tb:0,bl:1,dl:1,mtp:1,nor:1,nrr:1,su:1,cid:2,pr:2,sf:2,sid:2,st:2,v:2,bs:3,rtp:3},i=0,a=g;i<a.length;i++){var t=a[i],f=p[t]!=null?p[t]:1;l[f][t]=n[t]}for(var e=0;e<l.length;e++){var d=o.serialize(l[e]);d&&(h["CMCD-"+r[e]]=d)}return h},o.toQuery=function(n){return"CMCD="+encodeURIComponent(o.serialize(n))},o.appendQueryToUri=function(n,g){if(!g)return n;var h=n.includes("?")?"&":"?";return""+n+h+g},o}()},"./src/controller/eme-controller.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>i});var F=x("./src/events.ts"),A=x("./src/errors.ts"),b=x("./src/utils/logger.ts"),R=x("./src/utils/mediakeys-helper.ts"),k=x("./src/utils/keysystem-util.ts"),P=x("./src/utils/numeric-encoding-utils.ts"),L=x("./src/loader/level-key.ts"),S=x("./src/utils/hex.ts"),_=x("./src/utils/mp4-tools.ts"),T=x("./node_modules/eventemitter3/index.js"),c=x.n(T);function y(a,t){a.prototype=Object.create(t.prototype),a.prototype.constructor=a,n(a,t)}function m(a){var t=typeof Map=="function"?new Map:void 0;return m=function(e){if(e===null||!s(e))return e;if(typeof e!="function")throw new TypeError("Super expression must either be null or a function");if(typeof t<"u"){if(t.has(e))return t.get(e);t.set(e,d)}function d(){return o(e,arguments,g(this).constructor)}return d.prototype=Object.create(e.prototype,{constructor:{value:d,enumerable:!1,writable:!0,configurable:!0}}),n(d,e)},m(a)}function o(a,t,f){return u()?o=Reflect.construct.bind():o=function(d,E,v){var D=[null];D.push.apply(D,E);var I=Function.bind.apply(d,D),O=new I;return v&&n(O,v.prototype),O},o.apply(null,arguments)}function u(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function s(a){return Function.toString.call(a).indexOf("[native code]")!==-1}function n(a,t){return n=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,d){return e.__proto__=d,e},n(a,t)}function g(a){return g=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(f){return f.__proto__||Object.getPrototypeOf(f)},g(a)}var h=3,r="[eme]",l=function(){function a(f){this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.setMediaKeysQueue=a.CDMCleanupPromise?[a.CDMCleanupPromise]:[],this.onMediaEncrypted=this._onMediaEncrypted.bind(this),this.onWaitingForKey=this._onWaitingForKey.bind(this),this.debug=b.logger.debug.bind(b.logger,r),this.log=b.logger.log.bind(b.logger,r),this.warn=b.logger.warn.bind(b.logger,r),this.error=b.logger.error.bind(b.logger,r),this.hls=f,this.config=f.config,this.registerListeners()}var t=a.prototype;return t.destroy=function(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.onMediaEncrypted=this.onWaitingForKey=this.keyIdToKeySessionPromise=null},t.registerListeners=function(){this.hls.on(F.Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(F.Events.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(F.Events.MANIFEST_LOADED,this.onManifestLoaded,this)},t.unregisterListeners=function(){this.hls.off(F.Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(F.Events.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(F.Events.MANIFEST_LOADED,this.onManifestLoaded,this)},t.getLicenseServerUrl=function(e){var d=this.config,E=d.drmSystems,v=d.widevineLicenseUrl,D=E[e];if(D)return D.licenseUrl;if(e===R.KeySystems.WIDEVINE&&v)return v;throw new Error('no license server URL configured for key-system "'+e+'"')},t.getServerCertificateUrl=function(e){var d=this.config.drmSystems,E=d[e];if(E)return E.serverCertificateUrl;this.log('No Server Certificate in config.drmSystems["'+e+'"]')},t.attemptKeySystemAccess=function(e){var d=this,E=this.hls.levels,v=function(C,M,U){return!!C&&U.indexOf(C)===M},D=E.map(function(O){return O.audioCodec}).filter(v),I=E.map(function(O){return O.videoCodec}).filter(v);return D.length+I.length===0&&I.push("avc1.42e01e"),new Promise(function(O,C){var M=function U(w){var N=w.shift();d.getMediaKeysPromise(N,D,I).then(function(K){return O({keySystem:N,mediaKeys:K})}).catch(function(K){w.length?U(w):K instanceof p?C(K):C(new p({type:A.ErrorTypes.KEY_SYSTEM_ERROR,details:A.ErrorDetails.KEY_SYSTEM_NO_ACCESS,error:K,fatal:!0},K.message))})};M(e)})},t.requestMediaKeySystemAccess=function(e,d){var E=this.config.requestMediaKeySystemAccessFunc;if(typeof E!="function"){var v="Configured requestMediaKeySystemAccess is not a function "+E;return R.requestMediaKeySystemAccess===null&&self.location.protocol==="http:"&&(v="navigator.requestMediaKeySystemAccess is not available over insecure protocol "+location.protocol),Promise.reject(new Error(v))}return E(e,d)},t.getMediaKeysPromise=function(e,d,E){var v=this,D=(0,R.getSupportedMediaKeySystemConfigurations)(e,d,E,this.config.drmSystemOptions),I=this.keySystemAccessPromises[e],O=I==null?void 0:I.keySystemAccess;if(!O){this.log('Requesting encrypted media "'+e+'" key-system access with config: '+JSON.stringify(D)),O=this.requestMediaKeySystemAccess(e,D);var C=this.keySystemAccessPromises[e]={keySystemAccess:O};return O.catch(function(M){v.log('Failed to obtain access to key-system "'+e+'": '+M)}),O.then(function(M){v.log('Access for key-system "'+M.keySystem+'" obtained');var U=v.fetchServerCertificate(e);return v.log('Create media-keys for "'+e+'"'),C.mediaKeys=M.createMediaKeys().then(function(w){return v.log('Media-keys created for "'+e+'"'),U.then(function(N){return N?v.setMediaKeysServerCertificate(w,e,N):w})}),C.mediaKeys.catch(function(w){v.error('Failed to create media-keys for "'+e+'"}: '+w)}),C.mediaKeys})}return O.then(function(){return I.mediaKeys})},t.createMediaKeySessionContext=function(e){var d=e.decryptdata,E=e.keySystem,v=e.mediaKeys;console.assert(!!v,"mediaKeys is defined"),this.log('Creating key-system session "'+E+'" keyId: '+S.default.hexDump(d.keyId||[]));var D=v.createSession(),I={decryptdata:d,keySystem:E,mediaKeys:v,mediaKeysSession:D,keyStatus:"status-pending"};return this.mediaKeySessions.push(I),I},t.renewKeySession=function(e){var d=e.decryptdata;if(d.pssh){var E=this.createMediaKeySessionContext(e),v=this.getKeyIdString(d),D="cenc";this.keyIdToKeySessionPromise[v]=this.generateRequestWithPreferredKeySession(E,D,d.pssh,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e)},t.getKeyIdString=function(e){if(!e)throw new Error("Could not read keyId of undefined decryptdata");if(e.keyId===null)throw new Error("keyId is null");return S.default.hexDump(e.keyId)},t.updateKeySession=function(e,d){var E,v=e.mediaKeysSession;return this.log('Updating key-session "'+v.sessionId+'" for keyID '+S.default.hexDump(((E=e.decryptdata)===null||E===void 0?void 0:E.keyId)||[])+`
      } (data length: `+(d&&d.byteLength)+")"),v.update(d)},t.selectKeySystemFormat=function(e){var d=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log("Selecting key-system from fragment (sn: "+e.sn+" "+e.type+": "+e.level+") key formats "+d.join(", ")),this.keyFormatPromise=this.getKeyFormatPromise(d)),this.keyFormatPromise},t.getKeyFormatPromise=function(e){var d=this;return new Promise(function(E,v){var D=(0,R.getKeySystemsForConfig)(d.config),I=e.map(R.keySystemFormatToKeySystemDomain).filter(function(O){return!!O&&D.indexOf(O)!==-1});return d.getKeySystemSelectionPromise(I).then(function(O){var C=O.keySystem,M=(0,R.keySystemDomainToKeySystemFormat)(C);M?E(M):v(new Error('Unable to find format for key-system "'+C+'"'))}).catch(v)})},t.loadKey=function(e){var d=this,E=e.keyInfo.decryptdata,v=this.getKeyIdString(E),D="(keyId: "+v+' format: "'+E.keyFormat+'" method: '+E.method+" uri: "+E.uri+")";this.log("Starting session for key "+D);var I=this.keyIdToKeySessionPromise[v];return I||(I=this.keyIdToKeySessionPromise[v]=this.getKeySystemForKeyPromise(E).then(function(O){var C=O.keySystem,M=O.mediaKeys;return d.throwIfDestroyed(),d.log("Handle encrypted media sn: "+e.frag.sn+" "+e.frag.type+": "+e.frag.level+" using key "+D),d.attemptSetMediaKeys(C,M).then(function(){d.throwIfDestroyed();var U=d.createMediaKeySessionContext({keySystem:C,mediaKeys:M,decryptdata:E}),w="cenc";return d.generateRequestWithPreferredKeySession(U,w,E.pssh,"playlist-key")})}),I.catch(function(O){return d.handleError(O)})),I},t.throwIfDestroyed=function(e){if(!this.hls)throw new Error("invalid state")},t.handleError=function(e){this.hls&&(this.error(e.message),e instanceof p?this.hls.trigger(F.Events.ERROR,e.data):this.hls.trigger(F.Events.ERROR,{type:A.ErrorTypes.KEY_SYSTEM_ERROR,details:A.ErrorDetails.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0}))},t.getKeySystemForKeyPromise=function(e){var d=this.getKeyIdString(e),E=this.keyIdToKeySessionPromise[d];if(!E){var v=(0,R.keySystemFormatToKeySystemDomain)(e.keyFormat),D=v?[v]:(0,R.getKeySystemsForConfig)(this.config);return this.attemptKeySystemAccess(D)}return E},t.getKeySystemSelectionPromise=function(e){if(e.length||(e=(0,R.getKeySystemsForConfig)(this.config)),e.length===0)throw new p({type:A.ErrorTypes.KEY_SYSTEM_ERROR,details:A.ErrorDetails.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},"Missing key-system license configuration options "+JSON.stringify({drmSystems:this.config.drmSystems}));return this.attemptKeySystemAccess(e)},t._onMediaEncrypted=function(e){var d=this,E=e.initDataType,v=e.initData;if(this.debug('"'+e.type+'" event: init data type: "'+E+'"'),v!==null){var D,I;if(E==="sinf"&&this.config.drmSystems[R.KeySystems.FAIRPLAY]){var O=(0,_.bin2str)(new Uint8Array(v));try{var C=(0,P.base64Decode)(JSON.parse(O).sinf),M=(0,_.parseSinf)(new Uint8Array(C));if(!M)return;D=M.subarray(8,24),I=R.KeySystems.FAIRPLAY}catch{this.warn('Failed to parse sinf "encrypted" event message initData');return}}else{var U=(0,_.parsePssh)(v);if(U===null)return;U.version===0&&U.systemId===R.KeySystemIds.WIDEVINE&&U.data&&(D=U.data.subarray(8,24)),I=(0,R.keySystemIdToKeySystemDomain)(U.systemId)}if(!(!I||!D)){for(var w=S.default.hexDump(D),N=this.keyIdToKeySessionPromise,K=this.mediaKeySessions,W=N[w],G=function(z){var $=K[z],Q=$.decryptdata;if(Q.pssh||!Q.keyId)return"continue";var X=S.default.hexDump(Q.keyId);if(w===X||Q.uri.replace(/-/g,"").indexOf(w)!==-1)return W=N[X],delete N[X],Q.pssh=new Uint8Array(v),Q.keyId=D,W=N[w]=W.then(function(){return d.generateRequestWithPreferredKeySession($,E,v,"encrypted-event-key-match")}),"break"},j=0;j<K.length;j++){var H=G(j);if(H!=="continue"&&H==="break")break}W||(W=N[w]=this.getKeySystemSelectionPromise([I]).then(function(V){var z,$=V.keySystem,Q=V.mediaKeys;d.throwIfDestroyed();var X=new L.LevelKey("ISO-23001-7",w,(z=(0,R.keySystemDomainToKeySystemFormat)($))!=null?z:"");return X.pssh=new Uint8Array(v),X.keyId=D,d.attemptSetMediaKeys($,Q).then(function(){d.throwIfDestroyed();var Z=d.createMediaKeySessionContext({decryptdata:X,keySystem:$,mediaKeys:Q});return d.generateRequestWithPreferredKeySession(Z,E,v,"encrypted-event-no-match")})})),W.catch(function(V){return d.handleError(V)})}}},t._onWaitingForKey=function(e){this.log('"'+e.type+'" event')},t.attemptSetMediaKeys=function(e,d){var E=this,v=this.setMediaKeysQueue.slice();this.log('Setting media-keys for "'+e+'"');var D=Promise.all(v).then(function(){if(!E.media)throw new Error("Attempted to set mediaKeys without media element attached");return E.media.setMediaKeys(d)});return this.setMediaKeysQueue.push(D),D.then(function(){E.log('Media-keys set for "'+e+'"'),v.push(D),E.setMediaKeysQueue=E.setMediaKeysQueue.filter(function(I){return v.indexOf(I)===-1})})},t.generateRequestWithPreferredKeySession=function(e,d,E,v){var D,I,O=this,C=(D=this.config.drmSystems)===null||D===void 0||(I=D[e.keySystem])===null||I===void 0?void 0:I.generateRequest;if(C)try{var M=C.call(this.hls,d,E,e);if(!M)throw new Error("Invalid response from configured generateRequest filter");d=M.initDataType,E=e.decryptdata.pssh=M.initData?new Uint8Array(M.initData):null}catch(W){var U;if(this.warn(W.message),(U=this.hls)!==null&&U!==void 0&&U.config.debug)throw W}if(E===null)return this.log('Skipping key-session request for "'+v+'" (no initData)'),Promise.resolve(e);var w=this.getKeyIdString(e.decryptdata);this.log('Generating key-session request for "'+v+'": '+w+" (init data type: "+d+" length: "+(E?E.byteLength:null)+")");var N=new(c());e.mediaKeysSession.onmessage=function(W){var G=e.mediaKeysSession;if(!G){N.emit("error",new Error("invalid state"));return}var j=W.messageType,H=W.message;O.log('"'+j+'" message event for session "'+G.sessionId+'" message size: '+H.byteLength),j==="license-request"||j==="license-renewal"?O.renewLicense(e,H).catch(function(V){O.handleError(V),N.emit("error",V)}):j==="license-release"?e.keySystem===R.KeySystems.FAIRPLAY&&(O.updateKeySession(e,(0,k.strToUtf8array)("acknowledged")),O.removeSession(e)):O.warn('unhandled media key message type "'+j+'"')},e.mediaKeysSession.onkeystatuseschange=function(W){var G=e.mediaKeysSession;if(!G){N.emit("error",new Error("invalid state"));return}O.onKeyStatusChange(e);var j=e.keyStatus;N.emit("keyStatus",j),j==="expired"&&(O.warn(e.keySystem+" expired for key "+w),O.renewKeySession(e))};var K=new Promise(function(W,G){N.on("error",G),N.on("keyStatus",function(j){j.startsWith("usable")?W():j==="output-restricted"?G(new p({type:A.ErrorTypes.KEY_SYSTEM_ERROR,details:A.ErrorDetails.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):j==="internal-error"?G(new p({type:A.ErrorTypes.KEY_SYSTEM_ERROR,details:A.ErrorDetails.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},'key status changed to "'+j+'"')):j==="expired"?G(new Error("key expired while generating request")):O.warn('unhandled key status change "'+j+'"')})});return e.mediaKeysSession.generateRequest(d,E).then(function(){var W;O.log('Request generated for key-session "'+((W=e.mediaKeysSession)===null||W===void 0?void 0:W.sessionId)+'" keyId: '+w)}).catch(function(W){throw new p({type:A.ErrorTypes.KEY_SYSTEM_ERROR,details:A.ErrorDetails.KEY_SYSTEM_NO_SESSION,error:W,fatal:!1},"Error generating key-session request: "+W)}).then(function(){return K}).catch(function(W){throw N.removeAllListeners(),O.removeSession(e),W}).then(function(){return N.removeAllListeners(),e})},t.onKeyStatusChange=function(e){var d=this;e.mediaKeysSession.keyStatuses.forEach(function(E,v){d.log('key status change "'+E+'" for keyStatuses keyId: '+S.default.hexDump("buffer"in v?new Uint8Array(v.buffer,v.byteOffset,v.byteLength):new Uint8Array(v))+" session keyId: "+S.default.hexDump(new Uint8Array(e.decryptdata.keyId||[]))+" uri: "+e.decryptdata.uri),e.keyStatus=E})},t.fetchServerCertificate=function(e){var d=this;return new Promise(function(E,v){var D=d.getServerCertificateUrl(e);if(!D)return E();d.log('Fetching serverCertificate for "'+e+'"');var I=new XMLHttpRequest;I.open("GET",D,!0),I.responseType="arraybuffer",I.onreadystatechange=function(){I.readyState===XMLHttpRequest.DONE&&(I.status===200?E(I.response):v(new p({type:A.ErrorTypes.KEY_SYSTEM_ERROR,details:A.ErrorDetails.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:I},'"'+e+'" certificate request XHR failed ('+D+"). Status: "+I.status+" ("+I.statusText+")")))},I.send()})},t.setMediaKeysServerCertificate=function(e,d,E){var v=this;return new Promise(function(D,I){e.setServerCertificate(E).then(function(O){v.log("setServerCertificate "+(O?"success":"not supported by CDM")+" ("+(E==null?void 0:E.byteLength)+') on "'+d+'"'),D(e)}).catch(function(O){I(new p({type:A.ErrorTypes.KEY_SYSTEM_ERROR,details:A.ErrorDetails.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:O,fatal:!0},O.message))})})},t.renewLicense=function(e,d){var E=this;return this.requestLicense(e,new Uint8Array(d)).then(function(v){return E.updateKeySession(e,new Uint8Array(v)).catch(function(D){throw new p({type:A.ErrorTypes.KEY_SYSTEM_ERROR,details:A.ErrorDetails.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:D,fatal:!0},D.message)})})},t.setupLicenseXHR=function(e,d,E,v){var D=this,I=this.config.licenseXhrSetup;return I?Promise.resolve().then(function(){if(!E.decryptdata)throw new Error("Key removed");return I.call(D.hls,e,d,E,v)}).catch(function(O){if(!E.decryptdata)throw O;return e.open("POST",d,!0),I.call(D.hls,e,d,E,v)}).then(function(O){e.readyState||e.open("POST",d,!0);var C=O||v;return{xhr:e,licenseChallenge:C}}):(e.open("POST",d,!0),Promise.resolve({xhr:e,licenseChallenge:v}))},t.requestLicense=function(e,d){var E=this;return new Promise(function(v,D){var I=E.getLicenseServerUrl(e.keySystem);E.log("Sending license request to URL: "+I);var O=new XMLHttpRequest;O.responseType="arraybuffer",O.onreadystatechange=function(){if(!E.hls||!e.mediaKeysSession)return D(new Error("invalid state"));if(O.readyState===4)if(O.status===200){E._requestLicenseFailureCount=0;var C=O.response;E.log("License received "+(C instanceof ArrayBuffer?C.byteLength:C));var M=E.config.licenseResponseCallback;if(M)try{C=M.call(E.hls,O,I,e)}catch(w){E.error(w)}v(C)}else if(E._requestLicenseFailureCount++,E._requestLicenseFailureCount>h||O.status>=400&&O.status<500)D(new p({type:A.ErrorTypes.KEY_SYSTEM_ERROR,details:A.ErrorDetails.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:O},"License Request XHR failed ("+I+"). Status: "+O.status+" ("+O.statusText+")"));else{var U=h-E._requestLicenseFailureCount+1;E.warn("Retrying license request, "+U+" attempts left"),E.requestLicense(e,d).then(v,D)}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=O,E.setupLicenseXHR(O,I,e,d).then(function(C){var M=C.xhr,U=C.licenseChallenge;M.send(U)})})},t.onMediaAttached=function(e,d){if(this.config.emeEnabled){var E=d.media;this.media=E,E.addEventListener("encrypted",this.onMediaEncrypted),E.addEventListener("waitingforkey",this.onWaitingForKey)}},t.onMediaDetached=function(){var e=this,d=this.media,E=this.mediaKeySessions;d&&(d.removeEventListener("encrypted",this.onMediaEncrypted),d.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null),this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},L.LevelKey.clearKeyUriToKeyIdMap();var v=E.length;a.CDMCleanupPromise=Promise.all(E.map(function(D){return e.removeSession(D)}).concat(d==null?void 0:d.setMediaKeys(null).catch(function(D){e.log("Could not clear media keys: "+D+". media.src: "+(d==null?void 0:d.src))}))).then(function(){v&&(e.log("finished closing key sessions and clearing media keys"),E.length=0)}).catch(function(D){e.log("Could not close sessions and clear media keys: "+D+". media.src: "+(d==null?void 0:d.src))})},t.onManifestLoaded=function(e,d){var E=d.sessionKeys;if(!(!E||!this.config.emeEnabled)&&!this.keyFormatPromise){var v=E.reduce(function(D,I){return D.indexOf(I.keyFormat)===-1&&D.push(I.keyFormat),D},[]);this.log("Selecting key-system from session-keys "+v.join(", ")),this.keyFormatPromise=this.getKeyFormatPromise(v)}},t.removeSession=function(e){var d=this,E=e.mediaKeysSession,v=e.licenseXhr;if(E){this.log("Remove licenses and keys and close session "+E.sessionId),E.onmessage=null,E.onkeystatuseschange=null,v&&v.readyState!==XMLHttpRequest.DONE&&v.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;var D=this.mediaKeySessions.indexOf(e);return D>-1&&this.mediaKeySessions.splice(D,1),E.remove().catch(function(I){d.log("Could not remove session: "+I)}).then(function(){return E.close()}).catch(function(I){d.log("Could not close session: "+I)})}},a}();l.CDMCleanupPromise=void 0;var p=function(a){y(t,a);function t(f,e){var d;return d=a.call(this,e)||this,d.data=void 0,d.data=f,f.err=f.error,d}return t}(m(Error));const i=l},"./src/controller/fps-controller.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>R});var F=x("./src/events.ts"),A=x("./src/utils/logger.ts"),b=function(){function k(L){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=L,this.registerListeners()}var P=k.prototype;return P.setStreamController=function(S){this.streamController=S},P.registerListeners=function(){this.hls.on(F.Events.MEDIA_ATTACHING,this.onMediaAttaching,this)},P.unregisterListeners=function(){this.hls.off(F.Events.MEDIA_ATTACHING,this.onMediaAttaching)},P.destroy=function(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null},P.onMediaAttaching=function(S,_){var T=this.hls.config;if(T.capLevelOnFPSDrop){var c=_.media instanceof self.HTMLVideoElement?_.media:null;this.media=c,c&&typeof c.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),T.fpsDroppedMonitoringPeriod)}},P.checkFPS=function(S,_,T){var c=performance.now();if(_){if(this.lastTime){var y=c-this.lastTime,m=T-this.lastDroppedFrames,o=_-this.lastDecodedFrames,u=1e3*m/y,s=this.hls;if(s.trigger(F.Events.FPS_DROP,{currentDropped:m,currentDecoded:o,totalDroppedFrames:T}),u>0&&m>s.config.fpsDroppedMonitoringThreshold*o){var n=s.currentLevel;A.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+n),n>0&&(s.autoLevelCapping===-1||s.autoLevelCapping>=n)&&(n=n-1,s.trigger(F.Events.FPS_DROP_LEVEL_CAPPING,{level:n,droppedLevel:s.currentLevel}),s.autoLevelCapping=n,this.streamController.nextLevelSwitch())}}this.lastTime=c,this.lastDroppedFrames=T,this.lastDecodedFrames=_}},P.checkFPSInterval=function(){var S=this.media;if(S)if(this.isVideoPlaybackQualityAvailable){var _=S.getVideoPlaybackQuality();this.checkFPS(S,_.totalVideoFrames,_.droppedVideoFrames)}else this.checkFPS(S,S.webkitDecodedFrameCount,S.webkitDroppedFrameCount)},k}();const R=b},"./src/controller/fragment-finders.ts":(Y,B,x)=>{x.r(B),x.d(B,{findFragWithCC:()=>L,findFragmentByPDT:()=>b,findFragmentByPTS:()=>R,fragmentWithinToleranceTest:()=>k,pdtWithinToleranceTest:()=>P});var F=x("./src/polyfills/number.ts"),A=x("./src/utils/binary-search.ts");function b(S,_,T){if(_===null||!Array.isArray(S)||!S.length||!(0,F.isFiniteNumber)(_))return null;var c=S[0].programDateTime;if(_<(c||0))return null;var y=S[S.length-1].endProgramDateTime;if(_>=(y||0))return null;T=T||0;for(var m=0;m<S.length;++m){var o=S[m];if(P(_,T,o))return o}return null}function R(S,_,T,c){T===void 0&&(T=0),c===void 0&&(c=0);var y=null;if(S?y=_[S.sn-_[0].sn+1]||null:T===0&&_[0].start===0&&(y=_[0]),y&&k(T,c,y)===0)return y;var m=A.default.search(_,k.bind(null,T,c));return m&&(m!==S||!y)?m:y}function k(S,_,T){if(S===void 0&&(S=0),_===void 0&&(_=0),T.start<=S&&T.start+T.duration>S)return 0;var c=Math.min(_,T.duration+(T.deltaPTS?T.deltaPTS:0));return T.start+T.duration-c<=S?1:T.start-c>S&&T.start?-1:0}function P(S,_,T){var c=Math.min(_,T.duration+(T.deltaPTS?T.deltaPTS:0))*1e3,y=T.endProgramDateTime||0;return y-c>S}function L(S,_){return A.default.search(S,function(T){return T.cc<_?1:T.cc>_?-1:0})}},"./src/controller/fragment-tracker.ts":(Y,B,x)=>{x.r(B),x.d(B,{FragmentState:()=>b,FragmentTracker:()=>R});var F=x("./src/events.ts"),A=x("./src/types/loader.ts"),b;(function(L){L.NOT_LOADED="NOT_LOADED",L.APPENDING="APPENDING",L.PARTIAL="PARTIAL",L.OK="OK"})(b||(b={}));var R=function(){function L(_){this.activeFragment=null,this.activeParts=null,this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hls=_,this._registerListeners()}var S=L.prototype;return S._registerListeners=function(){var T=this.hls;T.on(F.Events.BUFFER_APPENDED,this.onBufferAppended,this),T.on(F.Events.FRAG_BUFFERED,this.onFragBuffered,this),T.on(F.Events.FRAG_LOADED,this.onFragLoaded,this)},S._unregisterListeners=function(){var T=this.hls;T.off(F.Events.BUFFER_APPENDED,this.onBufferAppended,this),T.off(F.Events.FRAG_BUFFERED,this.onFragBuffered,this),T.off(F.Events.FRAG_LOADED,this.onFragLoaded,this)},S.destroy=function(){this._unregisterListeners(),this.fragments=this.endListFragments=this.timeRanges=this.activeFragment=this.activeParts=null},S.getAppendedFrag=function(T,c){if(c===A.PlaylistLevelType.MAIN){var y=this.activeFragment,m=this.activeParts;if(!y)return null;if(m)for(var o=m.length;o--;){var u=m[o],s=u?u.end:y.appendedPTS;if(u.start<=T&&s!==void 0&&T<=s)return o>9&&(this.activeParts=m.slice(o-9)),u}else if(y.start<=T&&y.appendedPTS!==void 0&&T<=y.appendedPTS)return y}return this.getBufferedFrag(T,c)},S.getBufferedFrag=function(T,c){for(var y=this.fragments,m=Object.keys(y),o=m.length;o--;){var u=y[m[o]];if((u==null?void 0:u.body.type)===c&&u.buffered){var s=u.body;if(s.start<=T&&T<=s.end)return s}}return null},S.detectEvictedFragments=function(T,c,y){var m=this;this.timeRanges&&(this.timeRanges[T]=c),Object.keys(this.fragments).forEach(function(o){var u=m.fragments[o];if(u){if(!u.buffered&&!u.loaded){u.body.type===y&&m.removeFragment(u.body);return}var s=u.range[T];s&&s.time.some(function(n){var g=!m.isTimeBuffered(n.startPTS,n.endPTS,c);return g&&m.removeFragment(u.body),g})}})},S.detectPartialFragments=function(T){var c=this,y=this.timeRanges,m=T.frag,o=T.part;if(!(!y||m.sn==="initSegment")){var u=P(m),s=this.fragments[u];s&&(Object.keys(y).forEach(function(n){var g=m.elementaryStreams[n];if(g){var h=y[n],r=o!==null||g.partial===!0;s.range[n]=c.getBufferedTimes(m,o,r,h)}}),s.loaded=null,Object.keys(s.range).length?(s.buffered=!0,s.body.endList&&(this.endListFragments[s.body.type]=s)):this.removeFragment(s.body))}},S.fragBuffered=function(T){var c=P(T),y=this.fragments[c];y&&(y.loaded=null,y.buffered=!0)},S.getBufferedTimes=function(T,c,y,m){for(var o={time:[],partial:y},u=c?c.start:T.start,s=c?c.end:T.end,n=T.minEndPTS||s,g=T.maxStartPTS||u,h=0;h<m.length;h++){var r=m.start(h)-this.bufferPadding,l=m.end(h)+this.bufferPadding;if(g>=r&&n<=l){o.time.push({startPTS:Math.max(u,m.start(h)),endPTS:Math.min(s,m.end(h))});break}else if(u<l&&s>r)o.partial=!0,o.time.push({startPTS:Math.max(u,m.start(h)),endPTS:Math.min(s,m.end(h))});else if(s<=r)break}return o},S.getPartialFragment=function(T){var c=null,y,m,o,u=0,s=this.bufferPadding,n=this.fragments;return Object.keys(n).forEach(function(g){var h=n[g];h&&k(h)&&(m=h.body.start-s,o=h.body.end+s,T>=m&&T<=o&&(y=Math.min(T-m,o-T),u<=y&&(c=h.body,u=y)))}),c},S.isEndListAppended=function(T){var c=this.endListFragments[T];return c!==void 0&&(c.buffered||k(c))},S.getState=function(T){var c=P(T),y=this.fragments[c];return y?y.buffered?k(y)?b.PARTIAL:b.OK:b.APPENDING:b.NOT_LOADED},S.isTimeBuffered=function(T,c,y){for(var m,o,u=0;u<y.length;u++){if(m=y.start(u)-this.bufferPadding,o=y.end(u)+this.bufferPadding,T>=m&&c<=o)return!0;if(c<=m)return!1}return!1},S.onFragLoaded=function(T,c){var y=c.frag,m=c.part;if(!(y.sn==="initSegment"||y.bitrateTest||m)){var o=P(y);this.fragments[o]={body:y,loaded:c,buffered:!1,range:Object.create(null)}}},S.onBufferAppended=function(T,c){var y=this,m=c.frag,o=c.part,u=c.timeRanges;if(m.type===A.PlaylistLevelType.MAIN)if(this.activeFragment!==m&&(this.activeFragment=m,m.appendedPTS=void 0),o){var s=this.activeParts;s||(this.activeParts=s=[]),s.push(o)}else this.activeParts=null;this.timeRanges=u,Object.keys(u).forEach(function(n){var g=u[n];if(y.detectEvictedFragments(n,g),!o&&m.type===A.PlaylistLevelType.MAIN){var h=m.elementaryStreams[n];if(!h)return;for(var r=0;r<g.length;r++){var l=g.end(r);l<=h.endPTS&&l>h.startPTS?m.appendedPTS=Math.max(l,m.appendedPTS||0):m.appendedPTS=h.endPTS}}})},S.onFragBuffered=function(T,c){this.detectPartialFragments(c)},S.hasFragment=function(T){var c=P(T);return!!this.fragments[c]},S.removeFragmentsInRange=function(T,c,y){var m=this;Object.keys(this.fragments).forEach(function(o){var u=m.fragments[o];if(u&&u.buffered){var s=u.body;s.type===y&&s.start<c&&s.end>T&&m.removeFragment(s)}})},S.removeFragment=function(T){var c=P(T);T.stats.loaded=0,T.clearElementaryStreamInfo(),T.appendedPTS=void 0,delete this.fragments[c],T.endList&&delete this.endListFragments[T.type]},S.removeAllFragments=function(){this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activeFragment=null,this.activeParts=null},L}();function k(L){var S,_;return L.buffered&&(((S=L.range.video)===null||S===void 0?void 0:S.partial)||((_=L.range.audio)===null||_===void 0?void 0:_.partial))}function P(L){return L.type+"_"+L.level+"_"+L.urlId+"_"+L.sn}},"./src/controller/gap-controller.ts":(Y,B,x)=>{x.r(B),x.d(B,{MAX_START_GAP_JUMP:()=>P,SKIP_BUFFER_HOLE_STEP_SECONDS:()=>L,SKIP_BUFFER_RANGE_START:()=>S,STALL_MINIMUM_DURATION_MS:()=>k,default:()=>_});var F=x("./src/utils/buffer-helper.ts"),A=x("./src/errors.ts"),b=x("./src/events.ts"),R=x("./src/utils/logger.ts"),k=250,P=2,L=.1,S=.05,_=function(){function T(y,m,o,u){this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=y,this.media=m,this.fragmentTracker=o,this.hls=u}var c=T.prototype;return c.destroy=function(){this.media=null,this.hls=this.fragmentTracker=null},c.poll=function(m,o){var u=this.config,s=this.media,n=this.stalled;if(s!==null){var g=s.currentTime,h=s.seeking,r=this.seeking&&!h,l=!this.seeking&&h;if(this.seeking=h,g!==m){if(this.moved=!0,n!==null){if(this.stallReported){var p=self.performance.now()-n;R.logger.warn("playback not stuck anymore @"+g+", after "+Math.round(p)+"ms"),this.stallReported=!1}this.stalled=null,this.nudgeRetry=0}return}if((l||r)&&(this.stalled=null),!(s.paused&&!h||s.ended||s.playbackRate===0||!F.BufferHelper.getBuffered(s).length)){var i=F.BufferHelper.bufferInfo(s,g,0),a=i.len>0,t=i.nextStart||0;if(!(!a&&!t)){if(h){var f=i.len>P,e=!t||o&&o.start<=g||t-g>P&&!this.fragmentTracker.getPartialFragment(g);if(f||e)return;this.moved=!1}if(!this.moved&&this.stalled!==null){var d,E=Math.max(t,i.start||0)-g,v=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,D=v==null||(d=v.details)===null||d===void 0?void 0:d.live,I=D?v.details.targetduration*2:P;if(E>0&&E<=I){this._trySkipBufferHole(null);return}}var O=self.performance.now();if(n===null){this.stalled=O;return}var C=O-n;if(!(!h&&C>=k&&(this._reportStall(i),!this.media))){var M=F.BufferHelper.bufferInfo(s,g,u.maxBufferHole);this._tryFixBufferStall(M,C)}}}}},c._tryFixBufferStall=function(m,o){var u=this.config,s=this.fragmentTracker,n=this.media;if(n!==null){var g=n.currentTime,h=s.getPartialFragment(g);if(h){var r=this._trySkipBufferHole(h);if(r||!this.media)return}m.len>u.maxBufferHole&&o>u.highBufferWatchdogPeriod*1e3&&(R.logger.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}},c._reportStall=function(m){var o=this.hls,u=this.media,s=this.stallReported;!s&&u&&(this.stallReported=!0,R.logger.warn("Playback stalling at @"+u.currentTime+" due to low buffer ("+JSON.stringify(m)+")"),o.trigger(b.Events.ERROR,{type:A.ErrorTypes.MEDIA_ERROR,details:A.ErrorDetails.BUFFER_STALLED_ERROR,fatal:!1,buffer:m.len}))},c._trySkipBufferHole=function(m){var o=this.config,u=this.hls,s=this.media;if(s===null)return 0;for(var n=s.currentTime,g=0,h=F.BufferHelper.getBuffered(s),r=0;r<h.length;r++){var l=h.start(r);if(n+o.maxBufferHole>=g&&n<l){var p=Math.max(l+S,s.currentTime+L);return R.logger.warn("skipping hole, adjusting currentTime from "+n+" to "+p),this.moved=!0,this.stalled=null,s.currentTime=p,m&&u.trigger(b.Events.ERROR,{type:A.ErrorTypes.MEDIA_ERROR,details:A.ErrorDetails.BUFFER_SEEK_OVER_HOLE,fatal:!1,reason:"fragment loaded with buffer holes, seeking from "+n+" to "+p,frag:m}),p}g=h.end(r)}return 0},c._tryNudgeBuffer=function(){var m=this.config,o=this.hls,u=this.media,s=this.nudgeRetry;if(u!==null){var n=u.currentTime;if(this.nudgeRetry++,s<m.nudgeMaxRetry){var g=n+(s+1)*m.nudgeOffset;R.logger.warn("Nudging 'currentTime' from "+n+" to "+g),u.currentTime=g,o.trigger(b.Events.ERROR,{type:A.ErrorTypes.MEDIA_ERROR,details:A.ErrorDetails.BUFFER_NUDGE_ON_STALL,fatal:!1})}else R.logger.error("Playhead still not moving while enough data buffered @"+n+" after "+m.nudgeMaxRetry+" nudges"),o.trigger(b.Events.ERROR,{type:A.ErrorTypes.MEDIA_ERROR,details:A.ErrorDetails.BUFFER_STALLED_ERROR,fatal:!0})}},T}()},"./src/controller/id3-track-controller.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>m});var F=x("./src/polyfills/number.ts"),A=x("./src/events.ts"),b=x("./src/utils/texttrack-utils.ts"),R=x("./src/demux/id3.ts"),k=x("./src/loader/date-range.ts"),P=x("./src/types/demuxer.ts"),L=.25;function S(){return self.WebKitDataCue||self.VTTCue||self.TextTrackCue}var _=function(){var o=S();try{new o(0,Number.POSITIVE_INFINITY,"")}catch{return Number.MAX_VALUE}return Number.POSITIVE_INFINITY}();function T(o,u){return o.getTime()/1e3-u}function c(o){return Uint8Array.from(o.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}var y=function(){function o(s){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=s,this._registerListeners()}var u=o.prototype;return u.destroy=function(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=null},u._registerListeners=function(){var n=this.hls;n.on(A.Events.MEDIA_ATTACHED,this.onMediaAttached,this),n.on(A.Events.MEDIA_DETACHING,this.onMediaDetaching,this),n.on(A.Events.MANIFEST_LOADING,this.onManifestLoading,this),n.on(A.Events.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),n.on(A.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),n.on(A.Events.LEVEL_UPDATED,this.onLevelUpdated,this)},u._unregisterListeners=function(){var n=this.hls;n.off(A.Events.MEDIA_ATTACHED,this.onMediaAttached,this),n.off(A.Events.MEDIA_DETACHING,this.onMediaDetaching,this),n.off(A.Events.MANIFEST_LOADING,this.onManifestLoading,this),n.off(A.Events.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),n.off(A.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),n.off(A.Events.LEVEL_UPDATED,this.onLevelUpdated,this)},u.onMediaAttached=function(n,g){this.media=g.media},u.onMediaDetaching=function(){this.id3Track&&((0,b.clearCurrentCues)(this.id3Track),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={})},u.onManifestLoading=function(){this.dateRangeCuesAppended={}},u.createTrack=function(n){var g=this.getID3Track(n.textTracks);return g.mode="hidden",g},u.getID3Track=function(n){if(this.media){for(var g=0;g<n.length;g++){var h=n[g];if(h.kind==="metadata"&&h.label==="id3")return(0,b.sendAddTrackEvent)(h,this.media),h}return this.media.addTextTrack("metadata","id3")}},u.onFragParsingMetadata=function(n,g){if(this.media){var h=this.hls.config,r=h.enableEmsgMetadataCues,l=h.enableID3MetadataCues;if(!(!r&&!l)){var p=g.samples;this.id3Track||(this.id3Track=this.createTrack(this.media));for(var i=S(),a=0;a<p.length;a++){var t=p[a].type;if(!(t===P.MetadataSchema.emsg&&!r||!l)){var f=R.getID3Frames(p[a].data);if(f){var e=p[a].pts,d=e+p[a].duration;d>_&&(d=_);var E=d-e;E<=0&&(d=e+L);for(var v=0;v<f.length;v++){var D=f[v];if(!R.isTimeStampFrame(D)){this.updateId3CueEnds(e);var I=new i(e,d,"");I.value=D,t&&(I.type=t),this.id3Track.addCue(I)}}}}}}}},u.updateId3CueEnds=function(n){var g,h=(g=this.id3Track)===null||g===void 0?void 0:g.cues;if(h)for(var r=h.length;r--;){var l=h[r];l.startTime<n&&l.endTime===_&&(l.endTime=n)}},u.onBufferFlushing=function(n,g){var h=g.startOffset,r=g.endOffset,l=g.type,p=this.id3Track,i=this.hls;if(i){var a=i.config,t=a.enableEmsgMetadataCues,f=a.enableID3MetadataCues;if(p&&(t||f)){var e;l==="audio"?e=function(E){return E.type===P.MetadataSchema.audioId3&&f}:l==="video"?e=function(E){return E.type===P.MetadataSchema.emsg&&t}:e=function(E){return E.type===P.MetadataSchema.audioId3&&f||E.type===P.MetadataSchema.emsg&&t},(0,b.removeCuesInRange)(p,h,r,e)}}},u.onLevelUpdated=function(n,g){var h=this,r=g.details;if(!(!this.media||!r.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)){var l=this.dateRangeCuesAppended,p=this.id3Track,i=r.dateRanges,a=Object.keys(i);if(p)for(var t=Object.keys(l).filter(function(O){return!a.includes(O)}),f=function(C){var M=t[C];Object.keys(l[M].cues).forEach(function(U){p.removeCue(l[M].cues[U])}),delete l[M]},e=t.length;e--;)f(e);var d=r.fragments[r.fragments.length-1];if(!(a.length===0||!(0,F.isFiniteNumber)(d==null?void 0:d.programDateTime))){this.id3Track||(this.id3Track=this.createTrack(this.media));for(var E=d.programDateTime/1e3-d.start,v=S(),D=function(C){var M=a[C],U=i[M],w=l[M],N=(w==null?void 0:w.cues)||{},K=(w==null?void 0:w.durationKnown)||!1,W=T(U.startDate,E),G=_,j=U.endDate;if(j)G=T(j,E),K=!0;else if(U.endOnNext&&!K){var H=a.reduce(function(Z,J){var q=i[J];return q.class===U.class&&q.id!==J&&q.startDate>U.startDate&&Z.push(q),Z},[]).sort(function(Z,J){return Z.startDate.getTime()-J.startDate.getTime()})[0];H&&(G=T(H.startDate,E),K=!0)}for(var V=Object.keys(U.attr),z=0;z<V.length;z++){var $=V[z];if(!($===k.DateRangeAttribute.ID||$===k.DateRangeAttribute.CLASS||$===k.DateRangeAttribute.START_DATE||$===k.DateRangeAttribute.DURATION||$===k.DateRangeAttribute.END_DATE||$===k.DateRangeAttribute.END_ON_NEXT)){var Q=N[$];if(Q)K&&!w.durationKnown&&(Q.endTime=G);else{var X=U.attr[$];Q=new v(W,G,""),($===k.DateRangeAttribute.SCTE35_OUT||$===k.DateRangeAttribute.SCTE35_IN)&&(X=c(X)),Q.value={key:$,data:X},Q.type=P.MetadataSchema.dateRange,h.id3Track.addCue(Q),N[$]=Q}}}l[M]={cues:N,dateRange:U,durationKnown:K}},I=0;I<a.length;I++)D(I)}}},o}();const m=y},"./src/controller/latency-controller.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>S});var F=x("./src/errors.ts"),A=x("./src/events.ts"),b=x("./src/utils/logger.ts");function R(_,T){for(var c=0;c<T.length;c++){var y=T[c];y.enumerable=y.enumerable||!1,y.configurable=!0,"value"in y&&(y.writable=!0),Object.defineProperty(_,P(y.key),y)}}function k(_,T,c){return T&&R(_.prototype,T),Object.defineProperty(_,"prototype",{writable:!1}),_}function P(_){var T=L(_,"string");return typeof T=="symbol"?T:String(T)}function L(_,T){if(typeof _!="object"||_===null)return _;var c=_[Symbol.toPrimitive];if(c!==void 0){var y=c.call(_,T);if(typeof y!="object")return y;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(_)}var S=function(){function _(c){var y=this;this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=function(){return y.timeupdate()},this.hls=c,this.config=c.config,this.registerListeners()}var T=_.prototype;return T.destroy=function(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null},T.registerListeners=function(){this.hls.on(A.Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(A.Events.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(A.Events.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(A.Events.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(A.Events.ERROR,this.onError,this)},T.unregisterListeners=function(){this.hls.off(A.Events.MEDIA_ATTACHED,this.onMediaAttached),this.hls.off(A.Events.MEDIA_DETACHING,this.onMediaDetaching),this.hls.off(A.Events.MANIFEST_LOADING,this.onManifestLoading),this.hls.off(A.Events.LEVEL_UPDATED,this.onLevelUpdated),this.hls.off(A.Events.ERROR,this.onError)},T.onMediaAttached=function(y,m){this.media=m.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)},T.onMediaDetaching=function(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)},T.onManifestLoading=function(){this.levelDetails=null,this._latency=null,this.stallCount=0},T.onLevelUpdated=function(y,m){var o=m.details;this.levelDetails=o,o.advanced&&this.timeupdate(),!o.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)},T.onError=function(y,m){m.details===F.ErrorDetails.BUFFER_STALLED_ERROR&&(this.stallCount++,b.logger.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))},T.timeupdate=function(){var y=this.media,m=this.levelDetails;if(!(!y||!m)){this.currentTime=y.currentTime;var o=this.computeLatency();if(o!==null){this._latency=o;var u=this.config,s=u.lowLatencyMode,n=u.maxLiveSyncPlaybackRate;if(!(!s||n===1)){var g=this.targetLatency;if(g!==null){var h=o-g,r=Math.min(this.maxLatency,g+m.targetduration),l=h<r;if(m.live&&l&&h>.05&&this.forwardBufferLength>1){var p=Math.min(2,Math.max(1,n)),i=Math.round(2/(1+Math.exp(-.75*h-this.edgeStalled))*20)/20;y.playbackRate=Math.min(p,Math.max(1,i))}else y.playbackRate!==1&&y.playbackRate!==0&&(y.playbackRate=1)}}}}},T.estimateLiveEdge=function(){var y=this.levelDetails;return y===null?null:y.edge+y.age},T.computeLatency=function(){var y=this.estimateLiveEdge();return y===null?null:y-this.currentTime},k(_,[{key:"latency",get:function(){return this._latency||0}},{key:"maxLatency",get:function(){var y=this.config,m=this.levelDetails;return y.liveMaxLatencyDuration!==void 0?y.liveMaxLatencyDuration:m?y.liveMaxLatencyDurationCount*m.targetduration:0}},{key:"targetLatency",get:function(){var y=this.levelDetails;if(y===null)return null;var m=y.holdBack,o=y.partHoldBack,u=y.targetduration,s=this.config,n=s.liveSyncDuration,g=s.liveSyncDurationCount,h=s.lowLatencyMode,r=this.hls.userConfig,l=h&&o||m;(r.liveSyncDuration||r.liveSyncDurationCount||l===0)&&(l=n!==void 0?n:g*u);var p=u,i=1;return l+Math.min(this.stallCount*i,p)}},{key:"liveSyncPosition",get:function(){var y=this.estimateLiveEdge(),m=this.targetLatency,o=this.levelDetails;if(y===null||m===null||o===null)return null;var u=o.edge,s=y-m-this.edgeStalled,n=u-o.totalduration,g=u-(this.config.lowLatencyMode&&o.partTarget||o.targetduration);return Math.min(Math.max(n,s),g)}},{key:"drift",get:function(){var y=this.levelDetails;return y===null?1:y.drift}},{key:"edgeStalled",get:function(){var y=this.levelDetails;if(y===null)return 0;var m=(this.config.lowLatencyMode&&y.partTarget||y.targetduration)*3;return Math.max(y.age-m,0)}},{key:"forwardBufferLength",get:function(){var y=this.media,m=this.levelDetails;if(!y||!m)return 0;var o=y.buffered.length;return(o?y.buffered.end(o-1):m.edge)-this.currentTime}}]),_}()},"./src/controller/level-controller.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>s});var F=x("./src/types/level.ts"),A=x("./src/events.ts"),b=x("./src/errors.ts"),R=x("./src/utils/codecs.ts"),k=x("./src/controller/level-helper.ts"),P=x("./src/controller/base-playlist-controller.ts"),L=x("./src/types/loader.ts");function S(){return S=Object.assign?Object.assign.bind():function(n){for(var g=1;g<arguments.length;g++){var h=arguments[g];for(var r in h)Object.prototype.hasOwnProperty.call(h,r)&&(n[r]=h[r])}return n},S.apply(this,arguments)}function _(n,g){for(var h=0;h<g.length;h++){var r=g[h];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(n,c(r.key),r)}}function T(n,g,h){return g&&_(n.prototype,g),Object.defineProperty(n,"prototype",{writable:!1}),n}function c(n){var g=y(n,"string");return typeof g=="symbol"?g:String(g)}function y(n,g){if(typeof n!="object"||n===null)return n;var h=n[Symbol.toPrimitive];if(h!==void 0){var r=h.call(n,g);if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(n)}function m(n,g){n.prototype=Object.create(g.prototype),n.prototype.constructor=n,o(n,g)}function o(n,g){return o=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(r,l){return r.__proto__=l,r},o(n,g)}var u=/chrome|firefox/.test(navigator.userAgent.toLowerCase()),s=function(n){m(g,n);function g(r){var l;return l=n.call(this,r,"[level-controller]")||this,l._levels=[],l._firstLevel=-1,l._startLevel=void 0,l.currentLevelIndex=-1,l.manualLevelIndex=-1,l.onParsedComplete=void 0,l._registerListeners(),l}var h=g.prototype;return h._registerListeners=function(){var l=this.hls;l.on(A.Events.MANIFEST_LOADED,this.onManifestLoaded,this),l.on(A.Events.LEVEL_LOADED,this.onLevelLoaded,this),l.on(A.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),l.on(A.Events.FRAG_LOADED,this.onFragLoaded,this),l.on(A.Events.ERROR,this.onError,this)},h._unregisterListeners=function(){var l=this.hls;l.off(A.Events.MANIFEST_LOADED,this.onManifestLoaded,this),l.off(A.Events.LEVEL_LOADED,this.onLevelLoaded,this),l.off(A.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),l.off(A.Events.FRAG_LOADED,this.onFragLoaded,this),l.off(A.Events.ERROR,this.onError,this)},h.destroy=function(){this._unregisterListeners(),this.manualLevelIndex=-1,this._levels.length=0,n.prototype.destroy.call(this)},h.startLoad=function(){var l=this._levels;l.forEach(function(p){p.loadError=0}),n.prototype.startLoad.call(this)},h.onManifestLoaded=function(l,p){var i=[],a=[],t=[],f,e={},d,E=!1,v=!1,D=!1;if(p.levels.forEach(function(M){var U=M.attrs;E=E||!!(M.width&&M.height),v=v||!!M.videoCodec,D=D||!!M.audioCodec,u&&M.audioCodec&&M.audioCodec.indexOf("mp4a.40.34")!==-1&&(M.audioCodec=void 0);var w=M.bitrate+"-"+M.attrs.RESOLUTION+"-"+M.attrs.CODECS;d=e[w],d?d.url.push(M.url):(d=new F.Level(M),e[w]=d,i.push(d)),U&&(U.AUDIO&&(0,k.addGroupId)(d,"audio",U.AUDIO),U.SUBTITLES&&(0,k.addGroupId)(d,"text",U.SUBTITLES))}),(E||v)&&D&&(i=i.filter(function(M){var U=M.videoCodec,w=M.width,N=M.height;return!!U||!!(w&&N)})),i=i.filter(function(M){var U=M.audioCodec,w=M.videoCodec;return(!U||(0,R.isCodecSupportedInMp4)(U,"audio"))&&(!w||(0,R.isCodecSupportedInMp4)(w,"video"))}),p.audioTracks&&(a=p.audioTracks.filter(function(M){return!M.audioCodec||(0,R.isCodecSupportedInMp4)(M.audioCodec,"audio")}),(0,k.assignTrackIdsByGroup)(a)),p.subtitles&&(t=p.subtitles,(0,k.assignTrackIdsByGroup)(t)),i.length>0){f=i[0].bitrate,i.sort(function(M,U){return M.attrs["HDCP-LEVEL"]!==U.attrs["HDCP-LEVEL"]?(M.attrs["HDCP-LEVEL"]||"")>(U.attrs["HDCP-LEVEL"]||"")?1:-1:M.bitrate!==U.bitrate?M.bitrate-U.bitrate:M.attrs.SCORE!==U.attrs.SCORE?M.attrs.decimalFloatingPoint("SCORE")-U.attrs.decimalFloatingPoint("SCORE"):E&&M.height!==U.height?M.height-U.height:0}),this._levels=i;for(var I=0;I<i.length;I++)if(i[I].bitrate===f){this._firstLevel=I,this.log("manifest loaded, "+i.length+" level(s) found, first bitrate: "+f);break}var O=D&&!v,C={levels:i,audioTracks:a,subtitleTracks:t,sessionData:p.sessionData,sessionKeys:p.sessionKeys,firstLevel:this._firstLevel,stats:p.stats,audio:D,video:v,altAudio:!O&&a.some(function(M){return!!M.url})};this.hls.trigger(A.Events.MANIFEST_PARSED,C),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}else this.hls.trigger(A.Events.ERROR,{type:b.ErrorTypes.MEDIA_ERROR,details:b.ErrorDetails.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:p.url,reason:"no level with compatible codecs found in manifest"})},h.onError=function(l,p){var i,a;if(n.prototype.onError.call(this,l,p),!p.fatal){var t=p.context,f=this._levels[this.currentLevelIndex];if(t&&(t.type===L.PlaylistContextType.AUDIO_TRACK&&f.audioGroupIds&&t.groupId===f.audioGroupIds[f.urlId]||t.type===L.PlaylistContextType.SUBTITLE_TRACK&&f.textGroupIds&&t.groupId===f.textGroupIds[f.urlId])){this.redundantFailover(this.currentLevelIndex);return}var e=!1,d=!0,E;switch(p.details){case b.ErrorDetails.FRAG_LOAD_ERROR:case b.ErrorDetails.FRAG_LOAD_TIMEOUT:case b.ErrorDetails.KEY_LOAD_ERROR:case b.ErrorDetails.KEY_LOAD_TIMEOUT:if(p.frag){var v=p.frag.type===L.PlaylistLevelType.MAIN?p.frag.level:this.currentLevelIndex,D=this._levels[v];D?(D.fragmentError++,D.fragmentError>this.hls.config.fragLoadingMaxRetry&&(E=v)):E=v}break;case b.ErrorDetails.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{var I=f.attrs["HDCP-LEVEL"];I&&(this.hls.maxHdcpLevel=F.HdcpLevels[F.HdcpLevels.indexOf(I)-1],this.warn('Restricting playback to HDCP-LEVEL of "'+this.hls.maxHdcpLevel+'" or lower'))}case b.ErrorDetails.FRAG_PARSING_ERROR:case b.ErrorDetails.KEY_SYSTEM_NO_SESSION:E=((i=p.frag)===null||i===void 0?void 0:i.type)===L.PlaylistLevelType.MAIN?p.frag.level:this.currentLevelIndex,p.levelRetry=!1;break;case b.ErrorDetails.LEVEL_LOAD_ERROR:case b.ErrorDetails.LEVEL_LOAD_TIMEOUT:t&&(t.deliveryDirectives&&(d=!1),E=t.level),e=!0;break;case b.ErrorDetails.REMUX_ALLOC_ERROR:E=(a=p.level)!=null?a:this.currentLevelIndex,e=!0;break}E!==void 0&&this.recoverLevel(p,E,e,d)}},h.recoverLevel=function(l,p,i,a){var t=l.details,f=this._levels[p];if(f.loadError++,i){var e=this.retryLoadingOrFail(l);if(e)l.levelRetry=!0;else{this.currentLevelIndex=-1;return}}if(a){var d=f.url.length;if(d>1&&f.loadError<d)l.levelRetry=!0,this.redundantFailover(p);else if(this.manualLevelIndex===-1){for(var E=-1,v=this._levels,D=v.length;D--;){var I=(D+this.currentLevelIndex)%v.length;if(I!==this.currentLevelIndex&&v[I].loadError===0){E=I;break}}E>-1&&this.currentLevelIndex!==E?(this.warn(t+": switch to "+E),l.levelRetry=!0,this.hls.nextAutoLevel=E):l.levelRetry===!1&&(l.fatal=!0)}}},h.redundantFailover=function(l){var p=this._levels[l],i=p.url.length;if(i>1){var a=(p.urlId+1)%i;this.warn("Switching to redundant URL-id "+a),this._levels.forEach(function(t){t.urlId=a}),this.level=l}},h.onFragLoaded=function(l,p){var i=p.frag;if(i!==void 0&&i.type===L.PlaylistLevelType.MAIN){var a=this._levels[i.level];a!==void 0&&(a.fragmentError=0,a.loadError=0)}},h.onLevelLoaded=function(l,p){var i,a=p.level,t=p.details,f=this._levels[a];if(!f){var e;this.warn("Invalid level index "+a),(e=p.deliveryDirectives)!==null&&e!==void 0&&e.skip&&(t.deltaUpdateFailed=!0);return}a===this.currentLevelIndex?(f.fragmentError===0&&(f.loadError=0,this.retryCount=0),this.playlistLoaded(a,p,f.details)):(i=p.deliveryDirectives)!==null&&i!==void 0&&i.skip&&(t.deltaUpdateFailed=!0)},h.onAudioTrackSwitched=function(l,p){var i=this.hls.levels[this.currentLevelIndex];if(i&&i.audioGroupIds){for(var a=-1,t=this.hls.audioTracks[p.id].groupId,f=0;f<i.audioGroupIds.length;f++)if(i.audioGroupIds[f]===t){a=f;break}a!==i.urlId&&(i.urlId=a,this.startLoad())}},h.loadPlaylist=function(l){n.prototype.loadPlaylist.call(this);var p=this.currentLevelIndex,i=this._levels[p];if(this.canLoad&&i&&i.url.length>0){var a=i.urlId,t=i.url[a];if(l)try{t=l.addDirectives(t)}catch(f){this.warn("Could not construct new URL with HLS Delivery Directives: "+f)}this.log("Attempt loading level index "+p+((l==null?void 0:l.msn)!==void 0?" at sn "+l.msn+" part "+l.part:"")+" with URL-id "+a+" "+t),this.clearTimer(),this.hls.trigger(A.Events.LEVEL_LOADING,{url:t,level:p,id:a,deliveryDirectives:l||null})}},h.removeLevel=function(l,p){var i=function(f,e){return e!==p},a=this._levels.filter(function(t,f){return f!==l?!0:t.url.length>1&&p!==void 0?(t.url=t.url.filter(i),t.audioGroupIds&&(t.audioGroupIds=t.audioGroupIds.filter(i)),t.textGroupIds&&(t.textGroupIds=t.textGroupIds.filter(i)),t.urlId=0,!0):!1}).map(function(t,f){var e=t.details;return e!=null&&e.fragments&&e.fragments.forEach(function(d){d.level=f}),t});this._levels=a,this.hls.trigger(A.Events.LEVELS_UPDATED,{levels:a})},T(g,[{key:"levels",get:function(){return this._levels.length===0?null:this._levels}},{key:"level",get:function(){return this.currentLevelIndex},set:function(l){var p,i=this._levels;if(i.length!==0&&!(this.currentLevelIndex===l&&(p=i[l])!==null&&p!==void 0&&p.details)){if(l<0||l>=i.length){var a=l<0;if(this.hls.trigger(A.Events.ERROR,{type:b.ErrorTypes.OTHER_ERROR,details:b.ErrorDetails.LEVEL_SWITCH_ERROR,level:l,fatal:a,reason:"invalid level idx"}),a)return;l=Math.min(l,i.length-1)}this.clearTimer();var t=this.currentLevelIndex,f=i[t],e=i[l];this.log("switching to level "+l+" from "+t),this.currentLevelIndex=l;var d=S({},e,{level:l,maxBitrate:e.maxBitrate,uri:e.uri,urlId:e.urlId});delete d._urlId,this.hls.trigger(A.Events.LEVEL_SWITCHING,d);var E=e.details;if(!E||E.live){var v=this.switchParams(e.uri,f==null?void 0:f.details);this.loadPlaylist(v)}}}},{key:"manualLevel",get:function(){return this.manualLevelIndex},set:function(l){this.manualLevelIndex=l,this._startLevel===void 0&&(this._startLevel=l),l!==-1&&(this.level=l)}},{key:"firstLevel",get:function(){return this._firstLevel},set:function(l){this._firstLevel=l}},{key:"startLevel",get:function(){if(this._startLevel===void 0){var l=this.hls.config.startLevel;return l!==void 0?l:this._firstLevel}else return this._startLevel},set:function(l){this._startLevel=l}},{key:"nextLoadLevel",get:function(){return this.manualLevelIndex!==-1?this.manualLevelIndex:this.hls.nextAutoLevel},set:function(l){this.level=l,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=l)}}]),g}(P.default)},"./src/controller/level-helper.ts":(Y,B,x)=>{x.r(B),x.d(B,{addGroupId:()=>k,addSliding:()=>u,adjustSliding:()=>o,assignTrackIdsByGroup:()=>P,computeReloadInterval:()=>s,getFragmentWithSN:()=>n,getPartWith:()=>g,mapFragmentIntersection:()=>m,mapPartIntersection:()=>y,mergeDetails:()=>T,updateFragPTSDTS:()=>_,updatePTS:()=>L});var F=x("./src/polyfills/number.ts"),A=x("./src/utils/logger.ts"),b=x("./src/loader/date-range.ts");function R(){return R=Object.assign?Object.assign.bind():function(h){for(var r=1;r<arguments.length;r++){var l=arguments[r];for(var p in l)Object.prototype.hasOwnProperty.call(l,p)&&(h[p]=l[p])}return h},R.apply(this,arguments)}function k(h,r,l){switch(r){case"audio":h.audioGroupIds||(h.audioGroupIds=[]),h.audioGroupIds.push(l);break;case"text":h.textGroupIds||(h.textGroupIds=[]),h.textGroupIds.push(l);break}}function P(h){var r={};h.forEach(function(l){var p=l.groupId||"";l.id=r[p]=r[p]||0,r[p]++})}function L(h,r,l){var p=h[r],i=h[l];S(p,i)}function S(h,r){var l=r.startPTS;if((0,F.isFiniteNumber)(l)){var p=0,i;r.sn>h.sn?(p=l-h.start,i=h):(p=h.start-l,i=r),i.duration!==p&&(i.duration=p)}else if(r.sn>h.sn){var a=h.cc===r.cc;a&&h.minEndPTS?r.start=h.start+(h.minEndPTS-h.start):r.start=h.start+h.duration}else r.start=Math.max(h.start-r.duration,0)}function _(h,r,l,p,i,a){var t=p-l;t<=0&&(A.logger.warn("Fragment should have a positive duration",r),p=l+r.duration,a=i+r.duration);var f=l,e=p,d=r.startPTS,E=r.endPTS;if((0,F.isFiniteNumber)(d)){var v=Math.abs(d-l);(0,F.isFiniteNumber)(r.deltaPTS)?r.deltaPTS=Math.max(v,r.deltaPTS):r.deltaPTS=v,f=Math.max(l,d),l=Math.min(l,d),i=Math.min(i,r.startDTS),e=Math.min(p,E),p=Math.max(p,E),a=Math.max(a,r.endDTS)}r.duration=p-l;var D=l-r.start;r.start=r.startPTS=l,r.maxStartPTS=f,r.startDTS=i,r.endPTS=p,r.minEndPTS=e,r.endDTS=a;var I=r.sn;if(!h||I<h.startSN||I>h.endSN)return 0;var O,C=I-h.startSN,M=h.fragments;for(M[C]=r,O=C;O>0;O--)S(M[O],M[O-1]);for(O=C;O<M.length-1;O++)S(M[O],M[O+1]);return h.fragmentHint&&S(M[M.length-1],h.fragmentHint),h.PTSKnown=h.alignedSliding=!0,D}function T(h,r){for(var l=null,p=h.fragments,i=p.length-1;i>=0;i--){var a=p[i].initSegment;if(a){l=a;break}}h.fragmentHint&&delete h.fragmentHint.endPTS;var t=0,f;if(m(h,r,function(O,C){O.relurl&&(t=O.cc-C.cc),(0,F.isFiniteNumber)(O.startPTS)&&(0,F.isFiniteNumber)(O.endPTS)&&(C.start=C.startPTS=O.startPTS,C.startDTS=O.startDTS,C.appendedPTS=O.appendedPTS,C.maxStartPTS=O.maxStartPTS,C.endPTS=O.endPTS,C.endDTS=O.endDTS,C.minEndPTS=O.minEndPTS,C.duration=O.endPTS-O.startPTS,C.duration&&(f=C),r.PTSKnown=r.alignedSliding=!0),C.elementaryStreams=O.elementaryStreams,C.loader=O.loader,C.stats=O.stats,C.urlId=O.urlId,O.initSegment&&(C.initSegment=O.initSegment,l=O.initSegment)}),l){var e=r.fragmentHint?r.fragments.concat(r.fragmentHint):r.fragments;e.forEach(function(O){var C;(!O.initSegment||O.initSegment.relurl===((C=l)===null||C===void 0?void 0:C.relurl))&&(O.initSegment=l)})}if(r.skippedSegments)if(r.deltaUpdateFailed=r.fragments.some(function(O){return!O}),r.deltaUpdateFailed){A.logger.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(var d=r.skippedSegments;d--;)r.fragments.shift();r.startSN=r.fragments[0].sn,r.startCC=r.fragments[0].cc}else r.canSkipDateRanges&&(r.dateRanges=c(h.dateRanges,r.dateRanges,r.recentlyRemovedDateranges));var E=r.fragments;if(t){A.logger.warn("discontinuity sliding from playlist, take drift into account");for(var v=0;v<E.length;v++)E[v].cc+=t}r.skippedSegments&&(r.startCC=r.fragments[0].cc),y(h.partList,r.partList,function(O,C){C.elementaryStreams=O.elementaryStreams,C.stats=O.stats}),f?_(r,f,f.startPTS,f.endPTS,f.startDTS,f.endDTS):o(h,r),E.length&&(r.totalduration=r.edge-E[0].start),r.driftStartTime=h.driftStartTime,r.driftStart=h.driftStart;var D=r.advancedDateTime;if(r.advanced&&D){var I=r.edge;r.driftStart||(r.driftStartTime=D,r.driftStart=I),r.driftEndTime=D,r.driftEnd=I}else r.driftEndTime=h.driftEndTime,r.driftEnd=h.driftEnd,r.advancedDateTime=h.advancedDateTime}function c(h,r,l){var p=R({},h);return l&&l.forEach(function(i){delete p[i]}),Object.keys(r).forEach(function(i){var a=new b.DateRange(r[i].attr,p[i]);a.isValid?p[i]=a:A.logger.warn('Ignoring invalid Playlist Delta Update DATERANGE tag: "'+JSON.stringify(r[i].attr)+'"')}),p}function y(h,r,l){if(h&&r)for(var p=0,i=0,a=h.length;i<=a;i++){var t=h[i],f=r[i+p];t&&f&&t.index===f.index&&t.fragment.sn===f.fragment.sn?l(t,f):p--}}function m(h,r,l){for(var p=r.skippedSegments,i=Math.max(h.startSN,r.startSN)-r.startSN,a=(h.fragmentHint?1:0)+(p?r.endSN:Math.min(h.endSN,r.endSN))-r.startSN,t=r.startSN-h.startSN,f=r.fragmentHint?r.fragments.concat(r.fragmentHint):r.fragments,e=h.fragmentHint?h.fragments.concat(h.fragmentHint):h.fragments,d=i;d<=a;d++){var E=e[t+d],v=f[d];p&&!v&&d<p&&(v=r.fragments[d]=E),E&&v&&l(E,v)}}function o(h,r){var l=r.startSN+r.skippedSegments-h.startSN,p=h.fragments;l<0||l>=p.length||u(r,p[l].start)}function u(h,r){if(r){for(var l=h.fragments,p=h.skippedSegments;p<l.length;p++)l[p].start+=r;h.fragmentHint&&(h.fragmentHint.start+=r)}}function s(h,r){r===void 0&&(r=1/0);var l=1e3*h.targetduration;if(h.updated){var p=h.fragments,i=4;if(p.length&&l*i>r){var a=p[p.length-1].duration*1e3;a<l&&(l=a)}}else l/=2;return Math.round(l)}function n(h,r,l){if(!h||!h.details)return null;var p=h.details,i=p.fragments[r-p.startSN];return i||(i=p.fragmentHint,i&&i.sn===r)?i:r<p.startSN&&l&&l.sn===r?l:null}function g(h,r,l){if(!h||!h.details)return null;var p=h.details.partList;if(p)for(var i=p.length;i--;){var a=p[i];if(a.index===l&&a.fragment.sn===r)return a}return null}},"./src/controller/stream-controller.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>r});var F=x("./src/polyfills/number.ts"),A=x("./src/controller/base-stream-controller.ts"),b=x("./src/is-supported.ts"),R=x("./src/events.ts"),k=x("./src/utils/buffer-helper.ts"),P=x("./src/controller/fragment-tracker.ts"),L=x("./src/types/loader.ts"),S=x("./src/loader/fragment.ts"),_=x("./src/demux/transmuxer-interface.ts"),T=x("./src/types/transmuxer.ts"),c=x("./src/controller/gap-controller.ts"),y=x("./src/errors.ts");function m(l,p){for(var i=0;i<p.length;i++){var a=p[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(l,u(a.key),a)}}function o(l,p,i){return p&&m(l.prototype,p),Object.defineProperty(l,"prototype",{writable:!1}),l}function u(l){var p=s(l,"string");return typeof p=="symbol"?p:String(p)}function s(l,p){if(typeof l!="object"||l===null)return l;var i=l[Symbol.toPrimitive];if(i!==void 0){var a=i.call(l,p);if(typeof a!="object")return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(l)}function n(l,p){l.prototype=Object.create(p.prototype),l.prototype.constructor=l,g(l,p)}function g(l,p){return g=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(a,t){return a.__proto__=t,a},g(l,p)}var h=100,r=function(l){n(p,l);function p(a,t,f){var e;return e=l.call(this,a,t,f,"[stream-controller]")||this,e.audioCodecSwap=!1,e.gapController=null,e.level=-1,e._forceStartLoad=!1,e.altAudio=!1,e.audioOnly=!1,e.fragPlaying=null,e.onvplaying=null,e.onvseeked=null,e.fragLastKbps=0,e.couldBacktrack=!1,e.backtrackFragment=null,e.audioCodecSwitch=!1,e.videoBuffer=null,e._registerListeners(),e}var i=p.prototype;return i._registerListeners=function(){var t=this.hls;t.on(R.Events.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(R.Events.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(R.Events.MANIFEST_LOADING,this.onManifestLoading,this),t.on(R.Events.MANIFEST_PARSED,this.onManifestParsed,this),t.on(R.Events.LEVEL_LOADING,this.onLevelLoading,this),t.on(R.Events.LEVEL_LOADED,this.onLevelLoaded,this),t.on(R.Events.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),t.on(R.Events.ERROR,this.onError,this),t.on(R.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.on(R.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),t.on(R.Events.BUFFER_CREATED,this.onBufferCreated,this),t.on(R.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),t.on(R.Events.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(R.Events.FRAG_BUFFERED,this.onFragBuffered,this)},i._unregisterListeners=function(){var t=this.hls;t.off(R.Events.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(R.Events.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(R.Events.MANIFEST_LOADING,this.onManifestLoading,this),t.off(R.Events.MANIFEST_PARSED,this.onManifestParsed,this),t.off(R.Events.LEVEL_LOADED,this.onLevelLoaded,this),t.off(R.Events.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),t.off(R.Events.ERROR,this.onError,this),t.off(R.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.off(R.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),t.off(R.Events.BUFFER_CREATED,this.onBufferCreated,this),t.off(R.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),t.off(R.Events.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(R.Events.FRAG_BUFFERED,this.onFragBuffered,this)},i.onHandlerDestroying=function(){this._unregisterListeners(),this.onMediaDetaching()},i.startLoad=function(t){if(this.levels){var f=this.lastCurrentTime,e=this.hls;if(this.stopLoad(),this.setInterval(h),this.level=-1,this.fragLoadError=0,!this.startFragRequested){var d=e.startLevel;d===-1&&(e.config.testBandwidth&&this.levels.length>1?(d=0,this.bitrateTest=!0):d=e.nextAutoLevel),this.level=e.nextLoadLevel=d,this.loadedmetadata=!1}f>0&&t===-1&&(this.log("Override startPosition with lastCurrentTime @"+f.toFixed(3)),t=f),this.state=A.State.IDLE,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=t,this.tick()}else this._forceStartLoad=!0,this.state=A.State.STOPPED},i.stopLoad=function(){this._forceStartLoad=!1,l.prototype.stopLoad.call(this)},i.doTick=function(){switch(this.state){case A.State.IDLE:this.doTickIdle();break;case A.State.WAITING_LEVEL:{var t,f=this.levels,e=this.level,d=f==null||(t=f[e])===null||t===void 0?void 0:t.details;if(d&&(!d.live||this.levelLastLoaded===this.level)){if(this.waitForCdnTuneIn(d))break;this.state=A.State.IDLE;break}break}case A.State.FRAG_LOADING_WAITING_RETRY:{var E,v=self.performance.now(),D=this.retryDate;(!D||v>=D||(E=this.media)!==null&&E!==void 0&&E.seeking)&&(this.log("retryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded(this.level),this.state=A.State.IDLE)}break}this.onTickEnd()},i.onTickEnd=function(){l.prototype.onTickEnd.call(this),this.checkBuffer(),this.checkFragmentChanged()},i.doTickIdle=function(){var t=this.hls,f=this.levelLastLoaded,e=this.levels,d=this.media,E=t.config,v=t.nextLoadLevel;if(!(f===null||!d&&(this.startFragRequested||!E.startFragPrefetch))&&!(this.altAudio&&this.audioOnly)&&!(!e||!e[v])){var D=e[v],I=this.getMainFwdBufferInfo();if(I!==null){var O=this.getLevelDetails();if(O&&this._streamEnded(I,O)){var C={};this.altAudio&&(C.type="video"),this.hls.trigger(R.Events.BUFFER_EOS,C),this.state=A.State.ENDED;return}this.level=t.nextLoadLevel=v;var M=D.details;if(!M||this.state===A.State.WAITING_LEVEL||M.live&&this.levelLastLoaded!==v){this.level=v,this.state=A.State.WAITING_LEVEL;return}var U=I.len,w=this.getMaxBufferLength(D.maxBitrate);if(!(U>=w)){this.backtrackFragment&&this.backtrackFragment.start>I.end&&(this.backtrackFragment=null);var N=this.backtrackFragment?this.backtrackFragment.start:I.end,K=this.getNextFragment(N,M);if(this.couldBacktrack&&!this.fragPrevious&&K&&K.sn!=="initSegment"&&this.fragmentTracker.getState(K)!==P.FragmentState.OK){var W,G=((W=this.backtrackFragment)!=null?W:K).sn,j=G-M.startSN,H=M.fragments[j-1];H&&K.cc===H.cc&&(K=H,this.fragmentTracker.removeFragment(H))}else this.backtrackFragment&&I.len&&(this.backtrackFragment=null);if(K&&this.fragmentTracker.getState(K)===P.FragmentState.OK&&this.nextLoadPosition>N){var V=this.audioOnly&&!this.altAudio?S.ElementaryStreamTypes.AUDIO:S.ElementaryStreamTypes.VIDEO,z=(V===S.ElementaryStreamTypes.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;z&&this.afterBufferFlushed(z,V,L.PlaylistLevelType.MAIN),K=this.getNextFragment(this.nextLoadPosition,M)}K&&(K.initSegment&&!K.initSegment.data&&!this.bitrateTest&&(K=K.initSegment),this.loadFragment(K,M,N))}}}},i.loadFragment=function(t,f,e){var d,E=this.fragmentTracker.getState(t);this.fragCurrent=t,E===P.FragmentState.NOT_LOADED?t.sn==="initSegment"?this._loadInitSegment(t,f):this.bitrateTest?(this.log("Fragment "+t.sn+" of level "+t.level+" is being downloaded to test bitrate and will not be buffered"),this._loadBitrateTestFrag(t,f)):(this.startFragRequested=!0,l.prototype.loadFragment.call(this,t,f,e)):E===P.FragmentState.APPENDING?this.reduceMaxBufferLength(t.duration)&&this.fragmentTracker.removeFragment(t):((d=this.media)===null||d===void 0?void 0:d.buffered.length)===0&&this.fragmentTracker.removeAllFragments()},i.getAppendedFrag=function(t){var f=this.fragmentTracker.getAppendedFrag(t,L.PlaylistLevelType.MAIN);return f&&"fragment"in f?f.fragment:f},i.getBufferedFrag=function(t){return this.fragmentTracker.getBufferedFrag(t,L.PlaylistLevelType.MAIN)},i.followingBufferedFrag=function(t){return t?this.getBufferedFrag(t.end+.5):null},i.immediateLevelSwitch=function(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)},i.nextLevelSwitch=function(){var t=this.levels,f=this.media;if(f!=null&&f.readyState){var e,d=this.getAppendedFrag(f.currentTime);if(d&&d.start>1&&this.flushMainBuffer(0,d.start-1),!f.paused&&t){var E=this.hls.nextLoadLevel,v=t[E],D=this.fragLastKbps;D&&this.fragCurrent?e=this.fragCurrent.duration*v.maxBitrate/(1e3*D)+1:e=0}else e=0;var I=this.getBufferedFrag(f.currentTime+e);if(I){var O=this.followingBufferedFrag(I);if(O){this.abortCurrentFrag();var C=O.maxStartPTS?O.maxStartPTS:O.start,M=O.duration,U=Math.max(I.end,C+Math.min(Math.max(M-this.config.maxFragLookUpTolerance,M*.5),M*.75));this.flushMainBuffer(U,Number.POSITIVE_INFINITY)}}}},i.abortCurrentFrag=function(){var t=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,t&&t.abortRequests(),this.state){case A.State.KEY_LOADING:case A.State.FRAG_LOADING:case A.State.FRAG_LOADING_WAITING_RETRY:case A.State.PARSING:case A.State.PARSED:this.state=A.State.IDLE;break}this.nextLoadPosition=this.getLoadPosition()},i.flushMainBuffer=function(t,f){l.prototype.flushMainBuffer.call(this,t,f,this.altAudio?"video":null)},i.onMediaAttached=function(t,f){l.prototype.onMediaAttached.call(this,t,f);var e=f.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),e.addEventListener("playing",this.onvplaying),e.addEventListener("seeked",this.onvseeked),this.gapController=new c.default(this.config,e,this.fragmentTracker,this.hls)},i.onMediaDetaching=function(){var t=this.media;t&&this.onvplaying&&this.onvseeked&&(t.removeEventListener("playing",this.onvplaying),t.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),l.prototype.onMediaDetaching.call(this)},i.onMediaPlaying=function(){this.tick()},i.onMediaSeeked=function(){var t=this.media,f=t?t.currentTime:null;(0,F.isFiniteNumber)(f)&&this.log("Media seeked to "+f.toFixed(3)),this.tick()},i.onManifestLoading=function(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(R.Events.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=0,this.fragPlaying=null,this.backtrackFragment=null},i.onManifestParsed=function(t,f){var e=!1,d=!1,E;f.levels.forEach(function(v){E=v.audioCodec,E&&(E.indexOf("mp4a.40.2")!==-1&&(e=!0),E.indexOf("mp4a.40.5")!==-1&&(d=!0))}),this.audioCodecSwitch=e&&d&&!(0,b.changeTypeSupported)(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=f.levels,this.startFragRequested=!1},i.onLevelLoading=function(t,f){var e=this.levels;if(!(!e||this.state!==A.State.IDLE)){var d=e[f.level];(!d.details||d.details.live&&this.levelLastLoaded!==f.level||this.waitForCdnTuneIn(d.details))&&(this.state=A.State.WAITING_LEVEL)}},i.onLevelLoaded=function(t,f){var e,d=this.levels,E=f.level,v=f.details,D=v.totalduration;if(!d){this.warn("Levels were reset while loading level "+E);return}this.log("Level "+E+" loaded ["+v.startSN+","+v.endSN+"], cc ["+v.startCC+", "+v.endCC+"] duration:"+D);var I=this.fragCurrent;I&&(this.state===A.State.FRAG_LOADING||this.state===A.State.FRAG_LOADING_WAITING_RETRY)&&I.level!==f.level&&I.loader&&(this.state=A.State.IDLE,this.backtrackFragment=null,I.abortRequests());var O=d[E],C=0;if(v.live||(e=O.details)!==null&&e!==void 0&&e.live){if(v.fragments[0]||(v.deltaUpdateFailed=!0),v.deltaUpdateFailed)return;C=this.alignPlaylists(v,O.details)}if(O.details=v,this.levelLastLoaded=E,this.hls.trigger(R.Events.LEVEL_UPDATED,{details:v,level:E}),this.state===A.State.WAITING_LEVEL){if(this.waitForCdnTuneIn(v))return;this.state=A.State.IDLE}this.startFragRequested?v.live&&this.synchronizeToLiveEdge(v):this.setStartPosition(v,C),this.tick()},i._handleFragmentLoadProgress=function(t){var f,e=t.frag,d=t.part,E=t.payload,v=this.levels;if(!v){this.warn("Levels were reset while fragment load was in progress. Fragment "+e.sn+" of level "+e.level+" will not be buffered");return}var D=v[e.level],I=D.details;if(!I){this.warn("Dropping fragment "+e.sn+" of level "+e.level+" after level details were reset");return}var O=D.videoCodec,C=I.PTSKnown||!I.live,M=(f=e.initSegment)===null||f===void 0?void 0:f.data,U=this._getAudioCodec(D),w=this.transmuxer=this.transmuxer||new _.default(this.hls,L.PlaylistLevelType.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),N=d?d.index:-1,K=N!==-1,W=new T.ChunkMetadata(e.level,e.sn,e.stats.chunkCount,E.byteLength,N,K),G=this.initPTS[e.cc];w.push(E,M,U,O,e,d,I.totalduration,C,W,G)},i.onAudioTrackSwitching=function(t,f){var e=this.altAudio,d=!!f.url,E=f.id;if(!d){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;var v=this.fragCurrent;v&&(this.log("Switching to main audio track, cancel main fragment load"),v.abortRequests()),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();var D=this.hls;e&&D.trigger(R.Events.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:"audio"}),D.trigger(R.Events.AUDIO_TRACK_SWITCHED,{id:E})}},i.onAudioTrackSwitched=function(t,f){var e=f.id,d=!!this.hls.audioTracks[e].url;if(d){var E=this.videoBuffer;E&&this.mediaBuffer!==E&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=E)}this.altAudio=d,this.tick()},i.onBufferCreated=function(t,f){var e=f.tracks,d,E,v=!1;for(var D in e){var I=e[D];if(I.id==="main"){if(E=D,d=I,D==="video"){var O=e[D];O&&(this.videoBuffer=O.buffer)}}else v=!0}v&&d?(this.log("Alternate track found, use "+E+".buffered to schedule main fragment loading"),this.mediaBuffer=d.buffer):this.mediaBuffer=this.media},i.onFragBuffered=function(t,f){var e=f.frag,d=f.part;if(!(e&&e.type!==L.PlaylistLevelType.MAIN)){if(this.fragContextChanged(e)){this.warn("Fragment "+e.sn+(d?" p: "+d.index:"")+" of level "+e.level+" finished buffering, but was aborted. state: "+this.state),this.state===A.State.PARSED&&(this.state=A.State.IDLE);return}var E=d?d.stats:e.stats;this.fragLastKbps=Math.round(8*E.total/(E.buffering.end-E.loading.first)),e.sn!=="initSegment"&&(this.fragPrevious=e),this.fragBufferedComplete(e,d)}},i.onError=function(t,f){if(f.type===y.ErrorTypes.KEY_SYSTEM_ERROR){this.onFragmentOrKeyLoadError(L.PlaylistLevelType.MAIN,f);return}switch(f.details){case y.ErrorDetails.FRAG_LOAD_ERROR:case y.ErrorDetails.FRAG_LOAD_TIMEOUT:case y.ErrorDetails.FRAG_PARSING_ERROR:case y.ErrorDetails.KEY_LOAD_ERROR:case y.ErrorDetails.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(L.PlaylistLevelType.MAIN,f);break;case y.ErrorDetails.LEVEL_LOAD_ERROR:case y.ErrorDetails.LEVEL_LOAD_TIMEOUT:this.state!==A.State.ERROR&&(f.fatal?(this.warn(""+f.details),this.state=A.State.ERROR):!f.levelRetry&&this.state===A.State.WAITING_LEVEL&&(this.state=A.State.IDLE));break;case y.ErrorDetails.BUFFER_FULL_ERROR:if(f.parent==="main"&&(this.state===A.State.PARSING||this.state===A.State.PARSED)){var e=!0,d=this.getFwdBufferInfo(this.media,L.PlaylistLevelType.MAIN);d&&d.len>.5&&(e=!this.reduceMaxBufferLength(d.len)),e&&(this.warn("buffer full error also media.currentTime is not buffered, flush main"),this.immediateLevelSwitch()),this.resetLoadingState()}break}},i.checkBuffer=function(){var t=this.media,f=this.gapController;if(!(!t||!f||!t.readyState)){if(this.loadedmetadata||!k.BufferHelper.getBuffered(t).length){var e=this.state!==A.State.IDLE?this.fragCurrent:null;f.poll(this.lastCurrentTime,e)}this.lastCurrentTime=t.currentTime}},i.onFragLoadEmergencyAborted=function(){this.state=A.State.IDLE,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()},i.onBufferFlushed=function(t,f){var e=f.type;if(e!==S.ElementaryStreamTypes.AUDIO||this.audioOnly&&!this.altAudio){var d=(e===S.ElementaryStreamTypes.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(d,e,L.PlaylistLevelType.MAIN)}},i.onLevelsUpdated=function(t,f){this.levels=f.levels},i.swapAudioCodec=function(){this.audioCodecSwap=!this.audioCodecSwap},i.seekToStartPos=function(){var t=this.media;if(t){var f=t.currentTime,e=this.startPosition;if(e>=0&&f<e){if(t.seeking){this.log("could not seek to "+e+", already seeking at "+f);return}var d=k.BufferHelper.getBuffered(t),E=d.length?d.start(0):0,v=E-e;v>0&&(v<this.config.maxBufferHole||v<this.config.maxFragLookUpTolerance)&&(this.log("adjusting start position by "+v+" to match buffer start"),e+=v,this.startPosition=e),this.log("seek to target start position "+e+" from current time "+f),t.currentTime=e}}},i._getAudioCodec=function(t){var f=this.config.defaultAudioCodec||t.audioCodec;return this.audioCodecSwap&&f&&(this.log("Swapping audio codec"),f.indexOf("mp4a.40.5")!==-1?f="mp4a.40.2":f="mp4a.40.5"),f},i._loadBitrateTestFrag=function(t,f){var e=this;t.bitrateTest=!0,this._doFragLoad(t,f).then(function(d){var E=e.hls;if(!(!d||e.fragContextChanged(t))){e.fragLoadError=0,e.state=A.State.IDLE,e.startFragRequested=!1,e.bitrateTest=!1;var v=t.stats;v.parsing.start=v.parsing.end=v.buffering.start=v.buffering.end=self.performance.now(),E.trigger(R.Events.FRAG_LOADED,d),t.bitrateTest=!1}})},i._handleTransmuxComplete=function(t){var f,e="main",d=this.hls,E=t.remuxResult,v=t.chunkMeta,D=this.getCurrentContext(v);if(!D){this.warn("The loading context changed while buffering fragment "+v.sn+" of level "+v.level+". This chunk will not be buffered."),this.resetStartWhenNotLoaded(v.level);return}var I=D.frag,O=D.part,C=D.level,M=E.video,U=E.text,w=E.id3,N=E.initSegment,K=C.details,W=this.altAudio?void 0:E.audio;if(!this.fragContextChanged(I)){if(this.state=A.State.PARSING,N){N.tracks&&(this._bufferInitSegment(C,N.tracks,I,v),d.trigger(R.Events.FRAG_PARSING_INIT_SEGMENT,{frag:I,id:e,tracks:N.tracks}));var G=N.initPTS,j=N.timescale;(0,F.isFiniteNumber)(G)&&(this.initPTS[I.cc]=G,d.trigger(R.Events.INIT_PTS_FOUND,{frag:I,id:e,initPTS:G,timescale:j}))}if(M&&E.independent!==!1){if(K){var H=M.startPTS,V=M.endPTS,z=M.startDTS,$=M.endDTS;if(O)O.elementaryStreams[M.type]={startPTS:H,endPTS:V,startDTS:z,endDTS:$};else if(M.firstKeyFrame&&M.independent&&v.id===1&&(this.couldBacktrack=!0),M.dropped&&M.independent){var Q=this.getMainFwdBufferInfo(),X=(Q?Q.end:this.getLoadPosition())+this.config.maxBufferHole,Z=M.firstKeyFramePTS?M.firstKeyFramePTS:H;if(X<Z-this.config.maxBufferHole){this.backtrack(I);return}I.setElementaryStreamInfo(M.type,I.start,V,I.start,$,!0)}I.setElementaryStreamInfo(M.type,H,V,z,$),this.backtrackFragment&&(this.backtrackFragment=I),this.bufferFragmentData(M,I,O,v)}}else if(E.independent===!1){this.backtrack(I);return}if(W){var J=W.startPTS,q=W.endPTS,ae=W.startDTS,te=W.endDTS;O&&(O.elementaryStreams[S.ElementaryStreamTypes.AUDIO]={startPTS:J,endPTS:q,startDTS:ae,endDTS:te}),I.setElementaryStreamInfo(S.ElementaryStreamTypes.AUDIO,J,q,ae,te),this.bufferFragmentData(W,I,O,v)}if(K&&w!==null&&w!==void 0&&(f=w.samples)!==null&&f!==void 0&&f.length){var ne={id:e,frag:I,details:K,samples:w.samples};d.trigger(R.Events.FRAG_PARSING_METADATA,ne)}if(K&&U){var ee={id:e,frag:I,details:K,samples:U.samples};d.trigger(R.Events.FRAG_PARSING_USERDATA,ee)}}},i._bufferInitSegment=function(t,f,e,d){var E=this;if(this.state===A.State.PARSING){this.audioOnly=!!f.audio&&!f.video,this.altAudio&&!this.audioOnly&&delete f.audio;var v=f.audio,D=f.video,I=f.audiovideo;if(v){var O=t.audioCodec,C=navigator.userAgent.toLowerCase();this.audioCodecSwitch&&(O&&(O.indexOf("mp4a.40.5")!==-1?O="mp4a.40.2":O="mp4a.40.5"),v.metadata.channelCount!==1&&C.indexOf("firefox")===-1&&(O="mp4a.40.5")),C.indexOf("android")!==-1&&v.container!=="audio/mpeg"&&(O="mp4a.40.2",this.log("Android: force audio codec to "+O)),t.audioCodec&&t.audioCodec!==O&&this.log('Swapping manifest audio codec "'+t.audioCodec+'" for "'+O+'"'),v.levelCodec=O,v.id="main",this.log("Init audio buffer, container:"+v.container+", codecs[selected/level/parsed]=["+(O||"")+"/"+(t.audioCodec||"")+"/"+v.codec+"]")}D&&(D.levelCodec=t.videoCodec,D.id="main",this.log("Init video buffer, container:"+D.container+", codecs[level/parsed]=["+(t.videoCodec||"")+"/"+D.codec+"]")),I&&this.log("Init audiovideo buffer, container:"+I.container+", codecs[level/parsed]=["+(t.attrs.CODECS||"")+"/"+I.codec+"]"),this.hls.trigger(R.Events.BUFFER_CODECS,f),Object.keys(f).forEach(function(M){var U=f[M],w=U.initSegment;w!=null&&w.byteLength&&E.hls.trigger(R.Events.BUFFER_APPENDING,{type:M,data:w,frag:e,part:null,chunkMeta:d,parent:e.type})}),this.tick()}},i.getMainFwdBufferInfo=function(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,L.PlaylistLevelType.MAIN)},i.backtrack=function(t){this.couldBacktrack=!0,this.backtrackFragment=t,this.resetTransmuxer(),this.flushBufferGap(t),this.fragmentTracker.removeFragment(t),this.fragPrevious=null,this.nextLoadPosition=t.start,this.state=A.State.IDLE},i.checkFragmentChanged=function(){var t=this.media,f=null;if(t&&t.readyState>1&&t.seeking===!1){var e=t.currentTime;if(k.BufferHelper.isBuffered(t,e)?f=this.getAppendedFrag(e):k.BufferHelper.isBuffered(t,e+.1)&&(f=this.getAppendedFrag(e+.1)),f){this.backtrackFragment=null;var d=this.fragPlaying,E=f.level;(!d||f.sn!==d.sn||d.level!==E||f.urlId!==d.urlId)&&(this.fragPlaying=f,this.hls.trigger(R.Events.FRAG_CHANGED,{frag:f}),(!d||d.level!==E)&&this.hls.trigger(R.Events.LEVEL_SWITCHED,{level:E}))}}},o(p,[{key:"nextLevel",get:function(){var t=this.nextBufferedFrag;return t?t.level:-1}},{key:"currentFrag",get:function(){var t=this.media;return t?this.fragPlaying||this.getAppendedFrag(t.currentTime):null}},{key:"currentProgramDateTime",get:function(){var t=this.media;if(t){var f=t.currentTime,e=this.currentFrag;if(e&&(0,F.isFiniteNumber)(f)&&(0,F.isFiniteNumber)(e.programDateTime)){var d=e.programDateTime+(f-e.start)*1e3;return new Date(d)}}return null}},{key:"currentLevel",get:function(){var t=this.currentFrag;return t?t.level:-1}},{key:"nextBufferedFrag",get:function(){var t=this.currentFrag;return t?this.followingBufferedFrag(t):null}},{key:"forceStartLoad",get:function(){return this._forceStartLoad}}]),p}(A.default)},"./src/controller/subtitle-stream-controller.ts":(Y,B,x)=>{x.r(B),x.d(B,{SubtitleStreamController:()=>n});var F=x("./src/events.ts"),A=x("./src/utils/buffer-helper.ts"),b=x("./src/controller/fragment-finders.ts"),R=x("./src/utils/discontinuities.ts"),k=x("./src/controller/level-helper.ts"),P=x("./src/controller/fragment-tracker.ts"),L=x("./src/controller/base-stream-controller.ts"),S=x("./src/types/loader.ts"),_=x("./src/types/level.ts");function T(h,r){for(var l=0;l<r.length;l++){var p=r[l];p.enumerable=p.enumerable||!1,p.configurable=!0,"value"in p&&(p.writable=!0),Object.defineProperty(h,y(p.key),p)}}function c(h,r,l){return r&&T(h.prototype,r),Object.defineProperty(h,"prototype",{writable:!1}),h}function y(h){var r=m(h,"string");return typeof r=="symbol"?r:String(r)}function m(h,r){if(typeof h!="object"||h===null)return h;var l=h[Symbol.toPrimitive];if(l!==void 0){var p=l.call(h,r);if(typeof p!="object")return p;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(h)}function o(h,r){h.prototype=Object.create(r.prototype),h.prototype.constructor=h,u(h,r)}function u(h,r){return u=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(p,i){return p.__proto__=i,p},u(h,r)}var s=500,n=function(h){o(r,h);function r(p,i,a){var t;return t=h.call(this,p,i,a,"[subtitle-stream-controller]")||this,t.levels=[],t.currentTrackId=-1,t.tracksBuffered=[],t.mainDetails=null,t._registerListeners(),t}var l=r.prototype;return l.onHandlerDestroying=function(){this._unregisterListeners(),this.mainDetails=null},l._registerListeners=function(){var i=this.hls;i.on(F.Events.MEDIA_ATTACHED,this.onMediaAttached,this),i.on(F.Events.MEDIA_DETACHING,this.onMediaDetaching,this),i.on(F.Events.MANIFEST_LOADING,this.onManifestLoading,this),i.on(F.Events.LEVEL_LOADED,this.onLevelLoaded,this),i.on(F.Events.ERROR,this.onError,this),i.on(F.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),i.on(F.Events.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),i.on(F.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),i.on(F.Events.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),i.on(F.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),i.on(F.Events.FRAG_BUFFERED,this.onFragBuffered,this)},l._unregisterListeners=function(){var i=this.hls;i.off(F.Events.MEDIA_ATTACHED,this.onMediaAttached,this),i.off(F.Events.MEDIA_DETACHING,this.onMediaDetaching,this),i.off(F.Events.MANIFEST_LOADING,this.onManifestLoading,this),i.off(F.Events.LEVEL_LOADED,this.onLevelLoaded,this),i.off(F.Events.ERROR,this.onError,this),i.off(F.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),i.off(F.Events.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),i.off(F.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),i.off(F.Events.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),i.off(F.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),i.off(F.Events.FRAG_BUFFERED,this.onFragBuffered,this)},l.startLoad=function(i){this.stopLoad(),this.state=L.State.IDLE,this.setInterval(s),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=i,this.tick()},l.onManifestLoading=function(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()},l.onLevelLoaded=function(i,a){this.mainDetails=a.details},l.onSubtitleFragProcessed=function(i,a){var t=a.frag,f=a.success;if(this.fragPrevious=t,this.state=L.State.IDLE,!!f){var e=this.tracksBuffered[this.currentTrackId];if(e){for(var d,E=t.start,v=0;v<e.length;v++)if(E>=e[v].start&&E<=e[v].end){d=e[v];break}var D=t.start+t.duration;d?d.end=D:(d={start:E,end:D},e.push(d)),this.fragmentTracker.fragBuffered(t)}}},l.onBufferFlushing=function(i,a){var t=a.startOffset,f=a.endOffset;if(t===0&&f!==Number.POSITIVE_INFINITY){var e=this.currentTrackId,d=this.levels;if(!d.length||!d[e]||!d[e].details)return;var E=d[e].details,v=E.targetduration,D=f-v;if(D<=0)return;a.endOffsetSubtitles=Math.max(0,D),this.tracksBuffered.forEach(function(I){for(var O=0;O<I.length;){if(I[O].end<=D){I.shift();continue}else if(I[O].start<D)I[O].start=D;else break;O++}}),this.fragmentTracker.removeFragmentsInRange(t,D,S.PlaylistLevelType.SUBTITLE)}},l.onFragBuffered=function(i,a){if(!this.loadedmetadata&&a.frag.type===S.PlaylistLevelType.MAIN){var t;(t=this.media)!==null&&t!==void 0&&t.buffered.length&&(this.loadedmetadata=!0)}},l.onError=function(i,a){var t=a.frag;!t||t.type!==S.PlaylistLevelType.SUBTITLE||(this.fragCurrent&&this.fragCurrent.abortRequests(),this.state=L.State.IDLE)},l.onSubtitleTracksUpdated=function(i,a){var t=this,f=a.subtitleTracks;this.tracksBuffered=[],this.levels=f.map(function(e){return new _.Level(e)}),this.fragmentTracker.removeAllFragments(),this.fragPrevious=null,this.levels.forEach(function(e){t.tracksBuffered[e.id]=[]}),this.mediaBuffer=null},l.onSubtitleTrackSwitch=function(i,a){if(this.currentTrackId=a.id,!this.levels.length||this.currentTrackId===-1){this.clearInterval();return}var t=this.levels[this.currentTrackId];t!=null&&t.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,t&&this.setInterval(s)},l.onSubtitleTrackLoaded=function(i,a){var t,f=a.details,e=a.id,d=this.currentTrackId,E=this.levels;if(E.length){var v=E[d];if(!(e>=E.length||e!==d||!v)){this.mediaBuffer=this.mediaBufferTimeRanges;var D=0;if(f.live||(t=v.details)!==null&&t!==void 0&&t.live){var I=this.mainDetails;if(f.deltaUpdateFailed||!I)return;var O=I.fragments[0];v.details?(D=this.alignPlaylists(f,v.details),D===0&&O&&(D=O.start,(0,k.addSliding)(f,D))):f.hasProgramDateTime&&I.hasProgramDateTime?((0,R.alignMediaPlaylistByPDT)(f,I),D=f.fragments[0].start):O&&(D=O.start,(0,k.addSliding)(f,D))}if(v.details=f,this.levelLastLoaded=e,!this.startFragRequested&&(this.mainDetails||!f.live)&&this.setStartPosition(v.details,D),this.tick(),f.live&&!this.fragCurrent&&this.media&&this.state===L.State.IDLE){var C=(0,b.findFragmentByPTS)(null,f.fragments,this.media.currentTime,0);C||(this.warn("Subtitle playlist not aligned with playback"),v.details=void 0)}}}},l._handleFragmentLoadComplete=function(i){var a=this,t=i.frag,f=i.payload,e=t.decryptdata,d=this.hls;if(!this.fragContextChanged(t)&&f&&f.byteLength>0&&e&&e.key&&e.iv&&e.method==="AES-128"){var E=performance.now();this.decrypter.decrypt(new Uint8Array(f),e.key.buffer,e.iv.buffer).then(function(v){var D=performance.now();d.trigger(F.Events.FRAG_DECRYPTED,{frag:t,payload:v,stats:{tstart:E,tdecrypt:D}})}).catch(function(v){a.warn(v.name+": "+v.message),a.state=L.State.IDLE})}},l.doTick=function(){if(!this.media){this.state=L.State.IDLE;return}if(this.state===L.State.IDLE){var i=this.currentTrackId,a=this.levels;if(!a.length||!a[i]||!a[i].details)return;var t=a[i].details,f=t.targetduration,e=this.config,d=this.getLoadPosition(),E=A.BufferHelper.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],d-f,e.maxBufferHole),v=E.end,D=E.len,I=this.getFwdBufferInfo(this.media,S.PlaylistLevelType.MAIN),O=this.getMaxBufferLength(I==null?void 0:I.len)+f;if(D>O)return;console.assert(t,"Subtitle track details are defined on idle subtitle stream controller tick");var C=t.fragments,M=C.length,U=t.edge,w=null,N=this.fragPrevious;if(v<U){var K=e.maxFragLookUpTolerance;w=(0,b.findFragmentByPTS)(N,C,Math.max(C[0].start,v),K),!w&&N&&N.start<C[0].start&&(w=C[0])}else w=C[M-1];if(!w)return;w=this.mapToInitFragWhenRequired(w),this.fragmentTracker.getState(w)===P.FragmentState.NOT_LOADED&&this.loadFragment(w,t,v)}},l.getMaxBufferLength=function(i){var a=h.prototype.getMaxBufferLength.call(this);return i?Math.max(a,i):a},l.loadFragment=function(i,a,t){this.fragCurrent=i,i.sn==="initSegment"?this._loadInitSegment(i,a):(this.startFragRequested=!0,h.prototype.loadFragment.call(this,i,a,t))},c(r,[{key:"mediaBufferTimeRanges",get:function(){return new g(this.tracksBuffered[this.currentTrackId]||[])}}]),r}(L.default),g=function(r){this.buffered=void 0;var l=function(i,a,t){if(a=a>>>0,a>t-1)throw new DOMException("Failed to execute '"+i+"' on 'TimeRanges': The index provided ("+a+") is greater than the maximum bound ("+t+")");return r[a][i]};this.buffered={get length(){return r.length},end:function(i){return l("end",i,r.length)},start:function(i){return l("start",i,r.length)}}}},"./src/controller/subtitle-track-controller.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>m});var F=x("./src/events.ts"),A=x("./src/utils/texttrack-utils.ts"),b=x("./src/controller/base-playlist-controller.ts"),R=x("./src/types/loader.ts");function k(o,u){for(var s=0;s<u.length;s++){var n=u[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(o,L(n.key),n)}}function P(o,u,s){return u&&k(o.prototype,u),Object.defineProperty(o,"prototype",{writable:!1}),o}function L(o){var u=S(o,"string");return typeof u=="symbol"?u:String(u)}function S(o,u){if(typeof o!="object"||o===null)return o;var s=o[Symbol.toPrimitive];if(s!==void 0){var n=s.call(o,u);if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}function _(o,u){o.prototype=Object.create(u.prototype),o.prototype.constructor=o,T(o,u)}function T(o,u){return T=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(n,g){return n.__proto__=g,n},T(o,u)}var c=function(o){_(u,o);function u(n){var g;return g=o.call(this,n,"[subtitle-track-controller]")||this,g.media=null,g.tracks=[],g.groupId=null,g.tracksInGroup=[],g.trackId=-1,g.selectDefaultTrack=!0,g.queuedDefaultTrack=-1,g.trackChangeListener=function(){return g.onTextTracksChanged()},g.asyncPollTrackChange=function(){return g.pollTrackChange(0)},g.useTextTrackPolling=!1,g.subtitlePollingInterval=-1,g._subtitleDisplay=!0,g.registerListeners(),g}var s=u.prototype;return s.destroy=function(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.trackChangeListener=this.asyncPollTrackChange=null,o.prototype.destroy.call(this)},s.registerListeners=function(){var g=this.hls;g.on(F.Events.MEDIA_ATTACHED,this.onMediaAttached,this),g.on(F.Events.MEDIA_DETACHING,this.onMediaDetaching,this),g.on(F.Events.MANIFEST_LOADING,this.onManifestLoading,this),g.on(F.Events.MANIFEST_PARSED,this.onManifestParsed,this),g.on(F.Events.LEVEL_LOADING,this.onLevelLoading,this),g.on(F.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),g.on(F.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),g.on(F.Events.ERROR,this.onError,this)},s.unregisterListeners=function(){var g=this.hls;g.off(F.Events.MEDIA_ATTACHED,this.onMediaAttached,this),g.off(F.Events.MEDIA_DETACHING,this.onMediaDetaching,this),g.off(F.Events.MANIFEST_LOADING,this.onManifestLoading,this),g.off(F.Events.MANIFEST_PARSED,this.onManifestParsed,this),g.off(F.Events.LEVEL_LOADING,this.onLevelLoading,this),g.off(F.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),g.off(F.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),g.off(F.Events.ERROR,this.onError,this)},s.onMediaAttached=function(g,h){this.media=h.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))},s.pollTrackChange=function(g){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.trackChangeListener,g)},s.onMediaDetaching=function(){if(this.media){self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId);var g=y(this.media.textTracks);g.forEach(function(h){(0,A.clearCurrentCues)(h)}),this.subtitleTrack=-1,this.media=null}},s.onManifestLoading=function(){this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.selectDefaultTrack=!0},s.onManifestParsed=function(g,h){this.tracks=h.subtitleTracks},s.onSubtitleTrackLoaded=function(g,h){var r=h.id,l=h.details,p=this.trackId,i=this.tracksInGroup[p];if(!i){this.warn("Invalid subtitle track id "+r);return}var a=i.details;i.details=h.details,this.log("subtitle track "+r+" loaded ["+l.startSN+"-"+l.endSN+"]"),r===this.trackId&&(this.retryCount=0,this.playlistLoaded(r,h,a))},s.onLevelLoading=function(g,h){this.switchLevel(h.level)},s.onLevelSwitching=function(g,h){this.switchLevel(h.level)},s.switchLevel=function(g){var h=this.hls.levels[g];if(h!=null&&h.textGroupIds){var r=h.textGroupIds[h.urlId];if(this.groupId!==r){var l=this.tracksInGroup?this.tracksInGroup[this.trackId]:void 0,p=this.tracks.filter(function(t){return!r||t.groupId===r});this.tracksInGroup=p;var i=this.findTrackId(l==null?void 0:l.name)||this.findTrackId();this.groupId=r;var a={subtitleTracks:p};this.log("Updating subtitle tracks, "+p.length+' track(s) found in "'+r+'" group-id'),this.hls.trigger(F.Events.SUBTITLE_TRACKS_UPDATED,a),i!==-1&&this.setSubtitleTrack(i,l)}}},s.findTrackId=function(g){for(var h=this.tracksInGroup,r=0;r<h.length;r++){var l=h[r];if((!this.selectDefaultTrack||l.default)&&(!g||g===l.name))return l.id}return-1},s.onError=function(g,h){o.prototype.onError.call(this,g,h),!(h.fatal||!h.context)&&h.context.type===R.PlaylistContextType.SUBTITLE_TRACK&&h.context.id===this.trackId&&h.context.groupId===this.groupId&&this.retryLoadingOrFail(h)},s.loadPlaylist=function(g){o.prototype.loadPlaylist.call(this);var h=this.tracksInGroup[this.trackId];if(this.shouldLoadTrack(h)){var r=h.id,l=h.groupId,p=h.url;if(g)try{p=g.addDirectives(p)}catch(i){this.warn("Could not construct new URL with HLS Delivery Directives: "+i)}this.log("Loading subtitle playlist for id "+r),this.hls.trigger(F.Events.SUBTITLE_TRACK_LOADING,{url:p,id:r,groupId:l,deliveryDirectives:g||null})}},s.toggleTrackModes=function(g){var h=this,r=this.media,l=this.trackId;if(r){var p=y(r.textTracks),i=p.filter(function(f){return f.groupId===h.groupId});if(g===-1)[].slice.call(p).forEach(function(f){f.mode="disabled"});else{var a=i[l];a&&(a.mode="disabled")}var t=i[g];t&&(t.mode=this.subtitleDisplay?"showing":"hidden")}},s.setSubtitleTrack=function(g,h){var r,l=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=g;return}if(this.trackId!==g&&this.toggleTrackModes(g),!(this.trackId===g&&(g===-1||(r=l[g])!==null&&r!==void 0&&r.details)||g<-1||g>=l.length)){this.clearTimer();var p=l[g];if(this.log("Switching to subtitle track "+g),this.trackId=g,p){var i=p.id,a=p.groupId,t=a===void 0?"":a,f=p.name,e=p.type,d=p.url;this.hls.trigger(F.Events.SUBTITLE_TRACK_SWITCH,{id:i,groupId:t,name:f,type:e,url:d});var E=this.switchParams(p.url,h==null?void 0:h.details);this.loadPlaylist(E)}else this.hls.trigger(F.Events.SUBTITLE_TRACK_SWITCH,{id:g})}},s.onTextTracksChanged=function(){if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!(!this.media||!this.hls.config.renderTextTracksNatively)){for(var g=-1,h=y(this.media.textTracks),r=0;r<h.length;r++)if(h[r].mode==="hidden")g=r;else if(h[r].mode==="showing"){g=r;break}this.subtitleTrack!==g&&(this.subtitleTrack=g)}},P(u,[{key:"subtitleDisplay",get:function(){return this._subtitleDisplay},set:function(g){this._subtitleDisplay=g,this.trackId>-1&&this.toggleTrackModes(this.trackId)}},{key:"subtitleTracks",get:function(){return this.tracksInGroup}},{key:"subtitleTrack",get:function(){return this.trackId},set:function(g){this.selectDefaultTrack=!1;var h=this.tracksInGroup?this.tracksInGroup[this.trackId]:void 0;this.setSubtitleTrack(g,h)}}]),u}(b.default);function y(o){for(var u=[],s=0;s<o.length;s++){var n=o[s];(n.kind==="subtitles"||n.kind==="captions")&&n.label&&u.push(o[s])}return u}const m=c},"./src/controller/timeline-controller.ts":(Y,B,x)=>{x.r(B),x.d(B,{TimelineController:()=>c});var F=x("./src/polyfills/number.ts"),A=x("./src/events.ts"),b=x("./src/utils/cea-608-parser.ts"),R=x("./src/utils/output-filter.ts"),k=x("./src/utils/webvtt-parser.ts"),P=x("./src/utils/texttrack-utils.ts"),L=x("./src/utils/imsc1-ttml-parser.ts"),S=x("./src/utils/mp4-tools.ts"),_=x("./src/types/loader.ts"),T=x("./src/utils/logger.ts"),c=function(){function u(n){if(this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.timescale=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=o(),this.captionsProperties=void 0,this.hls=n,this.config=n.config,this.Cues=n.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},this.config.enableCEA708Captions){var g=new R.default(this,"textTrack1"),h=new R.default(this,"textTrack2"),r=new R.default(this,"textTrack3"),l=new R.default(this,"textTrack4");this.cea608Parser1=new b.default(1,g,h),this.cea608Parser2=new b.default(3,r,l)}n.on(A.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),n.on(A.Events.MEDIA_DETACHING,this.onMediaDetaching,this),n.on(A.Events.MANIFEST_LOADING,this.onManifestLoading,this),n.on(A.Events.MANIFEST_LOADED,this.onManifestLoaded,this),n.on(A.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),n.on(A.Events.FRAG_LOADING,this.onFragLoading,this),n.on(A.Events.FRAG_LOADED,this.onFragLoaded,this),n.on(A.Events.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),n.on(A.Events.FRAG_DECRYPTED,this.onFragDecrypted,this),n.on(A.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),n.on(A.Events.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),n.on(A.Events.BUFFER_FLUSHING,this.onBufferFlushing,this)}var s=u.prototype;return s.destroy=function(){var g=this.hls;g.off(A.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),g.off(A.Events.MEDIA_DETACHING,this.onMediaDetaching,this),g.off(A.Events.MANIFEST_LOADING,this.onManifestLoading,this),g.off(A.Events.MANIFEST_LOADED,this.onManifestLoaded,this),g.off(A.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),g.off(A.Events.FRAG_LOADING,this.onFragLoading,this),g.off(A.Events.FRAG_LOADED,this.onFragLoaded,this),g.off(A.Events.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),g.off(A.Events.FRAG_DECRYPTED,this.onFragDecrypted,this),g.off(A.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),g.off(A.Events.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),g.off(A.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.cea608Parser1=this.cea608Parser2=null},s.addCues=function(g,h,r,l,p){for(var i=!1,a=p.length;a--;){var t=p[a],f=m(t[0],t[1],h,r);if(f>=0&&(t[0]=Math.min(t[0],h),t[1]=Math.max(t[1],r),i=!0,f/(r-h)>.5))return}if(i||p.push([h,r]),this.config.renderTextTracksNatively){var e=this.captionsTracks[g];this.Cues.newCue(e,h,r,l)}else{var d=this.Cues.newCue(null,h,r,l);this.hls.trigger(A.Events.CUES_PARSED,{type:"captions",cues:d,track:g})}},s.onInitPtsFound=function(g,h){var r=this,l=h.frag,p=h.id,i=h.initPTS,a=h.timescale,t=this.unparsedVttFrags;p==="main"&&(this.initPTS[l.cc]=i,this.timescale[l.cc]=a),t.length&&(this.unparsedVttFrags=[],t.forEach(function(f){r.onFragLoaded(A.Events.FRAG_LOADED,f)}))},s.getExistingTrack=function(g){var h=this.media;if(h)for(var r=0;r<h.textTracks.length;r++){var l=h.textTracks[r];if(l[g])return l}return null},s.createCaptionsTrack=function(g){this.config.renderTextTracksNatively?this.createNativeTrack(g):this.createNonNativeTrack(g)},s.createNativeTrack=function(g){if(!this.captionsTracks[g]){var h=this.captionsProperties,r=this.captionsTracks,l=this.media,p=h[g],i=p.label,a=p.languageCode,t=this.getExistingTrack(g);if(t)r[g]=t,(0,P.clearCurrentCues)(r[g]),(0,P.sendAddTrackEvent)(r[g],l);else{var f=this.createTextTrack("captions",i,a);f&&(f[g]=!0,r[g]=f)}}},s.createNonNativeTrack=function(g){if(!this.nonNativeCaptionsTracks[g]){var h=this.captionsProperties[g];if(h){var r=h.label,l={_id:g,label:r,kind:"captions",default:h.media?!!h.media.default:!1,closedCaptions:h.media};this.nonNativeCaptionsTracks[g]=l,this.hls.trigger(A.Events.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[l]})}}},s.createTextTrack=function(g,h,r){var l=this.media;if(l)return l.addTextTrack(g,h,r)},s.onMediaAttaching=function(g,h){this.media=h.media,this._cleanTracks()},s.onMediaDetaching=function(){var g=this.captionsTracks;Object.keys(g).forEach(function(h){(0,P.clearCurrentCues)(g[h]),delete g[h]}),this.nonNativeCaptionsTracks={}},s.onManifestLoading=function(){this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=o(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=this.unparsedVttFrags||[],this.initPTS=[],this.timescale=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())},s._cleanTracks=function(){var g=this.media;if(g){var h=g.textTracks;if(h)for(var r=0;r<h.length;r++)(0,P.clearCurrentCues)(h[r])}},s.onSubtitleTracksUpdated=function(g,h){var r=this;this.textTracks=[];var l=h.subtitleTracks||[],p=l.some(function(f){return f.textCodec===L.IMSC1_CODEC});if(this.config.enableWebVTT||p&&this.config.enableIMSC1){var i=this.tracks&&l&&this.tracks.length===l.length;if(this.tracks=l||[],this.config.renderTextTracksNatively){var a=this.media?this.media.textTracks:[];this.tracks.forEach(function(f,e){var d;if(e<a.length){for(var E=null,v=0;v<a.length;v++)if(y(a[v],f)){E=a[v];break}E&&(d=E)}if(d)(0,P.clearCurrentCues)(d);else{var D=r._captionsOrSubtitlesFromCharacteristics(f);d=r.createTextTrack(D,f.name,f.lang),d&&(d.mode="disabled")}d&&(d.groupId=f.groupId,r.textTracks.push(d))})}else if(!i&&this.tracks&&this.tracks.length){var t=this.tracks.map(function(f){return{label:f.name,kind:f.type.toLowerCase(),default:f.default,subtitleTrack:f}});this.hls.trigger(A.Events.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:t})}}},s._captionsOrSubtitlesFromCharacteristics=function(g){var h;if((h=g.attrs)!==null&&h!==void 0&&h.CHARACTERISTICS){var r=/transcribes-spoken-dialog/gi.test(g.attrs.CHARACTERISTICS),l=/describes-music-and-sound/gi.test(g.attrs.CHARACTERISTICS);if(r&&l)return"captions"}return"subtitles"},s.onManifestLoaded=function(g,h){var r=this;this.config.enableCEA708Captions&&h.captions&&h.captions.forEach(function(l){var p=/(?:CC|SERVICE)([1-4])/.exec(l.instreamId);if(p){var i="textTrack"+p[1],a=r.captionsProperties[i];a&&(a.label=l.name,l.lang&&(a.languageCode=l.lang),a.media=l)}})},s.closedCaptionsForLevel=function(g){var h=this.hls.levels[g.level];return h==null?void 0:h.attrs["CLOSED-CAPTIONS"]},s.onFragLoading=function(g,h){var r=this.cea608Parser1,l=this.cea608Parser2,p=this.lastSn,i=this.lastPartIndex;if(!(!this.enabled||!(r&&l))&&h.frag.type===_.PlaylistLevelType.MAIN){var a,t,f=h.frag.sn,e=(a=h==null||(t=h.part)===null||t===void 0?void 0:t.index)!=null?a:-1;f===p+1||f===p&&e===i+1||(r.reset(),l.reset()),this.lastSn=f,this.lastPartIndex=e}},s.onFragLoaded=function(g,h){var r=h.frag,l=h.payload,p=this.initPTS,i=this.unparsedVttFrags;if(r.type===_.PlaylistLevelType.SUBTITLE)if(l.byteLength){if(!(0,F.isFiniteNumber)(p[r.cc])){i.push(h),p.length&&this.hls.trigger(A.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:r,error:new Error("Missing initial subtitle PTS")});return}var a=r.decryptdata,t="stats"in h;if(a==null||!a.encrypted||t){var f=this.tracks[r.level],e=this.vttCCs;e[r.cc]||(e[r.cc]={start:r.start,prevCC:this.prevCC,new:!0},this.prevCC=r.cc),f&&f.textCodec===L.IMSC1_CODEC?this._parseIMSC1(r,l):this._parseVTTs(r,l,e)}}else this.hls.trigger(A.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:r,error:new Error("Empty subtitle payload")})},s._parseIMSC1=function(g,h){var r=this,l=this.hls;(0,L.parseIMSC1)(h,this.initPTS[g.cc],this.timescale[g.cc],function(p){r._appendCues(p,g.level),l.trigger(A.Events.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:g})},function(p){T.logger.log("Failed to parse IMSC1: "+p),l.trigger(A.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:g,error:p})})},s._parseVTTs=function(g,h,r){var l,p=this,i=this.hls,a=(l=g.initSegment)!==null&&l!==void 0&&l.data?(0,S.appendUint8Array)(g.initSegment.data,new Uint8Array(h)):h;(0,k.parseWebVTT)(a,this.initPTS[g.cc],this.timescale[g.cc],r,g.cc,g.start,function(t){p._appendCues(t,g.level),i.trigger(A.Events.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:g})},function(t){p._fallbackToIMSC1(g,h),T.logger.log("Failed to parse VTT cue: "+t),i.trigger(A.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:g,error:t})})},s._fallbackToIMSC1=function(g,h){var r=this,l=this.tracks[g.level];l.textCodec||(0,L.parseIMSC1)(h,this.initPTS[g.cc],this.timescale[g.cc],function(){l.textCodec=L.IMSC1_CODEC,r._parseIMSC1(g,h)},function(){l.textCodec="wvtt"})},s._appendCues=function(g,h){var r=this.hls;if(this.config.renderTextTracksNatively){var l=this.textTracks[h];if(!l||l.mode==="disabled")return;g.forEach(function(a){return(0,P.addCueToTrack)(l,a)})}else{var p=this.tracks[h];if(!p)return;var i=p.default?"default":"subtitles"+h;r.trigger(A.Events.CUES_PARSED,{type:"subtitles",cues:g,track:i})}},s.onFragDecrypted=function(g,h){var r=h.frag;if(r.type===_.PlaylistLevelType.SUBTITLE){if(!(0,F.isFiniteNumber)(this.initPTS[r.cc])){this.unparsedVttFrags.push(h);return}this.onFragLoaded(A.Events.FRAG_LOADED,h)}},s.onSubtitleTracksCleared=function(){this.tracks=[],this.captionsTracks={}},s.onFragParsingUserdata=function(g,h){var r=this.cea608Parser1,l=this.cea608Parser2;if(!(!this.enabled||!(r&&l))){var p=h.frag,i=h.samples;if(!(p.type===_.PlaylistLevelType.MAIN&&this.closedCaptionsForLevel(p)==="NONE"))for(var a=0;a<i.length;a++){var t=i[a].bytes;if(t){var f=this.extractCea608Data(t);r.addData(i[a].pts,f[0]),l.addData(i[a].pts,f[1])}}}},s.onBufferFlushing=function(g,h){var r=h.startOffset,l=h.endOffset,p=h.endOffsetSubtitles,i=h.type,a=this.media;if(!(!a||a.currentTime<l)){if(!i||i==="video"){var t=this.captionsTracks;Object.keys(t).forEach(function(e){return(0,P.removeCuesInRange)(t[e],r,l)})}if(this.config.renderTextTracksNatively&&r===0&&p!==void 0){var f=this.textTracks;Object.keys(f).forEach(function(e){return(0,P.removeCuesInRange)(f[e],r,p)})}}},s.extractCea608Data=function(g){for(var h=[[],[]],r=g[0]&31,l=2,p=0;p<r;p++){var i=g[l++],a=127&g[l++],t=127&g[l++];if(!(a===0&&t===0)){var f=(4&i)!==0;if(f){var e=3&i;(e===0||e===1)&&(h[e].push(a),h[e].push(t))}}}return h},u}();function y(u,s){return u&&u.label===s.name&&!(u.textTrack1||u.textTrack2)}function m(u,s,n,g){return Math.min(s,g)-Math.max(u,n)}function o(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}},"./src/crypt/aes-crypto.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>F});var F=function(){function A(R,k){this.subtle=void 0,this.aesIV=void 0,this.subtle=R,this.aesIV=k}var b=A.prototype;return b.decrypt=function(k,P){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},P,k)},A}()},"./src/crypt/aes-decryptor.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>b,removePadding:()=>A});var F=x("./src/utils/typed-array.ts");function A(R){var k=R.byteLength,P=k&&new DataView(R.buffer).getUint8(k-1);return P?(0,F.sliceUint8)(R,0,k-P):R}var b=function(){function R(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}var k=R.prototype;return k.uint8ArrayToUint32Array_=function(L){for(var S=new DataView(L),_=new Uint32Array(4),T=0;T<4;T++)_[T]=S.getUint32(T*4);return _},k.initTable=function(){var L=this.sBox,S=this.invSBox,_=this.subMix,T=_[0],c=_[1],y=_[2],m=_[3],o=this.invSubMix,u=o[0],s=o[1],n=o[2],g=o[3],h=new Uint32Array(256),r=0,l=0,p=0;for(p=0;p<256;p++)p<128?h[p]=p<<1:h[p]=p<<1^283;for(p=0;p<256;p++){var i=l^l<<1^l<<2^l<<3^l<<4;i=i>>>8^i&255^99,L[r]=i,S[i]=r;var a=h[r],t=h[a],f=h[t],e=h[i]*257^i*16843008;T[r]=e<<24|e>>>8,c[r]=e<<16|e>>>16,y[r]=e<<8|e>>>24,m[r]=e,e=f*16843009^t*65537^a*257^r*16843008,u[i]=e<<24|e>>>8,s[i]=e<<16|e>>>16,n[i]=e<<8|e>>>24,g[i]=e,r?(r=a^h[h[h[f^a]]],l^=h[h[l]]):r=l=1}},k.expandKey=function(L){for(var S=this.uint8ArrayToUint32Array_(L),_=!0,T=0;T<S.length&&_;)_=S[T]===this.key[T],T++;if(!_){this.key=S;var c=this.keySize=S.length;if(c!==4&&c!==6&&c!==8)throw new Error("Invalid aes key size="+c);var y=this.ksRows=(c+6+1)*4,m,o,u=this.keySchedule=new Uint32Array(y),s=this.invKeySchedule=new Uint32Array(y),n=this.sBox,g=this.rcon,h=this.invSubMix,r=h[0],l=h[1],p=h[2],i=h[3],a,t;for(m=0;m<y;m++){if(m<c){a=u[m]=S[m];continue}t=a,m%c===0?(t=t<<8|t>>>24,t=n[t>>>24]<<24|n[t>>>16&255]<<16|n[t>>>8&255]<<8|n[t&255],t^=g[m/c|0]<<24):c>6&&m%c===4&&(t=n[t>>>24]<<24|n[t>>>16&255]<<16|n[t>>>8&255]<<8|n[t&255]),u[m]=a=(u[m-c]^t)>>>0}for(o=0;o<y;o++)m=y-o,o&3?t=u[m]:t=u[m-4],o<4||m<=4?s[o]=t:s[o]=r[n[t>>>24]]^l[n[t>>>16&255]]^p[n[t>>>8&255]]^i[n[t&255]],s[o]=s[o]>>>0}},k.networkToHostOrderSwap=function(L){return L<<24|(L&65280)<<8|(L&16711680)>>8|L>>>24},k.decrypt=function(L,S,_){for(var T=this.keySize+6,c=this.invKeySchedule,y=this.invSBox,m=this.invSubMix,o=m[0],u=m[1],s=m[2],n=m[3],g=this.uint8ArrayToUint32Array_(_),h=g[0],r=g[1],l=g[2],p=g[3],i=new Int32Array(L),a=new Int32Array(i.length),t,f,e,d,E,v,D,I,O,C,M,U,w,N,K=this.networkToHostOrderSwap;S<i.length;){for(O=K(i[S]),C=K(i[S+1]),M=K(i[S+2]),U=K(i[S+3]),E=O^c[0],v=U^c[1],D=M^c[2],I=C^c[3],w=4,N=1;N<T;N++)t=o[E>>>24]^u[v>>16&255]^s[D>>8&255]^n[I&255]^c[w],f=o[v>>>24]^u[D>>16&255]^s[I>>8&255]^n[E&255]^c[w+1],e=o[D>>>24]^u[I>>16&255]^s[E>>8&255]^n[v&255]^c[w+2],d=o[I>>>24]^u[E>>16&255]^s[v>>8&255]^n[D&255]^c[w+3],E=t,v=f,D=e,I=d,w=w+4;t=y[E>>>24]<<24^y[v>>16&255]<<16^y[D>>8&255]<<8^y[I&255]^c[w],f=y[v>>>24]<<24^y[D>>16&255]<<16^y[I>>8&255]<<8^y[E&255]^c[w+1],e=y[D>>>24]<<24^y[I>>16&255]<<16^y[E>>8&255]<<8^y[v&255]^c[w+2],d=y[I>>>24]<<24^y[E>>16&255]<<16^y[v>>8&255]<<8^y[D&255]^c[w+3],a[S]=K(t^h),a[S+1]=K(d^r),a[S+2]=K(e^l),a[S+3]=K(f^p),h=O,r=C,l=M,p=U,S=S+4}return a.buffer},R}()},"./src/crypt/decrypter.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>S});var F=x("./src/crypt/aes-crypto.ts"),A=x("./src/crypt/fast-aes-key.ts"),b=x("./src/crypt/aes-decryptor.ts"),R=x("./src/utils/logger.ts"),k=x("./src/utils/mp4-tools.ts"),P=x("./src/utils/typed-array.ts"),L=16,S=function(){function _(c,y){var m=y===void 0?{}:y,o=m.removePKCS7Padding,u=o===void 0?!0:o;if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.useSoftware=c.enableSoftwareAES,this.removePKCS7Padding=u,u)try{var s=self.crypto;s&&(this.subtle=s.subtle||s.webkitSubtle)}catch{}this.subtle===null&&(this.useSoftware=!0)}var T=_.prototype;return T.destroy=function(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null},T.isSync=function(){return this.useSoftware},T.flush=function(){var y=this.currentResult,m=this.remainderData;if(!y||m)return this.reset(),null;var o=new Uint8Array(y);return this.reset(),this.removePKCS7Padding?(0,b.removePadding)(o):o},T.reset=function(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)},T.decrypt=function(y,m,o){var u=this;return this.useSoftware?new Promise(function(s,n){u.softwareDecrypt(new Uint8Array(y),m,o);var g=u.flush();g?s(g.buffer):n(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(y),m,o)},T.softwareDecrypt=function(y,m,o){var u=this.currentIV,s=this.currentResult,n=this.remainderData;this.logOnce("JS AES decrypt"),n&&(y=(0,k.appendUint8Array)(n,y),this.remainderData=null);var g=this.getValidChunk(y);if(!g.length)return null;u&&(o=u);var h=this.softwareDecrypter;h||(h=this.softwareDecrypter=new b.default),h.expandKey(m);var r=s;return this.currentResult=h.decrypt(g.buffer,0,o),this.currentIV=(0,P.sliceUint8)(g,-16).buffer,r||null},T.webCryptoDecrypt=function(y,m,o){var u=this,s=this.subtle;return(this.key!==m||!this.fastAesKey)&&(this.key=m,this.fastAesKey=new A.default(s,m)),this.fastAesKey.expandKey().then(function(n){if(!s)return Promise.reject(new Error("web crypto not initialized"));u.logOnce("WebCrypto AES decrypt");var g=new F.default(s,new Uint8Array(o));return g.decrypt(y.buffer,n)}).catch(function(n){return R.logger.warn("[decrypter]: WebCrypto Error, disable WebCrypto API, "+n.name+": "+n.message),u.onWebCryptoError(y,m,o)})},T.onWebCryptoError=function(y,m,o){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(y,m,o);var u=this.flush();if(u)return u.buffer;throw new Error("WebCrypto and softwareDecrypt: failed to decrypt data")},T.getValidChunk=function(y){var m=y,o=y.length-y.length%L;return o!==y.length&&(m=(0,P.sliceUint8)(y,0,o),this.remainderData=(0,P.sliceUint8)(y,o)),m},T.logOnce=function(y){this.logEnabled&&(R.logger.log("[decrypter]: "+y),this.logEnabled=!1)},_}()},"./src/crypt/fast-aes-key.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>F});var F=function(){function A(R,k){this.subtle=void 0,this.key=void 0,this.subtle=R,this.key=k}var b=A.prototype;return b.expandKey=function(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])},A}()},"./src/demux/aacdemuxer.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>S});var F=x("./src/demux/base-audio-demuxer.ts"),A=x("./src/demux/adts.ts"),b=x("./src/utils/logger.ts"),R=x("./src/demux/id3.ts");function k(_,T){_.prototype=Object.create(T.prototype),_.prototype.constructor=_,P(_,T)}function P(_,T){return P=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(y,m){return y.__proto__=m,y},P(_,T)}var L=function(_){k(T,_);function T(y,m){var o;return o=_.call(this)||this,o.observer=void 0,o.config=void 0,o.observer=y,o.config=m,o}var c=T.prototype;return c.resetInitSegment=function(m,o,u,s){_.prototype.resetInitSegment.call(this,m,o,u,s),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:o,duration:s,inputTimeScale:9e4,dropped:0}},T.probe=function(m){if(!m)return!1;for(var o=R.getID3Data(m,0)||[],u=o.length,s=m.length;u<s;u++)if(A.probe(m,u))return b.logger.log("ADTS sync word found !"),!0;return!1},c.canParse=function(m,o){return A.canParse(m,o)},c.appendFrame=function(m,o,u){A.initTrackConfig(m,this.observer,o,u,m.manifestCodec);var s=A.appendFrame(m,o,u,this.basePTS,this.frameIndex);if(s&&s.missing===0)return s},T}(F.default);const S=L},"./src/demux/adts.ts":(Y,B,x)=>{x.r(B),x.d(B,{appendFrame:()=>u,canGetFrameLength:()=>S,canParse:()=>T,getAudioConfig:()=>R,getFrameDuration:()=>m,getFullFrameLength:()=>L,getHeaderLength:()=>P,initTrackConfig:()=>y,isHeader:()=>_,isHeaderPattern:()=>k,parseFrameHeader:()=>o,probe:()=>c});var F=x("./src/utils/logger.ts"),A=x("./src/errors.ts"),b=x("./src/events.ts");function R(s,n,g,h){var r,l,p,i,a=navigator.userAgent.toLowerCase(),t=h,f=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];r=((n[g+2]&192)>>>6)+1;var e=(n[g+2]&60)>>>2;if(e>f.length-1){s.trigger(b.Events.ERROR,{type:A.ErrorTypes.MEDIA_ERROR,details:A.ErrorDetails.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ADTS sampling index:"+e});return}return p=(n[g+2]&1)<<2,p|=(n[g+3]&192)>>>6,F.logger.log("manifest codec:"+h+", ADTS type:"+r+", samplingIndex:"+e),/firefox/i.test(a)?e>=6?(r=5,i=new Array(4),l=e-3):(r=2,i=new Array(2),l=e):a.indexOf("android")!==-1?(r=2,i=new Array(2),l=e):(r=5,i=new Array(4),h&&(h.indexOf("mp4a.40.29")!==-1||h.indexOf("mp4a.40.5")!==-1)||!h&&e>=6?l=e-3:((h&&h.indexOf("mp4a.40.2")!==-1&&(e>=6&&p===1||/vivaldi/i.test(a))||!h&&p===1)&&(r=2,i=new Array(2)),l=e)),i[0]=r<<3,i[0]|=(e&14)>>1,i[1]|=(e&1)<<7,i[1]|=p<<3,r===5&&(i[1]|=(l&14)>>1,i[2]=(l&1)<<7,i[2]|=8,i[3]=0),{config:i,samplerate:f[e],channelCount:p,codec:"mp4a.40."+r,manifestCodec:t}}function k(s,n){return s[n]===255&&(s[n+1]&246)===240}function P(s,n){return s[n+1]&1?7:9}function L(s,n){return(s[n+3]&3)<<11|s[n+4]<<3|(s[n+5]&224)>>>5}function S(s,n){return n+5<s.length}function _(s,n){return n+1<s.length&&k(s,n)}function T(s,n){return S(s,n)&&k(s,n)&&L(s,n)<=s.length-n}function c(s,n){if(_(s,n)){var g=P(s,n);if(n+g>=s.length)return!1;var h=L(s,n);if(h<=g)return!1;var r=n+h;return r===s.length||_(s,r)}return!1}function y(s,n,g,h,r){if(!s.samplerate){var l=R(n,g,h,r);if(!l)return;s.config=l.config,s.samplerate=l.samplerate,s.channelCount=l.channelCount,s.codec=l.codec,s.manifestCodec=l.manifestCodec,F.logger.log("parsed codec:"+s.codec+", rate:"+l.samplerate+", channels:"+l.channelCount)}}function m(s){return 9216e4/s}function o(s,n){var g=P(s,n);if(n+g<=s.length){var h=L(s,n)-g;if(h>0)return{headerLength:g,frameLength:h}}}function u(s,n,g,h,r){var l=m(s.samplerate),p=h+r*l,i=o(n,g),a;if(i){var t=i.frameLength,f=i.headerLength,e=f+t,d=Math.max(0,g+e-n.length);d?(a=new Uint8Array(e-f),a.set(n.subarray(g+f,n.length),0)):a=n.subarray(g+f,g+e);var E={unit:a,pts:p};return d||s.samples.push(E),{sample:E,length:e,missing:d}}var v=n.length-g;a=new Uint8Array(v),a.set(n.subarray(g,n.length),0);var D={unit:a,pts:p};return{sample:D,length:v,missing:-1}}},"./src/demux/base-audio-demuxer.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>_,initPTSFn:()=>S});var F=x("./src/polyfills/number.ts"),A=x("./src/demux/id3.ts"),b=x("./src/types/demuxer.ts"),R=x("./src/demux/dummy-demuxed-track.ts"),k=x("./src/utils/mp4-tools.ts"),P=x("./src/utils/typed-array.ts"),L=function(){function T(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}var c=T.prototype;return c.resetInitSegment=function(m,o,u,s){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}},c.resetTimeStamp=function(m){this.initPTS=m,this.resetContiguity()},c.resetContiguity=function(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0},c.canParse=function(m,o){return!1},c.appendFrame=function(m,o,u){},c.demux=function(m,o){this.cachedData&&(m=(0,k.appendUint8Array)(this.cachedData,m),this.cachedData=null);var u=A.getID3Data(m,0),s=u?u.length:0,n,g=this._audioTrack,h=this._id3Track,r=u?A.getTimeStamp(u):void 0,l=m.length;for((this.basePTS===null||this.frameIndex===0&&(0,F.isFiniteNumber)(r))&&(this.basePTS=S(r,o,this.initPTS),this.lastPTS=this.basePTS),this.lastPTS===null&&(this.lastPTS=this.basePTS),u&&u.length>0&&h.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:u,type:b.MetadataSchema.audioId3,duration:Number.POSITIVE_INFINITY});s<l;){if(this.canParse(m,s)){var p=this.appendFrame(g,m,s);p?(this.frameIndex++,this.lastPTS=p.sample.pts,s+=p.length,n=s):s=l}else A.canParse(m,s)?(u=A.getID3Data(m,s),h.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:u,type:b.MetadataSchema.audioId3,duration:Number.POSITIVE_INFINITY}),s+=u.length,n=s):s++;if(s===l&&n!==l){var i=(0,P.sliceUint8)(m,n);this.cachedData?this.cachedData=(0,k.appendUint8Array)(this.cachedData,i):this.cachedData=i}}return{audioTrack:g,videoTrack:(0,R.dummyTrack)(),id3Track:h,textTrack:(0,R.dummyTrack)()}},c.demuxSampleAes=function(m,o,u){return Promise.reject(new Error("["+this+"] This demuxer does not support Sample-AES decryption"))},c.flush=function(m){var o=this.cachedData;return o&&(this.cachedData=null,this.demux(o,0)),{audioTrack:this._audioTrack,videoTrack:(0,R.dummyTrack)(),id3Track:this._id3Track,textTrack:(0,R.dummyTrack)()}},c.destroy=function(){},T}(),S=function(c,y,m){return(0,F.isFiniteNumber)(c)?c*90:y*9e4+(m||0)};const _=L},"./src/demux/chunk-cache.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>F});var F=function(){function b(){this.chunks=[],this.dataLength=0}var R=b.prototype;return R.push=function(P){this.chunks.push(P),this.dataLength+=P.length},R.flush=function(){var P=this.chunks,L=this.dataLength,S;if(P.length)P.length===1?S=P[0]:S=A(P,L);else return new Uint8Array(0);return this.reset(),S},R.reset=function(){this.chunks.length=0,this.dataLength=0},b}();function A(b,R){for(var k=new Uint8Array(R),P=0,L=0;L<b.length;L++){var S=b[L];k.set(S,P),P+=S.length}return k}},"./src/demux/dummy-demuxed-track.ts":(Y,B,x)=>{x.r(B),x.d(B,{dummyTrack:()=>F});function F(A,b){return A===void 0&&(A=""),b===void 0&&(b=9e4),{type:A,id:-1,pid:-1,inputTimeScale:b,sequenceNumber:-1,samples:[],dropped:0}}},"./src/demux/exp-golomb.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>b});var F=x("./src/utils/logger.ts"),A=function(){function R(P){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=P,this.bytesAvailable=P.byteLength,this.word=0,this.bitsAvailable=0}var k=R.prototype;return k.loadWord=function(){var L=this.data,S=this.bytesAvailable,_=L.byteLength-S,T=new Uint8Array(4),c=Math.min(4,S);if(c===0)throw new Error("no bytes available");T.set(L.subarray(_,_+c)),this.word=new DataView(T.buffer).getUint32(0),this.bitsAvailable=c*8,this.bytesAvailable-=c},k.skipBits=function(L){var S;L=Math.min(L,this.bytesAvailable*8+this.bitsAvailable),this.bitsAvailable>L?(this.word<<=L,this.bitsAvailable-=L):(L-=this.bitsAvailable,S=L>>3,L-=S<<3,this.bytesAvailable-=S,this.loadWord(),this.word<<=L,this.bitsAvailable-=L)},k.readBits=function(L){var S=Math.min(this.bitsAvailable,L),_=this.word>>>32-S;if(L>32&&F.logger.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=S,this.bitsAvailable>0)this.word<<=S;else if(this.bytesAvailable>0)this.loadWord();else throw new Error("no bits available");return S=L-S,S>0&&this.bitsAvailable?_<<S|this.readBits(S):_},k.skipLZ=function(){var L;for(L=0;L<this.bitsAvailable;++L)if(this.word&2147483648>>>L)return this.word<<=L,this.bitsAvailable-=L,L;return this.loadWord(),L+this.skipLZ()},k.skipUEG=function(){this.skipBits(1+this.skipLZ())},k.skipEG=function(){this.skipBits(1+this.skipLZ())},k.readUEG=function(){var L=this.skipLZ();return this.readBits(L+1)-1},k.readEG=function(){var L=this.readUEG();return 1&L?1+L>>>1:-1*(L>>>1)},k.readBoolean=function(){return this.readBits(1)===1},k.readUByte=function(){return this.readBits(8)},k.readUShort=function(){return this.readBits(16)},k.readUInt=function(){return this.readBits(32)},k.skipScalingList=function(L){for(var S=8,_=8,T,c=0;c<L;c++)_!==0&&(T=this.readEG(),_=(S+T+256)%256),S=_===0?S:_},k.readSPS=function(){var L=0,S=0,_=0,T=0,c,y,m,o=this.readUByte.bind(this),u=this.readBits.bind(this),s=this.readUEG.bind(this),n=this.readBoolean.bind(this),g=this.skipBits.bind(this),h=this.skipEG.bind(this),r=this.skipUEG.bind(this),l=this.skipScalingList.bind(this);o();var p=o();if(u(5),g(3),o(),r(),p===100||p===110||p===122||p===244||p===44||p===83||p===86||p===118||p===128){var i=s();if(i===3&&g(1),r(),r(),g(1),n())for(y=i!==3?8:12,m=0;m<y;m++)n()&&(m<6?l(16):l(64))}r();var a=s();if(a===0)s();else if(a===1)for(g(1),h(),h(),c=s(),m=0;m<c;m++)h();r(),g(1);var t=s(),f=s(),e=u(1);e===0&&g(1),g(1),n()&&(L=s(),S=s(),_=s(),T=s());var d=[1,1];if(n()&&n()){var E=o();switch(E){case 1:d=[1,1];break;case 2:d=[12,11];break;case 3:d=[10,11];break;case 4:d=[16,11];break;case 5:d=[40,33];break;case 6:d=[24,11];break;case 7:d=[20,11];break;case 8:d=[32,11];break;case 9:d=[80,33];break;case 10:d=[18,11];break;case 11:d=[15,11];break;case 12:d=[64,33];break;case 13:d=[160,99];break;case 14:d=[4,3];break;case 15:d=[3,2];break;case 16:d=[2,1];break;case 255:{d=[o()<<8|o(),o()<<8|o()];break}}}return{width:Math.ceil((t+1)*16-L*2-S*2),height:(2-e)*(f+1)*16-(e?2:4)*(_+T),pixelRatio:d}},k.readSliceType=function(){return this.readUByte(),this.readUEG(),this.readUEG()},R}();const b=A},"./src/demux/id3.ts":(Y,B,x)=>{x.r(B),x.d(B,{canParse:()=>k,decodeFrame:()=>T,getID3Data:()=>b,getID3Frames:()=>_,getTimeStamp:()=>P,isFooter:()=>A,isHeader:()=>F,isTimeStampFrame:()=>L,testables:()=>s,utf8ArrayToStr:()=>u});var F=function(r,l){return l+10<=r.length&&r[l]===73&&r[l+1]===68&&r[l+2]===51&&r[l+3]<255&&r[l+4]<255&&r[l+6]<128&&r[l+7]<128&&r[l+8]<128&&r[l+9]<128},A=function(r,l){return l+10<=r.length&&r[l]===51&&r[l+1]===68&&r[l+2]===73&&r[l+3]<255&&r[l+4]<255&&r[l+6]<128&&r[l+7]<128&&r[l+8]<128&&r[l+9]<128},b=function(r,l){for(var p=l,i=0;F(r,l);){i+=10;var a=R(r,l+6);i+=a,A(r,l+10)&&(i+=10),l+=i}if(i>0)return r.subarray(p,p+i)},R=function(r,l){var p=0;return p=(r[l]&127)<<21,p|=(r[l+1]&127)<<14,p|=(r[l+2]&127)<<7,p|=r[l+3]&127,p},k=function(r,l){return F(r,l)&&R(r,l+6)+10<=r.length-l},P=function(r){for(var l=_(r),p=0;p<l.length;p++){var i=l[p];if(L(i))return o(i)}},L=function(r){return r&&r.key==="PRIV"&&r.info==="com.apple.streaming.transportStreamTimestamp"},S=function(r){var l=String.fromCharCode(r[0],r[1],r[2],r[3]),p=R(r,4),i=10;return{type:l,size:p,data:r.subarray(i,i+p)}},_=function(r){for(var l=0,p=[];F(r,l);){var i=R(r,l+6);l+=10;for(var a=l+i;l+8<a;){var t=S(r.subarray(l)),f=T(t);f&&p.push(f),l+=t.size+10}A(r,l)&&(l+=10)}return p},T=function(r){return r.type==="PRIV"?c(r):r.type[0]==="W"?m(r):y(r)},c=function(r){if(!(r.size<2)){var l=u(r.data,!0),p=new Uint8Array(r.data.subarray(l.length+1));return{key:r.type,info:l,data:p.buffer}}},y=function(r){if(!(r.size<2)){if(r.type==="TXXX"){var l=1,p=u(r.data.subarray(l),!0);l+=p.length+1;var i=u(r.data.subarray(l));return{key:r.type,info:p,data:i}}var a=u(r.data.subarray(1));return{key:r.type,data:a}}},m=function(r){if(r.type==="WXXX"){if(r.size<2)return;var l=1,p=u(r.data.subarray(l),!0);l+=p.length+1;var i=u(r.data.subarray(l));return{key:r.type,info:p,data:i}}var a=u(r.data);return{key:r.type,data:a}},o=function(r){if(r.data.byteLength===8){var l=new Uint8Array(r.data),p=l[3]&1,i=(l[4]<<23)+(l[5]<<15)+(l[6]<<7)+l[7];return i/=45,p&&(i+=4772185884e-2),Math.round(i)}},u=function(r,l){l===void 0&&(l=!1);var p=g();if(p){var i=p.decode(r);if(l){var a=i.indexOf("\0");return a!==-1?i.substring(0,a):i}return i.replace(/\0/g,"")}for(var t=r.length,f,e,d,E="",v=0;v<t;){if(f=r[v++],f===0&&l)return E;if(f===0||f===3)continue;switch(f>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:E+=String.fromCharCode(f);break;case 12:case 13:e=r[v++],E+=String.fromCharCode((f&31)<<6|e&63);break;case 14:e=r[v++],d=r[v++],E+=String.fromCharCode((f&15)<<12|(e&63)<<6|(d&63)<<0);break}}return E},s={decodeTextFrame:y},n;function g(){return!n&&typeof self.TextDecoder<"u"&&(n=new self.TextDecoder("utf-8")),n}},"./src/demux/mp3demuxer.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>S});var F=x("./src/demux/base-audio-demuxer.ts"),A=x("./src/demux/id3.ts"),b=x("./src/utils/logger.ts"),R=x("./src/demux/mpegaudio.ts");function k(_,T){_.prototype=Object.create(T.prototype),_.prototype.constructor=_,P(_,T)}function P(_,T){return P=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(y,m){return y.__proto__=m,y},P(_,T)}var L=function(_){k(T,_);function T(){return _.apply(this,arguments)||this}var c=T.prototype;return c.resetInitSegment=function(m,o,u,s){_.prototype.resetInitSegment.call(this,m,o,u,s),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:o,duration:s,inputTimeScale:9e4,dropped:0}},T.probe=function(m){if(!m)return!1;for(var o=A.getID3Data(m,0)||[],u=o.length,s=m.length;u<s;u++)if(R.probe(m,u))return b.logger.log("MPEG Audio sync word found !"),!0;return!1},c.canParse=function(m,o){return R.canParse(m,o)},c.appendFrame=function(m,o,u){if(this.basePTS!==null)return R.appendFrame(m,o,u,this.basePTS,this.frameIndex)},T}(F.default);const S=L},"./src/demux/mp4demuxer.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>L});var F=x("./src/polyfills/number.ts"),A=x("./src/types/demuxer.ts"),b=x("./src/utils/mp4-tools.ts"),R=x("./src/demux/dummy-demuxed-track.ts"),k=/\/emsg[-/]ID3/i,P=function(){function S(T,c){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=c}var _=S.prototype;return _.resetTimeStamp=function(){},_.resetInitSegment=function(c,y,m,o){var u=this.videoTrack=(0,R.dummyTrack)("video",1),s=this.audioTrack=(0,R.dummyTrack)("audio",1),n=this.txtTrack=(0,R.dummyTrack)("text",1);if(this.id3Track=(0,R.dummyTrack)("id3",1),this.timeOffset=0,!(!c||!c.byteLength)){var g=(0,b.parseInitSegment)(c);if(g.video){var h=g.video,r=h.id,l=h.timescale,p=h.codec;u.id=r,u.timescale=n.timescale=l,u.codec=p}if(g.audio){var i=g.audio,a=i.id,t=i.timescale,f=i.codec;s.id=a,s.timescale=t,s.codec=f}n.id=b.RemuxerTrackIdConfig.text,u.sampleDuration=0,u.duration=s.duration=o}},_.resetContiguity=function(){},S.probe=function(c){return c=c.length>16384?c.subarray(0,16384):c,(0,b.findBox)(c,["moof"]).length>0},_.demux=function(c,y){this.timeOffset=y;var m=c,o=this.videoTrack,u=this.txtTrack;if(this.config.progressive){this.remainderData&&(m=(0,b.appendUint8Array)(this.remainderData,c));var s=(0,b.segmentValidRange)(m);this.remainderData=s.remainder,o.samples=s.valid||new Uint8Array}else o.samples=m;var n=this.extractID3Track(o,y);return u.samples=(0,b.parseSamples)(y,o),{videoTrack:o,audioTrack:this.audioTrack,id3Track:n,textTrack:this.txtTrack}},_.flush=function(){var c=this.timeOffset,y=this.videoTrack,m=this.txtTrack;y.samples=this.remainderData||new Uint8Array,this.remainderData=null;var o=this.extractID3Track(y,this.timeOffset);return m.samples=(0,b.parseSamples)(c,y),{videoTrack:y,audioTrack:(0,R.dummyTrack)(),id3Track:o,textTrack:(0,R.dummyTrack)()}},_.extractID3Track=function(c,y){var m=this.id3Track;if(c.samples.length){var o=(0,b.findBox)(c.samples,["emsg"]);o&&o.forEach(function(u){var s=(0,b.parseEmsg)(u);if(k.test(s.schemeIdUri)){var n=(0,F.isFiniteNumber)(s.presentationTime)?s.presentationTime/s.timeScale:y+s.presentationTimeDelta/s.timeScale,g=s.eventDuration===4294967295?Number.POSITIVE_INFINITY:s.eventDuration/s.timeScale;g<=.001&&(g=Number.POSITIVE_INFINITY);var h=s.payload;m.samples.push({data:h,len:h.byteLength,dts:n,pts:n,type:A.MetadataSchema.emsg,duration:g})}})}return m},_.demuxSampleAes=function(c,y,m){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))},_.destroy=function(){},S}();const L=P},"./src/demux/mpegaudio.ts":(Y,B,x)=>{x.r(B),x.d(B,{appendFrame:()=>P,canParse:()=>T,isHeader:()=>_,isHeaderPattern:()=>S,parseHeader:()=>L,probe:()=>c});var F=null,A=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],b=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],R=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],k=[0,1,1,4];function P(y,m,o,u,s){if(!(o+24>m.length)){var n=L(m,o);if(n&&o+n.frameLength<=m.length){var g=n.samplesPerFrame*9e4/n.sampleRate,h=u+s*g,r={unit:m.subarray(o,o+n.frameLength),pts:h,dts:h};return y.config=[],y.channelCount=n.channelCount,y.samplerate=n.sampleRate,y.samples.push(r),{sample:r,length:n.frameLength,missing:0}}}}function L(y,m){var o=y[m+1]>>3&3,u=y[m+1]>>1&3,s=y[m+2]>>4&15,n=y[m+2]>>2&3;if(o!==1&&s!==0&&s!==15&&n!==3){var g=y[m+2]>>1&1,h=y[m+3]>>6,r=o===3?3-u:u===3?3:4,l=A[r*14+s-1]*1e3,p=o===3?0:o===2?1:2,i=b[p*3+n],a=h===3?1:2,t=R[o][u],f=k[u],e=t*8*f,d=Math.floor(t*l/i+g)*f;if(F===null){var E=navigator.userAgent||"",v=E.match(/Chrome\/(\d+)/i);F=v?parseInt(v[1]):0}var D=!!F&&F<=87;return D&&u===2&&l>=224e3&&h===0&&(y[m+3]=y[m+3]|128),{sampleRate:i,channelCount:a,frameLength:d,samplesPerFrame:e}}}function S(y,m){return y[m]===255&&(y[m+1]&224)===224&&(y[m+1]&6)!==0}function _(y,m){return m+1<y.length&&S(y,m)}function T(y,m){var o=4;return S(y,m)&&o<=y.length-m}function c(y,m){if(m+1<y.length&&S(y,m)){var o=4,u=L(y,m),s=o;u!=null&&u.frameLength&&(s=u.frameLength);var n=m+s;return n===y.length||_(y,n)}return!1}},"./src/demux/sample-aes.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>R});var F=x("./src/crypt/decrypter.ts"),A=x("./src/utils/mp4-tools.ts"),b=function(){function k(L,S,_){this.keyData=void 0,this.decrypter=void 0,this.keyData=_,this.decrypter=new F.default(S,{removePKCS7Padding:!1})}var P=k.prototype;return P.decryptBuffer=function(S){return this.decrypter.decrypt(S,this.keyData.key.buffer,this.keyData.iv.buffer)},P.decryptAacSample=function(S,_,T){var c=this,y=S[_].unit;if(!(y.length<=16)){var m=y.subarray(16,y.length-y.length%16),o=m.buffer.slice(m.byteOffset,m.byteOffset+m.length);this.decryptBuffer(o).then(function(u){var s=new Uint8Array(u);y.set(s,16),c.decrypter.isSync()||c.decryptAacSamples(S,_+1,T)})}},P.decryptAacSamples=function(S,_,T){for(;;_++){if(_>=S.length){T();return}if(!(S[_].unit.length<32)&&(this.decryptAacSample(S,_,T),!this.decrypter.isSync()))return}},P.getAvcEncryptedData=function(S){for(var _=Math.floor((S.length-48)/160)*16+16,T=new Int8Array(_),c=0,y=32;y<S.length-16;y+=160,c+=16)T.set(S.subarray(y,y+16),c);return T},P.getAvcDecryptedUnit=function(S,_){for(var T=new Uint8Array(_),c=0,y=32;y<S.length-16;y+=160,c+=16)S.set(T.subarray(c,c+16),y);return S},P.decryptAvcSample=function(S,_,T,c,y){var m=this,o=(0,A.discardEPB)(y.data),u=this.getAvcEncryptedData(o);this.decryptBuffer(u.buffer).then(function(s){y.data=m.getAvcDecryptedUnit(o,s),m.decrypter.isSync()||m.decryptAvcSamples(S,_,T+1,c)})},P.decryptAvcSamples=function(S,_,T,c){if(S instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;_++,T=0){if(_>=S.length){c();return}for(var y=S[_].units;!(T>=y.length);T++){var m=y[T];if(!(m.data.length<=48||m.type!==1&&m.type!==5)&&(this.decryptAvcSample(S,_,T,c,m),!this.decrypter.isSync()))return}}},k}();const R=b},"./src/demux/transmuxer-interface.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>_});var F=x("./src/demux/webworkify-webpack.js"),A=x("./src/events.ts"),b=x("./src/demux/transmuxer.ts"),R=x("./src/utils/logger.ts"),k=x("./src/errors.ts"),P=x("./src/utils/mediasource-helper.ts"),L=x("./node_modules/eventemitter3/index.js"),S=(0,P.getMediaSource)()||{isTypeSupported:function(){return!1}},_=function(){function T(y,m,o,u){var s=this;this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.worker=void 0,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0;var n=y.config;this.hls=y,this.id=m,this.useWorker=!!n.enableWorker,this.onTransmuxComplete=o,this.onFlush=u;var g=function(i,a){a=a||{},a.frag=s.frag,a.id=s.id,s.hls.trigger(i,a)};this.observer=new L.EventEmitter,this.observer.on(A.Events.FRAG_DECRYPTED,g),this.observer.on(A.Events.ERROR,g);var h={mp4:S.isTypeSupported("video/mp4"),mpeg:S.isTypeSupported("audio/mpeg"),mp3:S.isTypeSupported('audio/mp4; codecs="mp3"')},r=navigator.vendor;if(this.useWorker&&typeof Worker<"u"){R.logger.log("demuxing in webworker");var l;try{l=this.worker=(0,F.default)("./src/demux/transmuxer-worker.ts"),this.onwmsg=this.onWorkerMessage.bind(this),l.addEventListener("message",this.onwmsg),l.onerror=function(p){s.useWorker=!1,R.logger.warn("Exception in webworker, fallback to inline"),s.hls.trigger(A.Events.ERROR,{type:k.ErrorTypes.OTHER_ERROR,details:k.ErrorDetails.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:new Error(p.message+"  ("+p.filename+":"+p.lineno+")")})},l.postMessage({cmd:"init",typeSupported:h,vendor:r,id:m,config:JSON.stringify(n)})}catch(p){R.logger.warn("Error in worker:",p),R.logger.error("Error while initializing DemuxerWorker, fallback to inline"),l&&self.URL.revokeObjectURL(l.objectURL),this.transmuxer=new b.default(this.observer,h,n,r,m),this.worker=null}}else this.transmuxer=new b.default(this.observer,h,n,r,m)}var c=T.prototype;return c.destroy=function(){var m=this.worker;if(m)m.removeEventListener("message",this.onwmsg),m.terminate(),this.worker=null,this.onwmsg=void 0;else{var o=this.transmuxer;o&&(o.destroy(),this.transmuxer=null)}var u=this.observer;u&&u.removeAllListeners(),this.frag=null,this.observer=null,this.hls=null},c.push=function(m,o,u,s,n,g,h,r,l,p){var i,a,t=this;l.transmuxing.start=self.performance.now();var f=this.transmuxer,e=this.worker,d=g?g.start:n.start,E=n.decryptdata,v=this.frag,D=!(v&&n.cc===v.cc),I=!(v&&l.level===v.level),O=v?l.sn-v.sn:-1,C=this.part?l.part-this.part.index:-1,M=O===0&&l.id>1&&l.id===(v==null?void 0:v.stats.chunkCount),U=!I&&(O===1||O===0&&(C===1||M&&C<=0)),w=self.performance.now();(I||O||n.stats.parsing.start===0)&&(n.stats.parsing.start=w),g&&(C||!U)&&(g.stats.parsing.start=w);var N=!(v&&((i=n.initSegment)===null||i===void 0?void 0:i.url)===((a=v.initSegment)===null||a===void 0?void 0:a.url)),K=new b.TransmuxState(D,U,r,I,d,N);if(!U||D||N){R.logger.log("[transmuxer-interface, "+n.type+"]: Starting new transmux session for sn: "+l.sn+" p: "+l.part+" level: "+l.level+" id: "+l.id+`
        discontinuity: `+D+`
        trackSwitch: `+I+`
        contiguous: `+U+`
        accurateTimeOffset: `+r+`
        timeOffset: `+d+`
        initSegmentChange: `+N);var W=new b.TransmuxConfig(u,s,o,h,p);this.configureTransmuxer(W)}if(this.frag=n,this.part=g,e)e.postMessage({cmd:"demux",data:m,decryptdata:E,chunkMeta:l,state:K},m instanceof ArrayBuffer?[m]:[]);else if(f){var G=f.push(m,E,l,K);(0,b.isPromise)(G)?(f.async=!0,G.then(function(j){t.handleTransmuxComplete(j)}).catch(function(j){t.transmuxerError(j,l,"transmuxer-interface push error")})):(f.async=!1,this.handleTransmuxComplete(G))}},c.flush=function(m){var o=this;m.transmuxing.start=self.performance.now();var u=this.transmuxer,s=this.worker;if(s)s.postMessage({cmd:"flush",chunkMeta:m});else if(u){var n=u.flush(m),g=(0,b.isPromise)(n);g||u.async?((0,b.isPromise)(n)||(n=Promise.resolve(n)),n.then(function(h){o.handleFlushResult(h,m)}).catch(function(h){o.transmuxerError(h,m,"transmuxer-interface flush error")})):this.handleFlushResult(n,m)}},c.transmuxerError=function(m,o,u){this.hls&&this.hls.trigger(A.Events.ERROR,{type:k.ErrorTypes.MEDIA_ERROR,details:k.ErrorDetails.FRAG_PARSING_ERROR,chunkMeta:o,fatal:!1,error:m,err:m,reason:u})},c.handleFlushResult=function(m,o){var u=this;m.forEach(function(s){u.handleTransmuxComplete(s)}),this.onFlush(o)},c.onWorkerMessage=function(m){var o=m.data,u=this.hls;switch(o.event){case"init":{self.URL.revokeObjectURL(this.worker.objectURL);break}case"transmuxComplete":{this.handleTransmuxComplete(o.data);break}case"flush":{this.onFlush(o.data);break}case"workerLog":R.logger[o.data.logType]&&R.logger[o.data.logType](o.data.message);break;default:{o.data=o.data||{},o.data.frag=this.frag,o.data.id=this.id,u.trigger(o.event,o.data);break}}},c.configureTransmuxer=function(m){var o=this.worker,u=this.transmuxer;o?o.postMessage({cmd:"configure",config:m}):u&&u.configure(m)},c.handleTransmuxComplete=function(m){m.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(m)},T}()},"./src/demux/transmuxer-worker.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>P});var F=x("./src/demux/transmuxer.ts"),A=x("./src/events.ts"),b=x("./src/utils/logger.ts"),R=x("./node_modules/eventemitter3/index.js"),k=x("./src/errors.ts");function P(c){var y=new R.EventEmitter,m=function(s,n){c.postMessage({event:s,data:n})};y.on(A.Events.FRAG_DECRYPTED,m),y.on(A.Events.ERROR,m);var o=function(){var s=function(h){var r=function(p){m("workerLog",{logType:h,message:p})};b.logger[h]=r};for(var n in b.logger)s(n)};c.addEventListener("message",function(u){var s=u.data;switch(s.cmd){case"init":{var n=JSON.parse(s.config);c.transmuxer=new F.default(y,s.typeSupported,n,s.vendor,s.id),(0,b.enableLogs)(n.debug,s.id),o(),m("init",null);break}case"configure":{c.transmuxer.configure(s.config);break}case"demux":{var g=c.transmuxer.push(s.data,s.decryptdata,s.chunkMeta,s.state);(0,F.isPromise)(g)?(c.transmuxer.async=!0,g.then(function(p){L(c,p)}).catch(function(p){m(A.Events.ERROR,{type:k.ErrorTypes.MEDIA_ERROR,details:k.ErrorDetails.FRAG_PARSING_ERROR,chunkMeta:s.chunkMeta,fatal:!1,error:p,err:p,reason:"transmuxer-worker push error"})})):(c.transmuxer.async=!1,L(c,g));break}case"flush":{var h=s.chunkMeta,r=c.transmuxer.flush(h),l=(0,F.isPromise)(r);l||c.transmuxer.async?((0,F.isPromise)(r)||(r=Promise.resolve(r)),r.then(function(p){_(c,p,h)}).catch(function(p){m(A.Events.ERROR,{type:k.ErrorTypes.MEDIA_ERROR,details:k.ErrorDetails.FRAG_PARSING_ERROR,chunkMeta:s.chunkMeta,fatal:!1,error:p,err:p,reason:"transmuxer-worker flush error"})})):_(c,r,h);break}}})}function L(c,y){if(T(y.remuxResult))return!1;var m=[],o=y.remuxResult,u=o.audio,s=o.video;return u&&S(m,u),s&&S(m,s),c.postMessage({event:"transmuxComplete",data:y},m),!0}function S(c,y){y.data1&&c.push(y.data1.buffer),y.data2&&c.push(y.data2.buffer)}function _(c,y,m){var o=y.reduce(function(u,s){return L(c,s)||u},!1);o||c.postMessage({event:"transmuxComplete",data:y[0]}),c.postMessage({event:"flush",data:m})}function T(c){return!c.audio&&!c.video&&!c.text&&!c.id3&&!c.initSegment}},"./src/demux/transmuxer.ts":(Y,B,x)=>{x.r(B),x.d(B,{TransmuxConfig:()=>n,TransmuxState:()=>g,default:()=>m,isPromise:()=>s});var F=x("./src/events.ts"),A=x("./src/errors.ts"),b=x("./src/crypt/decrypter.ts"),R=x("./src/demux/aacdemuxer.ts"),k=x("./src/demux/mp4demuxer.ts"),P=x("./src/demux/tsdemuxer.ts"),L=x("./src/demux/mp3demuxer.ts"),S=x("./src/remux/mp4-remuxer.ts"),_=x("./src/remux/passthrough-remuxer.ts"),T=x("./src/utils/logger.ts"),c;try{c=self.performance.now.bind(self.performance)}catch{T.logger.debug("Unable to use Performance API on this environment"),c=self.Date.now}var y=[{demux:k.default,remux:_.default},{demux:P.default,remux:S.default},{demux:R.default,remux:S.default},{demux:L.default,remux:S.default}],m=function(){function h(l,p,i,a,t){this.async=!1,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=l,this.typeSupported=p,this.config=i,this.vendor=a,this.id=t}var r=h.prototype;return r.configure=function(p){this.transmuxConfig=p,this.decrypter&&this.decrypter.reset()},r.push=function(p,i,a,t){var f=this,e=a.transmuxing;e.executeStart=c();var d=new Uint8Array(p),E=this.currentTransmuxState,v=this.transmuxConfig;t&&(this.currentTransmuxState=t);var D=t||E,I=D.contiguous,O=D.discontinuity,C=D.trackSwitch,M=D.accurateTimeOffset,U=D.timeOffset,w=D.initSegmentChange,N=v.audioCodec,K=v.videoCodec,W=v.defaultInitPts,G=v.duration,j=v.initSegmentData,H=o(d,i);if(H&&H.method==="AES-128"){var V=this.getDecrypter();if(V.isSync()){var z=V.softwareDecrypt(d,H.key.buffer,H.iv.buffer),$=a.part>-1;if($&&(z=V.flush()),!z)return e.executeEnd=c(),u(a);d=new Uint8Array(z)}else return this.decryptionPromise=V.webCryptoDecrypt(d,H.key.buffer,H.iv.buffer).then(function(J){var q=f.push(J,null,a);return f.decryptionPromise=null,q}),this.decryptionPromise}var Q=this.needsProbing(O,C);Q&&this.configureTransmuxer(d),(O||C||w||Q)&&this.resetInitSegment(j,N,K,G,i),(O||w||Q)&&this.resetInitialTimestamp(W),I||this.resetContiguity();var X=this.transmux(d,H,U,M,a),Z=this.currentTransmuxState;return Z.contiguous=!0,Z.discontinuity=!1,Z.trackSwitch=!1,e.executeEnd=c(),X},r.flush=function(p){var i=this,a=p.transmuxing;a.executeStart=c();var t=this.decrypter,f=this.currentTransmuxState,e=this.decryptionPromise;if(e)return e.then(function(){return i.flush(p)});var d=[],E=f.timeOffset;if(t){var v=t.flush();v&&d.push(this.push(v,null,p))}var D=this.demuxer,I=this.remuxer;if(!D||!I)return this.observer.emit(F.Events.ERROR,F.Events.ERROR,{type:A.ErrorTypes.MEDIA_ERROR,details:A.ErrorDetails.FRAG_PARSING_ERROR,fatal:!0,reason:"no demux matching with content found"}),a.executeEnd=c(),[u(p)];var O=D.flush(E);return s(O)?O.then(function(C){return i.flushRemux(d,C,p),d}):(this.flushRemux(d,O,p),d)},r.flushRemux=function(p,i,a){var t=i.audioTrack,f=i.videoTrack,e=i.id3Track,d=i.textTrack,E=this.currentTransmuxState,v=E.accurateTimeOffset,D=E.timeOffset;T.logger.log("[transmuxer.ts]: Flushed fragment "+a.sn+(a.part>-1?" p: "+a.part:"")+" of level "+a.level);var I=this.remuxer.remux(t,f,e,d,D,v,!0,this.id);p.push({remuxResult:I,chunkMeta:a}),a.transmuxing.executeEnd=c()},r.resetInitialTimestamp=function(p){var i=this.demuxer,a=this.remuxer;!i||!a||(i.resetTimeStamp(p),a.resetTimeStamp(p))},r.resetContiguity=function(){var p=this.demuxer,i=this.remuxer;!p||!i||(p.resetContiguity(),i.resetNextTimestamp())},r.resetInitSegment=function(p,i,a,t,f){var e=this.demuxer,d=this.remuxer;!e||!d||(e.resetInitSegment(p,i,a,t),d.resetInitSegment(p,i,a,f))},r.destroy=function(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)},r.transmux=function(p,i,a,t,f){var e;return i&&i.method==="SAMPLE-AES"?e=this.transmuxSampleAes(p,i,a,t,f):e=this.transmuxUnencrypted(p,a,t,f),e},r.transmuxUnencrypted=function(p,i,a,t){var f=this.demuxer.demux(p,i,!1,!this.config.progressive),e=f.audioTrack,d=f.videoTrack,E=f.id3Track,v=f.textTrack,D=this.remuxer.remux(e,d,E,v,i,a,!1,this.id);return{remuxResult:D,chunkMeta:t}},r.transmuxSampleAes=function(p,i,a,t,f){var e=this;return this.demuxer.demuxSampleAes(p,i,a).then(function(d){var E=e.remuxer.remux(d.audioTrack,d.videoTrack,d.id3Track,d.textTrack,a,t,!1,e.id);return{remuxResult:E,chunkMeta:f}})},r.configureTransmuxer=function(p){for(var i=this.config,a=this.observer,t=this.typeSupported,f=this.vendor,e,d=0,E=y.length;d<E;d++)if(y[d].demux.probe(p)){e=y[d];break}e||(T.logger.warn("Failed to find demuxer by probing frag, treating as mp4 passthrough"),e={demux:k.default,remux:_.default});var v=this.demuxer,D=this.remuxer,I=e.remux,O=e.demux;(!D||!(D instanceof I))&&(this.remuxer=new I(a,i,t,f)),(!v||!(v instanceof O))&&(this.demuxer=new O(a,i,t),this.probe=O.probe)},r.needsProbing=function(p,i){return!this.demuxer||!this.remuxer||p||i},r.getDecrypter=function(){var p=this.decrypter;return p||(p=this.decrypter=new b.default(this.config)),p},h}();function o(h,r){var l=null;return h.byteLength>0&&r!=null&&r.key!=null&&r.iv!==null&&r.method!=null&&(l=r),l}var u=function(r){return{remuxResult:{},chunkMeta:r}};function s(h){return"then"in h&&h.then instanceof Function}var n=function(r,l,p,i,a){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=r,this.videoCodec=l,this.initSegmentData=p,this.duration=i,this.defaultInitPts=a},g=function(r,l,p,i,a,t){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=r,this.contiguous=l,this.accurateTimeOffset=p,this.trackSwitch=i,this.timeOffset=a,this.initSegmentChange=t}},"./src/demux/tsdemuxer.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>h});var F=x("./src/demux/adts.ts"),A=x("./src/demux/mpegaudio.ts"),b=x("./src/demux/exp-golomb.ts"),R=x("./src/demux/sample-aes.ts"),k=x("./src/events.ts"),P=x("./src/utils/mp4-tools.ts"),L=x("./src/utils/logger.ts"),S=x("./src/errors.ts"),_=x("./src/types/demuxer.ts");function T(){return T=Object.assign?Object.assign.bind():function(r){for(var l=1;l<arguments.length;l++){var p=arguments[l];for(var i in p)Object.prototype.hasOwnProperty.call(p,i)&&(r[i]=p[i])}return r},T.apply(this,arguments)}var c=188,y=function(){function r(p,i,a){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._avcTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.avcSample=null,this.remainderData=null,this.observer=p,this.config=i,this.typeSupported=a}r.probe=function(i){var a=r.syncOffset(i);return a>0&&L.logger.warn("MPEG2-TS detected but first sync word found @ offset "+a),a!==-1},r.syncOffset=function(i){for(var a=i.length,t=Math.min(c*5,i.length-c)+1,f=0;f<t;){for(var e=!1,d=f;d<a&&i[d]===71;d+=c)if(!e&&o(i,d)===0&&(e=!0),e&&d+c>t)return f;f++}return-1},r.createTrack=function(i,a){return{container:i==="video"||i==="audio"?"video/mp2t":void 0,type:i,id:P.RemuxerTrackIdConfig[i],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:i==="audio"?a:void 0}};var l=r.prototype;return l.resetInitSegment=function(i,a,t,f){this.pmtParsed=!1,this._pmtId=-1,this._avcTrack=r.createTrack("video"),this._audioTrack=r.createTrack("audio",f),this._id3Track=r.createTrack("id3"),this._txtTrack=r.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.avcSample=null,this.remainderData=null,this.audioCodec=a,this.videoCodec=t,this._duration=f},l.resetTimeStamp=function(){},l.resetContiguity=function(){var i=this._audioTrack,a=this._avcTrack,t=this._id3Track;i&&(i.pesData=null),a&&(a.pesData=null),t&&(t.pesData=null),this.aacOverFlow=null,this.avcSample=null,this.remainderData=null},l.demux=function(i,a,t,f){t===void 0&&(t=!1),f===void 0&&(f=!1),t||(this.sampleAes=null);var e,d=this._avcTrack,E=this._audioTrack,v=this._id3Track,D=this._txtTrack,I=d.pid,O=d.pesData,C=E.pid,M=v.pid,U=E.pesData,w=v.pesData,N=null,K=this.pmtParsed,W=this._pmtId,G=i.length;if(this.remainderData&&(i=(0,P.appendUint8Array)(this.remainderData,i),G=i.length,this.remainderData=null),G<c&&!f)return this.remainderData=i,{audioTrack:E,videoTrack:d,id3Track:v,textTrack:D};var j=Math.max(0,r.syncOffset(i));G-=(G-j)%c,G<i.byteLength&&!f&&(this.remainderData=new Uint8Array(i.buffer,G,i.buffer.byteLength-G));for(var H=0,V=j;V<G;V+=c)if(i[V]===71){var z=!!(i[V+1]&64),$=o(i,V),Q=(i[V+3]&48)>>4,X=void 0;if(Q>1){if(X=V+5+i[V+4],X===V+c)continue}else X=V+4;switch($){case I:z&&(O&&(e=n(O))&&this.parseAVCPES(d,D,e,!1),O={data:[],size:0}),O&&(O.data.push(i.subarray(X,V+c)),O.size+=V+c-X);break;case C:if(z){if(U&&(e=n(U)))switch(E.segmentCodec){case"aac":this.parseAACPES(E,e);break;case"mp3":this.parseMPEGPES(E,e);break}U={data:[],size:0}}U&&(U.data.push(i.subarray(X,V+c)),U.size+=V+c-X);break;case M:z&&(w&&(e=n(w))&&this.parseID3PES(v,e),w={data:[],size:0}),w&&(w.data.push(i.subarray(X,V+c)),w.size+=V+c-X);break;case 0:z&&(X+=i[X]+1),W=this._pmtId=u(i,X);break;case W:{z&&(X+=i[X]+1);var Z=s(i,X,this.typeSupported,t);I=Z.avc,I>0&&(d.pid=I),C=Z.audio,C>0&&(E.pid=C,E.segmentCodec=Z.segmentCodec),M=Z.id3,M>0&&(v.pid=M),N!==null&&!K&&(L.logger.warn("MPEG-TS PMT found at "+V+" after unknown PID '"+N+"'. Backtracking to sync byte @"+j+" to parse all TS packets."),N=null,V=j-188),K=this.pmtParsed=!0;break}case 17:case 8191:break;default:N=$;break}}else H++;H>0&&this.observer.emit(k.Events.ERROR,k.Events.ERROR,{type:S.ErrorTypes.MEDIA_ERROR,details:S.ErrorDetails.FRAG_PARSING_ERROR,fatal:!1,reason:"Found "+H+" TS packet/s that do not start with 0x47"}),d.pesData=O,E.pesData=U,v.pesData=w;var J={audioTrack:E,videoTrack:d,id3Track:v,textTrack:D};return f&&this.extractRemainingSamples(J),J},l.flush=function(){var i=this.remainderData;this.remainderData=null;var a;return i?a=this.demux(i,-1,!1,!0):a={videoTrack:this._avcTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(a),this.sampleAes?this.decrypt(a,this.sampleAes):a},l.extractRemainingSamples=function(i){var a=i.audioTrack,t=i.videoTrack,f=i.id3Track,e=i.textTrack,d=t.pesData,E=a.pesData,v=f.pesData,D;if(d&&(D=n(d))?(this.parseAVCPES(t,e,D,!0),t.pesData=null):t.pesData=d,E&&(D=n(E))){switch(a.segmentCodec){case"aac":this.parseAACPES(a,D);break;case"mp3":this.parseMPEGPES(a,D);break}a.pesData=null}else E!=null&&E.size&&L.logger.log("last AAC PES packet truncated,might overlap between fragments"),a.pesData=E;v&&(D=n(v))?(this.parseID3PES(f,D),f.pesData=null):f.pesData=v},l.demuxSampleAes=function(i,a,t){var f=this.demux(i,t,!0,!this.config.progressive),e=this.sampleAes=new R.default(this.observer,this.config,a);return this.decrypt(f,e)},l.decrypt=function(i,a){return new Promise(function(t){var f=i.audioTrack,e=i.videoTrack;f.samples&&f.segmentCodec==="aac"?a.decryptAacSamples(f.samples,0,function(){e.samples?a.decryptAvcSamples(e.samples,0,0,function(){t(i)}):t(i)}):e.samples&&a.decryptAvcSamples(e.samples,0,0,function(){t(i)})})},l.destroy=function(){this._duration=0},l.parseAVCPES=function(i,a,t,f){var e=this,d=this.parseAVCNALu(i,t.data),E=this.avcSample,v,D=!1;t.data=null,E&&d.length&&!i.audFound&&(g(E,i),E=this.avcSample=m(!1,t.pts,t.dts,"")),d.forEach(function(I){switch(I.type){case 1:{v=!0,E||(E=e.avcSample=m(!0,t.pts,t.dts,"")),E.frame=!0;var O=I.data;if(D&&O.length>4){var C=new b.default(O).readSliceType();(C===2||C===4||C===7||C===9)&&(E.key=!0)}break}case 5:v=!0,E||(E=e.avcSample=m(!0,t.pts,t.dts,"")),E.key=!0,E.frame=!0;break;case 6:{v=!0,(0,P.parseSEIMessageFromNALu)(I.data,1,t.pts,a.samples);break}case 7:if(v=!0,D=!0,!i.sps){var M=new b.default(I.data),U=M.readSPS();i.width=U.width,i.height=U.height,i.pixelRatio=U.pixelRatio,i.sps=[I.data],i.duration=e._duration;for(var w=I.data.subarray(1,4),N="avc1.",K=0;K<3;K++){var W=w[K].toString(16);W.length<2&&(W="0"+W),N+=W}i.codec=N}break;case 8:v=!0,i.pps||(i.pps=[I.data]);break;case 9:v=!1,i.audFound=!0,E&&g(E,i),E=e.avcSample=m(!1,t.pts,t.dts,"");break;case 12:v=!0;break;default:v=!1,E&&(E.debug+="unknown NAL "+I.type+" ");break}if(E&&v){var G=E.units;G.push(I)}}),f&&E&&(g(E,i),this.avcSample=null)},l.getLastNalUnit=function(i){var a,t=this.avcSample,f;if((!t||t.units.length===0)&&(t=i[i.length-1]),(a=t)!==null&&a!==void 0&&a.units){var e=t.units;f=e[e.length-1]}return f},l.parseAVCNALu=function(i,a){var t=a.byteLength,f=i.naluState||0,e=f,d=[],E=0,v,D,I,O=-1,C=0;for(f===-1&&(O=0,C=a[0]&31,f=0,E=1);E<t;){if(v=a[E++],!f){f=v?0:1;continue}if(f===1){f=v?0:2;continue}if(!v)f=3;else if(v===1){if(O>=0){var M={data:a.subarray(O,E-f-1),type:C};d.push(M)}else{var U=this.getLastNalUnit(i.samples);if(U&&(e&&E<=4-e&&U.state&&(U.data=U.data.subarray(0,U.data.byteLength-e)),D=E-f-1,D>0)){var w=new Uint8Array(U.data.byteLength+D);w.set(U.data,0),w.set(a.subarray(0,D),U.data.byteLength),U.data=w,U.state=0}}E<t?(I=a[E]&31,O=E,C=I,f=0):f=-1}else f=0}if(O>=0&&f>=0){var N={data:a.subarray(O,t),type:C,state:f};d.push(N)}if(d.length===0){var K=this.getLastNalUnit(i.samples);if(K){var W=new Uint8Array(K.data.byteLength+a.byteLength);W.set(K.data,0),W.set(a,K.data.byteLength),K.data=W}}return i.naluState=f,d},l.parseAACPES=function(i,a){var t=0,f=this.aacOverFlow,e=a.data;if(f){this.aacOverFlow=null;var d=f.missing,E=f.sample.unit.byteLength;if(d===-1){var v=new Uint8Array(E+e.byteLength);v.set(f.sample.unit,0),v.set(e,E),e=v}else{var D=E-d;f.sample.unit.set(e.subarray(0,d),D),i.samples.push(f.sample),t=f.missing}}var I,O;for(I=t,O=e.length;I<O-1&&!F.isHeader(e,I);I++);if(I!==t){var C,M;if(I<O-1?(C="AAC PES did not start with ADTS header,offset:"+I,M=!1):(C="no ADTS header found in AAC PES",M=!0),L.logger.warn("parsing error:"+C),this.observer.emit(k.Events.ERROR,k.Events.ERROR,{type:S.ErrorTypes.MEDIA_ERROR,details:S.ErrorDetails.FRAG_PARSING_ERROR,fatal:M,reason:C}),M)return}F.initTrackConfig(i,this.observer,e,I,this.audioCodec);var U;if(a.pts!==void 0)U=a.pts;else if(f){var w=F.getFrameDuration(i.samplerate);U=f.sample.pts+w}else{L.logger.warn("[tsdemuxer]: AAC PES unknown PTS");return}for(var N=0,K;I<O;)if(K=F.appendFrame(i,e,I,U,N),I+=K.length,K.missing){this.aacOverFlow=K;break}else for(N++;I<O-1&&!F.isHeader(e,I);I++);},l.parseMPEGPES=function(i,a){var t=a.data,f=t.length,e=0,d=0,E=a.pts;if(E===void 0){L.logger.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;d<f;)if(A.isHeader(t,d)){var v=A.appendFrame(i,t,d,E,e);if(v)d+=v.length,e++;else break}else d++},l.parseID3PES=function(i,a){if(a.pts===void 0){L.logger.warn("[tsdemuxer]: ID3 PES unknown PTS");return}var t=T({},a,{type:this._avcTrack?_.MetadataSchema.emsg:_.MetadataSchema.audioId3,duration:Number.POSITIVE_INFINITY});i.samples.push(t)},r}();function m(r,l,p,i){return{key:r,frame:!1,pts:l,dts:p,units:[],debug:i,length:0}}function o(r,l){return((r[l+1]&31)<<8)+r[l+2]}function u(r,l){return(r[l+10]&31)<<8|r[l+11]}function s(r,l,p,i){var a={audio:-1,avc:-1,id3:-1,segmentCodec:"aac"},t=(r[l+1]&15)<<8|r[l+2],f=l+3+t-4,e=(r[l+10]&15)<<8|r[l+11];for(l+=12+e;l<f;){var d=o(r,l);switch(r[l]){case 207:if(!i){L.logger.log("ADTS AAC with AES-128-CBC frame encryption found in unencrypted stream");break}case 15:a.audio===-1&&(a.audio=d);break;case 21:a.id3===-1&&(a.id3=d);break;case 219:if(!i){L.logger.log("H.264 with AES-128-CBC slice encryption found in unencrypted stream");break}case 27:a.avc===-1&&(a.avc=d);break;case 3:case 4:p.mpeg!==!0&&p.mp3!==!0?L.logger.log("MPEG audio found, not supported in this browser"):a.audio===-1&&(a.audio=d,a.segmentCodec="mp3");break;case 36:L.logger.warn("Unsupported HEVC stream type found");break}l+=((r[l+3]&15)<<8|r[l+4])+5}return a}function n(r){var l=0,p,i,a,t,f,e=r.data;if(!r||r.size===0)return null;for(;e[0].length<19&&e.length>1;){var d=new Uint8Array(e[0].length+e[1].length);d.set(e[0]),d.set(e[1],e[0].length),e[0]=d,e.splice(1,1)}p=e[0];var E=(p[0]<<16)+(p[1]<<8)+p[2];if(E===1){if(i=(p[4]<<8)+p[5],i&&i>r.size-6)return null;var v=p[7];v&192&&(t=(p[9]&14)*536870912+(p[10]&255)*4194304+(p[11]&254)*16384+(p[12]&255)*128+(p[13]&254)/2,v&64?(f=(p[14]&14)*536870912+(p[15]&255)*4194304+(p[16]&254)*16384+(p[17]&255)*128+(p[18]&254)/2,t-f>54e5&&(L.logger.warn(Math.round((t-f)/9e4)+"s delta between PTS and DTS, align them"),t=f)):f=t),a=p[8];var D=a+9;if(r.size<=D)return null;r.size-=D;for(var I=new Uint8Array(r.size),O=0,C=e.length;O<C;O++){p=e[O];var M=p.byteLength;if(D)if(D>M){D-=M;continue}else p=p.subarray(D),M-=D,D=0;I.set(p,l),l+=M}return i&&(i-=a+3),{data:I,pts:t,dts:f,len:i}}return null}function g(r,l){if(r.units.length&&r.frame){if(r.pts===void 0){var p=l.samples,i=p.length;if(i){var a=p[i-1];r.pts=a.pts,r.dts=a.dts}else{l.dropped++;return}}l.samples.push(r)}r.debug.length&&L.logger.log(r.pts+"/"+r.dts+":"+r.debug)}const h=y},"./src/demux/webworkify-webpack.js":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>c});var F=function(){var m=ENTRY_MODULE,o={},u=function n(g){var h=o[g];if(h!==void 0)return h.exports;var r=o[g]={exports:{}};return m[g].call(r.exports,r,r.exports,n),r.exports};u.m=m,function(){u.n=function(n){var g=n&&n.__esModule?function(){return n.default}:function(){return n};return u.d(g,{a:g}),g}}(),function(){u.d=function(n,g){for(var h in g)u.o(g,h)&&!u.o(n,h)&&Object.defineProperty(n,h,{enumerable:!0,get:g[h]})}}(),function(){u.o=function(n,g){return Object.prototype.hasOwnProperty.call(n,g)}}(),function(){u.r=function(n){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})}}();var s=u(ENTRY_MODULE);return s.default||s},A=F.toString().split("ENTRY_MODULE"),b="[\\.|\\-|\\+|\\w|/|@]+",R="\\(\\s*(/\\*.*?\\*/)?\\s*.*?("+b+").*?\\)";function k(y){return(y+"").replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")}function P(y){return!isNaN(1*y)}function L(y,m,o){var u={};u[o]=[];var s=m.toString().replace(/^"[^"]+"/,"function"),n=s.match(/^function\s?\w*\(\w+,\s*\w+,\s*(\w+)\)/)||s.match(/^\(\w+,\s*\w+,\s*(\w+)\)\s?\=\s?\>/);if(!n)return u;for(var g=n[1],h=new RegExp("(\\\\n|\\W)"+k(g)+R,"g"),r;r=h.exec(s);)r[3]!=="dll-reference"&&u[o].push(r[3]);for(h=new RegExp("\\("+k(g)+'\\("(dll-reference\\s('+b+'))"\\)\\)'+R,"g");r=h.exec(s);)y[r[2]]||(u[o].push(r[1]),y[r[2]]=x(r[1]).m),u[r[2]]=u[r[2]]||[],u[r[2]].push(r[4]);for(var l=Object.keys(u),p=0;p<l.length;p++)for(var i=0;i<u[l[p]].length;i++)P(u[l[p]][i])&&(u[l[p]][i]=1*u[l[p]][i]);return u}function S(y){var m=Object.keys(y);return m.reduce(function(o,u){return o||y[u].length>0},!1)}function _(y,m){for(var o={main:[m]},u={main:[]},s={main:{}};S(o);)for(var n=Object.keys(o),g=0;g<n.length;g++){var h=n[g],r=o[h],l=r.pop();if(s[h]=s[h]||{},!(s[h][l]||!y[h][l])){s[h][l]=!0,u[h]=u[h]||[],u[h].push(l);for(var p=L(y,y[h][l],h),i=Object.keys(p),a=0;a<i.length;a++)o[i[a]]=o[i[a]]||[],o[i[a]]=o[i[a]].concat(p[i[a]])}}return u}function T(y,m,o,u){var s=y[u].map(function(n){return'"'+n+'": '+m[u][n].toString().replace(/^"[^"]+"/,"function")}).join(",");return A[0]+"{"+s+"}"+A[1]+'"'+o+'"'+A[2]}function c(y,m){m=m||{};var o={main:x.m},u=m.all?{main:Object.keys(o.main)}:_(o,y),s="";Object.keys(u).filter(function(l){return l!=="main"}).forEach(function(l){for(var p=0;u[l][p];)p++;u[l].push(p),o[l][p]="(function(module, exports, __webpack_require__) { module.exports = __webpack_require__; })",s=s+("var "+l+" = ("+T(u,o,p,modules)+`)();
`)}),s=s+("new (("+T(u,o,y,"main")+")())(self);");var n=new window.Blob([s],{type:"text/javascript"}),g=window.URL||window.webkitURL||window.mozURL||window.msURL,h=g.createObjectURL(n),r=new window.Worker(h);return r.objectURL=h,r}},"./src/errors.ts":(Y,B,x)=>{x.r(B),x.d(B,{ErrorDetails:()=>A,ErrorTypes:()=>F});var F;(function(b){b.NETWORK_ERROR="networkError",b.MEDIA_ERROR="mediaError",b.KEY_SYSTEM_ERROR="keySystemError",b.MUX_ERROR="muxError",b.OTHER_ERROR="otherError"})(F||(F={}));var A;(function(b){b.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",b.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",b.KEY_SYSTEM_NO_SESSION="keySystemNoSession",b.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",b.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",b.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",b.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",b.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",b.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",b.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",b.MANIFEST_LOAD_ERROR="manifestLoadError",b.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",b.MANIFEST_PARSING_ERROR="manifestParsingError",b.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",b.LEVEL_EMPTY_ERROR="levelEmptyError",b.LEVEL_LOAD_ERROR="levelLoadError",b.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",b.LEVEL_SWITCH_ERROR="levelSwitchError",b.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",b.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",b.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",b.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",b.FRAG_LOAD_ERROR="fragLoadError",b.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",b.FRAG_DECRYPT_ERROR="fragDecryptError",b.FRAG_PARSING_ERROR="fragParsingError",b.REMUX_ALLOC_ERROR="remuxAllocError",b.KEY_LOAD_ERROR="keyLoadError",b.KEY_LOAD_TIMEOUT="keyLoadTimeOut",b.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",b.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",b.BUFFER_APPEND_ERROR="bufferAppendError",b.BUFFER_APPENDING_ERROR="bufferAppendingError",b.BUFFER_STALLED_ERROR="bufferStalledError",b.BUFFER_FULL_ERROR="bufferFullError",b.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",b.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",b.INTERNAL_EXCEPTION="internalException",b.INTERNAL_ABORTED="aborted",b.UNKNOWN="unknown"})(A||(A={}))},"./src/events.ts":(Y,B,x)=>{x.r(B),x.d(B,{Events:()=>F});var F;(function(A){A.MEDIA_ATTACHING="hlsMediaAttaching",A.MEDIA_ATTACHED="hlsMediaAttached",A.MEDIA_DETACHING="hlsMediaDetaching",A.MEDIA_DETACHED="hlsMediaDetached",A.BUFFER_RESET="hlsBufferReset",A.BUFFER_CODECS="hlsBufferCodecs",A.BUFFER_CREATED="hlsBufferCreated",A.BUFFER_APPENDING="hlsBufferAppending",A.BUFFER_APPENDED="hlsBufferAppended",A.BUFFER_EOS="hlsBufferEos",A.BUFFER_FLUSHING="hlsBufferFlushing",A.BUFFER_FLUSHED="hlsBufferFlushed",A.MANIFEST_LOADING="hlsManifestLoading",A.MANIFEST_LOADED="hlsManifestLoaded",A.MANIFEST_PARSED="hlsManifestParsed",A.LEVEL_SWITCHING="hlsLevelSwitching",A.LEVEL_SWITCHED="hlsLevelSwitched",A.LEVEL_LOADING="hlsLevelLoading",A.LEVEL_LOADED="hlsLevelLoaded",A.LEVEL_UPDATED="hlsLevelUpdated",A.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",A.LEVELS_UPDATED="hlsLevelsUpdated",A.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",A.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",A.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",A.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",A.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",A.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",A.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",A.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",A.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",A.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",A.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",A.CUES_PARSED="hlsCuesParsed",A.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",A.INIT_PTS_FOUND="hlsInitPtsFound",A.FRAG_LOADING="hlsFragLoading",A.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",A.FRAG_LOADED="hlsFragLoaded",A.FRAG_DECRYPTED="hlsFragDecrypted",A.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",A.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",A.FRAG_PARSING_METADATA="hlsFragParsingMetadata",A.FRAG_PARSED="hlsFragParsed",A.FRAG_BUFFERED="hlsFragBuffered",A.FRAG_CHANGED="hlsFragChanged",A.FPS_DROP="hlsFpsDrop",A.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",A.ERROR="hlsError",A.DESTROYING="hlsDestroying",A.KEY_LOADING="hlsKeyLoading",A.KEY_LOADED="hlsKeyLoaded",A.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",A.BACK_BUFFER_REACHED="hlsBackBufferReached"})(F||(F={}))},"./src/hls.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>r});var F=x("./node_modules/url-toolkit/src/url-toolkit.js"),A=x("./src/loader/playlist-loader.ts"),b=x("./src/controller/id3-track-controller.ts"),R=x("./src/controller/latency-controller.ts"),k=x("./src/controller/level-controller.ts"),P=x("./src/controller/fragment-tracker.ts"),L=x("./src/loader/key-loader.ts"),S=x("./src/controller/stream-controller.ts"),_=x("./src/is-supported.ts"),T=x("./src/utils/logger.ts"),c=x("./src/config.ts"),y=x("./node_modules/eventemitter3/index.js"),m=x("./src/events.ts"),o=x("./src/errors.ts"),u=x("./src/types/level.ts");function s(l,p){for(var i=0;i<p.length;i++){var a=p[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(l,g(a.key),a)}}function n(l,p,i){return p&&s(l.prototype,p),i&&s(l,i),Object.defineProperty(l,"prototype",{writable:!1}),l}function g(l){var p=h(l,"string");return typeof p=="symbol"?p:String(p)}function h(l,p){if(typeof l!="object"||l===null)return l;var i=l[Symbol.toPrimitive];if(i!==void 0){var a=i.call(l,p);if(typeof a!="object")return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(l)}var r=function(){l.isSupported=function(){return(0,_.isSupported)()};function l(i){i===void 0&&(i={}),this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new y.EventEmitter,this._autoLevelCapping=void 0,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null;var a=this.config=(0,c.mergeConfig)(l.DefaultConfig,i);this.userConfig=i,(0,T.enableLogs)(a.debug,"Hls instance"),this._autoLevelCapping=-1,a.progressive&&(0,c.enableStreamingMode)(a);var t=a.abrController,f=a.bufferController,e=a.capLevelController,d=a.fpsController,E=this.abrController=new t(this),v=this.bufferController=new f(this),D=this.capLevelController=new e(this),I=new d(this),O=new A.default(this),C=new b.default(this),M=this.levelController=new k.default(this),U=new P.FragmentTracker(this),w=new L.default(this.config),N=this.streamController=new S.default(this,U,w);D.setStreamController(N),I.setStreamController(N);var K=[O,M,N];this.networkControllers=K;var W=[E,v,D,I,C,U];this.audioTrackController=this.createController(a.audioTrackController,K);var G=a.audioStreamController;G&&K.push(new G(this,U,w)),this.subtitleTrackController=this.createController(a.subtitleTrackController,K);var j=a.subtitleStreamController;j&&K.push(new j(this,U,w)),this.createController(a.timelineController,W),w.emeController=this.emeController=this.createController(a.emeController,W),this.cmcdController=this.createController(a.cmcdController,W),this.latencyController=this.createController(R.default,W),this.coreComponents=W}var p=l.prototype;return p.createController=function(a,t){if(a){var f=new a(this);return t&&t.push(f),f}return null},p.on=function(a,t,f){f===void 0&&(f=this),this._emitter.on(a,t,f)},p.once=function(a,t,f){f===void 0&&(f=this),this._emitter.once(a,t,f)},p.removeAllListeners=function(a){this._emitter.removeAllListeners(a)},p.off=function(a,t,f,e){f===void 0&&(f=this),this._emitter.off(a,t,f,e)},p.listeners=function(a){return this._emitter.listeners(a)},p.emit=function(a,t,f){return this._emitter.emit(a,t,f)},p.trigger=function(a,t){if(this.config.debug)return this.emit(a,a,t);try{return this.emit(a,a,t)}catch(f){T.logger.error("An internal error happened while handling event "+a+'. Error message: "'+f.message+'". Here is a stacktrace:',f),this.trigger(m.Events.ERROR,{type:o.ErrorTypes.OTHER_ERROR,details:o.ErrorDetails.INTERNAL_EXCEPTION,fatal:!1,event:a,error:f})}return!1},p.listenerCount=function(a){return this._emitter.listenerCount(a)},p.destroy=function(){T.logger.log("destroy"),this.trigger(m.Events.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach(function(a){return a.destroy()}),this.networkControllers.length=0,this.coreComponents.forEach(function(a){return a.destroy()}),this.coreComponents.length=0},p.attachMedia=function(a){T.logger.log("attachMedia"),this._media=a,this.trigger(m.Events.MEDIA_ATTACHING,{media:a})},p.detachMedia=function(){T.logger.log("detachMedia"),this.trigger(m.Events.MEDIA_DETACHING,void 0),this._media=null},p.loadSource=function(a){this.stopLoad();var t=this.media,f=this.url,e=this.url=F.buildAbsoluteURL(self.location.href,a,{alwaysNormalize:!0});T.logger.log("loadSource:"+e),t&&f&&f!==e&&this.bufferController.hasSourceTypes()&&(this.detachMedia(),this.attachMedia(t)),this.trigger(m.Events.MANIFEST_LOADING,{url:a})},p.startLoad=function(a){a===void 0&&(a=-1),T.logger.log("startLoad("+a+")"),this.networkControllers.forEach(function(t){t.startLoad(a)})},p.stopLoad=function(){T.logger.log("stopLoad"),this.networkControllers.forEach(function(a){a.stopLoad()})},p.swapAudioCodec=function(){T.logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()},p.recoverMediaError=function(){T.logger.log("recoverMediaError");var a=this._media;this.detachMedia(),a&&this.attachMedia(a)},p.removeLevel=function(a,t){t===void 0&&(t=0),this.levelController.removeLevel(a,t)},n(l,[{key:"levels",get:function(){var a=this.levelController.levels;return a||[]}},{key:"currentLevel",get:function(){return this.streamController.currentLevel},set:function(a){T.logger.log("set currentLevel:"+a),this.loadLevel=a,this.abrController.clearTimer(),this.streamController.immediateLevelSwitch()}},{key:"nextLevel",get:function(){return this.streamController.nextLevel},set:function(a){T.logger.log("set nextLevel:"+a),this.levelController.manualLevel=a,this.streamController.nextLevelSwitch()}},{key:"loadLevel",get:function(){return this.levelController.level},set:function(a){T.logger.log("set loadLevel:"+a),this.levelController.manualLevel=a}},{key:"nextLoadLevel",get:function(){return this.levelController.nextLoadLevel},set:function(a){this.levelController.nextLoadLevel=a}},{key:"firstLevel",get:function(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)},set:function(a){T.logger.log("set firstLevel:"+a),this.levelController.firstLevel=a}},{key:"startLevel",get:function(){return this.levelController.startLevel},set:function(a){T.logger.log("set startLevel:"+a),a!==-1&&(a=Math.max(a,this.minAutoLevel)),this.levelController.startLevel=a}},{key:"capLevelToPlayerSize",get:function(){return this.config.capLevelToPlayerSize},set:function(a){var t=!!a;t!==this.config.capLevelToPlayerSize&&(t?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=t)}},{key:"autoLevelCapping",get:function(){return this._autoLevelCapping},set:function(a){this._autoLevelCapping!==a&&(T.logger.log("set autoLevelCapping:"+a),this._autoLevelCapping=a)}},{key:"bandwidthEstimate",get:function(){var a=this.abrController.bwEstimator;return a?a.getEstimate():NaN}},{key:"maxHdcpLevel",get:function(){return this._maxHdcpLevel},set:function(a){u.HdcpLevels.indexOf(a)>-1&&(this._maxHdcpLevel=a)}},{key:"autoLevelEnabled",get:function(){return this.levelController.manualLevel===-1}},{key:"manualLevel",get:function(){return this.levelController.manualLevel}},{key:"minAutoLevel",get:function(){var a=this.levels,t=this.config.minAutoBitrate;if(!a)return 0;for(var f=a.length,e=0;e<f;e++)if(a[e].maxBitrate>=t)return e;return 0}},{key:"maxAutoLevel",get:function(){var a=this.levels,t=this.autoLevelCapping,f=this.maxHdcpLevel,e;if(t===-1&&a&&a.length?e=a.length-1:e=t,f)for(var d=e;d--;){var E=a[d].attrs["HDCP-LEVEL"];if(E&&E<=f)return d}return e}},{key:"nextAutoLevel",get:function(){return Math.min(Math.max(this.abrController.nextAutoLevel,this.minAutoLevel),this.maxAutoLevel)},set:function(a){this.abrController.nextAutoLevel=Math.max(this.minAutoLevel,a)}},{key:"playingDate",get:function(){return this.streamController.currentProgramDateTime}},{key:"mainForwardBufferInfo",get:function(){return this.streamController.getMainFwdBufferInfo()}},{key:"audioTracks",get:function(){var a=this.audioTrackController;return a?a.audioTracks:[]}},{key:"audioTrack",get:function(){var a=this.audioTrackController;return a?a.audioTrack:-1},set:function(a){var t=this.audioTrackController;t&&(t.audioTrack=a)}},{key:"subtitleTracks",get:function(){var a=this.subtitleTrackController;return a?a.subtitleTracks:[]}},{key:"subtitleTrack",get:function(){var a=this.subtitleTrackController;return a?a.subtitleTrack:-1},set:function(a){var t=this.subtitleTrackController;t&&(t.subtitleTrack=a)}},{key:"media",get:function(){return this._media}},{key:"subtitleDisplay",get:function(){var a=this.subtitleTrackController;return a?a.subtitleDisplay:!1},set:function(a){var t=this.subtitleTrackController;t&&(t.subtitleDisplay=a)}},{key:"lowLatencyMode",get:function(){return this.config.lowLatencyMode},set:function(a){this.config.lowLatencyMode=a}},{key:"liveSyncPosition",get:function(){return this.latencyController.liveSyncPosition}},{key:"latency",get:function(){return this.latencyController.latency}},{key:"maxLatency",get:function(){return this.latencyController.maxLatency}},{key:"targetLatency",get:function(){return this.latencyController.targetLatency}},{key:"drift",get:function(){return this.latencyController.drift}},{key:"forceStartLoad",get:function(){return this.streamController.forceStartLoad}}],[{key:"version",get:function(){return"1.3.5"}},{key:"Events",get:function(){return m.Events}},{key:"ErrorTypes",get:function(){return o.ErrorTypes}},{key:"ErrorDetails",get:function(){return o.ErrorDetails}},{key:"DefaultConfig",get:function(){return l.defaultConfig?l.defaultConfig:c.hlsDefaultConfig},set:function(a){l.defaultConfig=a}}]),l}();r.defaultConfig=void 0},"./src/is-supported.ts":(Y,B,x)=>{x.r(B),x.d(B,{changeTypeSupported:()=>R,isSupported:()=>b});var F=x("./src/utils/mediasource-helper.ts");function A(){return self.SourceBuffer||self.WebKitSourceBuffer}function b(){var k=(0,F.getMediaSource)();if(!k)return!1;var P=A(),L=k&&typeof k.isTypeSupported=="function"&&k.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"'),S=!P||P.prototype&&typeof P.prototype.appendBuffer=="function"&&typeof P.prototype.remove=="function";return!!L&&!!S}function R(){var k,P=A();return typeof(P==null||(k=P.prototype)===null||k===void 0?void 0:k.changeType)=="function"}},"./src/loader/date-range.ts":(Y,B,x)=>{x.r(B),x.d(B,{DateRange:()=>T,DateRangeAttribute:()=>_});var F=x("./src/polyfills/number.ts"),A=x("./src/utils/attr-list.ts"),b=x("./src/utils/logger.ts");function R(){return R=Object.assign?Object.assign.bind():function(c){for(var y=1;y<arguments.length;y++){var m=arguments[y];for(var o in m)Object.prototype.hasOwnProperty.call(m,o)&&(c[o]=m[o])}return c},R.apply(this,arguments)}function k(c,y){for(var m=0;m<y.length;m++){var o=y[m];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(c,L(o.key),o)}}function P(c,y,m){return y&&k(c.prototype,y),Object.defineProperty(c,"prototype",{writable:!1}),c}function L(c){var y=S(c,"string");return typeof y=="symbol"?y:String(y)}function S(c,y){if(typeof c!="object"||c===null)return c;var m=c[Symbol.toPrimitive];if(m!==void 0){var o=m.call(c,y);if(typeof o!="object")return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(c)}var _;(function(c){c.ID="ID",c.CLASS="CLASS",c.START_DATE="START-DATE",c.DURATION="DURATION",c.END_DATE="END-DATE",c.END_ON_NEXT="END-ON-NEXT",c.PLANNED_DURATION="PLANNED-DURATION",c.SCTE35_OUT="SCTE35-OUT",c.SCTE35_IN="SCTE35-IN"})(_||(_={}));var T=function(){function c(y,m){if(this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,m){var o=m.attr;for(var u in o)if(Object.prototype.hasOwnProperty.call(y,u)&&y[u]!==o[u]){b.logger.warn('DATERANGE tag attribute: "'+u+'" does not match for tags with ID: "'+y.ID+'"'),this._badValueForSameId=u;break}y=R(new A.AttrList({}),o,y)}if(this.attr=y,this._startDate=new Date(y[_.START_DATE]),_.END_DATE in this.attr){var s=new Date(this.attr[_.END_DATE]);(0,F.isFiniteNumber)(s.getTime())&&(this._endDate=s)}}return P(c,[{key:"id",get:function(){return this.attr.ID}},{key:"class",get:function(){return this.attr.CLASS}},{key:"startDate",get:function(){return this._startDate}},{key:"endDate",get:function(){if(this._endDate)return this._endDate;var m=this.duration;return m!==null?new Date(this._startDate.getTime()+m*1e3):null}},{key:"duration",get:function(){if(_.DURATION in this.attr){var m=this.attr.decimalFloatingPoint(_.DURATION);if((0,F.isFiniteNumber)(m))return m}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}},{key:"plannedDuration",get:function(){return _.PLANNED_DURATION in this.attr?this.attr.decimalFloatingPoint(_.PLANNED_DURATION):null}},{key:"endOnNext",get:function(){return this.attr.bool(_.END_ON_NEXT)}},{key:"isValid",get:function(){return!!this.id&&!this._badValueForSameId&&(0,F.isFiniteNumber)(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)}}]),c}()},"./src/loader/fragment-loader.ts":(Y,B,x)=>{x.r(B),x.d(B,{LoadError:()=>m,default:()=>c});var F=x("./src/polyfills/number.ts"),A=x("./src/errors.ts");function b(o,u){o.prototype=Object.create(u.prototype),o.prototype.constructor=o,S(o,u)}function R(o){var u=typeof Map=="function"?new Map:void 0;return R=function(n){if(n===null||!L(n))return n;if(typeof n!="function")throw new TypeError("Super expression must either be null or a function");if(typeof u<"u"){if(u.has(n))return u.get(n);u.set(n,g)}function g(){return k(n,arguments,_(this).constructor)}return g.prototype=Object.create(n.prototype,{constructor:{value:g,enumerable:!1,writable:!0,configurable:!0}}),S(g,n)},R(o)}function k(o,u,s){return P()?k=Reflect.construct.bind():k=function(g,h,r){var l=[null];l.push.apply(l,h);var p=Function.bind.apply(g,l),i=new p;return r&&S(i,r.prototype),i},k.apply(null,arguments)}function P(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function L(o){return Function.toString.call(o).indexOf("[native code]")!==-1}function S(o,u){return S=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(n,g){return n.__proto__=g,n},S(o,u)}function _(o){return _=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(s){return s.__proto__||Object.getPrototypeOf(s)},_(o)}var T=Math.pow(2,17),c=function(){function o(s){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=s}var u=o.prototype;return u.destroy=function(){this.loader&&(this.loader.destroy(),this.loader=null)},u.abort=function(){this.loader&&this.loader.abort()},u.load=function(n,g){var h=this,r=n.url;if(!r)return Promise.reject(new m({type:A.ErrorTypes.NETWORK_ERROR,details:A.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:n,networkDetails:null},"Fragment does not have a "+(r?"part list":"url")));this.abort();var l=this.config,p=l.fLoader,i=l.loader;return new Promise(function(a,t){h.loader&&h.loader.destroy();var f=h.loader=n.loader=p?new p(l):new i(l),e=y(n),d={timeout:l.fragLoadingTimeOut,maxRetry:0,retryDelay:0,maxRetryDelay:l.fragLoadingMaxRetryTimeout,highWaterMark:n.sn==="initSegment"?1/0:T};n.stats=f.stats,f.load(e,d,{onSuccess:function(v,D,I,O){h.resetLoader(n,f);var C=v.data;I.resetIV&&n.decryptdata&&(n.decryptdata.iv=new Uint8Array(C.slice(0,16)),C=C.slice(16)),a({frag:n,part:null,payload:C,networkDetails:O})},onError:function(v,D,I){h.resetLoader(n,f),t(new m({type:A.ErrorTypes.NETWORK_ERROR,details:A.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:n,response:v,networkDetails:I}))},onAbort:function(v,D,I){h.resetLoader(n,f),t(new m({type:A.ErrorTypes.NETWORK_ERROR,details:A.ErrorDetails.INTERNAL_ABORTED,fatal:!1,frag:n,networkDetails:I}))},onTimeout:function(v,D,I){h.resetLoader(n,f),t(new m({type:A.ErrorTypes.NETWORK_ERROR,details:A.ErrorDetails.FRAG_LOAD_TIMEOUT,fatal:!1,frag:n,networkDetails:I}))},onProgress:function(v,D,I,O){g&&g({frag:n,part:null,payload:I,networkDetails:O})}})})},u.loadPart=function(n,g,h){var r=this;this.abort();var l=this.config,p=l.fLoader,i=l.loader;return new Promise(function(a,t){r.loader&&r.loader.destroy();var f=r.loader=n.loader=p?new p(l):new i(l),e=y(n,g),d={timeout:l.fragLoadingTimeOut,maxRetry:0,retryDelay:0,maxRetryDelay:l.fragLoadingMaxRetryTimeout,highWaterMark:T};g.stats=f.stats,f.load(e,d,{onSuccess:function(v,D,I,O){r.resetLoader(n,f),r.updateStatsFromPart(n,g);var C={frag:n,part:g,payload:v.data,networkDetails:O};h(C),a(C)},onError:function(v,D,I){r.resetLoader(n,f),t(new m({type:A.ErrorTypes.NETWORK_ERROR,details:A.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:n,part:g,response:v,networkDetails:I}))},onAbort:function(v,D,I){n.stats.aborted=g.stats.aborted,r.resetLoader(n,f),t(new m({type:A.ErrorTypes.NETWORK_ERROR,details:A.ErrorDetails.INTERNAL_ABORTED,fatal:!1,frag:n,part:g,networkDetails:I}))},onTimeout:function(v,D,I){r.resetLoader(n,f),t(new m({type:A.ErrorTypes.NETWORK_ERROR,details:A.ErrorDetails.FRAG_LOAD_TIMEOUT,fatal:!1,frag:n,part:g,networkDetails:I}))}})})},u.updateStatsFromPart=function(n,g){var h=n.stats,r=g.stats,l=r.total;if(h.loaded+=r.loaded,l){var p=Math.round(n.duration/g.duration),i=Math.min(Math.round(h.loaded/l),p),a=p-i,t=a*Math.round(h.loaded/i);h.total=h.loaded+t}else h.total=Math.max(h.loaded,h.total);var f=h.loading,e=r.loading;f.start?f.first+=e.first-e.start:(f.start=e.start,f.first=e.first),f.end=e.end},u.resetLoader=function(n,g){n.loader=null,this.loader===g&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),g.destroy()},o}();function y(o,u){u===void 0&&(u=null);var s=u||o,n={frag:o,part:u,responseType:"arraybuffer",url:s.url,headers:{},rangeStart:0,rangeEnd:0},g=s.byteRangeStartOffset,h=s.byteRangeEndOffset;if((0,F.isFiniteNumber)(g)&&(0,F.isFiniteNumber)(h)){var r,l=g,p=h;if(o.sn==="initSegment"&&((r=o.decryptdata)===null||r===void 0?void 0:r.method)==="AES-128"){var i=h-g;i%16&&(p=h+(16-i%16)),g!==0&&(n.resetIV=!0,l=g-16)}n.rangeStart=l,n.rangeEnd=p}return n}var m=function(o){b(u,o);function u(s){for(var n,g=arguments.length,h=new Array(g>1?g-1:0),r=1;r<g;r++)h[r-1]=arguments[r];return n=o.call.apply(o,[this].concat(h))||this,n.data=void 0,n.data=s,n}return u}(R(Error))},"./src/loader/fragment.ts":(Y,B,x)=>{x.r(B),x.d(B,{BaseSegment:()=>c,ElementaryStreamTypes:()=>T,Fragment:()=>y,Part:()=>m});var F=x("./src/polyfills/number.ts"),A=x("./node_modules/url-toolkit/src/url-toolkit.js"),b=x("./src/loader/load-stats.ts");function R(o,u){o.prototype=Object.create(u.prototype),o.prototype.constructor=o,k(o,u)}function k(o,u){return k=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(n,g){return n.__proto__=g,n},k(o,u)}function P(o,u){for(var s=0;s<u.length;s++){var n=u[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(o,S(n.key),n)}}function L(o,u,s){return u&&P(o.prototype,u),Object.defineProperty(o,"prototype",{writable:!1}),o}function S(o){var u=_(o,"string");return typeof u=="symbol"?u:String(u)}function _(o,u){if(typeof o!="object"||o===null)return o;var s=o[Symbol.toPrimitive];if(s!==void 0){var n=s.call(o,u);if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}var T;(function(o){o.AUDIO="audio",o.VIDEO="video",o.AUDIOVIDEO="audiovideo"})(T||(T={}));var c=function(){function o(s){var n;this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams=(n={},n[T.AUDIO]=null,n[T.VIDEO]=null,n[T.AUDIOVIDEO]=null,n),this.baseurl=s}var u=o.prototype;return u.setByteRange=function(n,g){var h=n.split("@",2),r=[];h.length===1?r[0]=g?g.byteRangeEndOffset:0:r[0]=parseInt(h[1]),r[1]=parseInt(h[0])+r[0],this._byteRange=r},L(o,[{key:"byteRange",get:function(){return this._byteRange?this._byteRange:[]}},{key:"byteRangeStartOffset",get:function(){return this.byteRange[0]}},{key:"byteRangeEndOffset",get:function(){return this.byteRange[1]}},{key:"url",get:function(){return!this._url&&this.baseurl&&this.relurl&&(this._url=(0,A.buildAbsoluteURL)(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""},set:function(n){this._url=n}}]),o}(),y=function(o){R(u,o);function u(n,g){var h;return h=o.call(this,g)||this,h._decryptdata=null,h.rawProgramDateTime=null,h.programDateTime=null,h.tagList=[],h.duration=0,h.sn=0,h.levelkeys=void 0,h.type=void 0,h.loader=null,h.keyLoader=null,h.level=-1,h.cc=0,h.startPTS=void 0,h.endPTS=void 0,h.appendedPTS=void 0,h.startDTS=void 0,h.endDTS=void 0,h.start=0,h.deltaPTS=void 0,h.maxStartPTS=void 0,h.minEndPTS=void 0,h.stats=new b.LoadStats,h.urlId=0,h.data=void 0,h.bitrateTest=!1,h.title=null,h.initSegment=null,h.endList=void 0,h.type=n,h}var s=u.prototype;return s.setKeyFormat=function(g){if(this.levelkeys){var h=this.levelkeys[g];h&&!this._decryptdata&&(this._decryptdata=h.getDecryptData(this.sn))}},s.abortRequests=function(){var g,h;(g=this.loader)===null||g===void 0||g.abort(),(h=this.keyLoader)===null||h===void 0||h.abort()},s.setElementaryStreamInfo=function(g,h,r,l,p,i){i===void 0&&(i=!1);var a=this.elementaryStreams,t=a[g];if(!t){a[g]={startPTS:h,endPTS:r,startDTS:l,endDTS:p,partial:i};return}t.startPTS=Math.min(t.startPTS,h),t.endPTS=Math.max(t.endPTS,r),t.startDTS=Math.min(t.startDTS,l),t.endDTS=Math.max(t.endDTS,p)},s.clearElementaryStreamInfo=function(){var g=this.elementaryStreams;g[T.AUDIO]=null,g[T.VIDEO]=null,g[T.AUDIOVIDEO]=null},L(u,[{key:"decryptdata",get:function(){var g=this.levelkeys;if(!g&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){var h=this.levelkeys.identity;if(h)this._decryptdata=h.getDecryptData(this.sn);else{var r=Object.keys(this.levelkeys);if(r.length===1)return this._decryptdata=this.levelkeys[r[0]].getDecryptData(this.sn)}}return this._decryptdata}},{key:"end",get:function(){return this.start+this.duration}},{key:"endProgramDateTime",get:function(){if(this.programDateTime===null||!(0,F.isFiniteNumber)(this.programDateTime))return null;var g=(0,F.isFiniteNumber)(this.duration)?this.duration:0;return this.programDateTime+g*1e3}},{key:"encrypted",get:function(){var g;if((g=this._decryptdata)!==null&&g!==void 0&&g.encrypted)return!0;if(this.levelkeys){var h=Object.keys(this.levelkeys),r=h.length;if(r>1||r===1&&this.levelkeys[h[0]].encrypted)return!0}return!1}}]),u}(c),m=function(o){R(u,o);function u(s,n,g,h,r){var l;l=o.call(this,g)||this,l.fragOffset=0,l.duration=0,l.gap=!1,l.independent=!1,l.relurl=void 0,l.fragment=void 0,l.index=void 0,l.stats=new b.LoadStats,l.duration=s.decimalFloatingPoint("DURATION"),l.gap=s.bool("GAP"),l.independent=s.bool("INDEPENDENT"),l.relurl=s.enumeratedString("URI"),l.fragment=n,l.index=h;var p=s.enumeratedString("BYTERANGE");return p&&l.setByteRange(p,r),r&&(l.fragOffset=r.fragOffset+r.duration),l}return L(u,[{key:"start",get:function(){return this.fragment.start+this.fragOffset}},{key:"end",get:function(){return this.start+this.duration}},{key:"loaded",get:function(){var n=this.elementaryStreams;return!!(n.audio||n.video||n.audiovideo)}}]),u}(c)},"./src/loader/key-loader.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>b});var F=x("./src/errors.ts"),A=x("./src/loader/fragment-loader.ts"),b=function(){function R(P){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=P}var k=R.prototype;return k.abort=function(){for(var L in this.keyUriToKeyInfo){var S=this.keyUriToKeyInfo[L].loader;S&&S.abort()}},k.detach=function(){for(var L in this.keyUriToKeyInfo){var S=this.keyUriToKeyInfo[L];(S.mediaKeySessionContext||S.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[L]}},k.destroy=function(){this.detach();for(var L in this.keyUriToKeyInfo){var S=this.keyUriToKeyInfo[L].loader;S&&S.destroy()}this.keyUriToKeyInfo={}},k.createKeyLoadError=function(L,S,_,T){return S===void 0&&(S=F.ErrorDetails.KEY_LOAD_ERROR),new A.LoadError({type:F.ErrorTypes.NETWORK_ERROR,details:S,fatal:!1,frag:L,networkDetails:_})},k.loadClear=function(L,S){var _=this;if(this.emeController&&this.config.emeEnabled)for(var T=L.sn,c=L.cc,y=function(s){var n=S[s];if(c<=n.cc&&(T==="initSegment"||T<n.sn))return _.emeController.selectKeySystemFormat(n).then(function(g){n.setKeyFormat(g)}),"break"},m=0;m<S.length;m++){var o=y(m);if(o==="break")break}},k.load=function(L){var S=this;return!L.decryptdata&&L.encrypted&&this.emeController?this.emeController.selectKeySystemFormat(L).then(function(_){return S.loadInternal(L,_)}):this.loadInternal(L)},k.loadInternal=function(L,S){var _,T;S&&L.setKeyFormat(S);var c=L.decryptdata;if(!c){var y=S?"Expected frag.decryptdata to be defined after setting format "+S:"Missing decryption data on fragment in onKeyLoading";return Promise.reject(this.createKeyLoadError(L,F.ErrorDetails.KEY_LOAD_ERROR,null,y))}var m=c.uri;if(!m)return Promise.reject(this.createKeyLoadError(L,F.ErrorDetails.KEY_LOAD_ERROR,null,'Invalid key URI: "'+m+'"'));var o=this.keyUriToKeyInfo[m];if((_=o)!==null&&_!==void 0&&_.decryptdata.key)return c.key=o.decryptdata.key,Promise.resolve({frag:L,keyInfo:o});if((T=o)!==null&&T!==void 0&&T.keyLoadPromise){var u;switch((u=o.mediaKeySessionContext)===null||u===void 0?void 0:u.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return o.keyLoadPromise.then(function(s){return c.key=s.keyInfo.decryptdata.key,{frag:L,keyInfo:o}})}}switch(o=this.keyUriToKeyInfo[m]={decryptdata:c,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},c.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return c.keyFormat==="identity"?this.loadKeyHTTP(o,L):this.loadKeyEME(o,L);case"AES-128":return this.loadKeyHTTP(o,L);default:return Promise.reject(this.createKeyLoadError(L,F.ErrorDetails.KEY_LOAD_ERROR,null,'Key supplied with unsupported METHOD: "'+c.method+'"'))}},k.loadKeyEME=function(L,S){var _={frag:S,keyInfo:L};if(this.emeController&&this.config.emeEnabled){var T=this.emeController.loadKey(_);if(T)return(L.keyLoadPromise=T.then(function(c){return L.mediaKeySessionContext=c,_})).catch(function(c){throw L.keyLoadPromise=null,c})}return Promise.resolve(_)},k.loadKeyHTTP=function(L,S){var _=this,T=this.config,c=T.loader,y=new c(T);return S.keyLoader=L.loader=y,L.keyLoadPromise=new Promise(function(m,o){var u={keyInfo:L,frag:S,responseType:"arraybuffer",url:L.decryptdata.uri},s={timeout:T.fragLoadingTimeOut,maxRetry:0,retryDelay:T.fragLoadingRetryDelay,maxRetryDelay:T.fragLoadingMaxRetryTimeout,highWaterMark:0},n={onSuccess:function(h,r,l,p){var i=l.frag,a=l.keyInfo,t=l.url;if(!i.decryptdata||a!==_.keyUriToKeyInfo[t])return o(_.createKeyLoadError(i,F.ErrorDetails.KEY_LOAD_ERROR,p,"after key load, decryptdata unset or changed"));a.decryptdata.key=i.decryptdata.key=new Uint8Array(h.data),i.keyLoader=null,a.loader=null,m({frag:i,keyInfo:a})},onError:function(h,r,l){_.resetLoader(r),o(_.createKeyLoadError(S,F.ErrorDetails.KEY_LOAD_ERROR,l))},onTimeout:function(h,r,l){_.resetLoader(r),o(_.createKeyLoadError(S,F.ErrorDetails.KEY_LOAD_TIMEOUT,l))},onAbort:function(h,r,l){_.resetLoader(r),o(_.createKeyLoadError(S,F.ErrorDetails.INTERNAL_ABORTED,l))}};y.load(u,s,n)})},k.resetLoader=function(L){var S=L.frag,_=L.keyInfo,T=L.url,c=_.loader;S.keyLoader===c&&(S.keyLoader=null,_.loader=null),delete this.keyUriToKeyInfo[T],c&&c.destroy()},R}()},"./src/loader/level-details.ts":(Y,B,x)=>{x.r(B),x.d(B,{LevelDetails:()=>L});var F=x("./src/polyfills/number.ts");function A(S,_){for(var T=0;T<_.length;T++){var c=_[T];c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(S,R(c.key),c)}}function b(S,_,T){return _&&A(S.prototype,_),Object.defineProperty(S,"prototype",{writable:!1}),S}function R(S){var _=k(S,"string");return typeof _=="symbol"?_:String(_)}function k(S,_){if(typeof S!="object"||S===null)return S;var T=S[Symbol.toPrimitive];if(T!==void 0){var c=T.call(S,_);if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(S)}var P=10,L=function(){function S(T){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=T}var _=S.prototype;return _.reloaded=function(c){if(!c){this.advanced=!0,this.updated=!0;return}var y=this.lastPartSn-c.lastPartSn,m=this.lastPartIndex-c.lastPartIndex;this.updated=this.endSN!==c.endSN||!!m||!!y,this.advanced=this.endSN>c.endSN||y>0||y===0&&m>0,this.updated||this.advanced?this.misses=Math.floor(c.misses*.6):this.misses=c.misses+1,this.availabilityDelay=c.availabilityDelay},b(S,[{key:"hasProgramDateTime",get:function(){return this.fragments.length?(0,F.isFiniteNumber)(this.fragments[this.fragments.length-1].programDateTime):!1}},{key:"levelTargetDuration",get:function(){return this.averagetargetduration||this.targetduration||P}},{key:"drift",get:function(){var c=this.driftEndTime-this.driftStartTime;if(c>0){var y=this.driftEnd-this.driftStart;return y*1e3/c}return 1}},{key:"edge",get:function(){return this.partEnd||this.fragmentEnd}},{key:"partEnd",get:function(){var c;return(c=this.partList)!==null&&c!==void 0&&c.length?this.partList[this.partList.length-1].end:this.fragmentEnd}},{key:"fragmentEnd",get:function(){var c;return(c=this.fragments)!==null&&c!==void 0&&c.length?this.fragments[this.fragments.length-1].end:0}},{key:"age",get:function(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}},{key:"lastPartIndex",get:function(){var c;return(c=this.partList)!==null&&c!==void 0&&c.length?this.partList[this.partList.length-1].index:-1}},{key:"lastPartSn",get:function(){var c;return(c=this.partList)!==null&&c!==void 0&&c.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}]),S}()},"./src/loader/level-key.ts":(Y,B,x)=>{x.r(B),x.d(B,{LevelKey:()=>L});var F=x("./src/utils/keysystem-util.ts"),A=x("./src/utils/mediakeys-helper.ts"),b=x("./src/utils/mp4-tools.ts"),R=x("./src/utils/logger.ts"),k=x("./src/utils/numeric-encoding-utils.ts"),P={},L=function(){_.clearKeyUriToKeyIdMap=function(){P={}};function _(c,y,m,o,u){o===void 0&&(o=[1]),u===void 0&&(u=null),this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=c,this.uri=y,this.keyFormat=m,this.keyFormatVersions=o,this.iv=u,this.encrypted=c?c!=="NONE":!1,this.isCommonEncryption=this.encrypted&&c!=="AES-128"}var T=_.prototype;return T.isSupported=function(){if(this.method){if(this.method==="AES-128"||this.method==="NONE")return!0;switch(this.keyFormat){case"identity":return this.method==="SAMPLE-AES";case A.KeySystemFormats.FAIRPLAY:case A.KeySystemFormats.WIDEVINE:case A.KeySystemFormats.PLAYREADY:case A.KeySystemFormats.CLEARKEY:return["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)!==-1}}return!1},T.getDecryptData=function(y){if(!this.encrypted||!this.uri)return null;if(this.method==="AES-128"&&this.uri&&!this.iv){typeof y!="number"&&(this.method==="AES-128"&&!this.iv&&R.logger.warn('missing IV for initialization segment with method="'+this.method+'" - compliance issue'),y=0);var m=S(y),o=new _(this.method,this.uri,"identity",this.keyFormatVersions,m);return o}var u=(0,F.convertDataUriToArrayBytes)(this.uri);if(u)switch(this.keyFormat){case A.KeySystemFormats.WIDEVINE:this.pssh=u,u.length>=22&&(this.keyId=u.subarray(u.length-22,u.length-6));break;case A.KeySystemFormats.PLAYREADY:{var s=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=(0,b.mp4pssh)(s,null,u);var n=new Uint16Array(u.buffer,u.byteOffset,u.byteLength/2),g=String.fromCharCode.apply(null,Array.from(n)),h=g.substring(g.indexOf("<"),g.length),r=new DOMParser,l=r.parseFromString(h,"text/xml"),p=l.getElementsByTagName("KID")[0];if(p){var i=p.childNodes[0]?p.childNodes[0].nodeValue:p.getAttribute("VALUE");if(i){var a=(0,k.base64Decode)(i).subarray(0,16);(0,F.changeEndianness)(a),this.keyId=a}}break}default:{var t=u.subarray(0,16);if(t.length!==16){var f=new Uint8Array(16);f.set(t,16-t.length),t=f}this.keyId=t;break}}if(!this.keyId||this.keyId.byteLength!==16){var e=P[this.uri];if(!e){var d=Object.keys(P).length%Number.MAX_SAFE_INTEGER;e=new Uint8Array(16);var E=new DataView(e.buffer,12,4);E.setUint32(0,d),P[this.uri]=e}this.keyId=e}return this},_}();function S(_){for(var T=new Uint8Array(16),c=12;c<16;c++)T[c]=_>>8*(15-c)&255;return T}},"./src/loader/load-stats.ts":(Y,B,x)=>{x.r(B),x.d(B,{LoadStats:()=>F});var F=function(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}},"./src/loader/m3u8-parser.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>u});var F=x("./src/polyfills/number.ts"),A=x("./node_modules/url-toolkit/src/url-toolkit.js"),b=x("./src/loader/date-range.ts"),R=x("./src/loader/fragment.ts"),k=x("./src/loader/level-details.ts"),P=x("./src/loader/level-key.ts"),L=x("./src/utils/attr-list.ts"),S=x("./src/utils/logger.ts"),_=x("./src/utils/codecs.ts");function T(){return T=Object.assign?Object.assign.bind():function(i){for(var a=1;a<arguments.length;a++){var t=arguments[a];for(var f in t)Object.prototype.hasOwnProperty.call(t,f)&&(i[f]=t[f])}return i},T.apply(this,arguments)}var c=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-SESSION-DATA:([^\r\n]*)[\r\n]+|#EXT-X-SESSION-KEY:([^\n\r]*)[\r\n]+/g,y=/#EXT-X-MEDIA:(.*)/g,m=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[\S ]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),o=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|")),u=function(){function i(){}return i.findGroup=function(t,f){for(var e=0;e<t.length;e++){var d=t[e];if(d.id===f)return d}},i.convertAVC1ToAVCOTI=function(t){var f=t.split(".");if(f.length>2){var e=f.shift()+".";return e+=parseInt(f.shift()).toString(16),e+=("000"+parseInt(f.shift()).toString(16)).slice(-4),e}return t},i.resolve=function(t,f){return(0,A.buildAbsoluteURL)(f,t,{alwaysNormalize:!0})},i.parseMasterPlaylist=function(t,f){var e=[],d=[],E={},v=[],D=!1;c.lastIndex=0;for(var I;(I=c.exec(t))!=null;)if(I[1]){var O,C=new L.AttrList(I[1]),M={attrs:C,bitrate:C.decimalInteger("AVERAGE-BANDWIDTH")||C.decimalInteger("BANDWIDTH"),name:C.NAME,url:i.resolve(I[2],f)},U=C.decimalResolution("RESOLUTION");U&&(M.width=U.width,M.height=U.height),n((C.CODECS||"").split(/[ ,]+/).filter(function(G){return G}),M),M.videoCodec&&M.videoCodec.indexOf("avc1")!==-1&&(M.videoCodec=i.convertAVC1ToAVCOTI(M.videoCodec)),(O=M.unknownCodecs)!==null&&O!==void 0&&O.length||d.push(M),e.push(M)}else if(I[3]){var w=new L.AttrList(I[3]);w["DATA-ID"]&&(D=!0,E[w["DATA-ID"]]=w)}else if(I[4]){var N=I[4],K=s(N,f);K.encrypted&&K.isSupported()?v.push(K):S.logger.warn('[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "'+N+'"')}var W=d.length>0&&d.length<e.length;return{levels:W?d:e,sessionData:D?E:null,sessionKeys:v.length?v:null}},i.parseMasterPlaylistMedia=function(t,f,e,d){d===void 0&&(d=[]);var E,v=[],D=0;for(y.lastIndex=0;(E=y.exec(t))!==null;){var I=new L.AttrList(E[1]);if(I.TYPE===e){var O={attrs:I,bitrate:0,id:D++,groupId:I["GROUP-ID"],instreamId:I["INSTREAM-ID"],name:I.NAME||I.LANGUAGE||"",type:e,default:I.bool("DEFAULT"),autoselect:I.bool("AUTOSELECT"),forced:I.bool("FORCED"),lang:I.LANGUAGE,url:I.URI?i.resolve(I.URI,f):""};if(d.length){var C=i.findGroup(d,O.groupId)||d[0];g(O,C,"audioCodec"),g(O,C,"textCodec")}v.push(O)}}return v},i.parseLevelPlaylist=function(t,f,e,d,E){var v=new k.LevelDetails(f),D=v.fragments,I=null,O=0,C=0,M=0,U=0,w=null,N=new R.Fragment(d,f),K,W,G,j=-1,H=!1;for(m.lastIndex=0,v.m3u8=t;(K=m.exec(t))!==null;){H&&(H=!1,N=new R.Fragment(d,f),N.start=M,N.sn=O,N.cc=U,N.level=e,I&&(N.initSegment=I,N.rawProgramDateTime=I.rawProgramDateTime,I.rawProgramDateTime=null));var V=K[1];if(V){N.duration=parseFloat(V);var z=(" "+K[2]).slice(1);N.title=z||null,N.tagList.push(z?["INF",V,z]:["INF",V])}else if(K[3])(0,F.isFiniteNumber)(N.duration)&&(N.start=M,G&&p(N,G,v),N.sn=O,N.level=e,N.cc=U,N.urlId=E,D.push(N),N.relurl=(" "+K[3]).slice(1),r(N,w),w=N,M+=N.duration,O++,C=0,H=!0);else if(K[4]){var $=(" "+K[4]).slice(1);w?N.setByteRange($,w):N.setByteRange($)}else if(K[5])N.rawProgramDateTime=(" "+K[5]).slice(1),N.tagList.push(["PROGRAM-DATE-TIME",N.rawProgramDateTime]),j===-1&&(j=D.length);else{if(K=K[0].match(o),!K){S.logger.warn("No matches on slow regex match for level playlist!");continue}for(W=1;W<K.length&&!(typeof K[W]<"u");W++);var Q=(" "+K[W]).slice(1),X=(" "+K[W+1]).slice(1),Z=K[W+2]?(" "+K[W+2]).slice(1):"";switch(Q){case"PLAYLIST-TYPE":v.type=X.toUpperCase();break;case"MEDIA-SEQUENCE":O=v.startSN=parseInt(X);break;case"SKIP":{var J=new L.AttrList(X),q=J.decimalInteger("SKIPPED-SEGMENTS");if((0,F.isFiniteNumber)(q)){v.skippedSegments=q;for(var ae=q;ae--;)D.unshift(null);O+=q}var te=J.enumeratedString("RECENTLY-REMOVED-DATERANGES");te&&(v.recentlyRemovedDateranges=te.split("	"));break}case"TARGETDURATION":v.targetduration=parseFloat(X);break;case"VERSION":v.version=parseInt(X);break;case"EXTM3U":break;case"ENDLIST":v.live=!1;break;case"#":(X||Z)&&N.tagList.push(Z?[X,Z]:[X]);break;case"DISCONTINUITY":U++,N.tagList.push(["DIS"]);break;case"GAP":N.tagList.push([Q]);break;case"BITRATE":N.tagList.push([Q,X]);break;case"DATERANGE":{var ne=new L.AttrList(X),ee=new b.DateRange(ne,v.dateRanges[ne.ID]);ee.isValid||v.skippedSegments?v.dateRanges[ee.id]=ee:S.logger.warn('Ignoring invalid DATERANGE tag: "'+X+'"'),N.tagList.push(["EXT-X-DATERANGE",X]);break}case"DISCONTINUITY-SEQUENCE":U=parseInt(X);break;case"KEY":{var re=s(X,f);if(re.isSupported()){if(re.method==="NONE"){G=void 0;break}G||(G={}),G[re.keyFormat]&&(G=T({},G)),G[re.keyFormat]=re}else S.logger.warn('[Keys] Ignoring invalid EXT-X-KEY tag: "'+X+'"');break}case"START":{var ie=new L.AttrList(X),se=ie.decimalFloatingPoint("TIME-OFFSET");(0,F.isFiniteNumber)(se)&&(v.startTimeOffset=se);break}case"MAP":{var fe=new L.AttrList(X);if(N.duration){var oe=new R.Fragment(d,f);l(oe,fe,e,G),I=oe,N.initSegment=I,I.rawProgramDateTime&&!N.rawProgramDateTime&&(N.rawProgramDateTime=I.rawProgramDateTime)}else l(N,fe,e,G),I=N,H=!0;break}case"SERVER-CONTROL":{var de=new L.AttrList(X);v.canBlockReload=de.bool("CAN-BLOCK-RELOAD"),v.canSkipUntil=de.optionalFloat("CAN-SKIP-UNTIL",0),v.canSkipDateRanges=v.canSkipUntil>0&&de.bool("CAN-SKIP-DATERANGES"),v.partHoldBack=de.optionalFloat("PART-HOLD-BACK",0),v.holdBack=de.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{var Se=new L.AttrList(X);v.partTarget=Se.decimalFloatingPoint("PART-TARGET");break}case"PART":{var ve=v.partList;ve||(ve=v.partList=[]);var De=C>0?ve[ve.length-1]:void 0,Ee=C++,ge=new R.Part(new L.AttrList(X),N,f,Ee,De);ve.push(ge),N.duration+=ge.duration;break}case"PRELOAD-HINT":{var me=new L.AttrList(X);v.preloadHint=me;break}case"RENDITION-REPORT":{var ce=new L.AttrList(X);v.renditionReports=v.renditionReports||[],v.renditionReports.push(ce);break}default:S.logger.warn("line parsed but not handled: "+K);break}}}w&&!w.relurl?(D.pop(),M-=w.duration,v.partList&&(v.fragmentHint=w)):v.partList&&(r(N,w),N.cc=U,v.fragmentHint=N,G&&p(N,G,v));var he=D.length,pe=D[0],ye=D[he-1];if(M+=v.skippedSegments*v.targetduration,M>0&&he&&ye){v.averagetargetduration=M/he;var le=ye.sn;v.endSN=le!=="initSegment"?le:0,v.live||(ye.endList=!0),pe&&(v.startCC=pe.cc)}else v.endSN=0,v.startCC=0;return v.fragmentHint&&(M+=v.fragmentHint.duration),v.totalduration=M,v.endCC=U,j>0&&h(D,j),v},i}();function s(i,a){var t,f,e=new L.AttrList(i),d=(t=e.enumeratedString("METHOD"))!=null?t:"",E=e.URI,v=e.hexadecimalInteger("IV"),D=e.enumeratedString("KEYFORMATVERSIONS"),I=(f=e.enumeratedString("KEYFORMAT"))!=null?f:"identity";E&&e.IV&&!v&&S.logger.error("Invalid IV: "+e.IV);var O=E?u.resolve(E,a):"",C=(D||"1").split("/").map(Number).filter(Number.isFinite);return new P.LevelKey(d,O,I,C,v)}function n(i,a){["video","audio","text"].forEach(function(t){var f=i.filter(function(d){return(0,_.isCodecType)(d,t)});if(f.length){var e=f.filter(function(d){return d.lastIndexOf("avc1",0)===0||d.lastIndexOf("mp4a",0)===0});a[t+"Codec"]=e.length>0?e[0]:f[0],i=i.filter(function(d){return f.indexOf(d)===-1})}}),a.unknownCodecs=i}function g(i,a,t){var f=a[t];f&&(i[t]=f)}function h(i,a){for(var t=i[a],f=a;f--;){var e=i[f];if(!e)return;e.programDateTime=t.programDateTime-e.duration*1e3,t=e}}function r(i,a){i.rawProgramDateTime?i.programDateTime=Date.parse(i.rawProgramDateTime):a!=null&&a.programDateTime&&(i.programDateTime=a.endProgramDateTime),(0,F.isFiniteNumber)(i.programDateTime)||(i.programDateTime=null,i.rawProgramDateTime=null)}function l(i,a,t,f){i.relurl=a.URI,a.BYTERANGE&&i.setByteRange(a.BYTERANGE),i.level=t,i.sn="initSegment",f&&(i.levelkeys=f),i.initSegment=null}function p(i,a,t){i.levelkeys=a;var f=t.encryptedFragments;(!f.length||f[f.length-1].levelkeys!==a)&&Object.keys(a).some(function(e){return a[e].isCommonEncryption})&&f.push(i)}},"./src/loader/playlist-loader.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>c});var F=x("./src/polyfills/number.ts"),A=x("./src/events.ts"),b=x("./src/errors.ts"),R=x("./src/utils/logger.ts"),k=x("./src/loader/m3u8-parser.ts"),P=x("./src/types/loader.ts"),L=x("./src/utils/attr-list.ts");function S(y){var m=y.type;switch(m){case P.PlaylistContextType.AUDIO_TRACK:return P.PlaylistLevelType.AUDIO;case P.PlaylistContextType.SUBTITLE_TRACK:return P.PlaylistLevelType.SUBTITLE;default:return P.PlaylistLevelType.MAIN}}function _(y,m){var o=y.url;return(o===void 0||o.indexOf("data:")===0)&&(o=m.url),o}var T=function(){function y(o){this.hls=void 0,this.loaders=Object.create(null),this.hls=o,this.registerListeners()}var m=y.prototype;return m.startLoad=function(u){},m.stopLoad=function(){this.destroyInternalLoaders()},m.registerListeners=function(){var u=this.hls;u.on(A.Events.MANIFEST_LOADING,this.onManifestLoading,this),u.on(A.Events.LEVEL_LOADING,this.onLevelLoading,this),u.on(A.Events.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),u.on(A.Events.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)},m.unregisterListeners=function(){var u=this.hls;u.off(A.Events.MANIFEST_LOADING,this.onManifestLoading,this),u.off(A.Events.LEVEL_LOADING,this.onLevelLoading,this),u.off(A.Events.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),u.off(A.Events.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)},m.createInternalLoader=function(u){var s=this.hls.config,n=s.pLoader,g=s.loader,h=n||g,r=new h(s);return u.loader=r,this.loaders[u.type]=r,r},m.getInternalLoader=function(u){return this.loaders[u.type]},m.resetInternalLoader=function(u){this.loaders[u]&&delete this.loaders[u]},m.destroyInternalLoaders=function(){for(var u in this.loaders){var s=this.loaders[u];s&&s.destroy(),this.resetInternalLoader(u)}},m.destroy=function(){this.unregisterListeners(),this.destroyInternalLoaders()},m.onManifestLoading=function(u,s){var n=s.url;this.load({id:null,groupId:null,level:0,responseType:"text",type:P.PlaylistContextType.MANIFEST,url:n,deliveryDirectives:null})},m.onLevelLoading=function(u,s){var n=s.id,g=s.level,h=s.url,r=s.deliveryDirectives;this.load({id:n,groupId:null,level:g,responseType:"text",type:P.PlaylistContextType.LEVEL,url:h,deliveryDirectives:r})},m.onAudioTrackLoading=function(u,s){var n=s.id,g=s.groupId,h=s.url,r=s.deliveryDirectives;this.load({id:n,groupId:g,level:null,responseType:"text",type:P.PlaylistContextType.AUDIO_TRACK,url:h,deliveryDirectives:r})},m.onSubtitleTrackLoading=function(u,s){var n=s.id,g=s.groupId,h=s.url,r=s.deliveryDirectives;this.load({id:n,groupId:g,level:null,responseType:"text",type:P.PlaylistContextType.SUBTITLE_TRACK,url:h,deliveryDirectives:r})},m.load=function(u){var s,n=this.hls.config,g=this.getInternalLoader(u);if(g){var h=g.context;if(h&&h.url===u.url){R.logger.trace("[playlist-loader]: playlist request ongoing");return}R.logger.log("[playlist-loader]: aborting previous loader for type: "+u.type),g.abort()}var r,l,p,i;switch(u.type){case P.PlaylistContextType.MANIFEST:r=n.manifestLoadingMaxRetry,l=n.manifestLoadingTimeOut,p=n.manifestLoadingRetryDelay,i=n.manifestLoadingMaxRetryTimeout;break;case P.PlaylistContextType.LEVEL:case P.PlaylistContextType.AUDIO_TRACK:case P.PlaylistContextType.SUBTITLE_TRACK:r=0,l=n.levelLoadingTimeOut;break;default:r=n.levelLoadingMaxRetry,l=n.levelLoadingTimeOut,p=n.levelLoadingRetryDelay,i=n.levelLoadingMaxRetryTimeout;break}if(g=this.createInternalLoader(u),(s=u.deliveryDirectives)!==null&&s!==void 0&&s.part){var a;if(u.type===P.PlaylistContextType.LEVEL&&u.level!==null?a=this.hls.levels[u.level].details:u.type===P.PlaylistContextType.AUDIO_TRACK&&u.id!==null?a=this.hls.audioTracks[u.id].details:u.type===P.PlaylistContextType.SUBTITLE_TRACK&&u.id!==null&&(a=this.hls.subtitleTracks[u.id].details),a){var t=a.partTarget,f=a.targetduration;t&&f&&(l=Math.min(Math.max(t*3,f*.8)*1e3,l))}}var e={timeout:l,maxRetry:r,retryDelay:p,maxRetryDelay:i,highWaterMark:0},d={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this)};g.load(u,e,d)},m.loadsuccess=function(u,s,n,g){g===void 0&&(g=null),this.resetInternalLoader(n.type);var h=u.data;if(h.indexOf("#EXTM3U")!==0){this.handleManifestParsingError(u,n,"no EXTM3U delimiter",g);return}s.parsing.start=performance.now(),h.indexOf("#EXTINF:")>0||h.indexOf("#EXT-X-TARGETDURATION:")>0?this.handleTrackOrLevelPlaylist(u,s,n,g):this.handleMasterPlaylist(u,s,n,g)},m.loaderror=function(u,s,n){n===void 0&&(n=null),this.handleNetworkError(s,n,!1,u)},m.loadtimeout=function(u,s,n){n===void 0&&(n=null),this.handleNetworkError(s,n,!0)},m.handleMasterPlaylist=function(u,s,n,g){var h=this.hls,r=u.data,l=_(u,n),p=k.default.parseMasterPlaylist(r,l),i=p.levels,a=p.sessionData,t=p.sessionKeys;if(!i.length){this.handleManifestParsingError(u,n,"no level found in manifest",g);return}var f=i.map(function(I){return{id:I.attrs.AUDIO,audioCodec:I.audioCodec}}),e=i.map(function(I){return{id:I.attrs.SUBTITLES,textCodec:I.textCodec}}),d=k.default.parseMasterPlaylistMedia(r,l,"AUDIO",f),E=k.default.parseMasterPlaylistMedia(r,l,"SUBTITLES",e),v=k.default.parseMasterPlaylistMedia(r,l,"CLOSED-CAPTIONS");if(d.length){var D=d.some(function(I){return!I.url});!D&&i[0].audioCodec&&!i[0].attrs.AUDIO&&(R.logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),d.unshift({type:"main",name:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new L.AttrList({}),bitrate:0,url:""}))}h.trigger(A.Events.MANIFEST_LOADED,{levels:i,audioTracks:d,subtitles:E,captions:v,url:l,stats:s,networkDetails:g,sessionData:a,sessionKeys:t})},m.handleTrackOrLevelPlaylist=function(u,s,n,g){var h=this.hls,r=n.id,l=n.level,p=n.type,i=_(u,n),a=(0,F.isFiniteNumber)(r)?r:0,t=(0,F.isFiniteNumber)(l)?l:a,f=S(n),e=k.default.parseLevelPlaylist(u.data,i,t,f,a);if(!e.fragments.length){h.trigger(A.Events.ERROR,{type:b.ErrorTypes.NETWORK_ERROR,details:b.ErrorDetails.LEVEL_EMPTY_ERROR,fatal:!1,url:i,reason:"no fragments found in level",level:typeof n.level=="number"?n.level:void 0});return}if(p===P.PlaylistContextType.MANIFEST){var d={attrs:new L.AttrList({}),bitrate:0,details:e,name:"",url:i};h.trigger(A.Events.MANIFEST_LOADED,{levels:[d],audioTracks:[],url:i,stats:s,networkDetails:g,sessionData:null,sessionKeys:null})}s.parsing.end=performance.now(),n.levelDetails=e,this.handlePlaylistLoaded(u,s,n,g)},m.handleManifestParsingError=function(u,s,n,g){this.hls.trigger(A.Events.ERROR,{type:b.ErrorTypes.NETWORK_ERROR,details:b.ErrorDetails.MANIFEST_PARSING_ERROR,fatal:s.type===P.PlaylistContextType.MANIFEST,url:u.url,reason:n,response:u,context:s,networkDetails:g})},m.handleNetworkError=function(u,s,n,g){n===void 0&&(n=!1),R.logger.warn("[playlist-loader]: A network "+(n?"timeout":"error")+" occurred while loading "+u.type+" level: "+u.level+" id: "+u.id+' group-id: "'+u.groupId+'"');var h=b.ErrorDetails.UNKNOWN,r=!1,l=this.getInternalLoader(u);switch(u.type){case P.PlaylistContextType.MANIFEST:h=n?b.ErrorDetails.MANIFEST_LOAD_TIMEOUT:b.ErrorDetails.MANIFEST_LOAD_ERROR,r=!0;break;case P.PlaylistContextType.LEVEL:h=n?b.ErrorDetails.LEVEL_LOAD_TIMEOUT:b.ErrorDetails.LEVEL_LOAD_ERROR,r=!1;break;case P.PlaylistContextType.AUDIO_TRACK:h=n?b.ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:b.ErrorDetails.AUDIO_TRACK_LOAD_ERROR,r=!1;break;case P.PlaylistContextType.SUBTITLE_TRACK:h=n?b.ErrorDetails.SUBTITLE_TRACK_LOAD_TIMEOUT:b.ErrorDetails.SUBTITLE_LOAD_ERROR,r=!1;break}l&&this.resetInternalLoader(u.type);var p={type:b.ErrorTypes.NETWORK_ERROR,details:h,fatal:r,url:u.url,loader:l,context:u,networkDetails:s};g&&(p.response=g),this.hls.trigger(A.Events.ERROR,p)},m.handlePlaylistLoaded=function(u,s,n,g){var h=n.type,r=n.level,l=n.id,p=n.groupId,i=n.loader,a=n.levelDetails,t=n.deliveryDirectives;if(!(a!=null&&a.targetduration)){this.handleManifestParsingError(u,n,"invalid target duration",g);return}if(i)switch(a.live&&(i.getCacheAge&&(a.ageHeader=i.getCacheAge()||0),(!i.getCacheAge||isNaN(a.ageHeader))&&(a.ageHeader=0)),h){case P.PlaylistContextType.MANIFEST:case P.PlaylistContextType.LEVEL:this.hls.trigger(A.Events.LEVEL_LOADED,{details:a,level:r||0,id:l||0,stats:s,networkDetails:g,deliveryDirectives:t});break;case P.PlaylistContextType.AUDIO_TRACK:this.hls.trigger(A.Events.AUDIO_TRACK_LOADED,{details:a,id:l||0,groupId:p||"",stats:s,networkDetails:g,deliveryDirectives:t});break;case P.PlaylistContextType.SUBTITLE_TRACK:this.hls.trigger(A.Events.SUBTITLE_TRACK_LOADED,{details:a,id:l||0,groupId:p||"",stats:s,networkDetails:g,deliveryDirectives:t});break}},y}();const c=T},"./src/polyfills/number.ts":(Y,B,x)=>{x.r(B),x.d(B,{MAX_SAFE_INTEGER:()=>A,isFiniteNumber:()=>F});var F=Number.isFinite||function(b){return typeof b=="number"&&isFinite(b)},A=Number.MAX_SAFE_INTEGER||9007199254740991},"./src/remux/aac-helper.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>A});var F=function(){function b(){}return b.getSilentFrame=function(k,P){switch(k){case"mp4a.40.2":if(P===1)return new Uint8Array([0,200,0,128,35,128]);if(P===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(P===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(P===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(P===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(P===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(P===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(P===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(P===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}},b}();const A=F},"./src/remux/mp4-generator.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>b});var F=Math.pow(2,32)-1,A=function(){function R(){}return R.init=function(){R.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};var P;for(P in R.types)R.types.hasOwnProperty(P)&&(R.types[P]=[P.charCodeAt(0),P.charCodeAt(1),P.charCodeAt(2),P.charCodeAt(3)]);var L=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),S=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);R.HDLR_TYPES={video:L,audio:S};var _=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),T=new Uint8Array([0,0,0,0,0,0,0,0]);R.STTS=R.STSC=R.STCO=T,R.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),R.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),R.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),R.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var c=new Uint8Array([105,115,111,109]),y=new Uint8Array([97,118,99,49]),m=new Uint8Array([0,0,0,1]);R.FTYP=R.box(R.types.ftyp,c,m,c,y),R.DINF=R.box(R.types.dinf,R.box(R.types.dref,_))},R.box=function(P){for(var L=8,S=arguments.length,_=new Array(S>1?S-1:0),T=1;T<S;T++)_[T-1]=arguments[T];for(var c=_.length,y=c;c--;)L+=_[c].byteLength;var m=new Uint8Array(L);for(m[0]=L>>24&255,m[1]=L>>16&255,m[2]=L>>8&255,m[3]=L&255,m.set(P,4),c=0,L=8;c<y;c++)m.set(_[c],L),L+=_[c].byteLength;return m},R.hdlr=function(P){return R.box(R.types.hdlr,R.HDLR_TYPES[P])},R.mdat=function(P){return R.box(R.types.mdat,P)},R.mdhd=function(P,L){L*=P;var S=Math.floor(L/(F+1)),_=Math.floor(L%(F+1));return R.box(R.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,P>>24&255,P>>16&255,P>>8&255,P&255,S>>24,S>>16&255,S>>8&255,S&255,_>>24,_>>16&255,_>>8&255,_&255,85,196,0,0]))},R.mdia=function(P){return R.box(R.types.mdia,R.mdhd(P.timescale,P.duration),R.hdlr(P.type),R.minf(P))},R.mfhd=function(P){return R.box(R.types.mfhd,new Uint8Array([0,0,0,0,P>>24,P>>16&255,P>>8&255,P&255]))},R.minf=function(P){return P.type==="audio"?R.box(R.types.minf,R.box(R.types.smhd,R.SMHD),R.DINF,R.stbl(P)):R.box(R.types.minf,R.box(R.types.vmhd,R.VMHD),R.DINF,R.stbl(P))},R.moof=function(P,L,S){return R.box(R.types.moof,R.mfhd(P),R.traf(S,L))},R.moov=function(P){for(var L=P.length,S=[];L--;)S[L]=R.trak(P[L]);return R.box.apply(null,[R.types.moov,R.mvhd(P[0].timescale,P[0].duration)].concat(S).concat(R.mvex(P)))},R.mvex=function(P){for(var L=P.length,S=[];L--;)S[L]=R.trex(P[L]);return R.box.apply(null,[R.types.mvex].concat(S))},R.mvhd=function(P,L){L*=P;var S=Math.floor(L/(F+1)),_=Math.floor(L%(F+1)),T=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,P>>24&255,P>>16&255,P>>8&255,P&255,S>>24,S>>16&255,S>>8&255,S&255,_>>24,_>>16&255,_>>8&255,_&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return R.box(R.types.mvhd,T)},R.sdtp=function(P){var L=P.samples||[],S=new Uint8Array(4+L.length),_,T;for(_=0;_<L.length;_++)T=L[_].flags,S[_+4]=T.dependsOn<<4|T.isDependedOn<<2|T.hasRedundancy;return R.box(R.types.sdtp,S)},R.stbl=function(P){return R.box(R.types.stbl,R.stsd(P),R.box(R.types.stts,R.STTS),R.box(R.types.stsc,R.STSC),R.box(R.types.stsz,R.STSZ),R.box(R.types.stco,R.STCO))},R.avc1=function(P){var L=[],S=[],_,T,c;for(_=0;_<P.sps.length;_++)T=P.sps[_],c=T.byteLength,L.push(c>>>8&255),L.push(c&255),L=L.concat(Array.prototype.slice.call(T));for(_=0;_<P.pps.length;_++)T=P.pps[_],c=T.byteLength,S.push(c>>>8&255),S.push(c&255),S=S.concat(Array.prototype.slice.call(T));var y=R.box(R.types.avcC,new Uint8Array([1,L[3],L[4],L[5],255,224|P.sps.length].concat(L).concat([P.pps.length]).concat(S))),m=P.width,o=P.height,u=P.pixelRatio[0],s=P.pixelRatio[1];return R.box(R.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,m>>8&255,m&255,o>>8&255,o&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),y,R.box(R.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),R.box(R.types.pasp,new Uint8Array([u>>24,u>>16&255,u>>8&255,u&255,s>>24,s>>16&255,s>>8&255,s&255])))},R.esds=function(P){var L=P.config.length;return new Uint8Array([0,0,0,0,3,23+L,0,1,0,4,15+L,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([L]).concat(P.config).concat([6,1,2]))},R.mp4a=function(P){var L=P.samplerate;return R.box(R.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,P.channelCount,0,16,0,0,0,0,L>>8&255,L&255,0,0]),R.box(R.types.esds,R.esds(P)))},R.mp3=function(P){var L=P.samplerate;return R.box(R.types[".mp3"],new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,P.channelCount,0,16,0,0,0,0,L>>8&255,L&255,0,0]))},R.stsd=function(P){return P.type==="audio"?P.segmentCodec==="mp3"&&P.codec==="mp3"?R.box(R.types.stsd,R.STSD,R.mp3(P)):R.box(R.types.stsd,R.STSD,R.mp4a(P)):R.box(R.types.stsd,R.STSD,R.avc1(P))},R.tkhd=function(P){var L=P.id,S=P.duration*P.timescale,_=P.width,T=P.height,c=Math.floor(S/(F+1)),y=Math.floor(S%(F+1));return R.box(R.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,L>>24&255,L>>16&255,L>>8&255,L&255,0,0,0,0,c>>24,c>>16&255,c>>8&255,c&255,y>>24,y>>16&255,y>>8&255,y&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,_>>8&255,_&255,0,0,T>>8&255,T&255,0,0]))},R.traf=function(P,L){var S=R.sdtp(P),_=P.id,T=Math.floor(L/(F+1)),c=Math.floor(L%(F+1));return R.box(R.types.traf,R.box(R.types.tfhd,new Uint8Array([0,0,0,0,_>>24,_>>16&255,_>>8&255,_&255])),R.box(R.types.tfdt,new Uint8Array([1,0,0,0,T>>24,T>>16&255,T>>8&255,T&255,c>>24,c>>16&255,c>>8&255,c&255])),R.trun(P,S.length+16+20+8+16+8+8),S)},R.trak=function(P){return P.duration=P.duration||4294967295,R.box(R.types.trak,R.tkhd(P),R.mdia(P))},R.trex=function(P){var L=P.id;return R.box(R.types.trex,new Uint8Array([0,0,0,0,L>>24,L>>16&255,L>>8&255,L&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))},R.trun=function(P,L){var S=P.samples||[],_=S.length,T=12+16*_,c=new Uint8Array(T),y,m,o,u,s,n;for(L+=8+T,c.set([P.type==="video"?1:0,0,15,1,_>>>24&255,_>>>16&255,_>>>8&255,_&255,L>>>24&255,L>>>16&255,L>>>8&255,L&255],0),y=0;y<_;y++)m=S[y],o=m.duration,u=m.size,s=m.flags,n=m.cts,c.set([o>>>24&255,o>>>16&255,o>>>8&255,o&255,u>>>24&255,u>>>16&255,u>>>8&255,u&255,s.isLeading<<2|s.dependsOn,s.isDependedOn<<6|s.hasRedundancy<<4|s.paddingValue<<1|s.isNonSync,s.degradPrio&61440,s.degradPrio&15,n>>>24&255,n>>>16&255,n>>>8&255,n&255],12+16*y);return R.box(R.types.trun,c)},R.initSegment=function(P){R.types||R.init();var L=R.moov(P),S=new Uint8Array(R.FTYP.byteLength+L.byteLength);return S.set(R.FTYP),S.set(L,R.FTYP.byteLength),S},R}();A.types=void 0,A.HDLR_TYPES=void 0,A.STTS=void 0,A.STSC=void 0,A.STCO=void 0,A.STSZ=void 0,A.VMHD=void 0,A.SMHD=void 0,A.STSD=void 0,A.FTYP=void 0,A.DINF=void 0;const b=A},"./src/remux/mp4-remuxer.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>u,flushTextTrackMetadataCueSamples:()=>g,flushTextTrackUserdataCueSamples:()=>h,normalizePts:()=>s});var F=x("./src/polyfills/number.ts"),A=x("./src/remux/aac-helper.ts"),b=x("./src/remux/mp4-generator.ts"),R=x("./src/events.ts"),k=x("./src/errors.ts"),P=x("./src/utils/logger.ts"),L=x("./src/types/loader.ts"),S=x("./src/utils/timescale-conversion.ts");function _(){return _=Object.assign?Object.assign.bind():function(p){for(var i=1;i<arguments.length;i++){var a=arguments[i];for(var t in a)Object.prototype.hasOwnProperty.call(a,t)&&(p[t]=a[t])}return p},_.apply(this,arguments)}var T=10*1e3,c=1024,y=1152,m=null,o=null,u=function(){function p(a,t,f,e){if(this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=void 0,this._initDTS=void 0,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.observer=a,this.config=t,this.typeSupported=f,this.ISGenerated=!1,m===null){var d=navigator.userAgent||"",E=d.match(/Chrome\/(\d+)/i);m=E?parseInt(E[1]):0}if(o===null){var v=navigator.userAgent.match(/Safari\/(\d+)/i);o=v?parseInt(v[1]):0}}var i=p.prototype;return i.destroy=function(){},i.resetTimeStamp=function(t){P.logger.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=t},i.resetNextTimestamp=function(){P.logger.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1},i.resetInitSegment=function(){P.logger.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1},i.getVideoStartPts=function(t){var f=!1,e=t.reduce(function(d,E){var v=E.pts-d;return v<-4294967296?(f=!0,s(d,E.pts)):v>0?d:E.pts},t[0].pts);return f&&P.logger.debug("PTS rollover detected"),e},i.remux=function(t,f,e,d,E,v,D,I){var O,C,M,U,w,N,K=E,W=E,G=t.pid>-1,j=f.pid>-1,H=f.samples.length,V=t.samples.length>0,z=D&&H>0||H>1,$=(!G||V)&&(!j||z)||this.ISGenerated||D;if($){this.ISGenerated||(M=this.generateIS(t,f,E));var Q=this.isVideoContiguous,X=-1,Z;if(z&&(X=n(f.samples),!Q&&this.config.forceKeyFrameOnDiscontinuity))if(N=!0,X>0){P.logger.warn("[mp4-remuxer]: Dropped "+X+" out of "+H+" video samples due to a missing keyframe");var J=this.getVideoStartPts(f.samples);f.samples=f.samples.slice(X),f.dropped+=X,W+=(f.samples[0].pts-J)/f.inputTimeScale,Z=W}else X===-1&&(P.logger.warn("[mp4-remuxer]: No keyframe found out of "+H+" video samples"),N=!1);if(this.ISGenerated){if(V&&z){var q=this.getVideoStartPts(f.samples),ae=s(t.samples[0].pts,q)-q,te=ae/f.inputTimeScale;K+=Math.max(0,te),W+=Math.max(0,-te)}if(V){if(t.samplerate||(P.logger.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),M=this.generateIS(t,f,E)),C=this.remuxAudio(t,K,this.isAudioContiguous,v,j||z||I===L.PlaylistLevelType.AUDIO?W:void 0),z){var ne=C?C.endPTS-C.startPTS:0;f.inputTimeScale||(P.logger.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),M=this.generateIS(t,f,E)),O=this.remuxVideo(f,W,Q,ne)}}else z&&(O=this.remuxVideo(f,W,Q,0));O&&(O.firstKeyFrame=X,O.independent=X!==-1,O.firstKeyFramePTS=Z)}}return this.ISGenerated&&(e.samples.length&&(w=g(e,E,this._initPTS,this._initDTS)),d.samples.length&&(U=h(d,E,this._initPTS))),{audio:C,video:O,initSegment:M,independent:N,text:U,id3:w}},i.generateIS=function(t,f,e){var d=t.samples,E=f.samples,v=this.typeSupported,D={},I=!(0,F.isFiniteNumber)(this._initPTS),O="audio/mp4",C,M,U;if(I&&(C=M=1/0),t.config&&d.length){switch(t.timescale=t.samplerate,t.segmentCodec){case"mp3":v.mpeg?(O="audio/mpeg",t.codec=""):v.mp3&&(t.codec="mp3");break}D.audio={id:"audio",container:O,codec:t.codec,initSegment:t.segmentCodec==="mp3"&&v.mpeg?new Uint8Array(0):b.default.initSegment([t]),metadata:{channelCount:t.channelCount}},I&&(U=t.inputTimeScale,C=M=d[0].pts-Math.round(U*e))}if(f.sps&&f.pps&&E.length&&(f.timescale=f.inputTimeScale,D.video={id:"main",container:"video/mp4",codec:f.codec,initSegment:b.default.initSegment([f]),metadata:{width:f.width,height:f.height}},I)){U=f.inputTimeScale;var w=this.getVideoStartPts(E),N=Math.round(U*e);M=Math.min(M,s(E[0].dts,w)-N),C=Math.min(C,w-N)}if(Object.keys(D).length)return this.ISGenerated=!0,I&&(this._initPTS=C,this._initDTS=M),{tracks:D,initPTS:C,timescale:U}},i.remuxVideo=function(t,f,e,d){var E=t.inputTimeScale,v=t.samples,D=[],I=v.length,O=this._initPTS,C=this.nextAvcDts,M=8,U=this.videoSampleDuration,w,N,K=Number.POSITIVE_INFINITY,W=Number.NEGATIVE_INFINITY,G=!1;if(!e||C===null){var j=f*E,H=v[0].pts-s(v[0].dts,v[0].pts);C=j-H}for(var V=0;V<I;V++){var z=v[V];z.pts=s(z.pts-O,C),z.dts=s(z.dts-O,C),z.dts<v[V>0?V-1:V].dts&&(G=!0)}G&&v.sort(function(Ue,We){var Ze=Ue.dts-We.dts,Je=Ue.pts-We.pts;return Ze||Je}),w=v[0].dts,N=v[v.length-1].dts;var $=N-w,Q=$?Math.round($/(I-1)):U||t.inputTimeScale/30;if(e){var X=w-C,Z=X>Q,J=X<-1;if((Z||J)&&(Z?P.logger.warn("AVC: "+(0,S.toMsFromMpegTsClock)(X,!0)+" ms ("+X+"dts) hole between fragments detected, filling it"):P.logger.warn("AVC: "+(0,S.toMsFromMpegTsClock)(-X,!0)+" ms ("+X+"dts) overlapping between fragments detected"),!J||C>v[0].pts)){w=C;var q=v[0].pts-X;v[0].dts=w,v[0].pts=q,P.logger.log("Video: First PTS/DTS adjusted: "+(0,S.toMsFromMpegTsClock)(q,!0)+"/"+(0,S.toMsFromMpegTsClock)(w,!0)+", delta: "+(0,S.toMsFromMpegTsClock)(X,!0)+" ms")}}w=Math.max(0,w);for(var ae=0,te=0,ne=0;ne<I;ne++){for(var ee=v[ne],re=ee.units,ie=re.length,se=0,fe=0;fe<ie;fe++)se+=re[fe].data.length;te+=se,ae+=ie,ee.length=se,ee.dts=Math.max(ee.dts,w),K=Math.min(ee.pts,K),W=Math.max(ee.pts,W)}N=v[I-1].dts;var oe=te+4*ae+8,de;try{de=new Uint8Array(oe)}catch{this.observer.emit(R.Events.ERROR,R.Events.ERROR,{type:k.ErrorTypes.MUX_ERROR,details:k.ErrorDetails.REMUX_ALLOC_ERROR,fatal:!1,bytes:oe,reason:"fail allocating video mdat "+oe});return}var Se=new DataView(de.buffer);Se.setUint32(0,oe),de.set(b.default.types.mdat,4);for(var ve=!1,De=Number.POSITIVE_INFINITY,Ee=Number.POSITIVE_INFINITY,ge=Number.NEGATIVE_INFINITY,me=Number.NEGATIVE_INFINITY,ce=0;ce<I;ce++){for(var he=v[ce],pe=he.units,ye=0,le=0,xe=pe.length;le<xe;le++){var Te=pe[le],Ce=Te.data,Ie=Te.data.byteLength;Se.setUint32(M,Ie),M+=4,de.set(Ce,M),M+=Ie,ye+=4+Ie}var Re=void 0;if(ce<I-1)U=v[ce+1].dts-he.dts,Re=v[ce+1].pts-he.pts;else{var Be=this.config,Me=ce>0?he.dts-v[ce-1].dts:Q;if(Re=ce>0?he.pts-v[ce-1].pts:Q,Be.stretchShortVideoTrack&&this.nextAudioPts!==null){var Ve=Math.floor(Be.maxBufferHole*E),Fe=(d?K+d*E:this.nextAudioPts)-he.pts;Fe>Ve?(U=Fe-Me,U<0?U=Me:ve=!0,P.logger.log("[mp4-remuxer]: It is approximately "+Fe/90+" ms to the next segment; using duration "+U/90+" ms for the last video frame.")):U=Me}else U=Me}var je=Math.round(he.pts-he.dts);De=Math.min(De,U),ge=Math.max(ge,U),Ee=Math.min(Ee,Re),me=Math.max(me,Re),D.push(new r(he.key,U,ye,je))}if(D.length){if(m){if(m<70){var we=D[0].flags;we.dependsOn=2,we.isNonSync=0}}else if(o&&me-Ee<ge-De&&Q/ge<.025&&D[0].cts===0){P.logger.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");for(var ke=w,_e=0,Ne=D.length;_e<Ne;_e++){var Ke=ke+D[_e].duration,Ye=ke+D[_e].cts;if(_e<Ne-1){var Xe=Ke+D[_e+1].cts;D[_e].duration=Xe-Ye}else D[_e].duration=_e?D[_e-1].duration:Q;D[_e].cts=0,ke=Ke}}}console.assert(U!==null,"mp4SampleDuration must be computed"),U=ve||!U?Q:U,this.nextAvcDts=C=N+U,this.videoSampleDuration=U,this.isVideoContiguous=!0;var ze=b.default.moof(t.sequenceNumber++,w,_({},t,{samples:D})),Qe="video",$e={data1:ze,data2:de,startPTS:K/E,endPTS:(W+U)/E,startDTS:w/E,endDTS:C/E,type:Qe,hasAudio:!1,hasVideo:!0,nb:D.length,dropped:t.dropped};return t.samples=[],t.dropped=0,console.assert(de.length,"MDAT length must not be zero"),$e},i.remuxAudio=function(t,f,e,d,E){var v=t.inputTimeScale,D=t.samplerate?t.samplerate:v,I=v/D,O=t.segmentCodec==="aac"?c:y,C=O*I,M=this._initPTS,U=t.segmentCodec==="mp3"&&this.typeSupported.mpeg,w=[],N=E!==void 0,K=t.samples,W=U?0:8,G=this.nextAudioPts||-1,j=f*v;if(this.isAudioContiguous=e=e||K.length&&G>0&&(d&&Math.abs(j-G)<9e3||Math.abs(s(K[0].pts-M,j)-G)<20*C),K.forEach(function(Te){Te.pts=s(Te.pts-M,j)}),!e||G<0){if(K=K.filter(function(Te){return Te.pts>=0}),!K.length)return;E===0?G=0:d&&!N?G=Math.max(0,j):G=K[0].pts}if(t.segmentCodec==="aac")for(var H=this.config.maxAudioFramesDrift,V=0,z=G;V<K.length;V++){var $=K[V],Q=$.pts,X=Q-z,Z=Math.abs(1e3*X/v);if(X<=-H*C&&N)V===0&&(P.logger.warn("Audio frame @ "+(Q/v).toFixed(3)+"s overlaps nextAudioPts by "+Math.round(1e3*X/v)+" ms."),this.nextAudioPts=G=z=Q);else if(X>=H*C&&Z<T&&N){var J=Math.round(X/C);z=Q-J*C,z<0&&(J--,z+=C),V===0&&(this.nextAudioPts=G=z),P.logger.warn("[mp4-remuxer]: Injecting "+J+" audio frame @ "+(z/v).toFixed(3)+"s due to "+Math.round(1e3*X/v)+" ms gap.");for(var q=0;q<J;q++){var ae=Math.max(z,0),te=A.default.getSilentFrame(t.manifestCodec||t.codec,t.channelCount);te||(P.logger.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),te=$.unit.subarray()),K.splice(V,0,{unit:te,pts:ae}),z+=C,V++}}$.pts=z,z+=C}for(var ne=null,ee=null,re,ie=0,se=K.length;se--;)ie+=K[se].unit.byteLength;for(var fe=0,oe=K.length;fe<oe;fe++){var de=K[fe],Se=de.unit,ve=de.pts;if(ee!==null){var De=w[fe-1];De.duration=Math.round((ve-ee)/I)}else if(e&&t.segmentCodec==="aac"&&(ve=G),ne=ve,ie>0){ie+=W;try{re=new Uint8Array(ie)}catch{this.observer.emit(R.Events.ERROR,R.Events.ERROR,{type:k.ErrorTypes.MUX_ERROR,details:k.ErrorDetails.REMUX_ALLOC_ERROR,fatal:!1,bytes:ie,reason:"fail allocating audio mdat "+ie});return}if(!U){var Ee=new DataView(re.buffer);Ee.setUint32(0,ie),re.set(b.default.types.mdat,4)}}else return;re.set(Se,W);var ge=Se.byteLength;W+=ge,w.push(new r(!0,O,ge,0)),ee=ve}var me=w.length;if(me){var ce=w[w.length-1];this.nextAudioPts=G=ee+I*ce.duration;var he=U?new Uint8Array(0):b.default.moof(t.sequenceNumber++,ne/I,_({},t,{samples:w}));t.samples=[];var pe=ne/v,ye=G/v,le="audio",xe={data1:he,data2:re,startPTS:pe,endPTS:ye,startDTS:pe,endDTS:ye,type:le,hasAudio:!0,hasVideo:!1,nb:me};return this.isAudioContiguous=!0,console.assert(re.length,"MDAT length must not be zero"),xe}},i.remuxEmptyAudio=function(t,f,e,d){var E=t.inputTimeScale,v=t.samplerate?t.samplerate:E,D=E/v,I=this.nextAudioPts,O=(I!==null?I:d.startDTS*E)+this._initDTS,C=d.endDTS*E+this._initDTS,M=D*c,U=Math.ceil((C-O)/M),w=A.default.getSilentFrame(t.manifestCodec||t.codec,t.channelCount);if(P.logger.warn("[mp4-remuxer]: remux empty Audio"),!w){P.logger.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");return}for(var N=[],K=0;K<U;K++){var W=O+K*M;N.push({unit:w,pts:W,dts:W})}return t.samples=N,this.remuxAudio(t,f,e,!1)},p}();function s(p,i){var a;if(i===null)return p;for(i<p?a=-8589934592:a=8589934592;Math.abs(p-i)>4294967296;)p+=a;return p}function n(p){for(var i=0;i<p.length;i++)if(p[i].key)return i;return-1}function g(p,i,a,t){var f=p.samples.length;if(f){for(var e=p.inputTimeScale,d=0;d<f;d++){var E=p.samples[d];E.pts=s(E.pts-a,i*e)/e,E.dts=s(E.dts-t,i*e)/e}var v=p.samples;return p.samples=[],{samples:v}}}function h(p,i,a){var t=p.samples.length;if(t){for(var f=p.inputTimeScale,e=0;e<t;e++){var d=p.samples[e];d.pts=s(d.pts-a,i*f)/f}p.samples.sort(function(v,D){return v.pts-D.pts});var E=p.samples;return p.samples=[],{samples:E}}}var r=function(i,a,t,f){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=a,this.size=t,this.cts=f,this.flags=new l(i)},l=function(i){this.isLeading=0,this.isDependedOn=0,this.hasRedundancy=0,this.degradPrio=0,this.dependsOn=1,this.isNonSync=1,this.dependsOn=i?2:1,this.isNonSync=i?0:1}},"./src/remux/passthrough-remuxer.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>S});var F=x("./src/polyfills/number.ts"),A=x("./src/remux/mp4-remuxer.ts"),b=x("./src/utils/mp4-tools.ts"),R=x("./src/loader/fragment.ts"),k=x("./src/utils/logger.ts"),P=function(){function _(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=void 0,this.initTracks=void 0,this.lastEndTime=null}var T=_.prototype;return T.destroy=function(){},T.resetTimeStamp=function(y){this.initPTS=y,this.lastEndTime=null},T.resetNextTimestamp=function(){this.lastEndTime=null},T.resetInitSegment=function(y,m,o,u){this.audioCodec=m,this.videoCodec=o,this.generateInitSegment((0,b.patchEncyptionData)(y,u)),this.emitInitSegment=!0},T.generateInitSegment=function(y){var m=this.audioCodec,o=this.videoCodec;if(!y||!y.byteLength){this.initTracks=void 0,this.initData=void 0;return}var u=this.initData=(0,b.parseInitSegment)(y);m||(m=L(u.audio,R.ElementaryStreamTypes.AUDIO)),o||(o=L(u.video,R.ElementaryStreamTypes.VIDEO));var s={};u.audio&&u.video?s.audiovideo={container:"video/mp4",codec:m+","+o,initSegment:y,id:"main"}:u.audio?s.audio={container:"audio/mp4",codec:m,initSegment:y,id:"audio"}:u.video?s.video={container:"video/mp4",codec:o,initSegment:y,id:"main"}:k.logger.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=s},T.remux=function(y,m,o,u,s){var n,g=this.initPTS,h=this.lastEndTime,r={audio:void 0,video:void 0,text:u,id3:o,initSegment:void 0};(0,F.isFiniteNumber)(h)||(h=this.lastEndTime=s||0);var l=m.samples;if(!l||!l.length)return r;var p={initPTS:void 0,timescale:1},i=this.initData;if((!i||!i.length)&&(this.generateInitSegment(l),i=this.initData),!i||!i.length)return k.logger.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),r;this.emitInitSegment&&(p.tracks=this.initTracks,this.emitInitSegment=!1);var a=(0,b.getStartDTS)(i,l);(0,F.isFiniteNumber)(g)||(this.initPTS=p.initPTS=g=a-s);var t=(0,b.getDuration)(l,i),f=y?a-g:h,e=f+t;(0,b.offsetStartDTS)(i,l,g),t>0?this.lastEndTime=e:(k.logger.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());var d=!!i.audio,E=!!i.video,v="";d&&(v+="audio"),E&&(v+="video");var D={data1:l,startPTS:f,startDTS:f,endPTS:e,endDTS:e,type:v,hasAudio:d,hasVideo:E,nb:1,dropped:0};r.audio=D.type==="audio"?D:void 0,r.video=D.type!=="audio"?D:void 0,r.initSegment=p;var I=(n=this.initPTS)!=null?n:0;return r.id3=(0,A.flushTextTrackMetadataCueSamples)(o,s,I,I),u.samples.length&&(r.text=(0,A.flushTextTrackUserdataCueSamples)(u,s,I)),r},_}();function L(_,T){var c=_==null?void 0:_.codec;return c&&c.length>4?c:c==="hvc1"||c==="hev1"?"hvc1.1.c.L120.90":c==="av01"?"av01.0.04M.08":c==="avc1"||T===R.ElementaryStreamTypes.VIDEO?"avc1.42e01e":"mp4a.40.5"}const S=P},"./src/task-loop.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>F});var F=function(){function A(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}var b=A.prototype;return b.destroy=function(){this.onHandlerDestroying(),this.onHandlerDestroyed()},b.onHandlerDestroying=function(){this.clearNextTick(),this.clearInterval()},b.onHandlerDestroyed=function(){},b.hasInterval=function(){return!!this._tickInterval},b.hasNextTick=function(){return!!this._tickTimer},b.setInterval=function(k){return this._tickInterval?!1:(this._tickInterval=self.setInterval(this._boundTick,k),!0)},b.clearInterval=function(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1},b.clearNextTick=function(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1},b.tick=function(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)},b.tickImmediate=function(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)},b.doTick=function(){},A}()},"./src/types/cmcd.ts":(Y,B,x)=>{x.r(B),x.d(B,{CMCDObjectType:()=>A,CMCDStreamType:()=>R,CMCDStreamingFormat:()=>b,CMCDVersion:()=>F});var F=1,A;(function(k){k.MANIFEST="m",k.AUDIO="a",k.VIDEO="v",k.MUXED="av",k.INIT="i",k.CAPTION="c",k.TIMED_TEXT="tt",k.KEY="k",k.OTHER="o"})(A||(A={}));var b;(function(k){k.DASH="d",k.HLS="h",k.SMOOTH="s",k.OTHER="o"})(b||(b={}));var R;(function(k){k.VOD="v",k.LIVE="l"})(R||(R={}))},"./src/types/demuxer.ts":(Y,B,x)=>{x.r(B),x.d(B,{MetadataSchema:()=>F});var F;(function(A){A.audioId3="org.id3",A.dateRange="com.apple.quicktime.HLS",A.emsg="https://aomedia.org/emsg/ID3"})(F||(F={}))},"./src/types/level.ts":(Y,B,x)=>{x.r(B),x.d(B,{HdcpLevels:()=>k,HlsSkip:()=>P,HlsUrlParameters:()=>S,Level:()=>_,getSkipValue:()=>L});function F(T,c){for(var y=0;y<c.length;y++){var m=c[y];m.enumerable=m.enumerable||!1,m.configurable=!0,"value"in m&&(m.writable=!0),Object.defineProperty(T,b(m.key),m)}}function A(T,c,y){return c&&F(T.prototype,c),Object.defineProperty(T,"prototype",{writable:!1}),T}function b(T){var c=R(T,"string");return typeof c=="symbol"?c:String(c)}function R(T,c){if(typeof T!="object"||T===null)return T;var y=T[Symbol.toPrimitive];if(y!==void 0){var m=y.call(T,c);if(typeof m!="object")return m;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(T)}var k=["NONE","TYPE-0","TYPE-1","TYPE-2",null],P;(function(T){T.No="",T.Yes="YES",T.v2="v2"})(P||(P={}));function L(T,c){var y=T.canSkipUntil,m=T.canSkipDateRanges,o=T.endSN,u=c!==void 0?c-o:0;return y&&u<y?m?P.v2:P.Yes:P.No}var S=function(){function T(y,m,o){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=y,this.part=m,this.skip=o}var c=T.prototype;return c.addDirectives=function(m){var o=new self.URL(m);return this.msn!==void 0&&o.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&o.searchParams.set("_HLS_part",this.part.toString()),this.skip&&o.searchParams.set("_HLS_skip",this.skip),o.href},T}(),_=function(){function T(c){this.attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.unknownCodecs=void 0,this.audioGroupIds=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.textGroupIds=void 0,this.url=void 0,this._urlId=0,this.url=[c.url],this.attrs=c.attrs,this.bitrate=c.bitrate,c.details&&(this.details=c.details),this.id=c.id||0,this.name=c.name,this.width=c.width||0,this.height=c.height||0,this.audioCodec=c.audioCodec,this.videoCodec=c.videoCodec,this.unknownCodecs=c.unknownCodecs,this.codecSet=[c.videoCodec,c.audioCodec].filter(function(y){return y}).join(",").replace(/\.[^.,]+/g,"")}return A(T,[{key:"maxBitrate",get:function(){return Math.max(this.realBitrate,this.bitrate)}},{key:"uri",get:function(){return this.url[this._urlId]||""}},{key:"urlId",get:function(){return this._urlId},set:function(y){var m=y%this.url.length;this._urlId!==m&&(this.details=void 0,this._urlId=m)}}]),T}()},"./src/types/loader.ts":(Y,B,x)=>{x.r(B),x.d(B,{PlaylistContextType:()=>F,PlaylistLevelType:()=>A});var F;(function(b){b.MANIFEST="manifest",b.LEVEL="level",b.AUDIO_TRACK="audioTrack",b.SUBTITLE_TRACK="subtitleTrack"})(F||(F={}));var A;(function(b){b.MAIN="main",b.AUDIO="audio",b.SUBTITLE="subtitle"})(A||(A={}))},"./src/types/transmuxer.ts":(Y,B,x)=>{x.r(B),x.d(B,{ChunkMetadata:()=>F});var F=function(R,k,P,L,S,_){L===void 0&&(L=0),S===void 0&&(S=-1),_===void 0&&(_=!1),this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=A(),this.buffering={audio:A(),video:A(),audiovideo:A()},this.level=R,this.sn=k,this.id=P,this.size=L,this.part=S,this.partial=_};function A(){return{start:0,executeStart:0,executeEnd:0,end:0}}},"./src/utils/attr-list.ts":(Y,B,x)=>{x.r(B),x.d(B,{AttrList:()=>b});var F=/^(\d+)x(\d+)$/,A=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g,b=function(){function R(P){typeof P=="string"&&(P=R.parseAttrList(P));for(var L in P)P.hasOwnProperty(L)&&(this[L]=P[L])}var k=R.prototype;return k.decimalInteger=function(L){var S=parseInt(this[L],10);return S>Number.MAX_SAFE_INTEGER?1/0:S},k.hexadecimalInteger=function(L){if(this[L]){var S=(this[L]||"0x").slice(2);S=(S.length&1?"0":"")+S;for(var _=new Uint8Array(S.length/2),T=0;T<S.length/2;T++)_[T]=parseInt(S.slice(T*2,T*2+2),16);return _}else return null},k.hexadecimalIntegerAsNumber=function(L){var S=parseInt(this[L],16);return S>Number.MAX_SAFE_INTEGER?1/0:S},k.decimalFloatingPoint=function(L){return parseFloat(this[L])},k.optionalFloat=function(L,S){var _=this[L];return _?parseFloat(_):S},k.enumeratedString=function(L){return this[L]},k.bool=function(L){return this[L]==="YES"},k.decimalResolution=function(L){var S=F.exec(this[L]);if(S!==null)return{width:parseInt(S[1],10),height:parseInt(S[2],10)}},R.parseAttrList=function(L){var S,_={},T='"';for(A.lastIndex=0;(S=A.exec(L))!==null;){var c=S[2];c.indexOf(T)===0&&c.lastIndexOf(T)===c.length-1&&(c=c.slice(1,-1)),_[S[1]]=c}return _},R}()},"./src/utils/binary-search.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>A});var F={search:function(R,k){for(var P=0,L=R.length-1,S=null,_=null;P<=L;){S=(P+L)/2|0,_=R[S];var T=k(_);if(T>0)P=S+1;else if(T<0)L=S-1;else return _}return null}};const A=F},"./src/utils/buffer-helper.ts":(Y,B,x)=>{x.r(B),x.d(B,{BufferHelper:()=>b});var F=x("./src/utils/logger.ts"),A={length:0,start:function(){return 0},end:function(){return 0}},b=function(){function R(){}return R.isBuffered=function(P,L){try{if(P){for(var S=R.getBuffered(P),_=0;_<S.length;_++)if(L>=S.start(_)&&L<=S.end(_))return!0}}catch{}return!1},R.bufferInfo=function(P,L,S){try{if(P){var _=R.getBuffered(P),T=[],c;for(c=0;c<_.length;c++)T.push({start:_.start(c),end:_.end(c)});return this.bufferedInfo(T,L,S)}}catch{}return{len:0,start:L,end:L,nextStart:void 0}},R.bufferedInfo=function(P,L,S){L=Math.max(0,L),P.sort(function(r,l){var p=r.start-l.start;return p||l.end-r.end});var _=[];if(S)for(var T=0;T<P.length;T++){var c=_.length;if(c){var y=_[c-1].end;P[T].start-y<S?P[T].end>y&&(_[c-1].end=P[T].end):_.push(P[T])}else _.push(P[T])}else _=P;for(var m=0,o,u=L,s=L,n=0;n<_.length;n++){var g=_[n].start,h=_[n].end;if(L+S>=g&&L<h)u=g,s=h,m=s-L;else if(L+S<g){o=g;break}}return{len:m,start:u||0,end:s||0,nextStart:o}},R.getBuffered=function(P){try{return P.buffered}catch(L){return F.logger.log("failed to get media.buffered",L),A}},R}()},"./src/utils/cea-608-parser.ts":(Y,B,x)=>{x.r(B),x.d(B,{CaptionScreen:()=>n,Row:()=>s,default:()=>i});var F=x("./src/utils/logger.ts"),A={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},b=function(t){var f=t;return A.hasOwnProperty(t)&&(f=A[t]),String.fromCharCode(f)},R=15,k=100,P={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},L={17:2,18:4,21:6,22:8,23:10,19:13,20:15},S={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},_={25:2,26:4,29:6,30:8,31:10,27:13,28:15},T=["white","green","blue","cyan","red","yellow","magenta","black","transparent"],c;(function(a){a[a.ERROR=0]="ERROR",a[a.TEXT=1]="TEXT",a[a.WARNING=2]="WARNING",a[a.INFO=2]="INFO",a[a.DEBUG=3]="DEBUG",a[a.DATA=3]="DATA"})(c||(c={}));var y=function(){function a(){this.time=null,this.verboseLevel=c.ERROR}var t=a.prototype;return t.log=function(e,d){if(this.verboseLevel>=e){var E=typeof d=="function"?d():d;F.logger.log(this.time+" ["+e+"] "+E)}},a}(),m=function(t){for(var f=[],e=0;e<t.length;e++)f.push(t[e].toString(16));return f},o=function(){function a(f,e,d,E,v){this.foreground=void 0,this.underline=void 0,this.italics=void 0,this.background=void 0,this.flash=void 0,this.foreground=f||"white",this.underline=e||!1,this.italics=d||!1,this.background=E||"black",this.flash=v||!1}var t=a.prototype;return t.reset=function(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1},t.setStyles=function(e){for(var d=["foreground","underline","italics","background","flash"],E=0;E<d.length;E++){var v=d[E];e.hasOwnProperty(v)&&(this[v]=e[v])}},t.isDefault=function(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash},t.equals=function(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash},t.copy=function(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash},t.toString=function(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash},a}(),u=function(){function a(f,e,d,E,v,D){this.uchar=void 0,this.penState=void 0,this.uchar=f||" ",this.penState=new o(e,d,E,v,D)}var t=a.prototype;return t.reset=function(){this.uchar=" ",this.penState.reset()},t.setChar=function(e,d){this.uchar=e,this.penState.copy(d)},t.setPenState=function(e){this.penState.copy(e)},t.equals=function(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)},t.copy=function(e){this.uchar=e.uchar,this.penState.copy(e.penState)},t.isEmpty=function(){return this.uchar===" "&&this.penState.isDefault()},a}(),s=function(){function a(f){this.chars=void 0,this.pos=void 0,this.currPenState=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chars=[];for(var e=0;e<k;e++)this.chars.push(new u);this.logger=f,this.pos=0,this.currPenState=new o}var t=a.prototype;return t.equals=function(e){for(var d=!0,E=0;E<k;E++)if(!this.chars[E].equals(e.chars[E])){d=!1;break}return d},t.copy=function(e){for(var d=0;d<k;d++)this.chars[d].copy(e.chars[d])},t.isEmpty=function(){for(var e=!0,d=0;d<k;d++)if(!this.chars[d].isEmpty()){e=!1;break}return e},t.setCursor=function(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(c.DEBUG,"Negative cursor position "+this.pos),this.pos=0):this.pos>k&&(this.logger.log(c.DEBUG,"Too large cursor position "+this.pos),this.pos=k)},t.moveCursor=function(e){var d=this.pos+e;if(e>1)for(var E=this.pos+1;E<d+1;E++)this.chars[E].setPenState(this.currPenState);this.setCursor(d)},t.backSpace=function(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)},t.insertChar=function(e){var d=this;e>=144&&this.backSpace();var E=b(e);if(this.pos>=k){this.logger.log(c.ERROR,function(){return"Cannot insert "+e.toString(16)+" ("+E+") at position "+d.pos+". Skipping it!"});return}this.chars[this.pos].setChar(E,this.currPenState),this.moveCursor(1)},t.clearFromPos=function(e){var d;for(d=e;d<k;d++)this.chars[d].reset()},t.clear=function(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()},t.clearToEndOfRow=function(){this.clearFromPos(this.pos)},t.getTextString=function(){for(var e=[],d=!0,E=0;E<k;E++){var v=this.chars[E].uchar;v!==" "&&(d=!1),e.push(v)}return d?"":e.join("")},t.setPenStyles=function(e){this.currPenState.setStyles(e);var d=this.chars[this.pos];d.setPenState(this.currPenState)},a}(),n=function(){function a(f){this.rows=void 0,this.currRow=void 0,this.nrRollUpRows=void 0,this.lastOutputScreen=void 0,this.logger=void 0,this.rows=[];for(var e=0;e<R;e++)this.rows.push(new s(f));this.logger=f,this.currRow=R-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.reset()}var t=a.prototype;return t.reset=function(){for(var e=0;e<R;e++)this.rows[e].clear();this.currRow=R-1},t.equals=function(e){for(var d=!0,E=0;E<R;E++)if(!this.rows[E].equals(e.rows[E])){d=!1;break}return d},t.copy=function(e){for(var d=0;d<R;d++)this.rows[d].copy(e.rows[d])},t.isEmpty=function(){for(var e=!0,d=0;d<R;d++)if(!this.rows[d].isEmpty()){e=!1;break}return e},t.backSpace=function(){var e=this.rows[this.currRow];e.backSpace()},t.clearToEndOfRow=function(){var e=this.rows[this.currRow];e.clearToEndOfRow()},t.insertChar=function(e){var d=this.rows[this.currRow];d.insertChar(e)},t.setPen=function(e){var d=this.rows[this.currRow];d.setPenStyles(e)},t.moveCursor=function(e){var d=this.rows[this.currRow];d.moveCursor(e)},t.setCursor=function(e){this.logger.log(c.INFO,"setCursor: "+e);var d=this.rows[this.currRow];d.setCursor(e)},t.setPAC=function(e){this.logger.log(c.INFO,function(){return"pacData = "+JSON.stringify(e)});var d=e.row-1;if(this.nrRollUpRows&&d<this.nrRollUpRows-1&&(d=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==d){for(var E=0;E<R;E++)this.rows[E].clear();var v=this.currRow+1-this.nrRollUpRows,D=this.lastOutputScreen;if(D){var I=D.rows[v].cueStartTime,O=this.logger.time;if(I&&O!==null&&I<O)for(var C=0;C<this.nrRollUpRows;C++)this.rows[d-this.nrRollUpRows+C+1].copy(D.rows[v+C])}}this.currRow=d;var M=this.rows[this.currRow];if(e.indent!==null){var U=e.indent,w=Math.max(U-1,0);M.setCursor(e.indent),e.color=M.chars[w].penState.foreground}var N={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(N)},t.setBkgData=function(e){this.logger.log(c.INFO,function(){return"bkgData = "+JSON.stringify(e)}),this.backSpace(),this.setPen(e),this.insertChar(32)},t.setRollUpRows=function(e){this.nrRollUpRows=e},t.rollUp=function(){var e=this;if(this.nrRollUpRows===null){this.logger.log(c.DEBUG,"roll_up but nrRollUpRows not set yet");return}this.logger.log(c.TEXT,function(){return e.getDisplayText()});var d=this.currRow+1-this.nrRollUpRows,E=this.rows.splice(d,1)[0];E.clear(),this.rows.splice(this.currRow,0,E),this.logger.log(c.INFO,"Rolling up")},t.getDisplayText=function(e){e=e||!1;for(var d=[],E="",v=-1,D=0;D<R;D++){var I=this.rows[D].getTextString();I&&(v=D+1,e?d.push("Row "+v+": '"+I+"'"):d.push(I.trim()))}return d.length>0&&(e?E="["+d.join(" | ")+"]":E=d.join(`
`)),E},t.getTextAndFormat=function(){return this.rows},a}(),g=function(){function a(f,e,d){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=f,this.outputFilter=e,this.mode=null,this.verbose=0,this.displayedMemory=new n(d),this.nonDisplayedMemory=new n(d),this.lastOutputScreen=new n(d),this.currRollUpRow=this.displayedMemory.rows[R-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=d}var t=a.prototype;return t.reset=function(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[R-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null},t.getHandler=function(){return this.outputFilter},t.setHandler=function(e){this.outputFilter=e},t.setPAC=function(e){this.writeScreen.setPAC(e)},t.setBkgData=function(e){this.writeScreen.setBkgData(e)},t.setMode=function(e){e!==this.mode&&(this.mode=e,this.logger.log(c.INFO,function(){return"MODE="+e}),this.mode==="MODE_POP-ON"?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!=="MODE_ROLL-UP"&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)},t.insertChars=function(e){for(var d=this,E=0;E<e.length;E++)this.writeScreen.insertChar(e[E]);var v=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(c.INFO,function(){return v+": "+d.writeScreen.getDisplayText(!0)}),(this.mode==="MODE_PAINT-ON"||this.mode==="MODE_ROLL-UP")&&(this.logger.log(c.TEXT,function(){return"DISPLAYED: "+d.displayedMemory.getDisplayText(!0)}),this.outputDataUpdate())},t.ccRCL=function(){this.logger.log(c.INFO,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")},t.ccBS=function(){this.logger.log(c.INFO,"BS - BackSpace"),this.mode!=="MODE_TEXT"&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())},t.ccAOF=function(){},t.ccAON=function(){},t.ccDER=function(){this.logger.log(c.INFO,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()},t.ccRU=function(e){this.logger.log(c.INFO,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)},t.ccFON=function(){this.logger.log(c.INFO,"FON - Flash On"),this.writeScreen.setPen({flash:!0})},t.ccRDC=function(){this.logger.log(c.INFO,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")},t.ccTR=function(){this.logger.log(c.INFO,"TR"),this.setMode("MODE_TEXT")},t.ccRTD=function(){this.logger.log(c.INFO,"RTD"),this.setMode("MODE_TEXT")},t.ccEDM=function(){this.logger.log(c.INFO,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)},t.ccCR=function(){this.logger.log(c.INFO,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)},t.ccENM=function(){this.logger.log(c.INFO,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()},t.ccEOC=function(){var e=this;if(this.logger.log(c.INFO,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){var d=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=d,this.writeScreen=this.nonDisplayedMemory,this.logger.log(c.TEXT,function(){return"DISP: "+e.displayedMemory.getDisplayText()})}this.outputDataUpdate(!0)},t.ccTO=function(e){this.logger.log(c.INFO,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)},t.ccMIDROW=function(e){var d={flash:!1};if(d.underline=e%2===1,d.italics=e>=46,d.italics)d.foreground="white";else{var E=Math.floor(e/2)-16,v=["white","green","blue","cyan","red","yellow","magenta"];d.foreground=v[E]}this.logger.log(c.INFO,"MIDROW: "+JSON.stringify(d)),this.writeScreen.setPen(d)},t.outputDataUpdate=function(e){e===void 0&&(e=!1);var d=this.logger.time;d!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=d:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,d,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:d),this.lastOutputScreen.copy(this.displayedMemory))},t.cueSplitAtTime=function(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))},a}(),h=function(){function a(f,e,d){this.channels=void 0,this.currentChannel=0,this.cmdHistory=void 0,this.logger=void 0;var E=new y;this.channels=[null,new g(f,e,E),new g(f+1,d,E)],this.cmdHistory=p(),this.logger=E}var t=a.prototype;return t.getHandler=function(e){return this.channels[e].getHandler()},t.setHandler=function(e,d){this.channels[e].setHandler(d)},t.addData=function(e,d){var E,v,D,I=!1;this.logger.time=e;for(var O=0;O<d.length;O+=2)if(v=d[O]&127,D=d[O+1]&127,!(v===0&&D===0)){if(this.logger.log(c.DATA,"["+m([d[O],d[O+1]])+"] -> ("+m([v,D])+")"),E=this.parseCmd(v,D),E||(E=this.parseMidrow(v,D)),E||(E=this.parsePAC(v,D)),E||(E=this.parseBackgroundAttributes(v,D)),!E&&(I=this.parseChars(v,D),I)){var C=this.currentChannel;if(C&&C>0){var M=this.channels[C];M.insertChars(I)}else this.logger.log(c.WARNING,"No channel found yet. TEXT-MODE?")}!E&&!I&&this.logger.log(c.WARNING,"Couldn't parse cleaned data "+m([v,D])+" orig: "+m([d[O],d[O+1]]))}},t.parseCmd=function(e,d){var E=this.cmdHistory,v=(e===20||e===28||e===21||e===29)&&d>=32&&d<=47,D=(e===23||e===31)&&d>=33&&d<=35;if(!(v||D))return!1;if(l(e,d,E))return r(null,null,E),this.logger.log(c.DEBUG,"Repeated command ("+m([e,d])+") is dropped"),!0;var I=e===20||e===21||e===23?1:2,O=this.channels[I];return e===20||e===21||e===28||e===29?d===32?O.ccRCL():d===33?O.ccBS():d===34?O.ccAOF():d===35?O.ccAON():d===36?O.ccDER():d===37?O.ccRU(2):d===38?O.ccRU(3):d===39?O.ccRU(4):d===40?O.ccFON():d===41?O.ccRDC():d===42?O.ccTR():d===43?O.ccRTD():d===44?O.ccEDM():d===45?O.ccCR():d===46?O.ccENM():d===47&&O.ccEOC():O.ccTO(d-32),r(e,d,E),this.currentChannel=I,!0},t.parseMidrow=function(e,d){var E=0;if((e===17||e===25)&&d>=32&&d<=47){if(e===17?E=1:E=2,E!==this.currentChannel)return this.logger.log(c.ERROR,"Mismatch channel in midrow parsing"),!1;var v=this.channels[E];return v?(v.ccMIDROW(d),this.logger.log(c.DEBUG,"MIDROW ("+m([e,d])+")"),!0):!1}return!1},t.parsePAC=function(e,d){var E,v=this.cmdHistory,D=(e>=17&&e<=23||e>=25&&e<=31)&&d>=64&&d<=127,I=(e===16||e===24)&&d>=64&&d<=95;if(!(D||I))return!1;if(l(e,d,v))return r(null,null,v),!0;var O=e<=23?1:2;d>=64&&d<=95?E=O===1?P[e]:S[e]:E=O===1?L[e]:_[e];var C=this.channels[O];return C?(C.setPAC(this.interpretPAC(E,d)),r(e,d,v),this.currentChannel=O,!0):!1},t.interpretPAC=function(e,d){var E,v={color:null,italics:!1,indent:null,underline:!1,row:e};return d>95?E=d-96:E=d-64,v.underline=(E&1)===1,E<=13?v.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(E/2)]:E<=15?(v.italics=!0,v.color="white"):v.indent=Math.floor((E-16)/2)*4,v},t.parseChars=function(e,d){var E,v=null,D=null;if(e>=25?(E=2,D=e-8):(E=1,D=e),D>=17&&D<=19){var I;D===17?I=d+80:D===18?I=d+112:I=d+144,this.logger.log(c.INFO,"Special char '"+b(I)+"' in channel "+E),v=[I]}else e>=32&&e<=127&&(v=d===0?[e]:[e,d]);if(v){var O=m(v);this.logger.log(c.DEBUG,"Char codes =  "+O.join(",")),r(e,d,this.cmdHistory)}return v},t.parseBackgroundAttributes=function(e,d){var E=(e===16||e===24)&&d>=32&&d<=47,v=(e===23||e===31)&&d>=45&&d<=47;if(!(E||v))return!1;var D,I={};e===16||e===24?(D=Math.floor((d-32)/2),I.background=T[D],d%2===1&&(I.background=I.background+"_semi")):d===45?I.background="transparent":(I.foreground="black",d===47&&(I.underline=!0));var O=e<=23?1:2,C=this.channels[O];return C.setBkgData(I),r(e,d,this.cmdHistory),!0},t.reset=function(){for(var e=0;e<Object.keys(this.channels).length;e++){var d=this.channels[e];d&&d.reset()}this.cmdHistory=p()},t.cueSplitAtTime=function(e){for(var d=0;d<this.channels.length;d++){var E=this.channels[d];E&&E.cueSplitAtTime(e)}},a}();function r(a,t,f){f.a=a,f.b=t}function l(a,t,f){return f.a===a&&f.b===t}function p(){return{a:null,b:null}}const i=h},"./src/utils/codecs.ts":(Y,B,x)=>{x.r(B),x.d(B,{isCodecSupportedInMp4:()=>b,isCodecType:()=>A});var F={audio:{a3ds:!0,"ac-3":!0,"ac-4":!0,alac:!0,alaw:!0,dra1:!0,"dts+":!0,"dts-":!0,dtsc:!0,dtse:!0,dtsh:!0,"ec-3":!0,enca:!0,g719:!0,g726:!0,m4ae:!0,mha1:!0,mha2:!0,mhm1:!0,mhm2:!0,mlpa:!0,mp4a:!0,"raw ":!0,Opus:!0,opus:!0,samr:!0,sawb:!0,sawp:!0,sevc:!0,sqcp:!0,ssmv:!0,twos:!0,ulaw:!0},video:{avc1:!0,avc2:!0,avc3:!0,avc4:!0,avcp:!0,av01:!0,drac:!0,dva1:!0,dvav:!0,dvh1:!0,dvhe:!0,encv:!0,hev1:!0,hvc1:!0,mjp2:!0,mp4v:!0,mvc1:!0,mvc2:!0,mvc3:!0,mvc4:!0,resv:!0,rv60:!0,s263:!0,svc1:!0,svc2:!0,"vc-1":!0,vp08:!0,vp09:!0},text:{stpp:!0,wvtt:!0}};function A(R,k){var P=F[k];return!!P&&P[R.slice(0,4)]===!0}function b(R,k){return MediaSource.isTypeSupported((k||"video")+'/mp4;codecs="'+R+'"')}},"./src/utils/cues.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>P});var F=x("./src/utils/vttparser.ts"),A=x("./src/utils/webvtt-parser.ts"),b=x("./src/utils/texttrack-utils.ts"),R=/\s/,k={newCue:function(S,_,T,c){for(var y=[],m,o,u,s,n,g=self.VTTCue||self.TextTrackCue,h=0;h<c.rows.length;h++)if(m=c.rows[h],u=!0,s=0,n="",!m.isEmpty()){for(var r=0;r<m.chars.length;r++)R.test(m.chars[r].uchar)&&u?s++:(n+=m.chars[r].uchar,u=!1);m.cueStartTime=_,_===T&&(T+=1e-4),s>=16?s--:s++;var l=(0,F.fixLineBreaks)(n.trim()),p=(0,A.generateCueId)(_,T,l);(!S||!S.cues||!S.cues.getCueById(p))&&(o=new g(_,T,l),o.id=p,o.line=h+1,o.align="left",o.position=10+Math.min(80,Math.floor(s*8/32)*10),y.push(o))}return S&&y.length&&(y.sort(function(i,a){return i.line==="auto"||a.line==="auto"?0:i.line>8&&a.line>8?a.line-i.line:i.line-a.line}),y.forEach(function(i){return(0,b.addCueToTrack)(S,i)})),y}};const P=k},"./src/utils/discontinuities.ts":(Y,B,x)=>{x.r(B),x.d(B,{adjustSlidingStart:()=>S,alignMediaPlaylistByPDT:()=>y,alignPDT:()=>c,alignStream:()=>_,findDiscontinuousReferenceFrag:()=>P,findFirstFragWithCC:()=>R,shouldAlignOnDiscontinuities:()=>k});var F=x("./src/polyfills/number.ts"),A=x("./src/utils/logger.ts"),b=x("./src/controller/level-helper.ts");function R(m,o){for(var u=null,s=0,n=m.length;s<n;s++){var g=m[s];if(g&&g.cc===o){u=g;break}}return u}function k(m,o,u){return!!(o.details&&(u.endCC>u.startCC||m&&m.cc<u.startCC))}function P(m,o,u){var s=m.fragments,n=o.fragments;if(!n.length||!s.length){A.logger.log("No fragments to align");return}var g=R(s,n[0].cc);if(!g||g&&!g.startPTS){A.logger.log("No frag in previous level to align on");return}return g}function L(m,o){if(m){var u=m.start+o;m.start=m.startPTS=u,m.endPTS=u+m.duration}}function S(m,o){for(var u=o.fragments,s=0,n=u.length;s<n;s++)L(u[s],m);o.fragmentHint&&L(o.fragmentHint,m),o.alignedSliding=!0}function _(m,o,u){o&&(T(m,u,o),!u.alignedSliding&&o.details&&c(u,o.details),!u.alignedSliding&&o.details&&!u.skippedSegments&&(0,b.adjustSliding)(o.details,u))}function T(m,o,u){if(k(m,u,o)){var s=P(u.details,o);s&&(0,F.isFiniteNumber)(s.start)&&(A.logger.log("Adjusting PTS using last level due to CC increase within current level "+o.url),S(s.start,o))}}function c(m,o){if(!(!o.fragments.length||!m.hasProgramDateTime||!o.hasProgramDateTime)){var u=o.fragments[0].programDateTime,s=m.fragments[0].programDateTime,n=(s-u)/1e3+o.fragments[0].start;n&&(0,F.isFiniteNumber)(n)&&(A.logger.log("Adjusting PTS using programDateTime delta "+(s-u)+"ms, sliding:"+n.toFixed(3)+" "+m.url+" "),S(n,m))}}function y(m,o){if(!(!m.hasProgramDateTime||!o.hasProgramDateTime)){var u=m.fragments,s=o.fragments;if(!(!u.length||!s.length)){var n=Math.round(s.length/2)-1,g=s[n],h=R(u,g.cc)||u[Math.round(u.length/2)-1],r=g.programDateTime,l=h.programDateTime;if(!(r===null||l===null)){var p=(l-r)/1e3-(h.start-g.start);S(p,m)}}}}},"./src/utils/ewma-bandwidth-estimator.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>b});var F=x("./src/utils/ewma.ts"),A=function(){function R(P,L,S){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultEstimate_=S,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new F.default(P),this.fast_=new F.default(L)}var k=R.prototype;return k.update=function(L,S){var _=this.slow_,T=this.fast_;this.slow_.halfLife!==L&&(this.slow_=new F.default(L,_.getEstimate(),_.getTotalWeight())),this.fast_.halfLife!==S&&(this.fast_=new F.default(S,T.getEstimate(),T.getTotalWeight()))},k.sample=function(L,S){L=Math.max(L,this.minDelayMs_);var _=8*S,T=L/1e3,c=_/T;this.fast_.sample(T,c),this.slow_.sample(T,c)},k.canEstimate=function(){var L=this.fast_;return L&&L.getTotalWeight()>=this.minWeight_},k.getEstimate=function(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_},k.destroy=function(){},R}();const b=A},"./src/utils/ewma.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>A});var F=function(){function b(k,P,L){P===void 0&&(P=0),L===void 0&&(L=0),this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=k,this.alpha_=k?Math.exp(Math.log(.5)/k):0,this.estimate_=P,this.totalWeight_=L}var R=b.prototype;return R.sample=function(P,L){var S=Math.pow(this.alpha_,P);this.estimate_=L*(1-S)+S*this.estimate_,this.totalWeight_+=P},R.getTotalWeight=function(){return this.totalWeight_},R.getEstimate=function(){if(this.alpha_){var P=1-Math.pow(this.alpha_,this.totalWeight_);if(P)return this.estimate_/P}return this.estimate_},b}();const A=F},"./src/utils/fetch-loader.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>n,fetchSupported:()=>y});var F=x("./src/polyfills/number.ts"),A=x("./src/loader/load-stats.ts"),b=x("./src/demux/chunk-cache.ts");function R(g,h){g.prototype=Object.create(h.prototype),g.prototype.constructor=g,_(g,h)}function k(g){var h=typeof Map=="function"?new Map:void 0;return k=function(l){if(l===null||!S(l))return l;if(typeof l!="function")throw new TypeError("Super expression must either be null or a function");if(typeof h<"u"){if(h.has(l))return h.get(l);h.set(l,p)}function p(){return P(l,arguments,T(this).constructor)}return p.prototype=Object.create(l.prototype,{constructor:{value:p,enumerable:!1,writable:!0,configurable:!0}}),_(p,l)},k(g)}function P(g,h,r){return L()?P=Reflect.construct.bind():P=function(p,i,a){var t=[null];t.push.apply(t,i);var f=Function.bind.apply(p,t),e=new f;return a&&_(e,a.prototype),e},P.apply(null,arguments)}function L(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function S(g){return Function.toString.call(g).indexOf("[native code]")!==-1}function _(g,h){return _=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(l,p){return l.__proto__=p,l},_(g,h)}function T(g){return T=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(r){return r.__proto__||Object.getPrototypeOf(r)},T(g)}function c(){return c=Object.assign?Object.assign.bind():function(g){for(var h=1;h<arguments.length;h++){var r=arguments[h];for(var l in r)Object.prototype.hasOwnProperty.call(r,l)&&(g[l]=r[l])}return g},c.apply(this,arguments)}function y(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch{}return!1}var m=function(){function g(r){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=void 0,this.response=void 0,this.controller=void 0,this.context=void 0,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=r.fetchSetup||u,this.controller=new self.AbortController,this.stats=new A.LoadStats}var h=g.prototype;return h.destroy=function(){this.loader=this.callbacks=null,this.abortInternal()},h.abortInternal=function(){var l=this.response;(!l||!l.ok)&&(this.stats.aborted=!0,this.controller.abort())},h.abort=function(){var l;this.abortInternal(),(l=this.callbacks)!==null&&l!==void 0&&l.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)},h.load=function(l,p,i){var a=this,t=this.stats;if(t.loading.start)throw new Error("Loader can only be used once.");t.loading.start=self.performance.now();var f=o(l,this.controller.signal),e=i.onProgress,d=l.responseType==="arraybuffer",E=d?"byteLength":"length";this.context=l,this.config=p,this.callbacks=i,this.request=this.fetchSetup(l,f),self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(function(){a.abortInternal(),i.onTimeout(t,l,a.response)},p.timeout),self.fetch(this.request).then(function(v){if(a.response=a.loader=v,!v.ok){var D=v.status,I=v.statusText;throw new s(I||"fetch, bad network response",D,v)}return t.loading.first=Math.max(self.performance.now(),t.loading.start),t.total=parseInt(v.headers.get("Content-Length")||"0"),e&&(0,F.isFiniteNumber)(p.highWaterMark)?a.loadProgressively(v,t,l,p.highWaterMark,e):d?v.arrayBuffer():v.text()}).then(function(v){var D=a.response;self.clearTimeout(a.requestTimeout),t.loading.end=Math.max(self.performance.now(),t.loading.first);var I=v[E];I&&(t.loaded=t.total=I);var O={url:D.url,data:v};e&&!(0,F.isFiniteNumber)(p.highWaterMark)&&e(t,l,v,D),i.onSuccess(O,t,l,D)}).catch(function(v){if(self.clearTimeout(a.requestTimeout),!t.aborted){var D=v&&v.code||0,I=v?v.message:null;i.onError({code:D,text:I},l,v?v.details:null)}})},h.getCacheAge=function(){var l=null;if(this.response){var p=this.response.headers.get("age");l=p?parseFloat(p):null}return l},h.loadProgressively=function(l,p,i,a,t){a===void 0&&(a=0);var f=new b.default,e=l.body.getReader(),d=function E(){return e.read().then(function(v){if(v.done)return f.dataLength&&t(p,i,f.flush(),l),Promise.resolve(new ArrayBuffer(0));var D=v.value,I=D.length;return p.loaded+=I,I<a||f.dataLength?(f.push(D),f.dataLength>=a&&t(p,i,f.flush(),l)):t(p,i,D,l),E()}).catch(function(){return Promise.reject()})};return d()},g}();function o(g,h){var r={method:"GET",mode:"cors",credentials:"same-origin",signal:h,headers:new self.Headers(c({},g.headers))};return g.rangeEnd&&r.headers.set("Range","bytes="+g.rangeStart+"-"+String(g.rangeEnd-1)),r}function u(g,h){return new self.Request(g.url,h)}var s=function(g){R(h,g);function h(r,l,p){var i;return i=g.call(this,r)||this,i.code=void 0,i.details=void 0,i.code=l,i.details=p,i}return h}(k(Error));const n=m},"./src/utils/hex.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>A});var F={hexDump:function(R){for(var k="",P=0;P<R.length;P++){var L=R[P].toString(16);L.length<2&&(L="0"+L),k+=L}return k}};const A=F},"./src/utils/imsc1-ttml-parser.ts":(Y,B,x)=>{x.r(B),x.d(B,{IMSC1_CODEC:()=>S,parseIMSC1:()=>y});var F=x("./src/utils/mp4-tools.ts"),A=x("./src/utils/vttparser.ts"),b=x("./src/utils/vttcue.ts"),R=x("./src/demux/id3.ts"),k=x("./src/utils/timescale-conversion.ts"),P=x("./src/utils/webvtt-parser.ts");function L(){return L=Object.assign?Object.assign.bind():function(i){for(var a=1;a<arguments.length;a++){var t=arguments[a];for(var f in t)Object.prototype.hasOwnProperty.call(t,f)&&(i[f]=t[f])}return i},L.apply(this,arguments)}var S="stpp.ttml.im1t",_=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,T=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,c={left:"start",center:"center",right:"end",start:"start",end:"end"};function y(i,a,t,f,e){var d=(0,F.findBox)(new Uint8Array(i),["mdat"]);if(d.length===0){e(new Error("Could not parse IMSC1 mdat"));return}var E=d.map(function(D){return(0,R.utf8ArrayToStr)(D)}),v=(0,k.toTimescaleFromScale)(a,1,t);try{E.forEach(function(D){return f(m(D,v))})}catch(D){e(D)}}function m(i,a){var t=new DOMParser,f=t.parseFromString(i,"text/xml"),e=f.getElementsByTagName("tt")[0];if(!e)throw new Error("Invalid ttml");var d={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},E=Object.keys(d).reduce(function(C,M){return C[M]=e.getAttribute("ttp:"+M)||d[M],C},{}),v=e.getAttribute("xml:space")!=="preserve",D=u(o(e,"styling","style")),I=u(o(e,"layout","region")),O=o(e,"body","[begin]");return[].map.call(O,function(C){var M=s(C,v);if(!M||!C.hasAttribute("begin"))return null;var U=r(C.getAttribute("begin"),E),w=r(C.getAttribute("dur"),E),N=r(C.getAttribute("end"),E);if(U===null)throw h(C);if(N===null){if(w===null)throw h(C);N=U+w}var K=new b.default(U-a,N-a,M);K.id=(0,P.generateCueId)(K.startTime,K.endTime,K.text);var W=I[C.getAttribute("region")],G=D[C.getAttribute("style")],j=n(W,G,D),H=j.textAlign;if(H){var V=c[H];V&&(K.lineAlign=V),K.align=H}return L(K,j),K}).filter(function(C){return C!==null})}function o(i,a,t){var f=i.getElementsByTagName(a)[0];return f?[].slice.call(f.querySelectorAll(t)):[]}function u(i){return i.reduce(function(a,t){var f=t.getAttribute("xml:id");return f&&(a[f]=t),a},{})}function s(i,a){return[].slice.call(i.childNodes).reduce(function(t,f,e){var d;return f.nodeName==="br"&&e?t+`
`:(d=f.childNodes)!==null&&d!==void 0&&d.length?s(f,a):a?t+f.textContent.trim().replace(/\s+/g," "):t+f.textContent},"")}function n(i,a,t){var f="http://www.w3.org/ns/ttml#styling",e=null,d=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],E=i!=null&&i.hasAttribute("style")?i.getAttribute("style"):null;return E&&t.hasOwnProperty(E)&&(e=t[E]),d.reduce(function(v,D){var I=g(a,f,D)||g(i,f,D)||g(e,f,D);return I&&(v[D]=I),v},{})}function g(i,a,t){return i&&i.hasAttributeNS(a,t)?i.getAttributeNS(a,t):null}function h(i){return new Error("Could not parse ttml timestamp "+i)}function r(i,a){if(!i)return null;var t=(0,A.parseTimeStamp)(i);return t===null&&(_.test(i)?t=l(i,a):T.test(i)&&(t=p(i,a))),t}function l(i,a){var t=_.exec(i),f=(t[4]|0)+(t[5]|0)/a.subFrameRate;return(t[1]|0)*3600+(t[2]|0)*60+(t[3]|0)+f/a.frameRate}function p(i,a){var t=T.exec(i),f=Number(t[1]),e=t[2];switch(e){case"h":return f*3600;case"m":return f*60;case"ms":return f*1e3;case"f":return f/a.frameRate;case"t":return f/a.tickRate}return f}},"./src/utils/keysystem-util.ts":(Y,B,x)=>{x.r(B),x.d(B,{changeEndianness:()=>b,convertDataUriToArrayBytes:()=>R,strToUtf8array:()=>k});var F=x("./src/utils/numeric-encoding-utils.ts");function A(P){var L=k(P).subarray(0,16),S=new Uint8Array(16);return S.set(L,16-L.length),S}function b(P){var L=function(_,T,c){var y=_[T];_[T]=_[c],_[c]=y};L(P,0,3),L(P,1,2),L(P,4,5),L(P,6,7)}function R(P){var L=P.split(":"),S=null;if(L[0]==="data"&&L.length===2){var _=L[1].split(";"),T=_[_.length-1].split(",");if(T.length===2){var c=T[0]==="base64",y=T[1];c?(_.splice(-1,1),S=(0,F.base64Decode)(y)):S=A(y)}}return S}function k(P){return Uint8Array.from(unescape(encodeURIComponent(P)),function(L){return L.charCodeAt(0)})}},"./src/utils/logger.ts":(Y,B,x)=>{x.r(B),x.d(B,{enableLogs:()=>P,logger:()=>L});var F=function(){},A={trace:F,debug:F,log:F,warn:F,info:F,error:F},b=A;function R(S){var _=self.console[S];return _?_.bind(self.console,"["+S+"] >"):F}function k(S){for(var _=arguments.length,T=new Array(_>1?_-1:0),c=1;c<_;c++)T[c-1]=arguments[c];T.forEach(function(y){b[y]=S[y]?S[y].bind(S):R(y)})}function P(S,_){if(self.console&&S===!0||typeof S=="object"){k(S,"debug","log","info","warn","error");try{b.log('Debug logs enabled for "'+_+'"')}catch{b=A}}else b=A}var L=b},"./src/utils/mediakeys-helper.ts":(Y,B,x)=>{x.r(B),x.d(B,{KeySystemFormats:()=>A,KeySystemIds:()=>R,KeySystems:()=>F,getKeySystemsForConfig:()=>L,getSupportedMediaKeySystemConfigurations:()=>_,keySystemDomainToKeySystemFormat:()=>P,keySystemFormatToKeySystemDomain:()=>b,keySystemIdToKeySystemDomain:()=>k,requestMediaKeySystemAccess:()=>S});var F;(function(c){c.CLEARKEY="org.w3.clearkey",c.FAIRPLAY="com.apple.fps",c.PLAYREADY="com.microsoft.playready",c.WIDEVINE="com.widevine.alpha"})(F||(F={}));var A;(function(c){c.CLEARKEY="org.w3.clearkey",c.FAIRPLAY="com.apple.streamingkeydelivery",c.PLAYREADY="com.microsoft.playready",c.WIDEVINE="urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"})(A||(A={}));function b(c){switch(c){case A.FAIRPLAY:return F.FAIRPLAY;case A.PLAYREADY:return F.PLAYREADY;case A.WIDEVINE:return F.WIDEVINE;case A.CLEARKEY:return F.CLEARKEY}}var R;(function(c){c.WIDEVINE="edef8ba979d64acea3c827dcd51d21ed"})(R||(R={}));function k(c){if(c===R.WIDEVINE)return F.WIDEVINE}function P(c){switch(c){case F.FAIRPLAY:return A.FAIRPLAY;case F.PLAYREADY:return A.PLAYREADY;case F.WIDEVINE:return A.WIDEVINE;case F.CLEARKEY:return A.CLEARKEY}}function L(c){var y=c.drmSystems,m=c.widevineLicenseUrl,o=y?[F.FAIRPLAY,F.WIDEVINE,F.PLAYREADY,F.CLEARKEY].filter(function(u){return!!y[u]}):[];return!o[F.WIDEVINE]&&m&&o.push(F.WIDEVINE),o}var S=function(){return typeof self<"u"&&self.navigator&&self.navigator.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null}();function _(c,y,m,o){var u;switch(c){case F.FAIRPLAY:u=["cenc","sinf"];break;case F.WIDEVINE:case F.PLAYREADY:u=["cenc"];break;case F.CLEARKEY:u=["cenc","keyids"];break;default:throw new Error("Unknown key-system: "+c)}return T(u,y,m,o)}function T(c,y,m,o){var u={initDataTypes:c,persistentState:o.persistentState||"not-allowed",distinctiveIdentifier:o.distinctiveIdentifier||"not-allowed",sessionTypes:o.sessionTypes||[o.sessionType||"temporary"],audioCapabilities:y.map(function(s){return{contentType:'audio/mp4; codecs="'+s+'"',robustness:o.audioRobustness||"",encryptionScheme:o.audioEncryptionScheme||null}}),videoCapabilities:m.map(function(s){return{contentType:'video/mp4; codecs="'+s+'"',robustness:o.videoRobustness||"",encryptionScheme:o.videoEncryptionScheme||null}})};return[u]}},"./src/utils/mediasource-helper.ts":(Y,B,x)=>{x.r(B),x.d(B,{getMediaSource:()=>F});function F(){return self.MediaSource||self.WebKitMediaSource}},"./src/utils/mp4-tools.ts":(Y,B,x)=>{x.r(B),x.d(B,{RemuxerTrackIdConfig:()=>S,appendUint8Array:()=>a,bin2str:()=>_,computeRawDurationFromSamples:()=>l,discardEPB:()=>E,findBox:()=>o,getDuration:()=>r,getStartDTS:()=>h,mp4Box:()=>D,mp4pssh:()=>I,offsetStartDTS:()=>p,parseEmsg:()=>v,parseInitSegment:()=>s,parsePssh:()=>O,parseSEIMessageFromNALu:()=>d,parseSamples:()=>t,parseSegmentIndex:()=>u,parseSinf:()=>g,patchEncyptionData:()=>n,readSint32:()=>y,readUint16:()=>T,readUint32:()=>c,segmentValidRange:()=>i,writeUint32:()=>m});var F=x("./src/loader/fragment.ts"),A=x("./src/utils/typed-array.ts"),b=x("./src/demux/id3.ts"),R=x("./src/utils/logger.ts"),k=x("./src/utils/hex.ts"),P=Math.pow(2,32)-1,L=[].push,S={video:1,audio:2,id3:3,text:4};function _(C){return String.fromCharCode.apply(null,C)}function T(C,M){var U=C[M]<<8|C[M+1];return U<0?65536+U:U}function c(C,M){var U=y(C,M);return U<0?4294967296+U:U}function y(C,M){return C[M]<<24|C[M+1]<<16|C[M+2]<<8|C[M+3]}function m(C,M,U){C[M]=U>>24,C[M+1]=U>>16&255,C[M+2]=U>>8&255,C[M+3]=U&255}function o(C,M){var U=[];if(!M.length)return U;for(var w=C.byteLength,N=0;N<w;){var K=c(C,N),W=_(C.subarray(N+4,N+8)),G=K>1?N+K:w;if(W===M[0])if(M.length===1)U.push(C.subarray(N+8,G));else{var j=o(C.subarray(N+8,G),M.slice(1));j.length&&L.apply(U,j)}N=G}return U}function u(C){var M=[],U=C[0],w=8,N=c(C,w);w+=4;var K=0,W=0;U===0?w+=8:w+=16,w+=2;var G=C.length+W,j=T(C,w);w+=2;for(var H=0;H<j;H++){var V=w,z=c(C,V);V+=4;var $=z&2147483647,Q=(z&2147483648)>>>31;if(Q===1)return console.warn("SIDX has hierarchical references (not supported)"),null;var X=c(C,V);V+=4,M.push({referenceSize:$,subsegmentDuration:X,info:{duration:X/N,start:G,end:G+$-1}}),G+=$,V+=4,w=V}return{earliestPresentationTime:K,timescale:N,version:U,referencesCount:j,references:M}}function s(C){for(var M=[],U=o(C,["moov","trak"]),w=0;w<U.length;w++){var N=U[w],K=o(N,["tkhd"])[0];if(K){var W=K[0],G=W===0?12:20,j=c(K,G),H=o(N,["mdia","mdhd"])[0];if(H){W=H[0],G=W===0?12:20;var V=c(H,G),z=o(N,["mdia","hdlr"])[0];if(z){var $=_(z.subarray(8,12)),Q={soun:F.ElementaryStreamTypes.AUDIO,vide:F.ElementaryStreamTypes.VIDEO}[$];if(Q){var X=o(N,["mdia","minf","stbl","stsd"])[0],Z=void 0;X&&(Z=_(X.subarray(12,16))),M[j]={timescale:V,type:Q},M[Q]={timescale:V,id:j,codec:Z}}}}}}var J=o(C,["moov","mvex","trex"]);return J.forEach(function(q){var ae=c(q,4),te=M[ae];te&&(te.default={duration:c(q,12),flags:c(q,20)})}),M}function n(C,M){if(!C||!M)return C;var U=M.keyId;if(U&&M.isCommonEncryption){var w=o(C,["moov","trak"]);w.forEach(function(N){var K=o(N,["mdia","minf","stbl","stsd"])[0],W=K.subarray(8),G=o(W,["enca"]),j=G.length>0;j||(G=o(W,["encv"])),G.forEach(function(H){var V=j?H.subarray(28):H.subarray(78),z=o(V,["sinf"]);z.forEach(function($){var Q=g($);if(Q){var X=Q.subarray(8,24);X.some(function(Z){return Z!==0})||(R.logger.log("[eme] Patching keyId in 'enc"+(j?"a":"v")+">sinf>>tenc' box: "+k.default.hexDump(X)+" -> "+k.default.hexDump(U)),Q.set(U,8))}})})})}return C}function g(C){var M=o(C,["schm"])[0];if(M){var U=_(M.subarray(4,8));if(U==="cbcs"||U==="cenc")return o(C,["schi","tenc"])[0]}return R.logger.error("[eme] missing 'schm' box"),null}function h(C,M){return o(M,["moof","traf"]).reduce(function(U,w){var N=o(w,["tfdt"])[0],K=N[0],W=o(w,["tfhd"]).reduce(function(G,j){var H=c(j,4),V=C[H];if(V){var z=c(N,4);K===1&&(z*=Math.pow(2,32),z+=c(N,8));var $=V.timescale||9e4,Q=z/$;if(isFinite(Q)&&(G===null||Q<G))return Q}return G},null);return W!==null&&isFinite(W)&&(U===null||W<U)?W:U},null)||0}function r(C,M){for(var U=0,w=0,N=0,K=o(C,["moof","traf"]),W=0;W<K.length;W++){var G=K[W],j=o(G,["tfhd"])[0],H=c(j,4),V=M[H];if(V){var z=V.default,$=c(j,0)|(z==null?void 0:z.flags),Q=z==null?void 0:z.duration;$&8&&($&2?Q=c(j,12):Q=c(j,8));for(var X=V.timescale||9e4,Z=o(G,["trun"]),J=0;J<Z.length;J++){if(U=l(Z[J]),!U&&Q){var q=c(Z[J],4);U=Q*q}V.type===F.ElementaryStreamTypes.VIDEO?w+=U/X:V.type===F.ElementaryStreamTypes.AUDIO&&(N+=U/X)}}}if(w===0&&N===0){for(var ae=0,te=o(C,["sidx"]),ne=0;ne<te.length;ne++){var ee=u(te[ne]);ee!=null&&ee.references&&(ae+=ee.references.reduce(function(re,ie){return re+ie.info.duration||0},0))}return ae}return w||N}function l(C){var M=c(C,0),U=8;M&1&&(U+=4),M&4&&(U+=4);for(var w=0,N=c(C,4),K=0;K<N;K++){if(M&256){var W=c(C,U);w+=W,U+=4}M&512&&(U+=4),M&1024&&(U+=4),M&2048&&(U+=4)}return w}function p(C,M,U){o(M,["moof","traf"]).forEach(function(w){o(w,["tfhd"]).forEach(function(N){var K=c(N,4),W=C[K];if(W){var G=W.timescale||9e4;o(w,["tfdt"]).forEach(function(j){var H=j[0],V=c(j,4);if(H===0)V-=U*G,V=Math.max(V,0),m(j,4,V);else{V*=Math.pow(2,32),V+=c(j,8),V-=U*G,V=Math.max(V,0);var z=Math.floor(V/(P+1)),$=Math.floor(V%(P+1));m(j,4,z),m(j,8,$)}})}})})}function i(C){var M={valid:null,remainder:null},U=o(C,["moof"]);if(U){if(U.length<2)return M.remainder=C,M}else return M;var w=U[U.length-1];return M.valid=(0,A.sliceUint8)(C,0,w.byteOffset-8),M.remainder=(0,A.sliceUint8)(C,w.byteOffset-8),M}function a(C,M){var U=new Uint8Array(C.length+M.length);return U.set(C),U.set(M,C.length),U}function t(C,M){var U=[],w=M.samples,N=M.timescale,K=M.id,W=!1,G=o(w,["moof"]);return G.map(function(j){var H=j.byteOffset-8,V=o(j,["traf"]);V.map(function(z){var $=o(z,["tfdt"]).map(function(Q){var X=Q[0],Z=c(Q,4);return X===1&&(Z*=Math.pow(2,32),Z+=c(Q,8)),Z/N})[0];return $!==void 0&&(C=$),o(z,["tfhd"]).map(function(Q){var X=c(Q,4),Z=c(Q,0)&16777215,J=(Z&1)!==0,q=(Z&2)!==0,ae=(Z&8)!==0,te=0,ne=(Z&16)!==0,ee=0,re=(Z&32)!==0,ie=8;X===K&&(J&&(ie+=8),q&&(ie+=4),ae&&(te=c(Q,ie),ie+=4),ne&&(ee=c(Q,ie),ie+=4),re&&(ie+=4),M.type==="video"&&(W=f(M.codec)),o(z,["trun"]).map(function(se){var fe=se[0],oe=c(se,0)&16777215,de=(oe&1)!==0,Se=0,ve=(oe&4)!==0,De=(oe&256)!==0,Ee=0,ge=(oe&512)!==0,me=0,ce=(oe&1024)!==0,he=(oe&2048)!==0,pe=0,ye=c(se,4),le=8;de&&(Se=c(se,le),le+=4),ve&&(le+=4);for(var xe=Se+H,Te=0;Te<ye;Te++){if(De?(Ee=c(se,le),le+=4):Ee=te,ge?(me=c(se,le),le+=4):me=ee,ce&&(le+=4),he&&(fe===0?pe=c(se,le):pe=y(se,le),le+=4),M.type===F.ElementaryStreamTypes.VIDEO)for(var Ce=0;Ce<me;){var Ie=c(w,xe);if(xe+=4,e(W,w[xe])){var Re=w.subarray(xe,xe+Ie);d(Re,W?2:1,C+pe/N,U)}xe+=Ie,Ce+=Ie+4}C+=Ee/N}}))})})}),U}function f(C){if(!C)return!1;var M=C.indexOf("."),U=M<0?C:C.substring(0,M);return U==="hvc1"||U==="hev1"||U==="dvh1"||U==="dvhe"}function e(C,M){if(C){var U=M>>1&63;return U===39||U===40}else{var w=M&31;return w===6}}function d(C,M,U,w){var N=E(C),K=0;K+=M;for(var W=0,G=0,j=!1,H=0;K<N.length;){W=0;do{if(K>=N.length)break;H=N[K++],W+=H}while(H===255);G=0;do{if(K>=N.length)break;H=N[K++],G+=H}while(H===255);var V=N.length-K;if(!j&&W===4&&K<N.length){j=!0;var z=N[K++];if(z===181){var $=T(N,K);if(K+=2,$===49){var Q=c(N,K);if(K+=4,Q===1195456820){var X=N[K++];if(X===3){var Z=N[K++],J=31&Z,q=64&Z,ae=q?2+J*3:0,te=new Uint8Array(ae);if(q){te[0]=Z;for(var ne=1;ne<ae;ne++)te[ne]=N[K++]}w.push({type:X,payloadType:W,pts:U,bytes:te})}}}}}else if(W===5&&G<V){if(j=!0,G>16){for(var ee=[],re=0;re<16;re++){var ie=N[K++].toString(16);ee.push(ie.length==1?"0"+ie:ie),(re===3||re===5||re===7||re===9)&&ee.push("-")}for(var se=G-16,fe=new Uint8Array(se),oe=0;oe<se;oe++)fe[oe]=N[K++];w.push({payloadType:W,pts:U,uuid:ee.join(""),userData:(0,b.utf8ArrayToStr)(fe),userDataBytes:fe})}}else if(G<V)K+=G;else if(G>V)break}}function E(C){for(var M=C.byteLength,U=[],w=1;w<M-2;)C[w]===0&&C[w+1]===0&&C[w+2]===3?(U.push(w+2),w+=2):w++;if(U.length===0)return C;var N=M-U.length,K=new Uint8Array(N),W=0;for(w=0;w<N;W++,w++)W===U[0]&&(W++,U.shift()),K[w]=C[W];return K}function v(C){var M=C[0],U="",w="",N=0,K=0,W=0,G=0,j=0,H=0;if(M===0){for(;_(C.subarray(H,H+1))!=="\0";)U+=_(C.subarray(H,H+1)),H+=1;for(U+=_(C.subarray(H,H+1)),H+=1;_(C.subarray(H,H+1))!=="\0";)w+=_(C.subarray(H,H+1)),H+=1;w+=_(C.subarray(H,H+1)),H+=1,N=c(C,12),K=c(C,16),G=c(C,20),j=c(C,24),H=28}else if(M===1){H+=4,N=c(C,H),H+=4;var V=c(C,H);H+=4;var z=c(C,H);for(H+=4,W=Math.pow(2,32)*V+z,Number.isSafeInteger(W)||(W=Number.MAX_SAFE_INTEGER,console.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),G=c(C,H),H+=4,j=c(C,H),H+=4;_(C.subarray(H,H+1))!=="\0";)U+=_(C.subarray(H,H+1)),H+=1;for(U+=_(C.subarray(H,H+1)),H+=1;_(C.subarray(H,H+1))!=="\0";)w+=_(C.subarray(H,H+1)),H+=1;w+=_(C.subarray(H,H+1)),H+=1}var $=C.subarray(H,C.byteLength);return{schemeIdUri:U,value:w,timeScale:N,presentationTime:W,presentationTimeDelta:K,eventDuration:G,id:j,payload:$}}function D(C){for(var M=arguments.length,U=new Array(M>1?M-1:0),w=1;w<M;w++)U[w-1]=arguments[w];for(var N=U.length,K=8,W=N;W--;)K+=U[W].byteLength;var G=new Uint8Array(K);for(G[0]=K>>24&255,G[1]=K>>16&255,G[2]=K>>8&255,G[3]=K&255,G.set(C,4),W=0,K=8;W<N;W++)G.set(U[W],K),K+=U[W].byteLength;return G}function I(C,M,U){if(C.byteLength!==16)throw new RangeError("Invalid system id");var w,N;if(M){w=1,N=new Uint8Array(M.length*16);for(var K=0;K<M.length;K++){var W=M[K];if(W.byteLength!==16)throw new RangeError("Invalid key");N.set(W,K*16)}}else w=0,N=new Uint8Array;var G;w>0?(G=new Uint8Array(4),M.length>0&&new DataView(G.buffer).setUint32(0,M.length,!1)):G=new Uint8Array;var j=new Uint8Array(4);return U&&U.byteLength>0&&new DataView(j.buffer).setUint32(0,U.byteLength,!1),D([112,115,115,104],new Uint8Array([w,0,0,0]),C,G,N,j,U||new Uint8Array)}function O(C){if(!(C instanceof ArrayBuffer)||C.byteLength<32)return null;var M={version:0,systemId:"",kids:null,data:null},U=new DataView(C),w=U.getUint32(0);if(C.byteLength!==w&&w>44)return null;var N=U.getUint32(4);if(N!==1886614376||(M.version=U.getUint32(8)>>>24,M.version>1))return null;M.systemId=k.default.hexDump(new Uint8Array(C,12,16));var K=U.getUint32(28);if(M.version===0){if(w-32<K)return null;M.data=new Uint8Array(C,32,K)}else if(M.version===1){M.kids=[];for(var W=0;W<K;W++)M.kids.push(new Uint8Array(C,32+W*16,16))}return M}},"./src/utils/numeric-encoding-utils.ts":(Y,B,x)=>{x.r(B),x.d(B,{base64Decode:()=>P,base64DecodeToStr:()=>b,base64Encode:()=>R,base64ToBase64Url:()=>F,base64UrlEncode:()=>k,strToBase64Encode:()=>A});function F(L){return L.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function A(L){return btoa(L)}function b(L){return atob(L)}function R(L){return btoa(String.fromCharCode.apply(String,L))}function k(L){return F(R(L))}function P(L){return Uint8Array.from(atob(L),function(S){return S.charCodeAt(0)})}},"./src/utils/output-filter.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>F});var F=function(){function A(R,k){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=R,this.trackName=k}var b=A.prototype;return b.dispatchCue=function(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)},b.newCue=function(k,P,L){(this.startTime===null||this.startTime>k)&&(this.startTime=k),this.endTime=P,this.screen=L,this.timelineController.createCaptionsTrack(this.trackName)},b.reset=function(){this.cueRanges=[],this.startTime=null},A}()},"./src/utils/texttrack-utils.ts":(Y,B,x)=>{x.r(B),x.d(B,{addCueToTrack:()=>b,clearCurrentCues:()=>R,getCuesInRange:()=>L,removeCuesInRange:()=>k,sendAddTrackEvent:()=>A});var F=x("./src/utils/logger.ts");function A(S,_){var T;try{T=new Event("addtrack")}catch{T=document.createEvent("Event"),T.initEvent("addtrack",!1,!1)}T.track=S,_.dispatchEvent(T)}function b(S,_){var T=S.mode;if(T==="disabled"&&(S.mode="hidden"),S.cues&&!S.cues.getCueById(_.id))try{if(S.addCue(_),!S.cues.getCueById(_.id))throw new Error("addCue is failed for: "+_)}catch(y){F.logger.debug("[texttrack-utils]: "+y);var c=new self.TextTrackCue(_.startTime,_.endTime,_.text);c.id=_.id,S.addCue(c)}T==="disabled"&&(S.mode=T)}function R(S){var _=S.mode;if(_==="disabled"&&(S.mode="hidden"),S.cues)for(var T=S.cues.length;T--;)S.removeCue(S.cues[T]);_==="disabled"&&(S.mode=_)}function k(S,_,T,c){var y=S.mode;if(y==="disabled"&&(S.mode="hidden"),S.cues&&S.cues.length>0)for(var m=L(S.cues,_,T),o=0;o<m.length;o++)(!c||c(m[o]))&&S.removeCue(m[o]);y==="disabled"&&(S.mode=y)}function P(S,_){if(_<S[0].startTime)return 0;var T=S.length-1;if(_>S[T].endTime)return-1;for(var c=0,y=T;c<=y;){var m=Math.floor((y+c)/2);if(_<S[m].startTime)y=m-1;else if(_>S[m].startTime&&c<T)c=m+1;else return m}return S[c].startTime-_<_-S[y].startTime?c:y}function L(S,_,T){var c=[],y=P(S,_);if(y>-1)for(var m=y,o=S.length;m<o;m++){var u=S[m];if(u.startTime>=_&&u.endTime<=T)c.push(u);else if(u.startTime>T)return c}return c}},"./src/utils/time-ranges.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>A});var F={toString:function(R){for(var k="",P=R.length,L=0;L<P;L++)k+="["+R.start(L).toFixed(3)+"-"+R.end(L).toFixed(3)+"]";return k}};const A=F},"./src/utils/timescale-conversion.ts":(Y,B,x)=>{x.r(B),x.d(B,{toMpegTsClockFromTimescale:()=>k,toMsFromMpegTsClock:()=>R,toTimescaleFromBase:()=>A,toTimescaleFromScale:()=>b});var F=9e4;function A(P,L,S,_){S===void 0&&(S=1),_===void 0&&(_=!1);var T=P*L*S;return _?Math.round(T):T}function b(P,L,S,_){return S===void 0&&(S=1),_===void 0&&(_=!1),A(P,L,1/S,_)}function R(P,L){return L===void 0&&(L=!1),A(P,1e3,1/F,L)}function k(P,L){return L===void 0&&(L=1),A(P,F,1/L)}},"./src/utils/typed-array.ts":(Y,B,x)=>{x.r(B),x.d(B,{sliceUint8:()=>F});function F(A,b,R){return Uint8Array.prototype.slice?A.slice(b,R):new Uint8Array(Array.prototype.slice.call(A,b,R))}},"./src/utils/vttcue.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>F});const F=function(){if(typeof self<"u"&&self.VTTCue)return self.VTTCue;var A=["","lr","rl"],b=["start","middle","end","left","right"];function R(_,T){if(typeof T!="string"||!Array.isArray(_))return!1;var c=T.toLowerCase();return~_.indexOf(c)?c:!1}function k(_){return R(A,_)}function P(_){return R(b,_)}function L(_){for(var T=arguments.length,c=new Array(T>1?T-1:0),y=1;y<T;y++)c[y-1]=arguments[y];for(var m=1;m<arguments.length;m++){var o=arguments[m];for(var u in o)_[u]=o[u]}return _}function S(_,T,c){var y=this,m={enumerable:!0};y.hasBeenReset=!1;var o="",u=!1,s=_,n=T,g=c,h=null,r="",l=!0,p="auto",i="start",a=50,t="middle",f=50,e="middle";Object.defineProperty(y,"id",L({},m,{get:function(){return o},set:function(E){o=""+E}})),Object.defineProperty(y,"pauseOnExit",L({},m,{get:function(){return u},set:function(E){u=!!E}})),Object.defineProperty(y,"startTime",L({},m,{get:function(){return s},set:function(E){if(typeof E!="number")throw new TypeError("Start time must be set to a number.");s=E,this.hasBeenReset=!0}})),Object.defineProperty(y,"endTime",L({},m,{get:function(){return n},set:function(E){if(typeof E!="number")throw new TypeError("End time must be set to a number.");n=E,this.hasBeenReset=!0}})),Object.defineProperty(y,"text",L({},m,{get:function(){return g},set:function(E){g=""+E,this.hasBeenReset=!0}})),Object.defineProperty(y,"region",L({},m,{get:function(){return h},set:function(E){h=E,this.hasBeenReset=!0}})),Object.defineProperty(y,"vertical",L({},m,{get:function(){return r},set:function(E){var v=k(E);if(v===!1)throw new SyntaxError("An invalid or illegal string was specified.");r=v,this.hasBeenReset=!0}})),Object.defineProperty(y,"snapToLines",L({},m,{get:function(){return l},set:function(E){l=!!E,this.hasBeenReset=!0}})),Object.defineProperty(y,"line",L({},m,{get:function(){return p},set:function(E){if(typeof E!="number"&&E!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");p=E,this.hasBeenReset=!0}})),Object.defineProperty(y,"lineAlign",L({},m,{get:function(){return i},set:function(E){var v=P(E);if(!v)throw new SyntaxError("An invalid or illegal string was specified.");i=v,this.hasBeenReset=!0}})),Object.defineProperty(y,"position",L({},m,{get:function(){return a},set:function(E){if(E<0||E>100)throw new Error("Position must be between 0 and 100.");a=E,this.hasBeenReset=!0}})),Object.defineProperty(y,"positionAlign",L({},m,{get:function(){return t},set:function(E){var v=P(E);if(!v)throw new SyntaxError("An invalid or illegal string was specified.");t=v,this.hasBeenReset=!0}})),Object.defineProperty(y,"size",L({},m,{get:function(){return f},set:function(E){if(E<0||E>100)throw new Error("Size must be between 0 and 100.");f=E,this.hasBeenReset=!0}})),Object.defineProperty(y,"align",L({},m,{get:function(){return e},set:function(E){var v=P(E);if(!v)throw new SyntaxError("An invalid or illegal string was specified.");e=v,this.hasBeenReset=!0}})),y.displayState=void 0}return S.prototype.getCueAsHTML=function(){var _=self.WebVTT;return _.convertCueToDOMTree(self,this.text)},S}()},"./src/utils/vttparser.ts":(Y,B,x)=>{x.r(B),x.d(B,{VTTParser:()=>T,fixLineBreaks:()=>_,parseTimeStamp:()=>b});var F=x("./src/utils/vttcue.ts"),A=function(){function c(){}var y=c.prototype;return y.decode=function(o,u){if(!o)return"";if(typeof o!="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(o))},c}();function b(c){function y(o,u,s,n){return(o|0)*3600+(u|0)*60+(s|0)+parseFloat(n||0)}var m=c.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return m?parseFloat(m[2])>59?y(m[2],m[3],0,m[4]):y(m[1],m[2],m[3],m[4]):null}var R=function(){function c(){this.values=Object.create(null)}var y=c.prototype;return y.set=function(o,u){!this.get(o)&&u!==""&&(this.values[o]=u)},y.get=function(o,u,s){return s?this.has(o)?this.values[o]:u[s]:this.has(o)?this.values[o]:u},y.has=function(o){return o in this.values},y.alt=function(o,u,s){for(var n=0;n<s.length;++n)if(u===s[n]){this.set(o,u);break}},y.integer=function(o,u){/^-?\d+$/.test(u)&&this.set(o,parseInt(u,10))},y.percent=function(o,u){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(u)){var s=parseFloat(u);if(s>=0&&s<=100)return this.set(o,s),!0}return!1},c}();function k(c,y,m,o){var u=o?c.split(o):[c];for(var s in u)if(typeof u[s]=="string"){var n=u[s].split(m);if(n.length===2){var g=n[0],h=n[1];y(g,h)}}}var P=new F.default(0,0,""),L=P.align==="middle"?"middle":"center";function S(c,y,m){var o=c;function u(){var g=b(c);if(g===null)throw new Error("Malformed timestamp: "+o);return c=c.replace(/^[^\sa-zA-Z-]+/,""),g}function s(g,h){var r=new R;k(g,function(i,a){var t;switch(i){case"region":for(var f=m.length-1;f>=0;f--)if(m[f].id===a){r.set(i,m[f].region);break}break;case"vertical":r.alt(i,a,["rl","lr"]);break;case"line":t=a.split(","),r.integer(i,t[0]),r.percent(i,t[0])&&r.set("snapToLines",!1),r.alt(i,t[0],["auto"]),t.length===2&&r.alt("lineAlign",t[1],["start",L,"end"]);break;case"position":t=a.split(","),r.percent(i,t[0]),t.length===2&&r.alt("positionAlign",t[1],["start",L,"end","line-left","line-right","auto"]);break;case"size":r.percent(i,a);break;case"align":r.alt(i,a,["start",L,"end","left","right"]);break}},/:/,/\s/),h.region=r.get("region",null),h.vertical=r.get("vertical","");var l=r.get("line","auto");l==="auto"&&P.line===-1&&(l=-1),h.line=l,h.lineAlign=r.get("lineAlign","start"),h.snapToLines=r.get("snapToLines",!0),h.size=r.get("size",100),h.align=r.get("align",L);var p=r.get("position","auto");p==="auto"&&P.position===50&&(p=h.align==="start"||h.align==="left"?0:h.align==="end"||h.align==="right"?100:50),h.position=p}function n(){c=c.replace(/^\s+/,"")}if(n(),y.startTime=u(),n(),c.slice(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+o);c=c.slice(3),n(),y.endTime=u(),n(),s(c,y)}function _(c){return c.replace(/<br(?: \/)?>/gi,`
`)}var T=function(){function c(){this.state="INITIAL",this.buffer="",this.decoder=new A,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}var y=c.prototype;return y.parse=function(o){var u=this;o&&(u.buffer+=u.decoder.decode(o,{stream:!0}));function s(){var p=u.buffer,i=0;for(p=_(p);i<p.length&&p[i]!=="\r"&&p[i]!==`
`;)++i;var a=p.slice(0,i);return p[i]==="\r"&&++i,p[i]===`
`&&++i,u.buffer=p.slice(i),a}function n(p){k(p,function(i,a){},/:/)}try{var g="";if(u.state==="INITIAL"){if(!/\r\n|\n/.test(u.buffer))return this;g=s();var h=g.match(/^(ï»¿)?WEBVTT([ \t].*)?$/);if(!h||!h[0])throw new Error("Malformed WebVTT signature.");u.state="HEADER"}for(var r=!1;u.buffer;){if(!/\r\n|\n/.test(u.buffer))return this;switch(r?r=!1:g=s(),u.state){case"HEADER":/:/.test(g)?n(g):g||(u.state="ID");continue;case"NOTE":g||(u.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(g)){u.state="NOTE";break}if(!g)continue;if(u.cue=new F.default(0,0,""),u.state="CUE",g.indexOf("-->")===-1){u.cue.id=g;continue}case"CUE":if(!u.cue){u.state="BADCUE";continue}try{S(g,u.cue,u.regionList)}catch{u.cue=null,u.state="BADCUE";continue}u.state="CUETEXT";continue;case"CUETEXT":{var l=g.indexOf("-->")!==-1;if(!g||l&&(r=!0)){u.oncue&&u.cue&&u.oncue(u.cue),u.cue=null,u.state="ID";continue}if(u.cue===null)continue;u.cue.text&&(u.cue.text+=`
`),u.cue.text+=g}continue;case"BADCUE":g||(u.state="ID")}}}catch{u.state==="CUETEXT"&&u.cue&&u.oncue&&u.oncue(u.cue),u.cue=null,u.state=u.state==="INITIAL"?"BADWEBVTT":"BADCUE"}return this},y.flush=function(){var o=this;try{if((o.cue||o.state==="HEADER")&&(o.buffer+=`

`,o.parse()),o.state==="INITIAL"||o.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(u){o.onparsingerror&&o.onparsingerror(u)}return o.onflush&&o.onflush(),this},c}()},"./src/utils/webvtt-parser.ts":(Y,B,x)=>{x.r(B),x.d(B,{generateCueId:()=>T,parseWebVTT:()=>y});var F=x("./src/polyfills/number.ts"),A=x("./src/utils/vttparser.ts"),b=x("./src/demux/id3.ts"),R=x("./src/utils/timescale-conversion.ts"),k=x("./src/remux/mp4-remuxer.ts"),P=/\r\n|\n\r|\n|\r/g,L=function(o,u,s){return s===void 0&&(s=0),o.slice(s,s+u.length)===u},S=function(o){var u=parseInt(o.slice(-3)),s=parseInt(o.slice(-6,-4)),n=parseInt(o.slice(-9,-7)),g=o.length>9?parseInt(o.substring(0,o.indexOf(":"))):0;if(!(0,F.isFiniteNumber)(u)||!(0,F.isFiniteNumber)(s)||!(0,F.isFiniteNumber)(n)||!(0,F.isFiniteNumber)(g))throw Error("Malformed X-TIMESTAMP-MAP: Local:"+o);return u+=1e3*s,u+=60*1e3*n,u+=60*60*1e3*g,u},_=function(o){for(var u=5381,s=o.length;s;)u=u*33^o.charCodeAt(--s);return(u>>>0).toString()};function T(m,o,u){return _(m.toString())+_(o.toString())+_(u)}var c=function(o,u,s){var n=o[u],g=o[n.prevCC];if(!g||!g.new&&n.new){o.ccOffset=o.presentationOffset=n.start,n.new=!1;return}for(;(h=g)!==null&&h!==void 0&&h.new;){var h;o.ccOffset+=n.start-g.start,n.new=!1,n=g,g=o[n.prevCC]}o.presentationOffset=s};function y(m,o,u,s,n,g,h,r){var l=new A.VTTParser,p=(0,b.utf8ArrayToStr)(new Uint8Array(m)).trim().replace(P,`
`).split(`
`),i=[],a=(0,R.toMpegTsClockFromTimescale)(o,u),t="00:00.000",f=0,e=0,d,E=!0;l.oncue=function(v){var D=s[n],I=s.ccOffset,O=(f-a)/9e4;D!=null&&D.new&&(e!==void 0?I=s.ccOffset=D.start:c(s,n,O)),O&&(I=O-s.presentationOffset);var C=v.endTime-v.startTime,M=(0,k.normalizePts)((v.startTime+I-e)*9e4,g*9e4)/9e4;v.startTime=Math.max(M,0),v.endTime=Math.max(M+C,0);var U=v.text.trim();v.text=decodeURIComponent(encodeURIComponent(U)),v.id||(v.id=T(v.startTime,v.endTime,U)),v.endTime>0&&i.push(v)},l.onparsingerror=function(v){d=v},l.onflush=function(){if(d){r(d);return}h(i)},p.forEach(function(v){if(E)if(L(v,"X-TIMESTAMP-MAP=")){E=!1,v.slice(16).split(",").forEach(function(D){L(D,"LOCAL:")?t=D.slice(6):L(D,"MPEGTS:")&&(f=parseInt(D.slice(7)))});try{e=S(t)/1e3}catch(D){d=D}return}else v===""&&(E=!1);l.parse(v+`
`)}),l.flush()}},"./src/utils/xhr-loader.ts":(Y,B,x)=>{x.r(B),x.d(B,{default:()=>k});var F=x("./src/utils/logger.ts"),A=x("./src/loader/load-stats.ts"),b=/^age:\s*[\d.]+\s*$/m,R=function(){function P(S){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=void 0,this.loader=null,this.stats=void 0,this.xhrSetup=S?S.xhrSetup:null,this.stats=new A.LoadStats,this.retryDelay=0}var L=P.prototype;return L.destroy=function(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null},L.abortInternal=function(){var _=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),_&&(_.onreadystatechange=null,_.onprogress=null,_.readyState!==4&&(this.stats.aborted=!0,_.abort()))},L.abort=function(){var _;this.abortInternal(),(_=this.callbacks)!==null&&_!==void 0&&_.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)},L.load=function(_,T,c){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=_,this.config=T,this.callbacks=c,this.retryDelay=T.retryDelay,this.loadInternal()},L.loadInternal=function(){var _=this.config,T=this.context;if(_){var c=this.loader=new self.XMLHttpRequest,y=this.stats;y.loading.first=0,y.loaded=0;var m=this.xhrSetup;try{if(m)try{m(c,T.url)}catch{c.open("GET",T.url,!0),m(c,T.url)}c.readyState||c.open("GET",T.url,!0);var o=this.context.headers;if(o)for(var u in o)c.setRequestHeader(u,o[u])}catch(s){this.callbacks.onError({code:c.status,text:s.message},T,c);return}T.rangeEnd&&c.setRequestHeader("Range","bytes="+T.rangeStart+"-"+(T.rangeEnd-1)),c.onreadystatechange=this.readystatechange.bind(this),c.onprogress=this.loadprogress.bind(this),c.responseType=T.responseType,self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),_.timeout),c.send()}},L.readystatechange=function(){var _=this.context,T=this.loader,c=this.stats;if(!(!_||!T)){var y=T.readyState,m=this.config;if(!c.aborted&&y>=2)if(self.clearTimeout(this.requestTimeout),c.loading.first===0&&(c.loading.first=Math.max(self.performance.now(),c.loading.start)),y===4){T.onreadystatechange=null,T.onprogress=null;var o=T.status,u=T.responseType==="arraybuffer";if(o>=200&&o<300&&(u&&T.response||T.responseText!==null)){c.loading.end=Math.max(self.performance.now(),c.loading.first);var s,n;if(u?(s=T.response,n=s.byteLength):(s=T.responseText,n=s.length),c.loaded=c.total=n,!this.callbacks)return;var g=this.callbacks.onProgress;if(g&&g(c,_,s,T),!this.callbacks)return;var h={url:T.responseURL,data:s};this.callbacks.onSuccess(h,c,_,T)}else c.retry>=m.maxRetry||o>=400&&o<499?(F.logger.error(o+" while loading "+_.url),this.callbacks.onError({code:o,text:T.statusText},_,T)):(F.logger.warn(o+" while loading "+_.url+", retrying in "+this.retryDelay+"..."),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay),this.retryDelay=Math.min(2*this.retryDelay,m.maxRetryDelay),c.retry++)}else self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),m.timeout)}},L.loadtimeout=function(){F.logger.warn("timeout while loading "+this.context.url);var _=this.callbacks;_&&(this.abortInternal(),_.onTimeout(this.stats,this.context,this.loader))},L.loadprogress=function(_){var T=this.stats;T.loaded=_.loaded,_.lengthComputable&&(T.total=_.total)},L.getCacheAge=function(){var _=null;if(this.loader&&b.test(this.loader.getAllResponseHeaders())){var T=this.loader.getResponseHeader("age");_=T?parseFloat(T):null}return _},P}();const k=R},"./node_modules/eventemitter3/index.js":Y=>{var B=Object.prototype.hasOwnProperty,x="~";function F(){}Object.create&&(F.prototype=Object.create(null),new F().__proto__||(x=!1));function A(P,L,S){this.fn=P,this.context=L,this.once=S||!1}function b(P,L,S,_,T){if(typeof S!="function")throw new TypeError("The listener must be a function");var c=new A(S,_||P,T),y=x?x+L:L;return P._events[y]?P._events[y].fn?P._events[y]=[P._events[y],c]:P._events[y].push(c):(P._events[y]=c,P._eventsCount++),P}function R(P,L){--P._eventsCount===0?P._events=new F:delete P._events[L]}function k(){this._events=new F,this._eventsCount=0}k.prototype.eventNames=function(){var L=[],S,_;if(this._eventsCount===0)return L;for(_ in S=this._events)B.call(S,_)&&L.push(x?_.slice(1):_);return Object.getOwnPropertySymbols?L.concat(Object.getOwnPropertySymbols(S)):L},k.prototype.listeners=function(L){var S=x?x+L:L,_=this._events[S];if(!_)return[];if(_.fn)return[_.fn];for(var T=0,c=_.length,y=new Array(c);T<c;T++)y[T]=_[T].fn;return y},k.prototype.listenerCount=function(L){var S=x?x+L:L,_=this._events[S];return _?_.fn?1:_.length:0},k.prototype.emit=function(L,S,_,T,c,y){var m=x?x+L:L;if(!this._events[m])return!1;var o=this._events[m],u=arguments.length,s,n;if(o.fn){switch(o.once&&this.removeListener(L,o.fn,void 0,!0),u){case 1:return o.fn.call(o.context),!0;case 2:return o.fn.call(o.context,S),!0;case 3:return o.fn.call(o.context,S,_),!0;case 4:return o.fn.call(o.context,S,_,T),!0;case 5:return o.fn.call(o.context,S,_,T,c),!0;case 6:return o.fn.call(o.context,S,_,T,c,y),!0}for(n=1,s=new Array(u-1);n<u;n++)s[n-1]=arguments[n];o.fn.apply(o.context,s)}else{var g=o.length,h;for(n=0;n<g;n++)switch(o[n].once&&this.removeListener(L,o[n].fn,void 0,!0),u){case 1:o[n].fn.call(o[n].context);break;case 2:o[n].fn.call(o[n].context,S);break;case 3:o[n].fn.call(o[n].context,S,_);break;case 4:o[n].fn.call(o[n].context,S,_,T);break;default:if(!s)for(h=1,s=new Array(u-1);h<u;h++)s[h-1]=arguments[h];o[n].fn.apply(o[n].context,s)}}return!0},k.prototype.on=function(L,S,_){return b(this,L,S,_,!1)},k.prototype.once=function(L,S,_){return b(this,L,S,_,!0)},k.prototype.removeListener=function(L,S,_,T){var c=x?x+L:L;if(!this._events[c])return this;if(!S)return R(this,c),this;var y=this._events[c];if(y.fn)y.fn===S&&(!T||y.once)&&(!_||y.context===_)&&R(this,c);else{for(var m=0,o=[],u=y.length;m<u;m++)(y[m].fn!==S||T&&!y[m].once||_&&y[m].context!==_)&&o.push(y[m]);o.length?this._events[c]=o.length===1?o[0]:o:R(this,c)}return this},k.prototype.removeAllListeners=function(L){var S;return L?(S=x?x+L:L,this._events[S]&&R(this,S)):(this._events=new F,this._eventsCount=0),this},k.prototype.off=k.prototype.removeListener,k.prototype.addListener=k.prototype.on,k.prefixed=x,k.EventEmitter=k,Y.exports=k},"./node_modules/url-toolkit/src/url-toolkit.js":function(Y){(function(B){var x=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,F=/^(?=([^\/?#]*))\1([^]*)$/,A=/(?:\/|^)\.(?=\/)/g,b=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,R={buildAbsoluteURL:function(k,P,L){if(L=L||{},k=k.trim(),P=P.trim(),!P){if(!L.alwaysNormalize)return k;var S=R.parseURL(k);if(!S)throw new Error("Error trying to parse base URL.");return S.path=R.normalizePath(S.path),R.buildURLFromParts(S)}var _=R.parseURL(P);if(!_)throw new Error("Error trying to parse relative URL.");if(_.scheme)return L.alwaysNormalize?(_.path=R.normalizePath(_.path),R.buildURLFromParts(_)):P;var T=R.parseURL(k);if(!T)throw new Error("Error trying to parse base URL.");if(!T.netLoc&&T.path&&T.path[0]!=="/"){var c=F.exec(T.path);T.netLoc=c[1],T.path=c[2]}T.netLoc&&!T.path&&(T.path="/");var y={scheme:T.scheme,netLoc:_.netLoc,path:null,params:_.params,query:_.query,fragment:_.fragment};if(!_.netLoc&&(y.netLoc=T.netLoc,_.path[0]!=="/"))if(!_.path)y.path=T.path,_.params||(y.params=T.params,_.query||(y.query=T.query));else{var m=T.path,o=m.substring(0,m.lastIndexOf("/")+1)+_.path;y.path=R.normalizePath(o)}return y.path===null&&(y.path=L.alwaysNormalize?R.normalizePath(_.path):_.path),R.buildURLFromParts(y)},parseURL:function(k){var P=x.exec(k);return P?{scheme:P[1]||"",netLoc:P[2]||"",path:P[3]||"",params:P[4]||"",query:P[5]||"",fragment:P[6]||""}:null},normalizePath:function(k){for(k=k.split("").reverse().join("").replace(A,"");k.length!==(k=k.replace(b,"")).length;);return k.split("").reverse().join("")},buildURLFromParts:function(k){return k.scheme+k.netLoc+k.path+k.params+k.query+k.fragment}};Y.exports=R})()}},Le={};function ue(Y){var B=Le[Y];if(B!==void 0)return B.exports;var x=Le[Y]={exports:{}};return Ae[Y].call(x.exports,x,x.exports,ue),x.exports}ue.m=Ae,ue.n=Y=>{var B=Y&&Y.__esModule?()=>Y.default:()=>Y;return ue.d(B,{a:B}),B},ue.d=(Y,B)=>{for(var x in B)ue.o(B,x)&&!ue.o(Y,x)&&Object.defineProperty(Y,x,{enumerable:!0,get:B[x]})},ue.o=(Y,B)=>Object.prototype.hasOwnProperty.call(Y,B),ue.r=Y=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(Y,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(Y,"__esModule",{value:!0})};var Pe=ue("./src/hls.ts");return Pe=Pe.default,Pe})())})(Ge);var He=Ge.exports;const rt=qe(He),nt=tt({__proto__:null,default:rt},[He]);export{nt as h};
